<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>投票（意見一覧）｜ADDEVA</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- common.js が初回に localStorage へ保存します -->
  <meta name="x-api-key" content="ADDEVA_API_KEY_c3rITY1LbafHBYaO62tJ4h4nzqQKsEMvXQ7aFRz3Uqk">

  <style>
    .vote-btn.active { box-shadow: inset 0 0 0 2px rgba(13,110,253,.35); }
    .note-warn { color: #8B0000; }
  </style>
</head>
<body>

  <!-- header include -->
  <div data-include="/header.html"></div>

  <main class="py-4">
    <div class="container container-narrow">

      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb small mb-0">
          <li class="breadcrumb-item"><a href="/">ホーム</a></li>
          <li class="breadcrumb-item"><a href="/customer.html">顧客ポータル</a></li>
          <li class="breadcrumb-item active" aria-current="page">投票（意見一覧）</li>
        </ol>
      </nav>

      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
        <div>
          <h1 class="h3 mb-1">投票（意見一覧）</h1>
          <div class="text-secondary small">
            対象商品：<span id="productName" class="fw-semibold">-</span>
            <span class="ms-2">商品コード：<span id="productCodeLabel">-</span></span>
          </div>
          <div class="text-secondary small">表示順は読み込み（または更新）時に確定し、投票しても次の更新まで変わりません。</div>
        </div>

        <div class="d-flex gap-2">
          <a id="btnAddOpinion" class="btn btn-primary btn-sm" href="#">
            <i class="bi bi-plus-lg"></i> 意見を追加する
          </a>
          <button id="btnReload" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> 更新
          </button>
        </div>
      </div>

      <div id="messageArea" class="alert d-none" role="alert" aria-live="polite" aria-atomic="true">
        <div class="d-flex align-items-start justify-content-between gap-3">
          <div id="messageText" class="flex-grow-1"></div>
          <button type="button" class="btn-close" aria-label="閉じる" id="messageCloseBtn"></button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm p-4 h-100">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
              <div>
                <div class="fw-semibold">改善してほしい点（上位）</div>
                <div class="text-secondary small">総投票数が多い順。全件は「すべて見る」で確認できます。</div>
              </div>
              <button class="btn btn-outline-primary btn-sm" data-open-all="improve">すべて見る</button>
            </div>
            <div id="summaryImproveWrap" class="vstack gap-2"></div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card shadow-sm p-4 h-100">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
              <div>
                <div class="fw-semibold">良かった点（上位）</div>
                <div class="text-secondary small">総投票数が多い順。全件は「すべて見る」で確認できます。</div>
              </div>
              <button class="btn btn-outline-primary btn-sm" data-open-all="praise">すべて見る</button>
            </div>
            <div id="summaryPraiseWrap" class="vstack gap-2"></div>
          </div>
        </div>
      </div>

      <div class="mt-3 text-secondary small">
        注：審査中（new）の意見は投票できません。投票はいつでも変更できます（賛成/反対/どちらでもない）。
      </div>

    </div>
  </main>

  <!-- footer include -->
  <div data-include="/footer.html"></div>

  <!-- All posts modal -->
  <div class="modal fade" id="allModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">意見一覧（すべて）</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <label class="small text-secondary" for="typeSelect">種類</label>
              <select id="typeSelect" class="form-select form-select-sm" style="width:auto;">
                <option value="improve">改善してほしい点</option>
                <option value="praise">良かった点</option>
              </select>

              <label class="small text-secondary ms-2" for="sortSelect">並び順</label>
              <select id="sortSelect" class="form-select form-select-sm" style="width:auto;">
                <option value="top">投票数が多い順</option>
                <option value="new">新しい順</option>
              </select>

              <span class="small text-secondary ms-2">（投票しても、次の更新までは表示順は変わりません）</span>
            </div>

            <button id="btnAllReload" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-arrow-clockwise"></i> 更新
            </button>
          </div>

          <div id="allWrap" class="vstack gap-2"></div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="/common.js"></script>

  <script>
    const qs = (name) => new URL(window.location.href).searchParams.get(name) || '';

    /* -------------------- include (header/footer) -------------------- */
    async function includeFragments() {
      const nodes = Array.from(document.querySelectorAll('[data-include]'));
      await Promise.all(nodes.map(async (el) => {
        const url = String(el.getAttribute('data-include') || '').trim();
        if (!url) return;
        try {
          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const html = await res.text();
          el.innerHTML = html;
        } catch (e) {
          // include は UI の補助なので、致命傷にしない
          console.warn('include failed:', url, e);
        }
      }));
    }

    /* -------------------- alert helpers -------------------- */
    const bindMessageClose = () => {
      const btn = document.getElementById('messageCloseBtn');
      if (!btn) return;
      if (btn.dataset.bound === '1') return;
      btn.addEventListener('click', clearAlert);
      btn.dataset.bound = '1';
    };

    const showAlert = (kind, msg) => {
      const box = document.getElementById('messageArea');
      if (!box) return;

      box.className = `alert alert-${kind} shadow-sm`;
      box.classList.remove('d-none');

      const text = document.getElementById('messageText');
      if (text) text.textContent = msg;

      bindMessageClose();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const clearAlert = () => {
      const box = document.getElementById('messageArea');
      if (!box) return;
      box.classList.add('d-none');
      const text = document.getElementById('messageText');
      if (text) text.textContent = '';
      bindMessageClose();
    };

    /* -------------------- utils -------------------- */
    const escapeHtml = (v) => String(v ?? '').replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    })[m]);

    const api = (path, opts) => ADDEVA.apiFetch(path, opts);

    const statusMap = { new: '審査中', reviewing: '検討中', planned: '対応予定', shipped: '対応済み', rejected: '否認' };
    const statusLabel = (s) => statusMap[s] || s || '';
    const isApprovedStatus = (s) => ['reviewing', 'planned', 'shipped'].includes(s);

    function totalVotes(p) {
      return Number(p.up_count || 0) + Number(p.down_count || 0) + Number(p.neutral_count || 0);
    }

    /* -------------------- render -------------------- */
    function voteButtons(p, disabled) {
      const btn = (voteType, label, count) => `
        <button class="btn btn-sm btn-outline-secondary vote-btn ${p.my_vote === voteType ? 'active' : ''}"
                data-post="${p.post_id}" data-v="${voteType}" ${disabled ? 'disabled' : ''}>
          ${label} <span class="badge text-bg-light" data-count="${voteType}">${count}</span>
        </button>`;

      return `
        <div class="btn-group btn-group-sm" role="group" aria-label="vote">
          ${btn('up', '賛成', p.up_count || 0)}
          ${btn('down', '反対', p.down_count || 0)}
          ${btn('neutral', 'どちらでもない', p.neutral_count || 0)}
        </div>`;
    }

    function renderPostItem(p, inModal = false) {
      const partName = String(p.part_name_ja || '').trim();
      const partCode = String(p.part_code || '').trim();
      const part = (partName || partCode)
        ? `（部位：${escapeHtml(partName || partCode)}${(partName && partCode) ? ` / ${escapeHtml(partCode)}` : ''}）`
        : '';

      const total = totalVotes(p);
      const nickname = p.nickname ? escapeHtml(p.nickname) : '-';

      const status = `<span class="badge ${isApprovedStatus(p.status) ? 'text-bg-success' : 'text-bg-secondary'} fw-normal">${escapeHtml(statusLabel(p.status))}</span>`;
      const type = `<span class="badge text-bg-info fw-normal">${p.post_type === 'improve' ? '改善してほしい点' : '良かった点'}</span>`;

      const meta = `
        <div class="small text-secondary">
          投稿ID: ${p.post_id} / ニックネーム: ${nickname} ${part}
          <span class="ms-2">総投票数: <span data-total-count="1">${total}</span></span>
        </div>`;

      const body = inModal
        ? `<div class="mt-2" style="white-space:pre-wrap;">${escapeHtml(p.body || '')}</div>`
        : '';

      const disabled = !isApprovedStatus(p.status);

      return `
        <div class="post-item border rounded p-3" data-post-id="${p.post_id}">
          <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
            <div class="flex-grow-1">
              <div class="d-flex gap-2 align-items-center flex-wrap mb-1">
                ${status}
                ${type}
                <div class="fw-semibold">${escapeHtml(p.title || '')}</div>
              </div>
              ${meta}
              ${body}
            </div>

            <div class="text-end" style="min-width:220px;">
              ${voteButtons(p, disabled)}
              <div class="form-text mt-1">${disabled ? '審査中は投票不可' : 'クリックで投票/取消（表示順は次の更新まで変わりません）'}</div>
            </div>
          </div>
        </div>`;
    }

    /* -------------------- voting: post_id 指定でDOM更新（並び順固定） -------------------- */
    function applyVoteResultToDom(postId, res) {
      const myVote = (res && (res.myVote ?? res.my_vote ?? null)) || null;
      const up = Number((res && (res.upCount ?? res.up_count)) ?? 0);
      const down = Number((res && (res.downCount ?? res.down_count)) ?? 0);
      const neutral = Number((res && (res.neutralCount ?? res.neutral_count)) ?? 0);
      const total = up + down + neutral;

      // 画面上に同じ投稿が複数箇所（上位表示／モーダル等）に出ても、全部更新する
      document.querySelectorAll(`[data-post-id="${postId}"]`).forEach((card) => {
        const upEl = card.querySelector('.vote-btn[data-v="up"] [data-count="up"]');
        const downEl = card.querySelector('.vote-btn[data-v="down"] [data-count="down"]');
        const neutralEl = card.querySelector('.vote-btn[data-v="neutral"] [data-count="neutral"]');

        if (upEl) upEl.textContent = String(up);
        if (downEl) downEl.textContent = String(down);
        if (neutralEl) neutralEl.textContent = String(neutral);

        const totalEl = card.querySelector('[data-total-count]');
        if (totalEl) totalEl.textContent = String(total);
      });

      // active 状態の更新（表示順は変えない）
      document.querySelectorAll(`.vote-btn[data-post="${postId}"]`).forEach((btn) => {
        const v = String(btn.dataset.v || '').trim();
        btn.classList.toggle('active', !!myVote && v === myVote);
      });
    }

    function bindVoteHandlers(rootEl) {
      rootEl.querySelectorAll('.vote-btn').forEach((btn) => {
        if (btn.dataset.bound === '1') return;

        btn.addEventListener('click', async () => {
          if (btn.disabled) return;

          const postId = Number(btn.dataset.post);
          const voteType = String(btn.dataset.v || '').trim();
          if (!postId || !voteType) return;

          // 二重クリック対策：同一postの全ボタンを一時disable
          const btns = Array.from(document.querySelectorAll(`.vote-btn[data-post="${postId}"]`));
          const prevDisabled = new Map();
          btns.forEach((b) => prevDisabled.set(b, !!b.disabled));
          btns.forEach((b) => { b.disabled = true; });

          try {
            const res = await api('/api/addeva/feedback/vote', { method: 'POST', body: { postId, voteType } });
            // 並び順は維持しつつ、当該postだけ数値を更新
            applyVoteResultToDom(postId, res);
          } catch (e) {
            showAlert('danger', e.message || '投票に失敗しました。');
          } finally {
            btns.forEach((b) => { b.disabled = prevDisabled.get(b) || false; });
          }
        });

        btn.dataset.bound = '1';
      });
    }

    /* -------------------- data load -------------------- */
    function renderEmpty(wrapEl) {
      wrapEl.innerHTML = '<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">投稿がありません。</p></div>';
    }

    async function loadProductInfo(productCode) {
      const nameEl = document.getElementById('productName');
      const codeEl = document.getElementById('productCodeLabel');
      if (codeEl) codeEl.textContent = productCode || '-';

      try {
        const info = await api('/api/addeva/feedback/product_info', { method: 'POST', body: { productCode } });
        const productName = (info && (info.product_name ?? info.productName)) ? String(info.product_name ?? info.productName).trim() : '';
        if (nameEl) nameEl.textContent = productName || '-';
      } catch (e) {
        if (nameEl) nameEl.textContent = '-';
        // 商品名が取れなくても投票ページ自体は動かす
        console.warn('product_info failed:', e);
      }
    }

    async function loadSummary() {
      clearAlert();
      const productCode = qs('product_code');
      if (!productCode) {
        showAlert('danger', '商品コードが指定されていません。');
        return;
      }

      // 意見追加ボタン
      const addBtn = document.getElementById('btnAddOpinion');
      if (addBtn) addBtn.href = `/feedback.html?product_code=${encodeURIComponent(productCode)}`;

      // 商品名
      await loadProductInfo(productCode);

      const improveWrap = document.getElementById('summaryImproveWrap');
      const praiseWrap = document.getElementById('summaryPraiseWrap');
      improveWrap.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm" role="status"></div></div>';
      praiseWrap.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm" role="status"></div></div>';

      try {
        // summary は配列（既存運用に合わせる）
        const rows = await api('/api/addeva/opinion/summary', { method: 'POST', body: { productCode } });
        const arr = Array.isArray(rows) ? rows : [];

        const improve = arr.filter((p) => String(p.post_type || '').trim() === 'improve');
        const praise  = arr.filter((p) => String(p.post_type || '').trim() !== 'improve');

        // 表示順は「読み込み時」に確定（以後、投票しても並び替えない）
        improve.sort((a,b) => totalVotes(b) - totalVotes(a));
        praise.sort((a,b) => totalVotes(b) - totalVotes(a));

        const improveTop = improve.slice(0, 5);
        const praiseTop  = praise.slice(0, 5);

        if (improveTop.length === 0) renderEmpty(improveWrap);
        else {
          improveWrap.innerHTML = improveTop.map((p) => renderPostItem(p, false)).join('');
          bindVoteHandlers(improveWrap);
        }

        if (praiseTop.length === 0) renderEmpty(praiseWrap);
        else {
          praiseWrap.innerHTML = praiseTop.map((p) => renderPostItem(p, false)).join('');
          bindVoteHandlers(praiseWrap);
        }

      } catch (e) {
        improveWrap.innerHTML = `<div class="alert alert-danger mb-0">${escapeHtml(e.message || '読み込みに失敗しました。')}</div>`;
        praiseWrap.innerHTML = `<div class="alert alert-danger mb-0">${escapeHtml(e.message || '読み込みに失敗しました。')}</div>`;
      }
    }

    async function loadAll() {
      clearAlert();
      const productCode = qs('product_code');
      if (!productCode) {
        showAlert('danger', '商品コードが指定されていません。');
        return;
      }

      const sortEl = document.getElementById('sortSelect');
      const typeEl = document.getElementById('typeSelect');
      const sortMode = sortEl ? String(sortEl.value || 'top') : 'top';
      const typeMode = typeEl ? String(typeEl.value || 'improve') : 'improve';

      // 画面上の並び順は「この loadAll のタイミング」で確定
      const wrap = document.getElementById('allWrap');
      wrap.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm" role="status"></div></div>';

      try {
        const rows = await api('/api/addeva/opinion/list', { method: 'POST', body: { productCode, sort: sortMode } });
        let arr = Array.isArray(rows) ? rows : [];

        // 種類で絞り込み（モーダル内）
        arr = arr.filter((p) => {
          const t = String(p.post_type || '').trim();
          return (typeMode === 'improve') ? (t === 'improve') : (t !== 'improve');
        });

        // ここで並び順を確定させる（投票後は再描画しないので変わらない）
        if (sortMode === 'top') {
          arr = arr.slice().sort((a,b) => totalVotes(b) - totalVotes(a));
        } else {
          // new: API側が新着順を返す想定だが、念のため created_at があれば降順に
          if (arr.length > 0 && (arr[0].created_at || arr[0].createdAt)) {
            arr = arr.slice().sort((a,b) => String(b.created_at ?? b.createdAt).localeCompare(String(a.created_at ?? a.createdAt)));
          }
        }

        if (arr.length === 0) {
          renderEmpty(wrap);
          return;
        }

        wrap.innerHTML = arr.map((p) => renderPostItem(p, true)).join('');
        bindVoteHandlers(wrap);

      } catch (e) {
        wrap.innerHTML = `<div class="alert alert-danger mb-0">${escapeHtml(e.message || '読み込みに失敗しました。')}</div>`;
      }
    }

    /* -------------------- init -------------------- */
    async function openAllModal(type) {
      const typeEl = document.getElementById('typeSelect');
      if (typeEl) typeEl.value = (type === 'praise') ? 'praise' : 'improve';

      const modalEl = document.getElementById('allModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();

      await loadAll();
    }

    async function init() {
      await includeFragments();

      const btnReload = document.getElementById('btnReload');
      const btnAllReload = document.getElementById('btnAllReload');
      const sortSelect = document.getElementById('sortSelect');
      const typeSelect = document.getElementById('typeSelect');

      if (btnReload) btnReload.addEventListener('click', loadSummary);
      if (btnAllReload) btnAllReload.addEventListener('click', loadAll);
      if (sortSelect) sortSelect.addEventListener('change', loadAll);
      if (typeSelect) typeSelect.addEventListener('change', loadAll);

      // 「すべて見る」ボタン（2箇所）
      document.querySelectorAll('[data-open-all]').forEach((btn) => {
        if (btn.dataset.bound === '1') return;
        btn.addEventListener('click', async () => {
          const t = String(btn.getAttribute('data-open-all') || '').trim();
          await openAllModal(t);
        });
        btn.dataset.bound = '1';
      });

      await loadSummary();
    }

    (function waitForADDEVA() {
      const START = Date.now();
      const TIMEOUT_MS = 7000;

      function tick() {
        if (typeof ADDEVA !== 'undefined' && ADDEVA && typeof ADDEVA.apiFetch === 'function') {
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
          } else {
            init();
          }
          return;
        }

        if (Date.now() - START > TIMEOUT_MS) {
          showAlert('danger', 'common.js の読み込みが完了していないため、API通信を開始できません。/common.js が 404 になっていないか確認してください。');
          return;
        }

        setTimeout(tick, 50);
      }

      tick();
    })();
  </script>

</body>
</html>
