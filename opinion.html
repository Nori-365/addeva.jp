<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>投票ページ｜ADDEVA フィードバック</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- APIキーをcommon.jsが読み取るためのメタタグ -->
  <meta name="x-api-key" content="ADDEVA_API_KEY_c3rITY1LbafHBYaO62tJ4h4nzqQKsEMvXQ7aFRz3Uqk">

  <style>
    /* Chromeのスクロールアンカー対策 */
    #messageArea { overflow-anchor: none; }

    .vote-btn.active { box-shadow: inset 0 0 0 2px rgba(13,110,253,.35); }

    .post-item {
      border: 1px solid rgba(0,0,0,.12);
      border-radius: .75rem;
      padding: 1rem;
      background: #fff;
    }

    .post-title { line-height: 1.35; }

    .text-darkred { color: #8B0000 !important; }

    /* モーダル内の長文も読みやすく */
    .modal-body .post-item { border-radius: .75rem; }
  </style>
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header fixed-top" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item"><a href="/customer.html">顧客ポータル</a></li>
            <li class="breadcrumb-item active" aria-current="page">投票ページ</li>
          </ol>
        </nav>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert" aria-live="polite" aria-atomic="true">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div id="messageText" class="flex-grow-1"></div>
            <button type="button" class="btn-close" aria-label="閉じる" id="messageCloseBtn"></button>
          </div>
        </div>

        <!-- ページヘッダー情報 -->
        <div class="mb-4">
          <h1 class="mb-2">投票ページ</h1>
          <p class="lead mb-1">
            対象商品：<span id="productName" class="fw-bold text-primary">-</span>
            <span class="badge bg-secondary fw-normal ms-2" id="productCodeChip">-</span>
          </p>
          <p class="text-secondary">
            まずは皆さんの意見に投票してください。該当する意見が無ければ、意見を追加できます。
          </p>
        </div>

        <div class="d-flex flex-wrap gap-2 mb-4">
          <a id="btnAddOpinion" class="btn btn-primary" href="#">
            <i class="bi bi-plus-circle me-1"></i> 新しい意見を追加する
          </a>
          <button id="btnReload" class="btn btn-outline-secondary" type="button">
            <i class="bi bi-arrow-clockwise me-1"></i> 更新
          </button>
        </div>

        <div class="row g-4">
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                  <h2 class="h5 m-0"><i class="bi bi-lightbulb me-2"></i>改善してほしい点（上位）</h2>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-act="openAll" data-type="improve">
                    全部見る
                  </button>
                </div>
                <p class="text-secondary small mb-3">投票数の多い順に表示します（承認済み投稿のみ）。</p>
                <div id="topImprove" class="vstack gap-3">
                  <div class="text-center p-4 bg-light rounded">
                    <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                  <h2 class="h5 m-0"><i class="bi bi-hand-thumbs-up me-2"></i>良かった点（上位）</h2>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-act="openAll" data-type="praise">
                    全部見る
                  </button>
                </div>
                <p class="text-secondary small mb-3">投票数の多い順に表示します（承認済み投稿のみ）。</p>
                <div id="topPraise" class="vstack gap-3">
                  <div class="text-center p-4 bg-light rounded">
                    <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <div class="p-3 bg-light border rounded">
            <div class="d-flex gap-2 align-items-start">
              <i class="bi bi-info-circle mt-1"></i>
              <div>
                <div class="fw-semibold">投票のルール</div>
                <div class="small text-secondary">
                  投票は「賛成 / 反対 / どちらでもない」の3択です。同じボタンをもう一度押すと無投票に戻ります。分からない場合は「無投票」のままで問題ありません。
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <!-- ▼ 一覧モーダル（全部見る） -->
  <div class="modal fade" id="allModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="allModalTitle">一覧</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <div class="small text-secondary" id="allModalSub">-</div>
            <div class="d-flex gap-2 align-items-center">
              <select id="allSort" class="form-select form-select-sm" style="width:auto;">
                <option value="popular">人気順（総投票数）</option>
                <option value="new">新着順</option>
              </select>
              <button class="btn btn-sm btn-outline-secondary" id="btnAllReload" type="button"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
          </div>

          <div id="allList" class="vstack gap-3">
            <div class="text-center p-4 bg-light rounded">
              <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>
            </div>
          </div>

          <div class="d-grid mt-3">
            <button id="btnAllMore" class="btn btn-outline-primary" type="button">さらに読み込む</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="/common.js"></script>

  <script>
    // === ユーティリティ ===
    const qs = name => new URL(window.location.href).searchParams.get(name) || '';

    const bindMessageClose = () => {
      const btn = document.getElementById('messageCloseBtn');
      if (!btn) return;
      if (btn.dataset.bound === '1') return;
      btn.addEventListener('click', clearAlert);
      btn.dataset.bound = '1';
    };

    const showAlert = (kind, msg) => {
      const box = document.getElementById('messageArea');
      if (!box) return;

      box.className = `alert alert-${kind} shadow-sm`;
      box.classList.remove('d-none');

      const text = document.getElementById('messageText');
      if (text) text.textContent = msg;

      bindMessageClose();

      try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch (_) {}
    };

    const clearAlert = () => {
      const box = document.getElementById('messageArea');
      if (!box) return;
      box.classList.add('d-none');
      const text = document.getElementById('messageText');
      if (text) text.textContent = '';
      bindMessageClose();
    };

    const escapeHtml = v => String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);

    const api = (path, opts) => ADDEVA.apiFetch(path, opts);

    // === 表示ラベル ===
    const statusMap = { new: '審査中', reviewing: '検討中', planned: '対応予定', shipped: '対応済み', rejected: '否認' };
    const statusLabel = s => statusMap[s] || s || '';

    function voteButtons(p, disabled) {
      const btn = (voteType, label, count) => `
        <button class="btn btn-sm btn-outline-secondary vote-btn ${p.my_vote === voteType ? 'active' : ''}"
                data-act="vote" data-post="${p.post_id}" data-v="${voteType}" ${disabled ? 'disabled' : ''}>
          ${label} <span class="badge text-bg-light">${count}</span>
        </button>`;

      return `
        <div class="btn-group btn-group-sm" role="group" aria-label="vote">
          ${btn('up', '賛成', p.up_count || 0)}
          ${btn('down', '反対', p.down_count || 0)}
          ${btn('neutral', 'どちらでもない', p.neutral_count || 0)}
        </div>`;
    }

    function renderPostItem(p, inModal = false) {
      const typeLabel = (p.post_type === 'improve') ? '改善してほしい点' : '良かった点';
      const st = statusLabel(p.status);
      const total = (p.total_votes != null) ? ` / 総投票数: ${p.total_votes}` : '';

      // opinion側は承認済みのみを返す想定だが、念のため投票UIは常に有効にしておき、サーバ側で403等を返したらエラー表示する
      const disabled = false;

      const part = (p.part_name_ja || p.part_code) ? `（部位：${escapeHtml(p.part_name_ja || '')}${p.part_code ? ` / ${escapeHtml(p.part_code)}` : ''}）` : '';

      return `
        <div class="post-item">
          <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
            <div class="flex-grow-1">
              <div class="d-flex gap-2 align-items-center flex-wrap mb-1">
                <span class="badge text-bg-success fw-normal">${escapeHtml(st)}</span>
                <span class="badge text-bg-info fw-normal">${escapeHtml(typeLabel)}</span>
                <div class="fw-semibold post-title">${escapeHtml(p.title || '')}</div>
              </div>
              <div class="small text-secondary mb-2">
                投稿ID: ${p.post_id}${p.nickname ? ` / ニックネーム: ${escapeHtml(p.nickname)}` : ''}${part}${total}
              </div>
              ${inModal ? `<div class="small" style="white-space:pre-wrap;">${escapeHtml(p.body || '')}</div>` : ''}
            </div>
            <div class="text-end" style="min-width:220px;">
              ${voteButtons(p, disabled)}
              <div class="form-text mt-1">クリックで投票/取消</div>
            </div>
          </div>
        </div>`;
    }

    function bindVoteHandlers(rootEl) {
      rootEl.querySelectorAll('[data-act="vote"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const postId = Number(btn.dataset.post);
          const voteType = String(btn.dataset.v || '').trim();
          if (!postId || !voteType) return;
          clearAlert();

          try {
            await api('/api/addeva/feedback/vote', { method: 'POST', body: { postId, voteType } });

            // 画面上の件数はサーバ結果で再取得し直す（単純に再読込）
            const modalShown = document.body.classList.contains('modal-open');
            if (modalShown) {
              await loadAll(true);
            }
            await loadSummary();
          } catch (e) {
            showAlert('danger', e.message || '投票に失敗しました。');
          }
        });
      });
    }

    // === サマリー（TOP） ===
    async function loadSummary() {
      const productCode = qs('product_code');
      if (!productCode) {
        showAlert('danger', '商品コードが指定されていません。顧客ポータルから再度お試しください。');
        return;
      }

      document.getElementById('productCodeChip').textContent = productCode;

      const topImproveEl = document.getElementById('topImprove');
      const topPraiseEl = document.getElementById('topPraise');

      try {
        const res = await api('/api/addeva/opinion/summary', { method: 'POST', body: { productCode, topLimit: 5 } });

        document.getElementById('productName').textContent = res.product_name || '-';
        document.getElementById('productCodeChip').textContent = res.product_code || productCode;

        // 「意見追加」リンク
        const add = document.getElementById('btnAddOpinion');
        if (add) add.href = '/feedback.html?product_code=' + encodeURIComponent(res.product_code || productCode);

        const ti = Array.isArray(res.top_improve) ? res.top_improve : [];
        const tp = Array.isArray(res.top_praise) ? res.top_praise : [];

        if (ti.length === 0) {
          topImproveEl.innerHTML = '<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">まだ意見がありません。</p></div>';
        } else {
          topImproveEl.innerHTML = ti.map(p => renderPostItem(p, false)).join('');
          bindVoteHandlers(topImproveEl);
        }

        if (tp.length === 0) {
          topPraiseEl.innerHTML = '<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">まだ意見がありません。</p></div>';
        } else {
          topPraiseEl.innerHTML = tp.map(p => renderPostItem(p, false)).join('');
          bindVoteHandlers(topPraiseEl);
        }

      } catch (e) {
        topImproveEl.innerHTML = `<div class="alert alert-danger mb-0">${escapeHtml(e.message) || '読み込みに失敗しました。'}</div>`;
        topPraiseEl.innerHTML = `<div class="alert alert-danger mb-0">${escapeHtml(e.message) || '読み込みに失敗しました。'}</div>`;
      }
    }

    // === 一覧（全部見る / モーダル） ===
    const allState = {
      productCode: '',
      postType: 'improve',
      sort: 'popular',
      limit: 20,
      offset: 0,
      nextOffset: null,
      loading: false,
    };

    function setAllHeader() {
      const title = document.getElementById('allModalTitle');
      const sub = document.getElementById('allModalSub');
      const label = (allState.postType === 'improve') ? '改善してほしい点' : '良かった点';
      if (title) title.textContent = label + '（一覧）';
      if (sub) sub.textContent = '投票数の多い順、または新着順で表示します。';
    }

    async function loadAll(reset = false) {
      if (allState.loading) return;
      allState.loading = true;

      const listEl = document.getElementById('allList');
      const moreBtn = document.getElementById('btnAllMore');
      if (!listEl || !moreBtn) {
        allState.loading = false;
        return;
      }

      if (reset) {
        allState.offset = 0;
        allState.nextOffset = null;
        listEl.innerHTML = '<div class="text-center p-4 bg-light rounded"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>';
      }

      moreBtn.disabled = true;

      try {
        const body = {
          productCode: allState.productCode,
          postType: allState.postType,
          sort: allState.sort,
          limit: allState.limit,
          offset: allState.offset,
        };

        const res = await api('/api/addeva/opinion/list', { method: 'POST', body });
        const posts = Array.isArray(res.posts) ? res.posts : [];

        const html = posts.map(p => renderPostItem(p, true)).join('');

        if (reset) {
          listEl.innerHTML = html || '<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">まだ意見がありません。</p></div>';
        } else {
          listEl.insertAdjacentHTML('beforeend', html);
        }

        bindVoteHandlers(listEl);

        allState.nextOffset = (res.next_offset != null) ? Number(res.next_offset) : null;
        allState.offset = allState.nextOffset != null ? allState.nextOffset : allState.offset;

        if (allState.nextOffset == null) {
          moreBtn.classList.add('d-none');
        } else {
          moreBtn.classList.remove('d-none');
          moreBtn.disabled = false;
        }

      } catch (e) {
        listEl.innerHTML = `<div class="alert alert-danger mb-0">${escapeHtml(e.message) || '読み込みに失敗しました。'}</div>`;
        moreBtn.classList.add('d-none');
      } finally {
        allState.loading = false;
      }
    }

    function openAll(postType) {
      const productCode = qs('product_code');
      if (!productCode) {
        showAlert('danger', '商品コードが指定されていません。顧客ポータルから再度お試しください。');
        return;
      }

      allState.productCode = productCode;
      allState.postType = postType;

      const sortEl = document.getElementById('allSort');
      allState.sort = sortEl ? String(sortEl.value || 'popular') : 'popular';

      setAllHeader();

      const modalEl = document.getElementById('allModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();

      loadAll(true);
    }

    async function init() {
      // イベント
      document.getElementById('btnReload').addEventListener('click', () => { clearAlert(); loadSummary(); });

      document.querySelectorAll('[data-act="openAll"]').forEach(btn => {
        btn.addEventListener('click', () => openAll(String(btn.dataset.type || 'improve')));
      });

      document.getElementById('btnAllMore').addEventListener('click', () => {
        if (allState.nextOffset != null) {
          allState.offset = allState.nextOffset;
          loadAll(false);
        }
      });

      document.getElementById('btnAllReload').addEventListener('click', () => {
        const sortEl = document.getElementById('allSort');
        allState.sort = sortEl ? String(sortEl.value || 'popular') : 'popular';
        setAllHeader();
        loadAll(true);
      });

      document.getElementById('allSort').addEventListener('change', (e) => {
        allState.sort = String(e.target.value || 'popular');
        setAllHeader();
        loadAll(true);
      });

      // 初期ロード
      await loadSummary();
    }

    // ADDEVAオブジェクトの準備ができてから初期化を実行
    (function waitForADDEVA() {
      const START = Date.now();
      const TIMEOUT_MS = 7000;

      function tick() {
        if (typeof ADDEVA !== 'undefined' && ADDEVA && typeof ADDEVA.apiFetch === 'function') {
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
          } else {
            init();
          }
          return;
        }

        if (Date.now() - START > TIMEOUT_MS) {
          showAlert('danger', 'common.js の読み込みが完了していないため、API通信を開始できません。/common.js が 404 になっていないか、キャッシュを消して再読み込みしてください。');
          return;
        }

        setTimeout(tick, 50);
      }

      tick();
    })();
  </script>

  <!-- ▼ includeエンジン -->
  <script>
    (async()=>{try{const t=document.querySelectorAll('[data-include]');for(const e of t){const l=e.getAttribute('data-include');if(!l)continue;const o=await fetch(l,{cache:'no-cache'});if(!o.ok)throw new Error(`include failed: ${l} (${o.status})`);e.outerHTML=await o.text()}}catch(e){console.error('include loader error:',e)}})();
  </script>
</body>
</html>
