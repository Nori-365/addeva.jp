<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary SEO -->
  <title>顧客ポータル｜ADDEVA（アデバ）公式</title>
  <meta name="description" content="ADDEVA製品の顧客ログイン、購入履歴、サポート依頼ページです。">

  <!-- Canonical -->
  <link rel="canonical" href="https://addeva.jp/customer.html">

  <!-- Icons -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Robots -->
  <meta name="robots" content="noindex,nofollow">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.7">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- APIキーをcommon.jsが読み取るためのメタタグ -->
  <meta name="x-api-key" content="ADDEVA_API_KEY_c3rITY1LbafHBYaO62tJ4h4nzqQKsEMvXQ7aFRz3Uqk">
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div include-html="/includes/header.html" class="site-header" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item active" aria-current="page">顧客ポータル</li>
          </ol>
        </nav>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert"></div>

        <!-- コンテンツコンテナ -->
        <div id="customerContent" class="card shadow-sm p-4 mb-5">
          <!-- ここにログインフォームまたはサポートコンテンツが動的に読み込まれる -->
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-secondary">コンテンツを読み込み中...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div include-html="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- addeva.jp 専用 common.js を読み込み -->
  <script defer src="/common.js"></script>

  <script>
    // ADDEVAオブジェクトがロードされた後に実行されるように待機
    function waitForADDEVA(callback) {
      if (typeof ADDEVA !== 'undefined' && typeof ADDEVA.apiFetch === 'function' && ADDEVA.LS && ADDEVA.LS.authToken) {
        callback();
      } else {
        setTimeout(() => waitForADDEVA(callback), 50);
      }
    }

    // 日付フォーマットヘルパー関数 (YYYY/MM/DD 形式)
    function formatJapaneseDate(isoDateString) {
      if (!isoDateString) return 'N/A';
      const d = new Date(isoDateString);
      if (isNaN(d.getTime())) return 'N/A';
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}/${m}/${day}`;
    }

    waitForADDEVA(async () => {
      const customerContent = document.getElementById('customerContent');
      const messageArea = document.getElementById('messageArea');

      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode') || 'support';

      let loggedInCustomerId = null;
      let loggedInEmail = null;

      function clearMessage() {
        messageArea.classList.add('d-none');
        messageArea.textContent = '';
        messageArea.classList.remove('alert-danger', 'alert-success');
      }

      function showError(msg) {
        messageArea.textContent = msg;
        messageArea.classList.remove('d-none', 'alert-success');
        messageArea.classList.add('alert-danger');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function showSuccess(msg) {
        messageArea.textContent = msg;
        messageArea.classList.remove('d-none', 'alert-danger');
        messageArea.classList.add('alert-success');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function getAuthToken() {
        return localStorage.getItem(ADDEVA.LS.authToken) || '';
      }

      function setAuthToken(token) {
        localStorage.setItem(ADDEVA.LS.authToken, token);
      }

      function clearAuthToken() {
        localStorage.removeItem(ADDEVA.LS.authToken);
      }

      // ==== UIレンダリング関数 ====
      function renderLoginUI() {
        customerContent.innerHTML = `
          <h1 class="mb-4">顧客ログイン</h1>
          <p class="lead mb-4">ご登録済みのメールアドレスとパスワードでログインしてください。</p>
          <form id="loginForm" class="col-md-8 mx-auto">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">メールアドレス</label>
              <input type="email" class="form-control" id="loginEmail" name="email" required placeholder="登録メールアドレス">
            </div>
            <div class="mb-4">
              <label for="loginPassword" class="form-label">パスワード</label>
              <input type="password" class="form-control" id="loginPassword" name="password" required placeholder="パスワード">
            </div>
            <button type="submit" class="btn btn-primary w-100">ログイン</button>
            <p class="mt-3 text-center">
              <a href="/register.html">まだ登録されていませんか？新規登録はこちら</a>
            </p>
          </form>
        `;

        const loginForm = document.getElementById('loginForm');
        loginForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          clearMessage();

          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;

          try {
            const result = await ADDEVA.apiFetch('/api/addeva/login', {
              method: 'POST',
              body: { email, password }
            });

            if (result && result.access_token) {
              setAuthToken(result.access_token);

              loggedInCustomerId = result.customer_id;
              loggedInEmail = result.email;

              showSuccess(result.message || 'ログインに成功しました。');

              // ログイン成功後、サポートページへリダイレクト
              window.location.href = '/customer.html?mode=support';
              return;
            }

            showError((result && (result.detail || result.error)) ? (result.detail || result.error) : 'ログインに失敗しました。');
          } catch (error) {
            console.error('Login API Error:', error);
            showError(error.message || 'サーバーとの通信に失敗しました。');
          }
        });
      }

      async function renderSupportUI() {
        customerContent.innerHTML = `
          <h1 class="mb-4">お客様サポート</h1>
          <p class="lead mb-4">お客様ID: <span id="displayCustomerId" class="fw-bold text-primary"></span> / メールアドレス: <span id="displayEmail"></span></p>

          ${urlParams.get('registered') === 'true' ? `
            <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
              <i class="bi bi-check-circle-fill flex-shrink-0 me-3 fs-4"></i>
              <div>
                <h5 class="alert-heading mb-1">保証登録が完了しました！</h5>
                <p class="mb-0">新しい商品情報が登録されました。お客様の購入情報を確認後、保証期間が有効になります。</p>
              </div>
            </div>
          ` : ''}

          <div class="mb-4">
            <h5 class="mb-3">これまでの購入商品一覧</h5>
            <div class="table-responsive">
              <table class="table table-bordered table-striped table-sm mb-0">
                <thead>
                  <tr>
                    <th>購入日</th>
                    <th>商品名</th>
                    <th>注文番号</th>
                    <th>保証終了日</th>
                    <th class="text-center">サポート</th>
                  </tr>
                </thead>
                <tbody id="purchasesTableBody">
                  <tr><td colspan="5" class="text-muted">購入履歴を読み込み中...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 justify-content-center mt-5">
            <a href="/register.html?mode=edit&customerId=${encodeURIComponent(loggedInCustomerId)}&email=${encodeURIComponent(loggedInEmail)}" class="btn btn-primary btn-lg">
              <i class="bi bi-plus-circle me-2"></i>新しく購入した商品を登録する
            </a>
            <button id="logoutButton" class="btn btn-outline-secondary btn-lg">
              <i class="bi bi-box-arrow-right me-2"></i>ログアウト
            </button>
            <button id="contactSupportButton" class="btn btn-info text-white btn-lg">
              <i class="bi bi-headset me-2"></i>サポートを依頼する
            </button>
          </div>
        `;

        document.getElementById('displayCustomerId').textContent = loggedInCustomerId;
        document.getElementById('displayEmail').textContent = loggedInEmail;

        // 購入履歴の取得と表示（common.js が Authorization を自動付与するので extraHeaders は不要）
        const purchasesTableBody = document.getElementById('purchasesTableBody');
        try {
          const purchases = await ADDEVA.apiFetch('/api/addeva/customer/purchases', { method: 'GET' });

          purchasesTableBody.innerHTML = '';
          if (!purchases || purchases.length === 0) {
            purchasesTableBody.innerHTML = '<tr><td colspan="5" class="text-muted">まだ購入履歴がありません。</td></tr>';
          } else {
            purchases.forEach(p => {
              const row = purchasesTableBody.insertRow();
              row.insertCell().textContent = formatJapaneseDate(p.purchaseDate) || 'N/A';
              row.insertCell().textContent = p.productName || 'N/A';
              row.insertCell().textContent = p.orderNumber || 'N/A';
              row.insertCell().textContent = formatJapaneseDate(p.warrantyEndDate) || 'N/A';

              const supportCell = row.insertCell();
              supportCell.className = 'text-center';
              supportCell.innerHTML = `<button class="btn btn-sm btn-outline-info support-request-btn" data-purchase-id="${p.purchaseSequenceNumber}" data-product-name="${(p.productName || '').replace(/"/g, '&quot;')}">依頼</button>`;
            });

            purchasesTableBody.querySelectorAll('.support-request-btn').forEach(button => {
              button.addEventListener('click', (e) => {
                const purchaseId = e.currentTarget.dataset.purchaseId;
                const productName = e.currentTarget.dataset.productName || '';
                alert(`「${productName}」のサポートを依頼します (購入ID: ${purchaseId})`);
                window.location.href = `/contact.html?mode=support&purchaseId=${encodeURIComponent(purchaseId)}&email=${encodeURIComponent(loggedInEmail)}`;
              });
            });
          }
        } catch (error) {
          console.error('購入履歴の取得に失敗しました:', error);
          purchasesTableBody.innerHTML = '<tr><td colspan="5" class="text-danger">購入履歴の表示に失敗しました。再度ログインしてください。</td></tr>';
          showError(error.message || '購入履歴の取得中にエラーが発生しました。');
        }

        // ログアウトボタン
        document.getElementById('logoutButton').addEventListener('click', () => {
          clearAuthToken();
          window.location.href = '/customer.html?mode=login';
        });

        // サポートを依頼するボタン（purchaseId無しの一般問い合わせ）
        document.getElementById('contactSupportButton').addEventListener('click', () => {
          window.location.href = `/contact.html?mode=support&email=${encodeURIComponent(loggedInEmail)}`;
        });
      }

      // ==== メイン処理 ====
      clearMessage();

      const authToken = getAuthToken();

      if (mode === 'login') {
        // ログインモードでトークンがある場合はサポートへ
        if (authToken) {
          window.location.href = '/customer.html?mode=support';
          return;
        }
        renderLoginUI();
        return;
      }

      if (mode === 'support') {
        // サポートモードでトークンが無いならログインへ
        if (!authToken) {
          window.location.href = '/customer.html?mode=login';
          return;
        }

        try {
          // トークンの有効性を確認し、顧客情報を取得（common.js が Authorization 自動付与）
          const userInfo = await ADDEVA.apiFetch('/api/addeva/customer/me', { method: 'GET' });
          loggedInCustomerId = userInfo.customer_id;
          loggedInEmail = userInfo.email;

          await renderSupportUI();
          return;
        } catch (error) {
          console.error('認証情報の検証に失敗しました:', error);
          clearAuthToken();
          showError(error.message || 'セッションが無効です。再度ログインしてください。');
          renderLoginUI();
          return;
        }
      }

      // 未定義モードはログインへ
      window.location.href = '/customer.html?mode=login';
    });
  </script>
</body>
</html>
