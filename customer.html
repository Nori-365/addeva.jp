<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary SEO -->
  <title>ユーザーサポート｜ADDEVA（アデバ）公式</title>
  <meta name="description" content="ADDEVA製品のユーザーログイン、購入履歴、保証期限確認、サポート依頼ページです。">

  <!-- Canonical -->
  <link rel="canonical" href="https://addeva.jp/customer.html">

  <!-- Icons -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Robots -->
  <meta name="robots" content="noindex,follow">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- NOTE: customer.html は JWT 認証で動作させる方針のため、x-api-key は埋め込みません -->
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header fixed-top" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item active" aria-current="page">ユーザーサポート</li>
          </ol>
        </nav>

        <!-- 右上アクション（サポート表示時のみ：デベロッパー管理＋ログアウトを配置） -->
        <div id="customerTopBar" class="d-flex justify-content-end align-items-center gap-2 mb-2"></div>

        <!-- メッセージ表示エリア（承認待ち通知などもここに表示） -->
        <div id="messageArea" class="alert d-none" role="alert" aria-live="polite" aria-atomic="true"></div>

        <!-- ログインページ用：説明文（ログイン枠の上） -->
        <div id="customerLoginIntro" class="mb-3 d-none"></div>

        <!-- コンテンツコンテナ -->
        <div id="customerContent" class="card shadow-sm p-3 p-md-4 mb-5">
          <!-- ここにログインフォームまたはサポートコンテンツが動的に読み込まれる -->
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-secondary">コンテンツを読み込み中...</p>
          </div>
        </div>

        <!-- ログインページ用：保証画像（ログイン枠の下） -->
        <div id="customerLoginWarranty" class="mt-4 d-none"></div>
      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- addeva.jp 専用 common.js を読み込み -->
  <script defer src="/common.js"></script>

  <script>
    // ADDEVAオブジェクトがロードされた後に実行されるように待機
    function waitForADDEVA(callback) {
      if (typeof ADDEVA !== 'undefined' && typeof ADDEVA.apiFetch === 'function' && ADDEVA.LS && ADDEVA.LS.authToken) {
        callback();
      } else {
        setTimeout(() => waitForADDEVA(callback), 50);
      }
    }

    // 日付フォーマットヘルパー関数 (YYYY/MM/DD 形式)
    function formatJapaneseDate(isoDateString) {
      if (!isoDateString) return 'N/A';
      const d = new Date(isoDateString);
      if (isNaN(d.getTime())) return 'N/A';
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}/${m}/${day}`;
    }

    // HTMLエスケープ（innerHTML を使う箇所のXSS対策）
    function escapeHtml(value) {
      return String((value === undefined || value === null) ? '' : value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // next の安全化（外部URLへのオープンリダイレクト防止）
    function getSafeNextFromUrl(urlParams) {
      const raw = (urlParams.get('next') || '').trim();
      if (!raw) return '';
      let decoded = '';
      try { decoded = decodeURIComponent(raw); } catch (_) { decoded = raw; }
      decoded = String(decoded || '').trim();

      // ルール：同一サイト内の相対パスのみ許可（/ で始まる、ただし // は不可）
      if (!decoded.startsWith('/')) return '';
      if (decoded.startsWith('//')) return '';
      if (decoded.includes('://')) return '';
      return decoded;
    }

    function buildLoginUrl(nextPath) {
      const base = '/customer.html?mode=login';
      if (!nextPath) return base;
      return base + '&next=' + encodeURIComponent(nextPath);
    }

    function currentFullPath() {
      return (window.location.pathname || '/') + (window.location.search || '') + (window.location.hash || '');
    }

    waitForADDEVA(async () => {
      // customer.html は JWT 認証で運用する想定。
      // 既存セッションで localStorage に API Key が残っている場合でも送出しないよう、このページでは削除する。
      try { localStorage.removeItem(ADDEVA.LS.apiKey); } catch (_) {}

      const customerContent = document.getElementById('customerContent');
      const messageArea = document.getElementById('messageArea');
      const customerLoginIntro = document.getElementById('customerLoginIntro');
      const customerLoginWarranty = document.getElementById('customerLoginWarranty');

      const urlParams = new URLSearchParams(window.location.search);
      const mode = (urlParams.get('mode') || 'support').trim().toLowerCase();
      const safeNext = getSafeNextFromUrl(urlParams);

      let loggedInCustomerId = null;
      let loggedInEmail = null;

      function clearMessage() {
        messageArea.classList.add('d-none');
        messageArea.textContent = '';
        messageArea.innerHTML = '';
        messageArea.classList.remove('alert-danger', 'alert-success', 'alert-warning', 'alert-info');
      }

      function showError(msg) {
        messageArea.textContent = msg;
        messageArea.classList.remove('d-none', 'alert-success', 'alert-warning', 'alert-info');
        messageArea.classList.add('alert-danger');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function showSuccess(msg) {
        messageArea.textContent = msg;
        messageArea.classList.remove('d-none', 'alert-danger', 'alert-warning', 'alert-info');
        messageArea.classList.add('alert-success');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // messageArea に HTML を表示（リンク付き通知などに使用）
      function showHtmlBanner(type, html) {
        const klass = (type === 'success') ? 'alert-success'
                    : (type === 'warning') ? 'alert-warning'
                    : (type === 'info') ? 'alert-info'
                    : 'alert-danger';
        messageArea.innerHTML = String(html || '');
        messageArea.className = `alert ${klass} border rounded mb-3`;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function getAuthToken() {
        return localStorage.getItem(ADDEVA.LS.authToken) || '';
      }

      function setAuthToken(token) {
        localStorage.setItem(ADDEVA.LS.authToken, token);
      }

      function clearAuthToken() {
        localStorage.removeItem(ADDEVA.LS.authToken);
      }

      function redirectAfterLogin() {
        // next があればそこへ、無ければ通常のサポートへ
        if (safeNext) {
          window.location.href = safeNext;
          return;
        }
        window.location.href = '/customer.html?mode=support';
      }

      // ==== UIレンダリング関数 ====
      function renderLoginUI() {
        // ログイン枠の上：説明文
        if (customerLoginIntro) {
          customerLoginIntro.innerHTML = `
            <div class="alert alert-light border mb-0">
              <p class="mb-2">当ページは、ご購入者様向けのサポートページです。</p>
              <p class="mb-2">製品登録により、保証期限の管理（保証：6か月）、製品別の使用説明ページの閲覧、サポート依頼が可能になります。</p>
              <p class="mb-0">はじめての方は「<a href="/register.html" class="link-primary">新規登録</a>」からお進みください。</p>
            </div>
          `;
          customerLoginIntro.classList.remove('d-none');
        }

        // ログイン枠の下：保証書画像
        if (customerLoginWarranty) {
          customerLoginWarranty.innerHTML = `
            <div class="text-center">
              <p class="mb-2 fw-semibold">安心の半年保証</p>
              <a href="/assets/img/customer/urbanflex_amazon_08.jpg" target="_blank" rel="noopener">
                <img src="/assets/img/customer/urbanflex_amazon_08.jpg" class="img-fluid rounded" alt="安心の半年保証（6か月）">
              </a>
              <p class="mt-2 text-secondary small mb-0">画像をクリックすると拡大表示できます。</p>
            </div>
          `;
          customerLoginWarranty.classList.remove('d-none');
        }

        customerContent.innerHTML = `
          <h1 class="mb-3 text-center">ユーザーログイン</h1>
          <p class="lead mb-4 text-center">ご登録済みのメールアドレスとパスワードでログインしてください。</p>

          <form id="loginForm" class="col-md-8 mx-auto">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">メールアドレス</label>
              <input type="email" class="form-control" id="loginEmail" name="email" required placeholder="登録メールアドレス">
            </div>
            <div class="mb-4">
              <label for="loginPassword" class="form-label">パスワード</label>
              <input type="password" class="form-control" id="loginPassword" name="password" required placeholder="パスワード">
            </div>
            <button type="submit" class="btn btn-primary w-100">ログイン</button>
            <p class="mt-3 text-center">
              <a href="/register.html">はじめての方（新規登録）はこちら</a>
            </p>
          </form>
        `;

        const loginForm = document.getElementById('loginForm');
        loginForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          clearMessage();

          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;

          try {
            const result = await ADDEVA.apiFetch('/api/addeva/login', {
              method: 'POST',
              body: { email, password }
            });

            if (result && result.access_token) {
              setAuthToken(result.access_token);

              loggedInCustomerId = result.customer_id;
              loggedInEmail = result.email;

              showSuccess(result.message || 'ログインに成功しました。');

              // ログイン後は next へ戻す（無ければ support）
              redirectAfterLogin();
              return;
            }

            showError((result && (result.detail || result.error)) ? (result.detail || result.error) : 'ログインに失敗しました。');
          } catch (error) {
            console.error('Login API Error:', error);
            showError(error.message || 'サーバーとの通信に失敗しました。');
          }
        });
      }

      // デベロッパー権限がある product_code を1つ見つける（あれば「デベロッパー管理」ボタンを表示）
      // 併せて developer_status の返り値に含まれる pending_summary（承認待ち要約）も取得する。
      // ※pending_summary は「自分が developer/admin の全製品」に対する承認待ち件数を返す想定。
      async function findDeveloperProductCode(productCodes) {
        try {
          const uniq = Array.from(new Set((productCodes || []).map(v => String(v || '').trim()).filter(Boolean)));
          let lastPendingSummary = null;

          for (const code of uniq) {
            try {
              const res = await ADDEVA.apiFetch('/api/addeva/feedback_board/developer_status', {
                method: 'POST',
                body: { productCode: code }
              });

              if (res && res.pending_summary && !lastPendingSummary) {
                lastPendingSummary = res.pending_summary;
              }

              if (res && res.is_developer) {
                return {
                  devProductCode: code,
                  pendingSummary: res.pending_summary || lastPendingSummary
                };
              }
            } catch (_) {
              // 権限なし/未ログイン/通信失敗は静かに無視（次の product_code を試す）
            }
          }
        } catch (_) {}

        return { devProductCode: '', pendingSummary: null };
      }

      // 承認待ち（dev_approval: status=new/updated）が存在するかを確認（存在すれば true）
      async function hasPendingApproval(productCode) {
        if (!productCode) return false;
        try {
          const res = await ADDEVA.apiFetch('/api/addeva/dev_approval/pending_list', {
            method: 'POST',
            body: { productCode: String(productCode), limit: 1, offset: 0 }
          });
          return Array.isArray(res) && res.length > 0;
        } catch (_) {
          return false;
        }
      }

      async function renderSupportUI() {
        // サポート表示時は、ログイン用の説明と保証表示を隠す
        if (customerLoginIntro) {
          customerLoginIntro.classList.add('d-none');
          customerLoginIntro.innerHTML = '';
        }
        if (customerLoginWarranty) {
          customerLoginWarranty.classList.add('d-none');
          customerLoginWarranty.innerHTML = '';
        }

        // 右上アクション（ログアウトは常に表示、デベロッパー管理は後で判定）
        const topBar = document.getElementById('customerTopBar');
        if (topBar) {
          topBar.innerHTML = `
            <a id="developerButtonTop" class="btn btn-outline-primary btn-sm d-none" href="#" role="button">
              <i class="bi bi-gear me-1"></i>デベロッパー管理
            </a>
            <button id="logoutButtonTop" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-box-arrow-right me-1"></i>ログアウト
            </button>
          `;

          const logoutBtn = document.getElementById('logoutButtonTop');
          if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
              clearAuthToken();
              window.location.href = '/customer.html?mode=login';
            });
          }
        }

        customerContent.innerHTML = `
          <h1 class="mb-4 text-center">お客様サポート</h1>
          <p class="lead mb-4 text-center">お客様ID: <span id="displayCustomerId" class="fw-bold text-primary"></span><span class="d-block d-md-inline"> / メールアドレス: <span id="displayEmail"></span></span></p>

          ${urlParams.get('registered') === 'true' ? `
            <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
              <i class="bi bi-check-circle-fill flex-shrink-0 me-3 fs-4"></i>
              <div>
                <h5 class="alert-heading mb-1">保証登録が完了しました！</h5>
                <p class="mb-0">新しい商品情報が登録されました。お客様の購入情報を確認後、保証期間が有効になります。</p>
              </div>
            </div>
          ` : ''}

          <div class="mb-4">
            <h5 class="mb-3 text-center">これまでの購入商品一覧</h5>
            <div class="table-responsive">
              <table class="table table-bordered table-striped table-sm mb-0">
                <thead>
                  <tr>
                    <th class="d-none d-md-table-cell">購入日</th>
                    <th class="d-none d-md-table-cell">商品名</th>
                    <th class="d-none d-md-table-cell">注文番号</th>
                    <th class="d-md-none text-center">購入日 / 注文番号<br>/ 商品名</th>

                    <!-- Desktop（md以上）：保証終了日＋操作 を分離 -->
                    <th class="d-none d-md-table-cell">保証終了日</th>
                    <th class="d-none d-md-table-cell text-center">操作</th>

                    <!-- Mobile（md未満）：保証終了日＋ボタン を1セルにまとめる -->
                    <th class="d-md-none text-center">保証終了日<br>/操作</th>
                  </tr>
                </thead>
                <tbody id="purchasesTableBody">
                  <tr><td colspan="7" class="text-muted">購入履歴を読み込み中...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 購入一覧の直下（左寄せ）に「新しく購入した商品を登録する」を配置 -->
          <div class="d-flex flex-wrap gap-2 justify-content-start mt-3">
            <a href="/register.html?mode=edit&customerId=${encodeURIComponent(loggedInCustomerId)}&email=${encodeURIComponent(loggedInEmail)}" class="btn btn-primary">
              <i class="bi bi-plus-circle me-2"></i>新しく購入した商品を登録する
            </a>
          </div>

          <div class="mt-4">
            <div class="p-3 p-md-4 border rounded-3 bg-light text-center">
              <p class="mb-2 fs-5 fw-semibold">フィードバックから、ご使用後のご感想をお聞かせください。</p>
              <p class="mb-0">ADDEVAは、皆様と一緒にブランドを育てていきたいと考えています。いただいたフィードバックは、製品開発責任者に共有されます。採用された改良は、可能な限り迅速に製品へ反映します。公開／非公開は投稿画面で選択できます。</p>
            </div>
          </div>
        `;

        document.getElementById('displayCustomerId').textContent = loggedInCustomerId;
        document.getElementById('displayEmail').textContent = loggedInEmail;

        const purchasesTableBody = document.getElementById('purchasesTableBody');
        let purchases = [];

        try {
          purchases = await ADDEVA.apiFetch('/api/addeva/customer/purchases', { method: 'GET' });

          purchasesTableBody.innerHTML = '';
          if (!purchases || purchases.length === 0) {
            purchasesTableBody.innerHTML = '<tr><td colspan="7" class="text-muted">まだ購入履歴がありません。</td></tr>';
          } else {
            purchases.forEach(p => {
              const row = purchasesTableBody.insertRow();

              // Desktop（md以上）：従来どおり列を分ける
              const purchaseDateCell = row.insertCell();
              purchaseDateCell.className = 'd-none d-md-table-cell';
              purchaseDateCell.textContent = formatJapaneseDate(p.purchaseDate) || 'N/A';

              const productNameCell = row.insertCell();
              productNameCell.className = 'd-none d-md-table-cell';
              productNameCell.textContent = p.productName || 'N/A';

              const orderNumberCell = row.insertCell();
              orderNumberCell.className = 'd-none d-md-table-cell';
              orderNumberCell.textContent = p.orderNumber || 'N/A';

              // Mobile（md未満）：購入日/注文番号/商品名 を1セルにまとめる
              const compactCell = row.insertCell();
              compactCell.className = 'd-md-none';
              compactCell.innerHTML = `${escapeHtml(formatJapaneseDate(p.purchaseDate) || 'N/A')} / ${escapeHtml(p.orderNumber || 'N/A')}<br>${escapeHtml(p.productName || 'N/A')}`;

              // Desktop（md以上）：保証終了日
              const warrantyEndCell = row.insertCell();
              warrantyEndCell.className = 'd-none d-md-table-cell';
              warrantyEndCell.textContent = formatJapaneseDate(p.warrantyEndDate) || 'N/A';

              // Desktop（md以上）：操作（フィードバック／製品ガイド）
              const supportCell = row.insertCell();
              supportCell.className = 'd-none d-md-table-cell text-center';

              // product_code はAPIレスポンス内に含まれる前提（product_code / productCode の両方に対応）
              const productCode = String((p.product_code ?? p.productCode ?? '') || '').trim();
              const guideUrl = productCode
                ? `/product_guide/${encodeURIComponent(productCode)}.html`
                : '/product_guide/index.html';

              const feedbackUrl = productCode
                ? `/feedback_board.html?product_code=${encodeURIComponent(productCode)}`
                : '/feedback_board.html';

              supportCell.innerHTML = `
                <div class="d-grid gap-1">
                  <a class="btn btn-sm btn-primary fw-semibold" href="${feedbackUrl}">フィードバック</a>
                  <a class="btn btn-sm btn-outline-secondary" href="${guideUrl}">製品ガイド</a>
                </div>
              `;

              // Mobile（md未満）：保証終了日＋ボタンを1セルにまとめる
              const compactRightCell = row.insertCell();
              compactRightCell.className = 'd-md-none text-center';
              compactRightCell.innerHTML = `<div class="fw-semibold mb-2">${escapeHtml(formatJapaneseDate(p.warrantyEndDate) || 'N/A')}</div>
                <div class="d-grid gap-1">
                  <a class="btn btn-sm btn-primary fw-semibold" href="${feedbackUrl}">フィードバック</a>
                  <a class="btn btn-sm btn-outline-secondary" href="${guideUrl}">製品ガイド</a>
                </div>
              `;
            });
          }

          // デベロッパー権限がある場合のみ、デベロッパー管理ボタン＋承認待ち通知を出す
          // 新仕様：pending_list を叩かず、developer_status の pending_summary を参照する
          try {
            const productCodes = (purchases || []).map(p => String((p.product_code ?? p.productCode ?? '') || '').trim()).filter(Boolean);
            const found = await findDeveloperProductCode(productCodes);
            const devProductCode = (found && found.devProductCode) ? String(found.devProductCode) : '';
            const pendingSummary = (found && found.pendingSummary) ? found.pendingSummary : null;

            if (devProductCode) {
              const devBtn = document.getElementById('developerButtonTop');
              if (devBtn) {
                devBtn.href = `/dev_approval.html?product_code=${encodeURIComponent(devProductCode)}`;
                devBtn.classList.remove('d-none');
              }

              // pending_summary があればそれを優先。無ければ（旧API互換）pending_list を1件だけ確認。
              let pendingCount = 0;
              let hasPending = false;

              if (pendingSummary && (pendingSummary.pending_count !== undefined || pendingSummary.has_pending !== undefined)) {
                pendingCount = Number(pendingSummary.pending_count || 0);
                hasPending = !!pendingSummary.has_pending || pendingCount > 0;
              } else {
                // 旧API互換（万が一、サーバー側が未更新でも UI が落ちないように）
                hasPending = await hasPendingApproval(devProductCode);
                pendingCount = hasPending ? 1 : 0;
              }

              if (hasPending) {
                const u = `/dev_approval.html?product_code=${encodeURIComponent(devProductCode)}`;
                const countText = (pendingCount >= 1)
                  ? `（${pendingCount}件）`
                  : '';

                const html = `
                  <div class="d-flex align-items-start justify-content-between gap-3">
                    <div class="d-flex align-items-start gap-2">
                      <i class="bi bi-exclamation-circle-fill fs-5"></i>
                      <div>
                        <div class="fw-semibold">承認待ちの意見があります${countText}</div>
                        <div class="small">デベロッパー管理ページで内容を確認してください。</div>
                      </div>
                    </div>
                    <div class="flex-shrink-0">
                      <a class="btn btn-sm btn-success" href="${u}">確認する</a>
                    </div>
                  </div>
                `;
                showHtmlBanner('success', html);
              }
            }
          } catch (_) {
            // 失敗しても表示しないだけ（ユーザー側の通常動線は維持）
          }

        } catch (error) {
          console.error('購入履歴の取得に失敗しました:', error);
          purchasesTableBody.innerHTML = '<tr><td colspan="7" class="text-danger">購入履歴の表示に失敗しました。再度ログインしてください。</td></tr>';
          showError(error.message || '購入履歴の取得中にエラーが発生しました。');
        }
      }

      // ==== メイン処理 ====
      clearMessage();

      const authToken = getAuthToken();

      if (mode === 'login') {
        // 既にトークンがあるなら next or support へ（ただし期限切れは除外）
        if (authToken) {
          try {
            if (typeof ADDEVA.isJwtExpired === 'function' && ADDEVA.isJwtExpired(authToken)) {
              clearAuthToken();
            } else {
              redirectAfterLogin();
              return;
            }
          } catch (_) {
            // 期限判定に失敗した場合は念のためログイン画面へ
            clearAuthToken();
          }
        }
        renderLoginUI();
        return;
      }

      if (mode === 'support') {
        // サポートモードでトークンが無いなら、loginへ（nextつき）
        if (!authToken) {
          window.location.href = buildLoginUrl(currentFullPath());
          return;
        }

        try {
          // トークンの有効性を確認し、顧客情報を取得
          const userInfo = await ADDEVA.apiFetch('/api/addeva/customer/me', { method: 'GET' });
          loggedInCustomerId = userInfo.customer_id;
          loggedInEmail = userInfo.email;

          await renderSupportUI();
          return;
        } catch (error) {
          console.error('認証情報の検証に失敗しました:', error);
          clearAuthToken();

          // 再ログイン後に戻せるよう next を付けて loginへ
          window.location.href = buildLoginUrl(currentFullPath());
          return;
        }
      }

      // 未定義モードはログインへ（nextつき）
      window.location.href = buildLoginUrl(currentFullPath());
    });
  </script>

  <!-- ▼ includeエンジン（将来の不具合予防：data-include と include-html 両対応） -->
  <script>
    (async () => {
      try {
        const targets = document.querySelectorAll('[data-include],[include-html]');
        for (const el of targets) {
          const url = el.getAttribute('data-include') || el.getAttribute('include-html');
          if (!url) continue;

          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`include failed: ${url} (${res.status})`);

          const buf = await res.arrayBuffer();
          const html = new TextDecoder('utf-8').decode(buf);
          el.outerHTML = html;
        }
      } catch (e) {
        console.error('include loader error:', e);
      }
    })();
  </script>
</body>
</html>
