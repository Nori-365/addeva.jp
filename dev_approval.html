<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,nofollow">

  <title>デベロッパー承認｜ADDEVA サポート</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* main.css 側に寄せつつ、承認画面用の最小限だけ補強 */
    #messageArea { overflow-anchor: none; }

    .row-clickable { cursor: pointer; }
    .row-clickable:hover { background: rgba(13,110,253,.04); }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .sticky-pane {
      position: sticky;
      top: 86px; /* fixed header を想定 */
    }

    .textarea-readonly {
      background: #f8f9fa;
    }

    .char-hint { font-size: .85rem; color: #6c757d; }

    @media (max-width: 991.98px) {
      .sticky-pane { position: static; top: auto; }
    }

    /* モバイル：テーブルの情報密度を少し下げる */
    @media (max-width: 767.98px) {
      .col-hide-sm { display: none !important; }
    }

    /* 商品別ブロック */
    .product-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      flex-wrap: wrap;
    }

    .product-title {
      display: flex;
      align-items: baseline;
      gap: .5rem;
      flex-wrap: wrap;
    }

    .product-title .name {
      font-weight: 700;
    }

    .product-actions {
      display: flex;
      align-items: center;
      gap: .5rem;
      flex-wrap: wrap;
    }

    .accordion-button .badge {
      transform: translateY(-1px);
    }

    /* 左リスト：商品ヘッダー内にアクション（部位管理／フィードバック）を置く */
    .product-acc-header {
      display: flex;
      align-items: stretch;
      gap: .5rem;
    }
    .product-acc-header .accordion-button {
      flex: 1 1 auto;
    }
    .product-acc-header .header-actions {
      display: flex;
      align-items: center;
      gap: .5rem;
      flex-wrap: wrap;
      white-space: nowrap;
      align-self: center;
      margin-right: .25rem;
    }
    .product-acc-header .header-actions .btn {
      white-space: nowrap;
    }

    /* アクセスガード（暫定：HTML側で操作を無効化） */
    .guard-disabled { pointer-events: none; opacity: .55; }

    /* PC：左右ペインを独立スクロールにして、右（編集ボード）上でホイールすると右がスクロールされるようにする */
    @media (min-width: 992px) {
      .panel-scroll {
        max-height: calc(100vh - 140px); /* fixed header + 余白ぶん */
        overflow-y: auto;
        overscroll-behavior: contain;
      }
    }
  </style>
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header fixed-top" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container">

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item"><a href="/customer.html">ユーザーサポート</a></li>
            <li class="breadcrumb-item d-none" id="breadcrumbBoardItem"><a id="breadcrumbBoard" href="#">フィードバックボード</a></li>
            <li class="breadcrumb-item active" aria-current="page">デベロッパー承認</li>
          </ol>
        </nav>

        <!-- 右上アクション（デベロッパー管理＋自分の意見管理＋ログアウト） -->
        <div id="feedbackTopBar" class="d-flex justify-content-end align-items-center gap-2 mb-2">
          <span id="developerButtonTop" class="btn btn-outline-secondary btn-sm disabled" role="button" aria-disabled="true" aria-current="page" tabindex="-1">
            <i class="bi bi-gear me-1"></i>デベロッパー管理
          </span>
          <a id="opinionManageButtonTop" class="btn btn-outline-primary btn-sm" href="/user_opinion_manage.html" role="button">
            <i class="bi bi-card-checklist me-1"></i>自分の意見管理
          </a>
          <button id="logoutButtonTop" class="btn btn-outline-secondary btn-sm" type="button">
            <i class="bi bi-box-arrow-right me-1"></i>ログアウト
          </button>
        </div>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert" aria-live="polite" aria-atomic="true">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div id="messageText" class="flex-grow-1"></div>
            <button type="button" class="btn-close" aria-label="閉じる" id="messageCloseBtn"></button>
          </div>
        </div>

        <!-- アクセスガード（暫定：HTML側で操作を無効化） -->
        <div id="accessGuardChecking" class="alert alert-info d-flex align-items-center gap-2 mb-3" role="alert" aria-live="polite" aria-atomic="true">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <div>権限を確認しています。確認が完了するまで操作できません。</div>
        </div>

        <div id="accessGuardDenied" class="d-none mb-4" aria-live="assertive" aria-atomic="true">
          <div class="p-4 border rounded bg-light border-start border-3 border-danger">
            <div class="fw-bold" style="font-size: 1.2rem; line-height: 1.35;">このページはデベロッパー専用です。</div>
            <div class="mt-1 text-secondary">デベロッパー権限が確認できませんでした。ログイン状態、または対象商品の権限（developer / admin）をご確認ください。</div>
            <div class="mt-3 d-flex flex-wrap gap-2">
              <a class="btn btn-outline-secondary" href="/customer.html">ユーザーサポートへ戻る</a>
              <a class="btn btn-danger" href="/customer.html?mode=login">ログインし直す</a>
            </div>
          </div>
        </div>

        <div id="pageMain">

        <!-- ページヘッダー -->
        <div class="mb-4">
          <div class="mb-3 p-3 bg-light border rounded border-start border-3 border-primary">
            <div class="fw-bold" style="font-size: 1.4rem; line-height: 1.35;">承認待ち（new / updated）の意見を確認します。公開意見（visibility=public）の場合は公開内容（public_*）を確定します。</div>
            <div class="mt-1 text-secondary">
              公開表示は public_* を参照します。ユーザーが原文（title/body/part_code 等）を更新しても、公開内容は自動では変わりません。visibility=private の意見は、お客様の希望により公開できません（デベロッパー側 visibility_dev は private 固定）。内容確認と、進捗（status_dev）・公開内容（public_*）の確定のみ行えます。
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <h1 class="mb-1">デベロッパー承認</h1>
              <div class="text-secondary">
                管理対象：<span id="productCount" class="fw-semibold">-</span> 商品 ／ 承認待ち：<span id="pendingTotal" class="fw-semibold">-</span> 件
                <span class="ms-2 small" id="developerBadgeWrap" style="display:none;">
                  <span class="badge bg-success-subtle text-success border border-success-subtle">Developer: <span id="developerRole">-</span></span>
                </span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <button id="btnReload" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> 更新
              </button>
              <button id="btnScrollToDetail" class="btn btn-outline-secondary" disabled>
                <i class="bi bi-box-arrow-in-down"></i> 詳細へ
              </button>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <!-- 左：商品別 承認待ち一覧 -->
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
              <div class="card-body p-4 panel-scroll" id="leftPanelScroll">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                  <div>
                    <div class="h5 m-0">承認待ち一覧（商品別）</div>
                    <div class="text-secondary small">status が new / updated の意見を表示します（public / private を含む）。</div>
                  </div>
                  <div class="text-secondary small" id="leftHint"></div>
                </div>

                <div id="productAccordion" class="accordion">
                  <div class="text-center text-secondary py-4">読み込み中...</div>
                </div>

                <div class="mt-3 text-secondary small">※ 行をクリックすると右側に詳細を表示します。</div>

              </div>
            </div>
          </div>

          <!-- 右：詳細／公開内容編集 -->
          <div class="col-12 col-lg-6">
            <div class="sticky-pane">
              <div class="card shadow-sm">
                <div class="card-body p-4 panel-scroll" id="rightPanelScroll">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                    <div>
                      <div class="h5 m-0">意見詳細</div>
                      <div class="text-secondary small">上段：共通情報／中段：お客様入力（編集不可）／下段：デベロッパー入力（公開内容）</div>
                    </div>
                    <div class="text-secondary small">
                      <span id="detailMeta">未選択</span>
                    </div>
                  </div>

                  <div id="detailEmpty" class="text-secondary">
                    左の一覧から意見を選択してください。
                  </div>

                  <div id="detailWrap" class="d-none">

                    <!-- 中段：お客様入力（読み取り専用） -->
                    <div class="border rounded p-3 mb-3 bg-light">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">お客様の入力（編集不可）</div>
                        <div class="d-flex align-items-center flex-wrap gap-2">
                          <span class="small text-secondary">status：</span><span id="origStatusBadgeWrap">-</span>
                          <span class="small text-secondary ms-2">visibility：</span><span id="origVisibilityBadgeWrap">-</span>
                        </div>
                      </div>

                      <hr class="my-3">

                      <div class="row g-3">
                        <div class="col-12">
                          <div class="small text-secondary">意見タイプ（post_type）</div>
                          <div class="mono" id="origPostTypeText">-</div>
                        </div>
                        <div class="col-12">
                          <div class="small text-secondary">タイトル（原文）</div>
                          <input id="origTitle" class="form-control textarea-readonly" type="text" readonly>
                        </div>

                        <div class="col-12">
                          <div class="small text-secondary">本文（原文）</div>
                          <textarea id="origBody" class="form-control textarea-readonly" rows="12" readonly></textarea>
                        </div>
                      </div>
                    </div>

                    <!-- 上段：共通項目（商品関連） -->
                    <div class="border rounded p-3 mb-3">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">共通項目</div>
                        <div class="small text-secondary" id="commonTopBadges">
                          <span id="commonStatusDevBadgeWrap"></span>
                        </div>
                      </div>

                      <hr class="my-3">

                      <div class="row g-3">
                        <div class="col-6 col-md-4">
                          <div class="small text-secondary">投稿ID</div>
                          <div class="mono" id="commonPostId">-</div>
                        </div>

                        <div class="col-6 col-md-4">
                          <div class="small text-secondary">顧客ID</div>
                          <div class="mono" id="commonCustomerId">-</div>
                        </div>

                        <div class="col-12 col-md-4">
                          <div class="small text-secondary">更新日時</div>
                          <div class="mono" id="commonUpdatedAt">-</div>
                        </div>

                        <div class="col-12 col-md-6">
                          <div class="small text-secondary">商品</div>
                          <div class="mono mb-2" id="detailProductText">-</div>

                          <label class="form-label small text-secondary" for="commonPartSelect">部位（part_code）</label>
                          <div class="input-group input-group-sm">
                            <select id="commonPartSelect" class="form-select form-select-sm">
                              <option value="">読み込み中...</option>
                            </select>
                            <button id="commonPartEditBtn" class="btn btn-outline-secondary" type="button" disabled>変更</button>
                          </div>
                          <div class="char-hint mt-1" id="commonPartHint"></div>
                          <div id="commonPartWarn" class="alert alert-warning py-2 px-3 mt-2 mb-0 d-none" role="alert" aria-live="polite" aria-atomic="true"></div>
                        </div>

                        <div class="col-12 col-md-6" id="commonPartFreeWrap" style="display:none;">
                          <label class="form-label small text-secondary" for="commonPartFreeText">自由入力（part_free_text）</label>
                          <input id="commonPartFreeText" class="form-control form-control-sm textarea-readonly" type="text" readonly>
                        </div>
                      </div>
                    </div>

                    <!-- 下段：デベロッパー入力（公開内容 public_*） -->
                    <div class="border rounded p-3 mb-3">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">デベロッパー入力（公開内容 public_*）</div>
                        <div class="text-secondary small d-flex align-items-center flex-wrap gap-2">
                          <span>進捗（status_dev）：</span>
                          <select id="publishStatus" class="form-select form-select-sm d-inline-block" style="width:auto;">
                            <option value="reviewing">reviewing（検討中）</option>
                            <option value="planned">planned（対応予定）</option>
                            <option value="shipped">shipped（対応済み）</option>
                            <option value="rejected">rejected（不採用）</option>
                          </select>

                          <span class="ms-2">公開（visibility_dev）：</span>
                          <select id="visibilityDev" class="form-select form-select-sm d-inline-block" style="width:auto;">
                            <option value="public">public（公開）</option>
                            <option value="private">private（非公開）</option>
                          </select>
                          <span id="visibilityDevLockHint" class="small text-secondary ms-2 d-none">お客様が非公開希望のため、公開設定は変更できません。</span>
                        </div>
                      </div>

                      <hr class="my-3">

                      <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-2">
                        <div class="char-hint">
                          公開内容（public_*）は自動コピーしません。必要な場合は右のボタンで原文をコピーしてから編集してください。
                        </div>
                        <div>
                          <button id="btnCopyOriginalToPublic" class="btn btn-sm btn-outline-secondary" type="button" disabled>
                            <i class="bi bi-clipboard-plus me-1"></i>原文を公開にコピー
                          </button>
                        </div>
                      </div>

                      <div class="mb-3" id="publicPostTypeWrap" style="display:none;">
                        <label class="form-label" for="publicPostType">タイプ（公開）</label>
                        <select id="publicPostType" class="form-select">
                          <option value="improve">改善</option>
                          <option value="praise">良かった点</option>
                          <option value="guide">ガイド要望</option>
                        </select>
                        <div class="char-hint mt-1">公開表示の分類です（ユーザーの原文タイプとは別管理）。</div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label" for="publicTitle">タイトル（公開）</label>
                        <input id="publicTitle" class="form-control" type="text" maxlength="200" placeholder="公開用タイトル（未入力の場合は空欄のまま）">
                        <div class="d-flex justify-content-end">
                          <div class="char-hint"><span id="publicTitleCount">0</span>/200</div>
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label" for="publicBody">本文（公開）</label>
                        <textarea id="publicBody" class="form-control" rows="16" placeholder="公開用本文（未入力の場合は空欄のまま）"></textarea>
                      </div>
                    </div>

                    <!-- デベロッパー返信（dev_comment） -->
                    <div class="border rounded p-3 mb-3" id="devCommentBlock">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">デベロッパー返信</div>
                        <div class="small text-secondary">お客様への返信メッセージ（dev_comment）</div>
                      </div>

                      <hr class="my-3">

                      <div class="mb-3">
                        <label class="form-label" for="devCommentTemplate">返信テンプレート</label>
                        <select id="devCommentTemplate" class="form-select form-select-sm" disabled>
                          <option value="">（テンプレートを読み込みます）</option>
                        </select>
                        <div class="char-hint mt-1">/dev_reply_message/{developer_customer_id}.txt の各行がテンプレートです（1行=1テンプレート）。</div>
                      </div>

                      <div class="mb-0">
                        <label class="form-label" for="devComment">返信メッセージ</label>
                        <textarea id="devComment" class="form-control" rows="5" placeholder="例：ご意見ありがとうございます。確認のうえ、対応方針をご連絡します。"></textarea>
                        <div class="char-hint mt-1">※ 返信が不要な場合は空欄のまま保存できます。テンプレート選択時は、内容を入れ替えます（追記しません）。</div>
                      </div>
                    </div>

                    <div class="d-flex align-items-center justify-content-end flex-wrap gap-2">
                      <button id="btnPublish" class="btn btn-primary" type="button">
                        <i class="bi bi-check2-circle"></i> 保存して公開
                      </button>
                    </div>

                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>

        </div>

      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/common.js"></script>

  <script>
    // === ユーティリティ ===
    const qs = name => new URL(window.location.href).searchParams.get(name) || '';
    const el = (id) => document.getElementById(id);

    const setGuardState = (state, reason) => {
      const checking = el('accessGuardChecking');
      const denied = el('accessGuardDenied');
      const main = el('pageMain');

      if (state === 'checking') {
        if (checking) checking.classList.remove('d-none');
        if (denied) denied.classList.add('d-none');
        if (main) {
          main.classList.remove('d-none');
          main.classList.add('guard-disabled');
        }
        // 主要ボタンは一旦ロック（権限確認完了後に解除）
        if (el('btnReload')) el('btnReload').disabled = true;
        if (el('btnScrollToDetail')) el('btnScrollToDetail').disabled = true;
        if (el('btnPublish')) el('btnPublish').disabled = true;
        if (el('publishStatus')) el('publishStatus').disabled = true;
        if (el('commonPartEditBtn')) el('commonPartEditBtn').disabled = true;
        if (el('devComment')) el('devComment').disabled = true;
        if (el('devCommentTemplate')) el('devCommentTemplate').disabled = true;
        if (el('btnCopyOriginalToPublic')) el('btnCopyOriginalToPublic').disabled = true;
        return;
      }

      if (state === 'denied') {
        if (checking) checking.classList.add('d-none');
        if (denied) denied.classList.remove('d-none');
        if (main) {
          main.classList.add('d-none');
          main.classList.remove('guard-disabled');
        }
        showAlert('danger', reason || 'デベロッパー権限がありません。');
        if (el('devComment')) el('devComment').disabled = true;
        if (el('devCommentTemplate')) el('devCommentTemplate').disabled = true;
        if (el('btnCopyOriginalToPublic')) el('btnCopyOriginalToPublic').disabled = true;
        return;
      }

      // ok
      if (checking) checking.classList.add('d-none');
      if (denied) denied.classList.add('d-none');
      if (main) {
        main.classList.remove('d-none');
        main.classList.remove('guard-disabled');
      }
      if (el('btnReload')) el('btnReload').disabled = false;
    };


    const escapeHtml = (s) => {
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[c]));
    };

    const fmtDateTime = (iso) => {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return String(iso);
        return d.toLocaleString();
      } catch {
        return String(iso);
      }
    };

    // === メッセージ制御（タイマー禁止）===
    // 要件
    // ・初期メッセージは「初回のみ」。最初の表示更新で消す。
    // ・メッセージは「次の表示更新」まで保持する（時間で消さない）。
    // ・保存後の内部更新（loadDashboard→loadPostDetail 等）では、keepMessage=true で保持する。
    const __msg = {
      isInitial: false,
      hold: false,
    };

    const clearAlert = () => {
      const box = el('messageArea');
      const text = el('messageText');
      if (!box || !text) return;
      box.className = 'alert d-none';
      text.textContent = '';
      __msg.isInitial = false;
      __msg.hold = false;
    };

    const showAlert = (type, msg, opts = {}) => {
      const box = el('messageArea');
      const text = el('messageText');
      if (!box || !text) return;

      const klass = (type === 'success') ? 'alert-success'
                  : (type === 'warning') ? 'alert-warning'
                  : (type === 'info') ? 'alert-info'
                  : 'alert-danger';

      box.className = 'alert ' + klass;
      text.textContent = msg || '';

      __msg.isInitial = !!opts.isInitial;
      __msg.hold = !!opts.hold;

      el('messageCloseBtn')?.addEventListener('click', clearAlert, { once: true });

      // 既存挙動は維持（ジャンプ調査中のため、ここは変えない）
      if (!opts.noScroll) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    };

    // 「表示更新」の開始を宣言する。
    // keepMessage=true の場合は、同一処理内の内部更新とみなし、メッセージを消さない。
    const beginDisplayUpdate = (opts = {}) => {
      const keepMessage = !!opts.keepMessage;
      if (keepMessage) return;

      // 初期メッセージも含めて、表示更新タイミングで消す
      clearAlert();
    };

    const buildBoardUrl = (productCode) => {
      const p = encodeURIComponent(productCode || '');
      return `/feedback_board.html?product_code=${p}`;
    };

    const buildPartsRegistUrl = (productCode) => {
      const p = encodeURIComponent(productCode || '');
      return `/dev_parts_regist.html?product_code=${p}`;
    };

    // CSS.escape の簡易フォールバック（data-* セレクタ用）
    const cssEscape = (s) => {
      try {
        if (window.CSS && typeof CSS.escape === 'function') return CSS.escape(String(s ?? ''));
      } catch (_) {}
      // フォールバック：属性セレクタ（"...")内で安全に使うため、バックスラッシュとダブルクォートだけをエスケープする。
      const str = String(s ?? '');
      const bs = String.fromCharCode(92); // \
      const dq = String.fromCharCode(34); // "
      return str.replaceAll(bs, bs + bs).replaceAll(dq, bs + dq);
    };

    // 値のゆらぎを吸収（古い値・互換値）
    const normalizePostType = (v) => {
      const s = String(v ?? '').toLowerCase().trim();
      if (!s) return '';
      if (s === 'good') return 'praise'; // 互換：user_opinion_manage 側の値
      if (s === 'praise' || s === 'improve' || s === 'guide') return s;
      return '';
    };

    // feedback.html と同じ「その他」値
    const OTHER_PART_VALUE = '__other__';
    const OTHER_PART_LABEL = 'その他（部位が見当たらない）';

    const labelPostTypeJa = (v) => {
      const s = normalizePostType(v);
      if (s === 'improve') return 'improve（改善）';
      if (s === 'praise') return 'praise（良かった点）';
      if (s === 'guide') return 'guide（ガイド要望）';
      return '';
    };

    const normalizeDevStatus = (v) => {
      const s = String(v ?? '').toLowerCase().trim();
      if (!s) return '';
      if (s === 'reviewing' || s === 'planned' || s === 'shipped' || s === 'rejected') return s;
      return '';
    };

    const renderCustomerStatusBadge = (stRaw) => {
      const st = String(stRaw || '').trim();
      const lc = st.toLowerCase();
      let cls = 'text-bg-secondary';
      if (lc === 'new') cls = 'text-bg-warning';
      else if (lc === 'updated') cls = 'text-bg-success';
      else if (lc === 'done') cls = 'text-bg-secondary';
      else if (lc === 'cancel' || lc === 'canceled' || lc === 'cancelled') cls = 'text-bg-danger';
      const label = st ? escapeHtml(st) : '-';
      return `<span class="badge ${cls}">${label}</span>`;
    };

    const renderVisibilityBadge = (visRaw) => {
      const vis = String(visRaw || '').trim();
      const lc = vis.toLowerCase();
      let cls = 'text-bg-secondary';
      if (lc === 'public') cls = 'text-bg-primary';
      else if (lc === 'private') cls = 'text-bg-secondary';
      const label = vis ? escapeHtml(vis) : '-';
      return `<span class="badge ${cls}">${label}</span>`;
    };

    const renderDevStatusBadge = (v) => {
      const s = normalizeDevStatus(v);
      if (!s) return '';
      const label = (s === 'reviewing') ? 'reviewing'
                  : (s === 'planned') ? 'planned'
                  : (s === 'shipped') ? 'shipped'
                  : 'rejected';
      let cls = 'text-bg-secondary';
      if (s === 'reviewing') cls = 'text-bg-info';
      else if (s === 'planned') cls = 'text-bg-primary';
      else if (s === 'shipped') cls = 'text-bg-success';
      else if (s === 'rejected') cls = 'text-bg-danger';
      return `<span class="badge ${cls}">status_dev: ${escapeHtml(label)}</span>`;
    };

    // 保存後：左の一覧（該当行があればその行、無ければ該当 product のヘッダー）へジャンプ
    const scrollToEditedList = (productCode, postId) => {
      const acc = el('productAccordion');
      if (!acc) return;

      let target = null;
      const pid = (postId !== null && postId !== undefined) ? String(postId) : '';
      const pc = String(productCode || '').trim();

      if (pid) {
        target = acc.querySelector(`tr.row-clickable[data-post-id="${cssEscape(pid)}"]`);
      }
      if (!target && pc) {
        target = acc.querySelector(`button.accordion-button[data-product-code="${cssEscape(pc)}"]`);
      }
      if (!target) target = acc;

      try {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (_) {
        // scrollIntoView が失敗しても落とさない
      }
    };

    // 返信テンプレート（/dev_reply_message/{customerid}.txt）
    const replyTemplateCache = new Map(); // customer_id => { path, templates: [] }
    const REPLY_TEMPLATE_DIRS = ['/dev_reply_message', '/repy_message', '/reply_message']; // 互換：ユーザー指定優先 + 誤記揺れ吸収

    const parseReplyTemplates = (txt) => {
      const lf = String.fromCharCode(10);
      const cr = String.fromCharCode(13);
      const lines = String(txt || '').split(lf).map(s => String(s || '').replaceAll(cr, '').trim());
      return lines.filter(s => s && !s.startsWith('#'));
    };

    const loadReplyTemplatesForCustomer = async (customerId) => {
      const cid = String(customerId ?? '').trim();
      if (!cid) return [];

      if (replyTemplateCache.has(cid)) {
        return replyTemplateCache.get(cid).templates || [];
      }

      for (const dir of REPLY_TEMPLATE_DIRS) {
        const url = `${dir}/${encodeURIComponent(cid)}.txt`;
        try {
          const r = await fetch(url, { cache: 'no-cache' });
          if (!r.ok) continue;
          const t = await r.text();
          const templates = parseReplyTemplates(t);
          replyTemplateCache.set(cid, { path: url, templates });
          return templates;
        } catch (_) {
          // ignore
        }
      }

      replyTemplateCache.set(cid, { path: '', templates: [] });
      return [];
    };

    const setDevCommentTemplateSelect = (state, templates) => {
      const sel = el('devCommentTemplate');
      if (!sel) return;

      if (!isDeveloper) {
        sel.innerHTML = '<option value="">（テンプレートはデベロッパーのみ使用できます）</option>';
        sel.disabled = true;
        return;
      }

      if (state === 'loading') {
        sel.innerHTML = '<option value="">読み込み中...</option>';
        sel.disabled = true;
        return;
      }

      const list = Array.isArray(templates) ? templates : [];
      if (!list.length) {
        sel.innerHTML = '<option value="">テンプレートなし</option>';
        sel.disabled = true;
        return;
      }

      let html = '<option value="">テンプレートを選択してください</option>';
      for (let i = 0; i < list.length; i++) {
        const s = String(list[i] || '').trim();
        if (!s) continue;
        const label = (s.length > 80) ? (s.slice(0, 80) + '…') : s;
        html += `<option value="${escapeHtml(s)}">${escapeHtml(label)}</option>`;
      }
      sel.innerHTML = html;
      sel.disabled = false;
      sel.value = '';
    };

    const applyDevCommentTemplate = (tpl) => {
      const ta = el('devComment');
      if (!ta) return;
      const next = String(tpl || '').trim();
      if (!next) return;

      // 要件：テンプレートを再選択したら「入れ替え」。追記はしない。
      ta.value = next;

      try { ta.focus({ preventScroll: true }); } catch (_) {}
    };

    const setupDevCommentTemplatesForSelectedPost = async () => {
      const sel = el('devCommentTemplate');
      if (!sel) return;

      if (!selectedPost) {
        setDevCommentTemplateSelect('empty', []);
        return;
      }

      const cid = loginCustomerId; // テンプレートは投稿者ではなく、ログイン中デベロッパー単位
      if (!cid) {
        setDevCommentTemplateSelect('empty', []);
        return;
      }

      setDevCommentTemplateSelect('loading');
      const templates = await loadReplyTemplatesForCustomer(cid);
      setDevCommentTemplateSelect('ready', templates);
    };

    const fillPublicFromOriginal = () => {
      if (!selectedPost) {
        showAlert('warning', '意見を選択してください。');
        return;
      }

      const ot = el('origTitle');
      const ob = el('origBody');
      const pt = el('origPostTypeText');

      const pubT = el('publicTitle');
      const pubB = el('publicBody');

      if (pubT && ot) pubT.value = String(ot.value || '');
      if (pubB && ob) pubB.value = String(ob.value || '');

      // 公開タイプは「原文の post_type」を可能なら反映（分類の初期化）。未対応なら触らない。
      if (hasPublicPostType) {
        const ptSel = el('publicPostType');
        const raw = (selectedPost.original_post_type || selectedPost.post_type || selectedPost.postType || '');
        const v = normalizePostType(raw);
        if (ptSel && v) ptSel.value = v;
      }

      bindCharCount();
      try { pubT?.focus({ preventScroll: true }); } catch (_) {}
    };

    // === 状態 ===
    const focusProductCode = (qs('product_code') || '').trim(); // 互換：特定商品へフォーカスしたい時のみ使用

    let isDeveloper = false;
    let developerRole = '';
    let loginCustomerId = ''; // ログイン中ユーザー（デベロッパー）の customer_id（返信テンプレートの所有者）

    // dashboard から
    let products = []; // [{product_code, product_name}]
    let pendingByProduct = new Map(); // product_code => pending[]
    let pendingTotal = 0;

    // エンドポイント互換
    let supportsPostDetailById = false;
    let supportsPublishById = false;
    let supportsPublicPostType = false;

    // 詳細
    let selectedPostId = null;
    let selectedProductCode = '';
    let selectedPost = null;
    let hasPublicPostType = false;

    // parts キャッシュ
    const partsCache = new Map(); // product_code => grouped parts

    // === 描画 ===
    const renderHeaderSummary = () => {
      const pc = el('productCount');
      const pt = el('pendingTotal');
      pc && (pc.textContent = String(products.length));
      pt && (pt.textContent = String(pendingTotal));

      const hint = el('leftHint');
      if (hint) {
        if (!products.length) hint.textContent = '';
        else hint.textContent = '商品数：' + String(products.length);
      }

      const wrap = el('developerBadgeWrap');
      if (wrap) {
        if (isDeveloper) {
          wrap.style.display = '';
          el('developerRole') && (el('developerRole').textContent = developerRole || '-');
        } else {
          wrap.style.display = 'none';
        }
      }

      // breadcrumb の「フィードバックボード」は、互換として product_code が付いている時だけ出す
      const bcItem = el('breadcrumbBoardItem');
      const bcLink = el('breadcrumbBoard');
      if (bcItem && bcLink) {
        if (focusProductCode) {
          bcLink.href = buildBoardUrl(focusProductCode);
          bcItem.classList.remove('d-none');
        } else {
          bcItem.classList.add('d-none');
        }
      }
    };

    const renderProducts = () => {
      const acc = el('productAccordion');
      if (!acc) return;

      if (!products.length) {
        acc.innerHTML = '<div class="text-center text-secondary py-4">管理対象の商品がありません。</div>';
        return;
      }

      let html = '';

      for (let i = 0; i < products.length; i++) {
        const p = products[i];
        const code = String(p.product_code || '');
        const name = String(p.product_name || '');
        const items = pendingByProduct.get(code) || [];

        const headingId = 'heading_' + i;
        const collapseId = 'collapse_' + i;

        const pendingCount = items.length;
        const badge = pendingCount
          ? `<span class="badge text-bg-danger ms-2">${pendingCount}</span>`
          : `<span class="badge text-bg-secondary ms-2">0</span>`;

        // 仕様：未承認（>0）は初期表示で展開、0件は非展開。
        // 互換：URLに product_code があれば、その商品も展開。
        const isShow = (pendingCount > 0) || (focusProductCode && focusProductCode === code);
        const expanded = isShow ? 'true' : 'false';
        const showClass = isShow ? 'show' : '';
        const collapsedClass = isShow ? '' : 'collapsed';

        // テーブル
        let bodyHtml = '';
        if (!pendingCount) {
          bodyHtml = '<div class="text-secondary">承認待ちの意見はありません。</div>';
        } else {
          let rows = '';
          for (const it of items) {
            const postId = it.post_id;
            const stRaw = String(it.status || '-');
            const stLc = stRaw.toLowerCase();
            const stLabel = escapeHtml(stRaw);
            let stBadgeClass = 'text-bg-secondary';
            if (stLc === 'new') stBadgeClass = 'text-bg-warning';
            else if (stLc === 'updated') stBadgeClass = 'text-bg-success';
            const stBadge = `<span class="badge ${stBadgeClass} ms-2 align-middle">${stLabel}</span>`;

            const visBadge = renderVisibilityBadge(it.visibility || it.original_visibility || '');

            const title = it.original_title || '';
            const part = it.original_part_code || it.original_part_free_text || '';
            const updatedAt = fmtDateTime(it.updated_at || it.created_at || '');
            const isActive = (selectedPostId && Number(selectedPostId) === Number(postId));

            rows += `
              <tr class="row-clickable ${isActive ? 'table-primary' : ''}" data-post-id="${escapeHtml(postId)}" data-product-code="${escapeHtml(code)}">
                <td class="mono text-nowrap">${escapeHtml(postId)}</td>
                <td>
                  <div class="small text-secondary text-truncate" style="max-width: 26rem;">
                    <span class="mono">${escapeHtml(part)}</span>｜顧客ID: ${escapeHtml(it.customer_id)} <span class="ms-2">${visBadge}</span>
                  </div>
                  <div class="fw-semibold text-truncate" style="max-width: 26rem;">
                    ${escapeHtml(title)}${stBadge}
                  </div>
                </td>
                <td class="col-hide-sm"><span class="text-secondary small">${escapeHtml(updatedAt)}</span></td>
              </tr>
            `;
          }

          bodyHtml = `
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th class="text-nowrap" style="width:4.4rem;">ID</th>
                    <th class="text-center">意見</th>
                    <th class="col-hide-sm text-nowrap" style="width:11.5rem;">更新日時</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          `;
        }

        // 左リスト：product_code → 商品名 → 未承認件数 の順
        const safeName = name ? escapeHtml(name) : '<span class="text-secondary small ms-2">（商品名未設定）</span>';

        html += `
          <div class="accordion-item">
            <h2 class="accordion-header product-acc-header" id="${escapeHtml(headingId)}">
              <button class="accordion-button ${collapsedClass}" type="button" data-product-code="${escapeHtml(code)}" data-bs-toggle="collapse" data-bs-target="#${escapeHtml(collapseId)}" aria-expanded="${expanded}" aria-controls="${escapeHtml(collapseId)}">
                <span class="mono me-2">${escapeHtml(code)}</span>
                <span class="me-2">${safeName}</span>
                ${badge}
              </button>
              <div class="header-actions">
                <a class="btn btn-sm btn-outline-secondary" href="${escapeHtml(buildBoardUrl(code))}" aria-label="フィードバックボードを開く">
                  <i class="bi bi-window-stack me-1"></i>フィードバックボード
                </a>
                <a class="btn btn-sm btn-outline-secondary" href="${escapeHtml(buildPartsRegistUrl(code))}" aria-label="部位管理を開く">
                  <i class="bi bi-tags me-1"></i>部位管理
                </a>
              </div>
            </h2>
            <div id="${escapeHtml(collapseId)}" class="accordion-collapse collapse ${showClass}" aria-labelledby="${escapeHtml(headingId)}">
              <div class="accordion-body">
                ${bodyHtml}
              </div>
            </div>
          </div>
        `;
      }

      acc.innerHTML = html;

      // 行クリック
      acc.querySelectorAll('tr.row-clickable').forEach(tr => {
        tr.addEventListener('click', async () => {
          const postId = tr.getAttribute('data-post-id');
          const pc = tr.getAttribute('data-product-code') || '';
          if (!postId) return;

          // 左側の開閉状態を壊さないため、ここでは一覧を再描画しない（選択行のハイライトだけ更新）
          acc.querySelectorAll('tr.row-clickable.table-primary').forEach(x => x.classList.remove('table-primary'));
          tr.classList.add('table-primary');

          await loadPostDetail(Number(postId), String(pc));
        });
      });
    };

    const bindCharCount = () => {
      const t = el('publicTitle');
      const c = el('publicTitleCount');
      if (!t || !c) return;

      const update = () => {
        c.textContent = String((t.value || '').length);
      };

      if (t.dataset.bound !== '1') {
        t.addEventListener('input', update);
        t.dataset.bound = '1';
      }
      update();
    };

    const buildPartSelectOptionsHtml = (partsGrouped) => {
      if (!partsGrouped || !partsGrouped.length) {
        return `<option value="">部位がありません</option><option value="${escapeHtml(OTHER_PART_VALUE)}">${escapeHtml(OTHER_PART_LABEL)}</option>`;
      }

      let html = '<option value="">部位を選択してください</option>';
      for (const cat of partsGrouped) {
        const label = escapeHtml(cat.category_name || 'その他');
        html += `<optgroup label="${label}">`;
        for (const p of (cat.parts || [])) {
          const code = String(p.part_code || '').trim();
          const name = String(p.part_name_ja || code).trim();
          html += `<option value="${escapeHtml(code)}">${escapeHtml(name)}（${escapeHtml(code)}）</option>`;
        }
        html += '</optgroup>';
      }
      html += `<option value="${escapeHtml(OTHER_PART_VALUE)}">${escapeHtml(OTHER_PART_LABEL)}</option>`;
      return html;
    };

    const fillCommonPartSelectIfNeeded = (productCode) => {
      const sel = el('commonPartSelect');
      if (!sel) return;

      const pc = String(productCode || '').trim();
      const cached = pc ? partsCache.get(pc) : null;

      // product が変わった時だけ options を作り直す
      const samePc = (sel.dataset.productCode === pc);
      const alreadyFilled = (sel.dataset.filled === '1');
      if (samePc && alreadyFilled) return;

      if (!pc) {
        sel.innerHTML = '<option value="">（商品未選択）</option>';
        sel.dataset.productCode = '';
        sel.dataset.filled = '1';
        return;
      }

      if (!cached) {
        sel.innerHTML = '<option value="">読み込み中...</option>';
        sel.dataset.productCode = pc;
        sel.dataset.filled = '0';
        return;
      }

      sel.innerHTML = buildPartSelectOptionsHtml(cached);
      sel.dataset.productCode = pc;
      sel.dataset.filled = '1';
    };

    const applyCommonPartUi = (productCode, partCode, partFreeText) => {
      fillCommonPartSelectIfNeeded(productCode);

      const sel = el('commonPartSelect');
      const btn = el('commonPartEditBtn');
      const hint = el('commonPartHint');
      const freeWrap = el('commonPartFreeWrap');
      const freeInput = el('commonPartFreeText');

      if (hint) hint.textContent = '';
      if (!sel) return;

      const code = String(partCode || '').trim();
      const free = String(partFreeText || '').trim();

      // 元値を保持（変更ボタンや、"その他"表示に利用）
      sel.dataset.origCode = code;
      sel.dataset.origFree = free;

      const optionsReady = (sel.dataset.filled === '1');
      sel.dataset.editing = '0';

      if (btn) {
        btn.style.display = code ? '' : 'none';
        btn.disabled = (!code || !optionsReady);
        btn.textContent = '変更';
        btn.dataset.editing = '0';
      }

      if (code) {
        sel.value = code;
        const matched = (sel.value === code);

        // 初期はロック（ただし「変更」ボタンで解除可能）
        sel.disabled = true;

        if (freeWrap) freeWrap.style.display = 'none';
        if (freeInput) freeInput.value = '';

        if (!matched && hint) {
          hint.textContent = `部位一覧に存在しない部位コードです（${code}）。「変更」で再分類してください。`;
        }
        return;
      }

      // part_code が NULL の場合（feedback.html の「その他」相当）
      sel.value = OTHER_PART_VALUE;
      sel.disabled = false;
      sel.dataset.editing = '1';

      if (btn) {
        btn.style.display = 'none';
        btn.disabled = true;
        btn.textContent = '変更';
        btn.dataset.editing = '0';
      }

      if (freeWrap) freeWrap.style.display = '';
      if (freeInput) freeInput.value = free || '-';
    };

    const setCommonPartWarning = (msg) => {
      const warn = el('commonPartWarn');
      const sel = el('commonPartSelect');

      if (warn) {
        if (msg) {
          warn.textContent = msg;
          warn.classList.remove('d-none');
        } else {
          warn.textContent = '';
          warn.classList.add('d-none');
        }
      }

      if (sel) {
        if (msg) sel.classList.add('is-invalid');
        else sel.classList.remove('is-invalid');
      }
    };

    // 部位（part_code）が「その他/未選択」の場合に、確定処理をHTML側でブロックする（暫定）
    const validateCommonPartGuard = (opts = {}) => {
      const sel = el('commonPartSelect');
      if (!sel || !selectedPost) {
        setCommonPartWarning('');
        return true;
      }

      const optionsReady = (sel.dataset.filled === '1');
      const val = String(sel.value || '').trim();
      const isOther = (!val || val === OTHER_PART_VALUE);

      let ok = true;
      let msg = '';

      if (!optionsReady) {
        ok = false;
        msg = '部位一覧を取得中です。読み込み完了後に部位を選択してください。';
      } else if (isOther) {
        ok = false;
        msg = '部位が「その他」または未選択です。承認して公開する前に、正しい部位を選択してください。必要なら先に「部位管理」で部位を追加してください。';
      }

      setCommonPartWarning(msg);

      const publishBtn = el('btnPublish');
      if (publishBtn) {
        publishBtn.disabled = (!isDeveloper || !ok);
      }

      if (!ok && opts && opts.showAlert) {
        showAlert('warning', msg);
      }

      return ok;
    };

    // 右下ボタン文言は visibility_dev の選択に合わせて表示する
    const updatePublishButtonLabelByVisibility = () => {
      const b = el('btnPublish');
      if (!b) return;
      const v = String(el('visibilityDev')?.value || 'public').trim().toLowerCase();
      if (v === 'private') {
        b.innerHTML = '<i class="bi bi-check2-circle"></i> 公開しないで完了';
      } else {
        b.innerHTML = '<i class="bi bi-check2-circle"></i> 保存して公開';
      }
    };

    const renderDetail = () => {
      const empty = el('detailEmpty');
      const wrap = el('detailWrap');
      const meta = el('detailMeta');
      const btnScroll = el('btnScrollToDetail');

      if (!selectedPost) {
        empty && empty.classList.remove('d-none');
        wrap && wrap.classList.add('d-none');
        meta && (meta.textContent = '未選択');
        btnScroll && (btnScroll.disabled = true);

        // テンプレートUI
        setDevCommentTemplateSelect('empty', []);
        if (el('btnCopyOriginalToPublic')) el('btnCopyOriginalToPublic').disabled = true;

        return;
      }

      empty && empty.classList.add('d-none');
      wrap && wrap.classList.remove('d-none');
      btnScroll && (btnScroll.disabled = false);

      meta && (meta.textContent = `ID: ${selectedPost.post_id} / 顧客ID: ${selectedPost.customer_id}`);

      // 共通：商品情報（最低限 product_code は出す）
      const prodTxt = el('detailProductText');
      const code = String(selectedPost.product_code || selectedProductCode || '');
      const p = products.find(x => String(x.product_code || '') === code);
      const name = p ? String(p.product_name || '') : '';
      prodTxt && (prodTxt.textContent = name ? `${name} / ${code}` : (code || '-'));

      // 共通：post_id / customer_id / updated_at
      el('commonPostId') && (el('commonPostId').textContent = String(selectedPost.post_id ?? '-'));
      el('commonCustomerId') && (el('commonCustomerId').textContent = String(selectedPost.customer_id ?? '-'));
      el('commonUpdatedAt') && (el('commonUpdatedAt').textContent = fmtDateTime(selectedPost.updated_at || selectedPost.created_at || '') || '-');

      // 共通：part_code / part_free_text
      const partCode = String(
        selectedPost.part_code ||
        selectedPost.partCode ||
        selectedPost.original_part_code ||
        ''
      ).trim();
      const partFree = String(
        selectedPost.part_free_text ||
        selectedPost.partFreeText ||
        selectedPost.original_part_free_text ||
        ''
      ).trim();
      applyCommonPartUi(code, partCode, partFree);
      validateCommonPartGuard();

      // お客様側：status / visibility / post_type
      const statusRaw = String(selectedPost.status || '').trim();
      const visRaw = String(selectedPost.visibility || selectedPost.original_visibility || '').trim();
      const postTypeRaw = (selectedPost.original_post_type || selectedPost.post_type || selectedPost.postType || '');

      el('origStatusBadgeWrap') && (el('origStatusBadgeWrap').innerHTML = renderCustomerStatusBadge(statusRaw));
      el('origVisibilityBadgeWrap') && (el('origVisibilityBadgeWrap').innerHTML = renderVisibilityBadge(visRaw));
      el('origPostTypeText') && (el('origPostTypeText').textContent = labelPostTypeJa(postTypeRaw) || (postTypeRaw ? String(postTypeRaw) : '-'));

      // お客様の公開/非公開（visibility）に応じて、デベロッパー側の公開可否（visibility_dev）を制御する。
      const customerVisLc = String(visRaw || '').trim().toLowerCase();
      const isCustomerPublic = (!customerVisLc || customerVisLc === 'public');

      const publishBtn = el('btnPublish');
      if (publishBtn) publishBtn.disabled = (!isDeveloper);

      // 原文→公開コピー
      const copyBtn = el('btnCopyOriginalToPublic');
      if (copyBtn) copyBtn.disabled = !isDeveloper;

      const visDevSel = el('visibilityDev');
      const visDevHint = el('visibilityDevLockHint');
      if (visDevSel) {
        const stDev = normalizeDevStatus(selectedPost.status_dev || selectedPost.statusDev || '');

        if (!isCustomerPublic) {
          visDevSel.value = 'private';
          visDevSel.disabled = true;
          if (visDevHint) visDevHint.classList.remove('d-none');
        } else {
          const initialVisDev = (stDev === 'rejected') ? 'private' : 'public';
          visDevSel.value = initialVisDev;
          visDevSel.disabled = !isDeveloper;
          if (visDevHint) visDevHint.classList.add('d-none');
        }
      }

      // ボタン文言は visibility_dev に合わせて更新
      updatePublishButtonLabelByVisibility();

      // 部位ガード（最終状態を反映）
      validateCommonPartGuard();

      // 原文
      const origTitle = el('origTitle');
      const origBody = el('origBody');
      origTitle && (origTitle.value = String(selectedPost.original_title || selectedPost.title || ''));
      origBody && (origBody.value = String(selectedPost.original_body || selectedPost.body || ''));

      // public_* の入力欄は「自動コピーしない」方針。
      // 既に public_* がある場合のみ表示し、無い場合は空欄で開始する。
      const publicTitle = el('publicTitle');
      const publicBody = el('publicBody');
      publicTitle && (publicTitle.value = String(selectedPost.public_title || selectedPost.publicTitle || ''));
      publicBody && (publicBody.value = String(selectedPost.public_body || selectedPost.publicBody || ''));

      // デベロッパー返信（dev_comment）
      const devComment = el('devComment');
      if (devComment) {
        devComment.value = String(selectedPost.dev_comment || selectedPost.devComment || '');
        devComment.disabled = !isDeveloper;
      }

      // デベロッパー側：status_dev（バッジ＆セレクト）
      const stSel = el('publishStatus');
      if (stSel) {
        const st = normalizeDevStatus(selectedPost.status_dev || selectedPost.statusDev || '');
        stSel.value = st || 'reviewing';
        stSel.disabled = !isDeveloper;
        el('commonStatusDevBadgeWrap') && (el('commonStatusDevBadgeWrap').innerHTML = renderDevStatusBadge(stSel.value));
      }

      const ptWrap = el('publicPostTypeWrap');
      if (ptWrap) {
        ptWrap.style.display = hasPublicPostType ? '' : 'none';
      }

      // タイプ（公開）も「自動コピーしない」方針。
      // public_post_type がある場合のみ採用し、無い場合は improve を初期値とする。
      if (hasPublicPostType) {
        const ptSel = el('publicPostType');
        if (ptSel) {
          const cur = normalizePostType(
            selectedPost.public_post_type ||
            selectedPost.publicPostType ||
            ''
          );
          ptSel.value = cur || 'improve';
          ptSel.disabled = !isDeveloper;
        }
      }

      bindCharCount();
    };

    // === API 呼び出し ===

    const loadDashboard = async (opts = {}) => {
      beginDisplayUpdate({ keepMessage: !!opts.keepMessage });
      setGuardState('checking');

      // 初期表示
      const acc = el('productAccordion');
      acc && (acc.innerHTML = '<div class="text-center text-secondary py-4">読み込み中...</div>');

      try {
        // JWT が無い場合は common.js の挙動に任せる（あれば）
        try {
// 返信テンプレートは「ログイン中デベロッパー単位」なので、JWTから customer_id を抽出して保持する
          if (!loginCustomerId && token) {
            try {
              const parts = String(token).split('.');
              if (parts.length >= 2) {
                const b64 = String(parts[1] || '').replace(/-/g, '+').replace(/_/g, '/');
                const pad = b64 + '==='.slice((b64.length + 3) % 4);
                const json = decodeURIComponent(Array.from(atob(pad), c => '%' + c.charCodeAt(0).toString(16).padStart(2, '0')).join(''));
                const payload = JSON.parse(json);
                const cid = payload.customer_id || payload.customerId || payload.user_id || payload.userId || payload.sub || '';
                if (cid !== null && cid !== undefined && String(cid).trim() !== '') {
                  loginCustomerId = String(cid).trim();
                }
              }
            } catch (_) {}
          }
          if (!token || (typeof ADDEVA.isJwtExpired === 'function' && ADDEVA.isJwtExpired(token))) {
            if (window.ADDEVA && typeof ADDEVA._handleAuthFailure === 'function') {
              ADDEVA._handleAuthFailure('startup: token missing/expired');
              return;
            }
          }
        } catch (_) {}

        const res = await ADDEVA.apiFetch('/api/addeva/dev_approval/dashboard', {
          method: 'POST',
          body: {}
        });

        // capability
        const caps = (res && res.capabilities) ? res.capabilities : {};
        supportsPostDetailById = !!caps.supports_post_detail_by_id;
        supportsPublishById = !!caps.supports_publish_by_id;
        supportsPublicPostType = !!caps.supports_public_post_type;

        // developer
        developerRole = (res && res.role) ? String(res.role) : '';
        isDeveloper = !!(res && (res.is_developer || developerRole));

        // products
        const rawProducts = (res && (res.products || res.developer_products || res.product_list)) ? (res.products || res.developer_products || res.product_list) : [];
        products = (Array.isArray(rawProducts) ? rawProducts : []).map(v => {
          if (typeof v === 'string') {
            return { product_code: v, product_name: '' };
          }
          return {
            product_code: String(v.product_code || v.productCode || ''),
            product_name: String(v.product_name || v.productName || ''),
          };
        }).filter(x => x.product_code);

        // pending
        pendingByProduct = new Map();
        pendingTotal = 0;

        const by = res && (res.pending_by_product_code || res.pendingByProductCode || res.pending_by_product) ? (res.pending_by_product_code || res.pendingByProductCode || res.pending_by_product) : null;
        if (by && typeof by === 'object' && !Array.isArray(by)) {
          Object.keys(by).forEach(code => {
            const arr = Array.isArray(by[code]) ? by[code] : [];
            pendingByProduct.set(String(code), arr);
            pendingTotal += arr.length;
          });
        } else {
          const all = res && (res.pending || res.pending_list || res.pendingList) ? (res.pending || res.pending_list || res.pendingList) : [];
          const arrAll = Array.isArray(all) ? all : [];
          for (const it of arrAll) {
            const code = String(it.product_code || it.productCode || '');
            if (!code) continue;
            if (!pendingByProduct.has(code)) pendingByProduct.set(code, []);
            pendingByProduct.get(code).push(it);
          }
          // total
          pendingByProduct.forEach(v => { pendingTotal += v.length; });
        }

        // products の順序に合わせて、pendingByProduct に無いキーも作っておく
        for (const p of products) {
          const code = String(p.product_code || '');
          if (!pendingByProduct.has(code)) pendingByProduct.set(code, []);
        }

        // 表示
        renderHeaderSummary();
        renderProducts();

        // 権限なし
        if (!isDeveloper) {
          setGuardState('denied', 'デベロッパー権限がありません。');
          el('btnReload') && (el('btnReload').disabled = true);
          el('btnPublish') && (el('btnPublish').disabled = true);
          el('publishStatus') && (el('publishStatus').disabled = true);
          el('visibilityDev') && (el('visibilityDev').disabled = true);
          el('devComment') && (el('devComment').disabled = true);
          el('devCommentTemplate') && (el('devCommentTemplate').disabled = true);
          el('btnCopyOriginalToPublic') && (el('btnCopyOriginalToPublic').disabled = true);
          return;
        }
        // 返信テンプレートは「ログイン中デベロッパー単位」。
        // 初回ロードで先読みし、見つからない場合はここで通知する（編集途中の再読込を避ける）。
        try {
          if (loginCustomerId) {
            await loadReplyTemplatesForCustomer(loginCustomerId);
            const cached = replyTemplateCache.get(String(loginCustomerId));
            if (!cached || !cached.path) {
              showAlert('warning', `返信テンプレートファイルが見つかりません（/dev_reply_message/${loginCustomerId}.txt）。`, { noScroll: true, isInitial: true });
            }
          } else {
            showAlert('warning', '返信テンプレート用のログインIDが取得できませんでした（JWTのcustomer_id等）。', { noScroll: true, isInitial: true });
          }
        } catch (_) {}

      } catch (e) {
        console.error(e);
        isDeveloper = false;
        developerRole = '';
        products = [];
        pendingByProduct = new Map();
        pendingTotal = 0;
        renderHeaderSummary();
        renderProducts();
        setGuardState('denied', e && e.message ? e.message : '承認待ち情報の取得に失敗しました。');
      }
    };

    const loadPartsForProduct = async (productCode) => {
      const pc = String(productCode || '').trim();
      if (!pc) return [];
      if (partsCache.has(pc)) return partsCache.get(pc);

      try {
        const res = await ADDEVA.apiFetch('/api/addeva/feedback/parts/list', {
          method: 'POST',
          body: { productCode: pc, grouped: true }
        });
        const parts = Array.isArray(res) ? res : [];
        partsCache.set(pc, parts);
        return parts;
      } catch (e) {
        console.error(e);
        partsCache.set(pc, []);
        return [];
      }
    };

    const loadPostDetail = async (postId, productCode, opts = {}) => {
      beginDisplayUpdate({ keepMessage: !!(opts && opts.keepMessage) });

      selectedPostId = postId;
      selectedProductCode = String(productCode || '').trim();
      selectedPost = null;
      hasPublicPostType = false;
      renderDetail();

      try {
        let res = null;

        if (supportsPostDetailById) {
          res = await ADDEVA.apiFetch('/api/addeva/dev_approval/post_detail_by_id', {
            method: 'POST',
            body: { postId: Number(postId) }
          });
        }

        if (!res) {
          // 互換：従来ルート
          const pc = String(selectedProductCode || '').trim();
          if (!pc) {
            showAlert('danger', '内部エラー：product_code が取得できません。');
            return;
          }
          res = await ADDEVA.apiFetch('/api/addeva/dev_approval/post_detail', {
            method: 'POST',
            body: { productCode: pc, postId: Number(postId) }
          });
        }

        selectedPost = res || null;
        hasPublicPostType = (selectedPost && selectedPost.capabilities && typeof selectedPost.capabilities.has_public_post_type === 'boolean')
          ? selectedPost.capabilities.has_public_post_type
          : supportsPublicPostType;

        // 共通：部位一覧は常に取得（common パネルの部位Selectに使用）
        {
          const pc = String(selectedPost.product_code || selectedProductCode || '').trim();
          if (pc) await loadPartsForProduct(pc);
        }

        renderDetail();

        // 返信テンプレート
        await setupDevCommentTemplatesForSelectedPost();

        // 選択した意見が右側（編集ボード）に表示されたら、先頭へスクロール
        if (!opts || !opts.skipScrollToDetail) {
          const detailTarget = el('detailWrap') || el('detailEmpty');
          if (detailTarget) {
            detailTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }

        // 編集を始めやすいように、公開タイトルへフォーカス（スクロールは抑止）
        if (!opts || !opts.skipFocus) {
          setTimeout(() => {
            try { el('publicTitle')?.focus({ preventScroll: true }); } catch (_) {}
          }, 0);
        }

      } catch (e) {
        console.error(e);
        selectedPost = null;
        showAlert('danger', e && e.message ? e.message : '意見詳細の取得に失敗しました。');
        renderDetail();
      }
    };

    const doPublish = async () => {
      if (!selectedPost || !selectedPost.post_id) {
        showAlert('warning', '承認対象の意見を選択してください。');
        return;
      }

      const btn = el('btnPublish');
      btn && (btn.disabled = true);

      // 部位が「その他/未選択」の場合は、ここでブロック（暫定：HTML側ガード）
      if (!validateCommonPartGuard({ showAlert: true })) {
        btn && (btn.disabled = false);
        return;
      }

      try {
        const stSel = el('publishStatus');
        const newStatus = stSel ? String(stSel.value || '').trim() : 'reviewing';

        // お客様の公開/非公開（visibility）と、デベロッパー側の指定（visibility_dev）に基づいて visibilityDev を決定する
        const customerVis = String(selectedPost.visibility || selectedPost.original_visibility || '').trim().toLowerCase();
        const isCustomerPublic = (!customerVis || customerVis === 'public');

        // UI選択（public/private）を優先。ただし、お客様が private の場合は必ず private
        let visibilityDev = String(el('visibilityDev') ? el('visibilityDev').value : 'public').trim().toLowerCase();
        visibilityDev = (visibilityDev === 'private') ? 'private' : 'public';
        if (!isCustomerPublic) visibilityDev = 'private';

        // 否認（rejected）の場合は安全側で private に倒す
        if (String(newStatus || '').trim().toLowerCase() === 'rejected') visibilityDev = 'private';

        const publicTitle = el('publicTitle') ? String(el('publicTitle').value || '') : '';
        const publicBody = el('publicBody') ? String(el('publicBody').value || '') : '';
        const devComment = el('devComment') ? String(el('devComment').value || '') : '';

        // 公開タイプ（public_post_type）
        let publicPostType = null;
        if (hasPublicPostType) {
          const ptSel = el('publicPostType');
          const v = normalizePostType(ptSel ? ptSel.value : '');
          publicPostType = v ? v : null;
        }

        // 部位再分類（part_code）: 共通項目の部位選択を part_code に反映する（仕様：newPartCode -> part_code）
        let newPartCodeSpecified = false;
        let newPartCode = null;
        const commonPartSel = el('commonPartSelect');
        if (commonPartSel) {
          const orig = String(commonPartSel.dataset.origCode || '').trim();
          const val = String(commonPartSel.value || '').trim();
          const chosen = (!val || val === OTHER_PART_VALUE) ? '' : val;
          if (orig !== chosen) {
            newPartCodeSpecified = true;
            newPartCode = chosen ? chosen : null;
          }
        }

        // payload を一度作ってから、必要な項目だけ追加（余計な項目を送らないため）
        const payloadBase = {
          publicTitle,
          publicBody,
          devComment,
          newStatus,
          visibilityDev,
        };
        if (publicPostType) payloadBase.publicPostType = publicPostType;
        if (newPartCodeSpecified) payloadBase.newPartCode = newPartCode;

        let res = null;

        if (supportsPublishById) {
          const payload = {
            postId: Number(selectedPost.post_id),
            ...payloadBase,
          };
          res = await ADDEVA.apiFetch('/api/addeva/dev_approval/publish_by_id', {
            method: 'POST',
            body: payload
          });
        }

        if (!res) {
          const pc = String(selectedPost.product_code || selectedProductCode || '').trim();
          if (!pc) {
            showAlert('danger', '内部エラー：product_code が取得できません。');
            return;
          }

          const payload = {
            productCode: pc,
            postId: Number(selectedPost.post_id),
            ...payloadBase,
          };
          res = await ADDEVA.apiFetch('/api/addeva/dev_approval/publish', {
            method: 'POST',
            body: payload
          });
        }

        showAlert('success', `処理が完了しました（ID=${res.post_id}, status=${res.status}, status_dev=${newStatus}, visibility_dev=${visibilityDev}）。`);

        // 一覧を更新
        const keepPostId = Number(selectedPost.post_id);
        const keepProductCode = String(selectedPost.product_code || selectedProductCode || '').trim();

        await loadDashboard({ keepMessage: true });

        // 保存後：左の一覧へジャンプ（該当行が消えている場合は product のヘッダーへ）
        scrollToEditedList(keepProductCode, keepPostId);

        // 詳細も再読込（ただし保存後は一覧側を見たいので、右ペインへの自動スクロール/フォーカスは抑止）
        await loadPostDetail(keepPostId, keepProductCode, { skipScrollToDetail: true, skipFocus: true, keepMessage: true });

      } catch (e) {
        console.error(e);
        showAlert('danger', e && e.message ? e.message : '承認（公開）に失敗しました。');
      } finally {
        btn && (btn.disabled = false);
      }
    };

    // === UI バインド ===
    const bindUI = () => {

      el('btnReload')?.addEventListener('click', async () => {
        await loadDashboard();
      });

      el('btnScrollToDetail')?.addEventListener('click', () => {
        el('detailWrap')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });

      el('btnPublish')?.addEventListener('click', doPublish);

      // 原文→公開コピー
      const copyBtn = el('btnCopyOriginalToPublic');
      if (copyBtn && copyBtn.dataset.bound !== '1') {
        copyBtn.addEventListener('click', () => {
          if (!isDeveloper) return;
          fillPublicFromOriginal();
        });
        copyBtn.dataset.bound = '1';
      }

      // 返信テンプレート選択
      const tplSel = el('devCommentTemplate');
      if (tplSel && tplSel.dataset.bound !== '1') {
        tplSel.addEventListener('change', () => {
          const v = String(tplSel.value || '').trim();
          if (!v) return;
          applyDevCommentTemplate(v);
          tplSel.value = '';
        });
        tplSel.dataset.bound = '1';
      }

      // status_dev を変更したら、上段バッジも追従（見た目の一貫性）
      const stSel = el('publishStatus');
      if (stSel && stSel.dataset.bound !== '1') {
        stSel.addEventListener('change', () => {
          const wrap = el('commonStatusDevBadgeWrap');
          if (wrap) wrap.innerHTML = renderDevStatusBadge(stSel.value);

          // rejected の場合は visibility_dev を private に寄せる（お客様 public の場合のみ）
          const visDevSel = el('visibilityDev');
          const visRaw = String(selectedPost?.visibility || selectedPost?.original_visibility || '').trim().toLowerCase();
          const isCustomerPublic = (!visRaw || visRaw === 'public');
          if (visDevSel && isCustomerPublic && String(stSel.value || '').trim().toLowerCase() === 'rejected') {
            visDevSel.value = 'private';
          }

          // 右下ボタン文言を更新（visibility_dev に追従）
          updatePublishButtonLabelByVisibility();
        });
        stSel.dataset.bound = '1';
      }

      // visibility_dev の変更でもボタン文言を更新
      const visDevSel = el('visibilityDev');
      if (visDevSel && visDevSel.dataset.bound !== '1') {
        visDevSel.addEventListener('change', () => {
          updatePublishButtonLabelByVisibility();
        });
        visDevSel.dataset.bound = '1';
      }

      // Ctrl/Cmd+Enter で承認（公開）
      el('publicBody')?.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          doPublish();
        }
      });

      el('devComment')?.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          doPublish();
        }
      });

      // ログアウト
      const logoutBtn = el('logoutButtonTop');
      if (logoutBtn && logoutBtn.dataset.bound !== '1') {
        logoutBtn.addEventListener('click', () => {
          try {
            if (window.ADDEVA && ADDEVA.LS && ADDEVA.LS.authToken) {
              localStorage.removeItem(ADDEVA.LS.authToken);
            } else {
              localStorage.removeItem('authToken');
            }
          } catch (_) {}
          window.location.href = '/customer.html?mode=login';
        });
        logoutBtn.dataset.bound = '1';
      }

      // 共通：部位（part_code）変更ボタン（ロック解除 → 選び直し）
      const commonPartBtn = el('commonPartEditBtn');
      if (commonPartBtn && commonPartBtn.dataset.bound !== '1') {
        commonPartBtn.addEventListener('click', () => {
          const sel = el('commonPartSelect');
          const btn = el('commonPartEditBtn');
          const hint = el('commonPartHint');
          const freeWrap = el('commonPartFreeWrap');
          const freeInput = el('commonPartFreeText');
          if (!sel || !btn) return;

          const isEditing = (sel.dataset.editing === '1');

          if (!isEditing) {
            // 変更開始（ロック解除）
            sel.disabled = false;
            sel.dataset.editing = '1';
            btn.textContent = 'ロック';
            btn.dataset.editing = '1';
            if (hint) hint.textContent = '部位を選び直してください（変更後は「ロック」で確定します）。';

            // "その他" の場合は自由入力を見せる（読み取り専用）
            if (String(sel.value || '').trim() === OTHER_PART_VALUE) {
              const free = String(sel.dataset.origFree || '').trim();
              if (freeWrap) freeWrap.style.display = '';
              if (freeInput) freeInput.value = free || '-';
            }

            try { sel.focus({ preventScroll: true }); } catch (_) {}
            return;
          }

          // ロック（確定）
          sel.disabled = true;
          sel.dataset.editing = '0';
          btn.textContent = '変更';
          btn.dataset.editing = '0';
          if (hint) hint.textContent = '';
        });
        commonPartBtn.dataset.bound = '1';
      }

      // 変更中に「その他」を選んだ場合は自由入力を表示（読み取り専用）
      const commonPartSel = el('commonPartSelect');
      if (commonPartSel && commonPartSel.dataset.bound !== '1') {
        commonPartSel.addEventListener('change', () => {
          const val = commonPartSel.value;
          const origCode = commonPartSel.dataset.origCode || '';
          const free = commonPartSel.dataset.origFree || '';

          const freeWrap = el('commonPartFreeWrap');
          const freeInput = el('commonPartFreeText');

          if (val === OTHER_PART_VALUE) {
            if (freeWrap) freeWrap.style.display = '';
            if (freeInput) freeInput.value = free || '-';
            return;
          }

          // 元々 "その他" 投稿（origCode 空）なら、再分類後も自由入力は参考として残す
          if (!origCode && free) {
            if (freeWrap) freeWrap.style.display = '';
            if (freeInput) freeInput.value = free || '-';
            return;
          }

          if (freeWrap) freeWrap.style.display = 'none';
          if (freeInput) freeInput.value = '';
        });

        // 既存ハンドラの return 有無に関係なく、毎回ガード判定を更新
        commonPartSel.addEventListener('change', () => { validateCommonPartGuard(); });
        commonPartSel.dataset.bound = '1';
      }
    };

    // === スクロール制御（PC） ===
    const initWheelRouting = () => {
      const leftBox = el('leftPanelScroll');
      const rightBox = el('rightPanelScroll');
      if (!leftBox || !rightBox) return;

      const isDesktop = () => {
        try { return window.matchMedia('(min-width: 992px)').matches; } catch (_) { return window.innerWidth >= 992; }
      };

      const canScroll = (box, deltaY) => {
        if (!box) return false;
        if (box.scrollHeight <= box.clientHeight + 1) return false;
        const atTop = box.scrollTop <= 0;
        const atBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 1;
        if (deltaY < 0) return !atTop;
        if (deltaY > 0) return !atBottom;
        return false;
      };

      document.addEventListener('wheel', (e) => {
        if (!isDesktop()) return;
        if (e.defaultPrevented) return;
        if (e.ctrlKey) return; // pinch-zoom 等

        const target = e.target;
        if (!(target instanceof Element)) return;

        // 入力要素はネイティブ動作を優先（テキストエリア内部スクロール等）
        if (target.closest('textarea, select, input, [contenteditable="true"]')) return;

        const deltaY = Number(e.deltaY || 0);
        if (!deltaY) return;

        let box = null;
        if (target.closest('#rightPanelScroll')) box = rightBox;
        else if (target.closest('#leftPanelScroll')) box = leftBox;
        else return;

        if (canScroll(box, deltaY)) {
          box.scrollTop += deltaY;
          e.preventDefault();
        }
      }, { passive: false, capture: true });
    };

    // === 初期化 ===
    (async () => {
      bindUI();
      setGuardState('checking');
      initWheelRouting();
      await loadDashboard();
      renderDetail();
    })();
  </script>
</body>
</html>
