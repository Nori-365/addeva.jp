<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,nofollow">

  <title>デベロッパー承認｜ADDEVA サポート</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* main.css 側に寄せつつ、承認画面用の最小限だけ補強 */
    #messageArea { overflow-anchor: none; }

    .row-clickable { cursor: pointer; }
    .row-clickable:hover { background: rgba(13,110,253,.04); }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .sticky-pane {
      position: sticky;
      top: 86px; /* fixed header を想定 */
    }

    .textarea-readonly {
      background: #f8f9fa;
    }

    .char-hint { font-size: .85rem; color: #6c757d; }

    @media (max-width: 991.98px) {
      .sticky-pane { position: static; top: auto; }
    }

    /* モバイル：テーブルの情報密度を少し下げる */
    @media (max-width: 767.98px) {
      .col-hide-sm { display: none !important; }
    }

    /* 商品別ブロック */
    .product-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      flex-wrap: wrap;
    }

    .product-title {
      display: flex;
      align-items: baseline;
      gap: .5rem;
      flex-wrap: wrap;
    }

    .product-title .name {
      font-weight: 700;
    }

    .product-actions {
      display: flex;
      align-items: center;
      gap: .5rem;
      flex-wrap: wrap;
    }

    .accordion-button .badge {
      transform: translateY(-1px);
    }

    /* PC：左右ペインを独立スクロールにして、右（編集ボード）上でホイールすると右がスクロールされるようにする */
    @media (min-width: 992px) {
      .panel-scroll {
        max-height: calc(100vh - 140px); /* fixed header + 余白ぶん */
        overflow-y: auto;
        overscroll-behavior: contain;
      }
    }
  </style>
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header fixed-top" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container">

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item"><a href="/customer.html">ユーザーサポート</a></li>
            <li class="breadcrumb-item d-none" id="breadcrumbBoardItem"><a id="breadcrumbBoard" href="#">フィードバックボード</a></li>
            <li class="breadcrumb-item active" aria-current="page">デベロッパー承認</li>
          </ol>
        </nav>

        <!-- 右上アクション（デベロッパー管理＋自分の意見管理＋ログアウト） -->
        <div id="feedbackTopBar" class="d-flex justify-content-end align-items-center gap-2 mb-2">
          <span id="developerButtonTop" class="btn btn-outline-secondary btn-sm disabled" role="button" aria-disabled="true" aria-current="page" tabindex="-1">
            <i class="bi bi-gear me-1"></i>デベロッパー管理
          </span>
          <a id="opinionManageButtonTop" class="btn btn-outline-primary btn-sm" href="/user_opinion_manage.html" role="button">
            <i class="bi bi-card-checklist me-1"></i>自分の意見管理
          </a>
          <button id="logoutButtonTop" class="btn btn-outline-secondary btn-sm" type="button">
            <i class="bi bi-box-arrow-right me-1"></i>ログアウト
          </button>
        </div>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert" aria-live="polite" aria-atomic="true">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div id="messageText" class="flex-grow-1"></div>
            <button type="button" class="btn-close" aria-label="閉じる" id="messageCloseBtn"></button>
          </div>
        </div>

        <!-- ページヘッダー -->
        <div class="mb-4">
          <div class="mb-3 p-3 bg-light border rounded border-start border-3 border-primary">
            <div class="fw-bold" style="font-size: 1.4rem; line-height: 1.35;">承認待ち（new / updated）の意見を確認し、公開内容（public_*）を確定します。</div>
            <div class="mt-1 text-secondary">
              公開表示は public_* を参照します。ユーザーが原文（title/body/part_code 等）を更新しても、公開内容は自動では変わりません。
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <h1 class="mb-1">デベロッパー承認</h1>
              <div class="text-secondary">
                管理対象：<span id="productCount" class="fw-semibold">-</span> 商品 ／ 承認待ち：<span id="pendingTotal" class="fw-semibold">-</span> 件
                <span class="ms-2 small" id="developerBadgeWrap" style="display:none;">
                  <span class="badge bg-success-subtle text-success border border-success-subtle">Developer: <span id="developerRole">-</span></span>
                </span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <a id="btnPartsRegist" class="btn btn-outline-secondary disabled" href="#" role="button" aria-disabled="true">
                <i class="bi bi-tags me-1"></i>部位管理
              </a>
              <button id="btnReload" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> 更新
              </button>
              <button id="btnScrollToDetail" class="btn btn-outline-secondary" disabled>
                <i class="bi bi-box-arrow-in-down"></i> 詳細へ
              </button>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <!-- 左：商品別 承認待ち一覧 -->
          <div class="col-12 col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body p-4 panel-scroll" id="leftPanelScroll">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                  <div>
                    <div class="h5 m-0">承認待ち一覧（商品別）</div>
                    <div class="text-secondary small">status が new / updated の意見のみ表示します。</div>
                  </div>
                  <div class="text-secondary small" id="leftHint"></div>
                </div>

                <div id="productAccordion" class="accordion">
                  <div class="text-center text-secondary py-4">読み込み中...</div>
                </div>

                <div class="mt-3 text-secondary small">※ 行をクリックすると右側に詳細を表示します。</div>

              </div>
            </div>
          </div>

          <!-- 右：詳細／公開内容編集 -->
          <div class="col-12 col-lg-7">
            <div class="sticky-pane">
              <div class="card shadow-sm">
                <div class="card-body p-4 panel-scroll" id="rightPanelScroll">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                    <div>
                      <div class="h5 m-0">意見詳細</div>
                      <div class="text-secondary small">上段：共通情報／中段：お客様入力（編集不可）／下段：デベロッパー入力（公開内容）</div>
                    </div>
                    <div class="text-secondary small">
                      <span id="detailMeta">未選択</span>
                    </div>
                  </div>

                  <div id="detailEmpty" class="text-secondary">
                    左の一覧から意見を選択してください。
                  </div>

                  <div id="detailWrap" class="d-none">

                    <!-- 上段：共通項目（商品関連） -->
                    <div class="border rounded p-3 mb-3">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">共通項目</div>
                        <div class="small text-secondary" id="commonTopBadges">
                          <span id="commonStatusDevBadgeWrap"></span>
                        </div>
                      </div>

                      <hr class="my-3">

                      <div class="row g-3">
                        <div class="col-12">
                          <div class="small text-secondary">商品</div>
                          <div class="mono" id="detailProductText">-</div>
                        </div>

                        <div class="col-6 col-md-4">
                          <div class="small text-secondary">投稿ID</div>
                          <div class="mono" id="commonPostId">-</div>
                        </div>

                        <div class="col-6 col-md-4">
                          <div class="small text-secondary">顧客ID</div>
                          <div class="mono" id="commonCustomerId">-</div>
                        </div>

                        <div class="col-12 col-md-4">
                          <div class="small text-secondary">更新日時</div>
                          <div class="mono" id="commonUpdatedAt">-</div>
                        </div>

                        <div class="col-12 col-md-6">
                          <label class="form-label small text-secondary" for="commonPartSelect">部位（part_code）</label>
                          <div class="input-group input-group-sm">
                            <select id="commonPartSelect" class="form-select form-select-sm">
                              <option value="">読み込み中...</option>
                            </select>
                            <button id="commonPartEditBtn" class="btn btn-outline-secondary" type="button" disabled>変更</button>
                          </div>
                          <div class="char-hint mt-1" id="commonPartHint"></div>
                        </div>

                        <div class="col-12 col-md-6" id="commonPartFreeWrap" style="display:none;">
                          <label class="form-label small text-secondary" for="commonPartFreeText">自由入力（part_free_text）</label>
                          <input id="commonPartFreeText" class="form-control form-control-sm textarea-readonly" type="text" readonly>
                        </div>
                      </div>
                    </div>

                    <!-- 中段：お客様入力（読み取り専用） -->
                    <div class="border rounded p-3 mb-3 bg-light">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">お客様の入力（編集不可）</div>
                        <div class="d-flex align-items-center flex-wrap gap-2">
                          <span class="small text-secondary">status：</span><span id="origStatusBadgeWrap">-</span>
                          <span class="small text-secondary ms-2">visibility：</span><span id="origVisibilityBadgeWrap">-</span>
                        </div>
                      </div>

                      <hr class="my-3">

                      <div class="row g-3">
                        <div class="col-12">
                          <div class="small text-secondary">意見タイプ（post_type）</div>
                          <div class="mono" id="origPostTypeText">-</div>
                        </div>

                        <div class="col-12">
                          <div class="small text-secondary">部位（お客様入力）</div>
                          <div class="mono" id="origPartText">-</div>
                        </div>

                        <div class="col-12">
                          <div class="small text-secondary">タイトル（原文）</div>
                          <input id="origTitle" class="form-control textarea-readonly" type="text" readonly>
                        </div>

                        <div class="col-12">
                          <div class="small text-secondary">本文（原文）</div>
                          <textarea id="origBody" class="form-control textarea-readonly" rows="12" readonly></textarea>
                        </div>
                      </div>
                    </div>

                    <!-- 下段：デベロッパー入力（公開内容 public_*） -->
                    <div class="border rounded p-3">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">デベロッパー入力（公開内容 public_*）</div>
                        <div class="text-secondary small d-flex align-items-center flex-wrap gap-2">
                          <span>進捗（status_dev）：</span>
                          <select id="publishStatus" class="form-select form-select-sm d-inline-block" style="width:auto;">
                            <option value="reviewing">reviewing（検討中）</option>
                            <option value="planned">planned（対応予定）</option>
                            <option value="shipped">shipped（対応済み）</option>
                            <option value="rejected">rejected（不採用）</option>
                          </select>

                          <span class="ms-2">公開可否（visibility_dev）：</span>
                          <select id="visibilityDev" class="form-select form-select-sm d-inline-block" style="width:auto;" disabled>
                            <option value="private">private（非公開）</option>
                            <option value="public">public（公開）</option>
                          </select>
                        </div>
                      </div>

                      <hr class="my-3">

                      <div class="mb-3" id="publicPartWrap" style="display:none;">
                        <label class="form-label" for="publicPartSelect">部位（公開）</label>
                        <select id="publicPartSelect" class="form-select">
                          <option value="">読み込み中...</option>
                        </select>
                        <div class="char-hint mt-1" id="publicPartHint"></div>
                      </div>

                      <div class="mb-3" id="publicPostTypeWrap" style="display:none;">
                        <label class="form-label" for="publicPostType">タイプ（公開）</label>
                        <select id="publicPostType" class="form-select">
                          <option value="improve">改善</option>
                          <option value="praise">良かった点</option>
                          <option value="guide">ガイド要望</option>
                        </select>
                        <div class="char-hint mt-1">公開表示の分類です（ユーザーの原文タイプとは別管理）。</div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label" for="publicTitle">タイトル（公開）</label>
                        <input id="publicTitle" class="form-control" type="text" maxlength="200">
                        <div class="d-flex justify-content-end">
                          <div class="char-hint"><span id="publicTitleCount">0</span>/200</div>
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label" for="publicBody">本文（公開）</label>
                        <textarea id="publicBody" class="form-control" rows="16"></textarea>
                      </div>

                      <div class="d-flex align-items-center justify-content-end flex-wrap gap-2">
                        <button id="btnPublish" class="btn btn-primary" type="button">
                          <i class="bi bi-check2-circle"></i> 承認して公開
                        </button>
                      </div>
                    </div>

                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/common.js"></script>

  <script>
    // === ユーティリティ ===
    const qs = name => new URL(window.location.href).searchParams.get(name) || '';
    const el = (id) => document.getElementById(id);

    const escapeHtml = (s) => {
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[c]));
    };

    const fmtDateTime = (iso) => {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return String(iso);
        return d.toLocaleString();
      } catch {
        return String(iso);
      }
    };

    const clearAlert = () => {
      const box = el('messageArea');
      const text = el('messageText');
      if (!box || !text) return;
      box.className = 'alert d-none';
      text.textContent = '';
    };

    const showAlert = (type, msg) => {
      const box = el('messageArea');
      const text = el('messageText');
      if (!box || !text) return;

      const klass = (type === 'success') ? 'alert-success'
                  : (type === 'warning') ? 'alert-warning'
                  : (type === 'info') ? 'alert-info'
                  : 'alert-danger';

      box.className = 'alert ' + klass;
      text.textContent = msg || '';
      el('messageCloseBtn')?.addEventListener('click', clearAlert, { once: true });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const buildBoardUrl = (productCode) => {
      const p = encodeURIComponent(productCode || '');
      return `/feedback_board.html?product_code=${p}`;
    };

    const buildPartsRegistUrl = (productCode) => {
      const p = encodeURIComponent(productCode || '');
      return `/dev_parts_regist.html?product_code=${p}`;
    };

    const setPartsRegistButton = (productCode) => {
      const a = el('btnPartsRegist');
      if (!a) return;
      const pc = String(productCode || '').trim();
      if (!pc) {
        a.href = '#';
        a.setAttribute('aria-disabled', 'true');
        a.classList.add('disabled');
        return;
      }
      a.href = buildPartsRegistUrl(pc);
      a.setAttribute('aria-disabled', 'false');
      a.classList.remove('disabled');
    };

    // CSS.escape の簡易フォールバック（data-* セレクタ用）
    const cssEscape = (s) => {
      try {
        if (window.CSS && typeof CSS.escape === 'function') return CSS.escape(String(s ?? ''));
      } catch (_) {}
      // フォールバック：属性セレクタ（"...")内で安全に使うため、バックスラッシュとダブルクォートだけをエスケープする。
      const str = String(s ?? '');
      return str
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"');
    };

    // 値のゆらぎを吸収（古い値・互換値）
    const normalizePostType = (v) => {
      const s = String(v ?? '').toLowerCase().trim();
      if (!s) return '';
      if (s === 'good') return 'praise'; // 互換：user_opinion_manage 側の値
      if (s === 'praise' || s === 'improve' || s === 'guide') return s;
      return '';
    };

    // feedback.html と同じ「その他」値
    const OTHER_PART_VALUE = '__other__';
    const OTHER_PART_LABEL = 'その他（部位が見当たらない）';

    const labelPostTypeJa = (v) => {
      const s = normalizePostType(v);
      if (s === 'improve') return 'improve（改善）';
      if (s === 'praise') return 'praise（良かった点）';
      if (s === 'guide') return 'guide（ガイド要望）';
      return '';
    };

    const normalizeDevStatus = (v) => {
      const s = String(v ?? '').toLowerCase().trim();
      if (!s) return '';
      if (s === 'reviewing' || s === 'planned' || s === 'shipped' || s === 'rejected') return s;
      return '';
    };

    const renderCustomerStatusBadge = (stRaw) => {
      const st = String(stRaw || '').trim();
      const lc = st.toLowerCase();
      let cls = 'text-bg-secondary';
      if (lc === 'new') cls = 'text-bg-warning';
      else if (lc === 'updated') cls = 'text-bg-success';
      else if (lc === 'done') cls = 'text-bg-secondary';
      else if (lc === 'cancel' || lc === 'canceled' || lc === 'cancelled') cls = 'text-bg-danger';
      const label = st ? escapeHtml(st) : '-';
      return `<span class="badge ${cls}">${label}</span>`;
    };

    const renderVisibilityBadge = (visRaw) => {
      const vis = String(visRaw || '').trim();
      const lc = vis.toLowerCase();
      let cls = 'text-bg-secondary';
      if (lc === 'public') cls = 'text-bg-primary';
      else if (lc === 'private') cls = 'text-bg-secondary';
      const label = vis ? escapeHtml(vis) : '-';
      return `<span class="badge ${cls}">${label}</span>`;
    };

    const renderDevStatusBadge = (v) => {
      const s = normalizeDevStatus(v);
      if (!s) return '';
      const label = (s === 'reviewing') ? 'reviewing'
                  : (s === 'planned') ? 'planned'
                  : (s === 'shipped') ? 'shipped'
                  : 'rejected';
      let cls = 'text-bg-secondary';
      if (s === 'reviewing') cls = 'text-bg-info';
      else if (s === 'planned') cls = 'text-bg-primary';
      else if (s === 'shipped') cls = 'text-bg-success';
      else if (s === 'rejected') cls = 'text-bg-danger';
      return `<span class="badge ${cls}">status_dev: ${escapeHtml(label)}</span>`;
    };

    // 保存後：左の一覧（該当行があればその行、無ければ該当 product のヘッダー）へジャンプ
    const scrollToEditedList = (productCode, postId) => {
      const acc = el('productAccordion');
      if (!acc) return;

      let target = null;
      const pid = (postId !== null && postId !== undefined) ? String(postId) : '';
      const pc = String(productCode || '').trim();

      if (pid) {
        target = acc.querySelector(`tr.row-clickable[data-post-id="${cssEscape(pid)}"]`);
      }
      if (!target && pc) {
        target = acc.querySelector(`button.accordion-button[data-product-code="${cssEscape(pc)}"]`);
      }
      if (!target) target = acc;

      try {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (_) {
        // scrollIntoView が失敗しても落とさない
      }
    };


    // === 状態 ===
    const focusProductCode = (qs('product_code') || '').trim(); // 互換：特定商品へフォーカスしたい時のみ使用

    let isDeveloper = false;
    let developerRole = '';

    // dashboard から
    let products = []; // [{product_code, product_name}]
    let pendingByProduct = new Map(); // product_code => pending[]
    let pendingTotal = 0;

    // エンドポイント互換
    let supportsPostDetailById = false;
    let supportsPublishById = false;
    let supportsPublicPartCode = false;
    let supportsPublicPostType = false;

    // 詳細
    let selectedPostId = null;
    let selectedProductCode = '';
    let selectedPost = null;
    let hasPublicPartCode = false;
    let hasPublicPostType = false;

    // parts キャッシュ
    const partsCache = new Map(); // product_code => grouped parts

    // === 描画 ===
    const renderHeaderSummary = () => {
      const pc = el('productCount');
      const pt = el('pendingTotal');
      pc && (pc.textContent = String(products.length));
      pt && (pt.textContent = String(pendingTotal));

      const hint = el('leftHint');
      if (hint) {
        if (!products.length) hint.textContent = '';
        else hint.textContent = '商品数：' + String(products.length);
      }

      const wrap = el('developerBadgeWrap');
      if (wrap) {
        if (isDeveloper) {
          wrap.style.display = '';
          el('developerRole') && (el('developerRole').textContent = developerRole || '-');
        } else {
          wrap.style.display = 'none';
        }
      }

      // breadcrumb の「フィードバックボード」は、互換として product_code が付いている時だけ出す
      const bcItem = el('breadcrumbBoardItem');
      const bcLink = el('breadcrumbBoard');
      if (bcItem && bcLink) {
        if (focusProductCode) {
          bcLink.href = buildBoardUrl(focusProductCode);
          bcItem.classList.remove('d-none');
        } else {
          bcItem.classList.add('d-none');
        }
      }
    };

    const renderProducts = () => {
      const acc = el('productAccordion');
      if (!acc) return;

      if (!products.length) {
        acc.innerHTML = '<div class="text-center text-secondary py-4">管理対象の商品がありません。</div>';
        return;
      }

      let html = '';

      for (let i = 0; i < products.length; i++) {
        const p = products[i];
        const code = String(p.product_code || '');
        const name = String(p.product_name || '');
        const items = pendingByProduct.get(code) || [];

        const headingId = 'heading_' + i;
        const collapseId = 'collapse_' + i;

        const pendingCount = items.length;
        const badge = pendingCount
          ? `<span class="badge text-bg-danger ms-2">${pendingCount}</span>`
          : `<span class="badge text-bg-secondary ms-2">0</span>`;

        // 仕様：未承認（>0）は初期表示で展開、0件は非展開。
        // 互換：URLに product_code があれば、その商品も展開。
        const isShow = (pendingCount > 0) || (focusProductCode && focusProductCode === code);
        const expanded = isShow ? 'true' : 'false';
        const showClass = isShow ? 'show' : '';
        const collapsedClass = isShow ? '' : 'collapsed';

        // テーブル
        let bodyHtml = '';
        if (!pendingCount) {
          bodyHtml = '<div class="text-secondary">承認待ちの意見はありません。</div>';
        } else {
          let rows = '';
          for (const it of items) {
            const postId = it.post_id;
            const stRaw = String(it.status || '-');
            const stLc = stRaw.toLowerCase();
            const stLabel = escapeHtml(stRaw);
            let stBadgeClass = 'text-bg-secondary';
            if (stLc === 'new') stBadgeClass = 'text-bg-warning';
            else if (stLc === 'updated') stBadgeClass = 'text-bg-success';
            const stBadge = `<span class="badge ${stBadgeClass} ms-2 align-middle">${stLabel}</span>`;

            const title = it.original_title || '';
            const part = it.original_part_code || it.original_part_free_text || '';
            const updatedAt = fmtDateTime(it.updated_at || it.created_at || '');
            const isActive = (selectedPostId && Number(selectedPostId) === Number(postId));

            rows += `
              <tr class="row-clickable ${isActive ? 'table-primary' : ''}" data-post-id="${escapeHtml(postId)}" data-product-code="${escapeHtml(code)}">
                <td class="mono text-nowrap">${escapeHtml(postId)}</td>
                <td>
                  <div class="small text-secondary text-truncate" style="max-width: 26rem;">
                    <span class="mono">${escapeHtml(part)}</span>｜顧客ID: ${escapeHtml(it.customer_id)}
                  </div>
                  <div class="fw-semibold text-truncate" style="max-width: 26rem;">
                    ${escapeHtml(title)}${stBadge}
                  </div>
                </td>
                <td class="col-hide-sm"><span class="text-secondary small">${escapeHtml(updatedAt)}</span></td>
              </tr>
            `;
          }

          bodyHtml = `
            <div class="product-head mb-2">
              <div class="product-title">
                <span class="name">${escapeHtml(name || code || '-')}</span>
                <span class="badge bg-secondary fw-normal">${escapeHtml(code)}</span>
              </div>
              <div class="product-actions">
                <a class="btn btn-sm btn-outline-secondary" href="${escapeHtml(buildBoardUrl(code))}">フィードバックボード</a>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th class="text-nowrap" style="width:4.4rem;">ID</th>
                    <th class="text-center">意見</th>
                    <th class="col-hide-sm text-nowrap" style="width:11.5rem;">更新日時</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          `;
        }

        // 左リスト：product_code → 商品名 → 未承認件数 の順
        const safeName = name ? escapeHtml(name) : '<span class="text-secondary small ms-2">（商品名未設定）</span>';

        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="${escapeHtml(headingId)}">
              <button class="accordion-button ${collapsedClass}" type="button" data-product-code="${escapeHtml(code)}" data-bs-toggle="collapse" data-bs-target="#${escapeHtml(collapseId)}" aria-expanded="${expanded}" aria-controls="${escapeHtml(collapseId)}">
                <span class="mono me-2">${escapeHtml(code)}</span>
                <span class="me-2">${safeName}</span>
                ${badge}
              </button>
            </h2>
            <div id="${escapeHtml(collapseId)}" class="accordion-collapse collapse ${showClass}" aria-labelledby="${escapeHtml(headingId)}">
              <div class="accordion-body">
                ${bodyHtml}
              </div>
            </div>
          </div>
        `;
      }

      acc.innerHTML = html;

      // 行クリック
      acc.querySelectorAll('tr.row-clickable').forEach(tr => {
        tr.addEventListener('click', async () => {
          const postId = tr.getAttribute('data-post-id');
          const pc = tr.getAttribute('data-product-code') || '';
          if (!postId) return;
          await loadPostDetail(Number(postId), String(pc));
          renderProducts();
        });
      });
    };

    const bindCharCount = () => {
      const t = el('publicTitle');
      const c = el('publicTitleCount');
      if (!t || !c) return;

      const update = () => {
        c.textContent = String((t.value || '').length);
      };
      t.addEventListener('input', update);
      update();
    };

    const buildPartSelectOptionsHtml = (partsGrouped) => {
      if (!partsGrouped || !partsGrouped.length) {
        return `<option value="">部位がありません</option><option value="${escapeHtml(OTHER_PART_VALUE)}">${escapeHtml(OTHER_PART_LABEL)}</option>`;
      }

      let html = '<option value="">部位を選択してください</option>';
      for (const cat of partsGrouped) {
        const label = escapeHtml(cat.category_name || 'その他');
        html += `<optgroup label="${label}">`;
        for (const p of (cat.parts || [])) {
          const code = String(p.part_code || '').trim();
          const name = String(p.part_name_ja || code).trim();
          html += `<option value="${escapeHtml(code)}">${escapeHtml(name)}（${escapeHtml(code)}）</option>`;
        }
        html += '</optgroup>';
      }
      html += `<option value="${escapeHtml(OTHER_PART_VALUE)}">${escapeHtml(OTHER_PART_LABEL)}</option>`;
      return html;
    };

    const fillCommonPartSelectIfNeeded = (productCode) => {
      const sel = el('commonPartSelect');
      if (!sel) return;

      const pc = String(productCode || '').trim();
      const cached = pc ? partsCache.get(pc) : null;

      // product が変わった時だけ options を作り直す
      const samePc = (sel.dataset.productCode === pc);
      const alreadyFilled = (sel.dataset.filled === '1');
      if (samePc && alreadyFilled) return;

      if (!pc) {
        sel.innerHTML = '<option value="">（商品未選択）</option>';
        sel.dataset.productCode = '';
        sel.dataset.filled = '1';
        return;
      }

      if (!cached) {
        sel.innerHTML = '<option value="">読み込み中...</option>';
        sel.dataset.productCode = pc;
        sel.dataset.filled = '0';
        return;
      }

      sel.innerHTML = buildPartSelectOptionsHtml(cached);
      sel.dataset.productCode = pc;
      sel.dataset.filled = '1';
    };

    const applyCommonPartUi = (productCode, partCode, partFreeText) => {
      fillCommonPartSelectIfNeeded(productCode);

      const sel = el('commonPartSelect');
      const btn = el('commonPartEditBtn');
      const hint = el('commonPartHint');
      const freeWrap = el('commonPartFreeWrap');
      const freeInput = el('commonPartFreeText');

      if (hint) hint.textContent = '';
      if (!sel) return;

      const code = String(partCode || '').trim();
      const free = String(partFreeText || '').trim();

      // 元値を保持（変更ボタンや、"その他"表示に利用）
      sel.dataset.origCode = code;
      sel.dataset.origFree = free;

      const optionsReady = (sel.dataset.filled === '1');
      sel.dataset.editing = '0';

      if (btn) {
        btn.style.display = code ? '' : 'none';
        btn.disabled = (!code || !optionsReady);
        btn.textContent = '変更';
        btn.dataset.editing = '0';
      }

      if (code) {
        sel.value = code;
        const matched = (sel.value === code);

        // 初期はロック（ただし「変更」ボタンで解除可能）
        sel.disabled = true;

        if (freeWrap) freeWrap.style.display = 'none';
        if (freeInput) freeInput.value = '';

        if (!matched && hint) {
          hint.textContent = `部位一覧に存在しない部位コードです（${code}）。「変更」で再分類してください。`;
        }
        return;
      }

      // part_code が NULL の場合（feedback.html の「その他」相当）
      sel.value = OTHER_PART_VALUE;
      sel.disabled = false;
      sel.dataset.editing = '1';

      if (btn) {
        btn.style.display = 'none';
        btn.disabled = true;
        btn.textContent = '変更';
        btn.dataset.editing = '0';
      }

      if (freeWrap) freeWrap.style.display = '';
      if (freeInput) freeInput.value = free || '-';
    };

    const renderPartsSelect = (partsGrouped, selectedCode) => {
      const sel = el('publicPartSelect');
      if (!sel) return;

      if (!partsGrouped || !partsGrouped.length) {
        sel.innerHTML = '<option value="">部位がありません</option>';
        return;
      }

      let html = '<option value="">（未選択）</option>';
      for (const cat of partsGrouped) {
        const label = escapeHtml(cat.category_name || 'その他');
        html += `<optgroup label="${label}">`;
        for (const p of (cat.parts || [])) {
          const code = String(p.part_code || '');
          const name = String(p.part_name_ja || code);
          html += `<option value="${escapeHtml(code)}">${escapeHtml(name)} (${escapeHtml(code)})</option>`;
        }
        html += '</optgroup>';
      }

      sel.innerHTML = html;
      if (selectedCode) sel.value = String(selectedCode);

      const hint = el('publicPartHint');
      if (hint) hint.textContent = '';
    };

    const renderDetail = () => {
      const empty = el('detailEmpty');
      const wrap = el('detailWrap');
      const meta = el('detailMeta');
      const btnScroll = el('btnScrollToDetail');

      if (!selectedPost) {
        empty && empty.classList.remove('d-none');
        wrap && wrap.classList.add('d-none');
        meta && (meta.textContent = '未選択');
        btnScroll && (btnScroll.disabled = true);
        return;
      }

      empty && empty.classList.add('d-none');
      wrap && wrap.classList.remove('d-none');
      btnScroll && (btnScroll.disabled = false);

      meta && (meta.textContent = `ID: ${selectedPost.post_id} / 顧客ID: ${selectedPost.customer_id}`);

      // 共通：商品情報（最低限 product_code は出す）
      const prodTxt = el('detailProductText');
      const code = String(selectedPost.product_code || selectedProductCode || '');
      const p = products.find(x => String(x.product_code || '') === code);
      const name = p ? String(p.product_name || '') : '';
      prodTxt && (prodTxt.textContent = name ? `${name} / ${code}` : (code || '-'));

      // 共通：post_id / customer_id / updated_at
      el('commonPostId') && (el('commonPostId').textContent = String(selectedPost.post_id ?? '-'));
      el('commonCustomerId') && (el('commonCustomerId').textContent = String(selectedPost.customer_id ?? '-'));
      el('commonUpdatedAt') && (el('commonUpdatedAt').textContent = fmtDateTime(selectedPost.updated_at || selectedPost.created_at || '') || '-');

      // 共通：part_code / part_free_text（現状はAPI返却名に揺れがあるためフォールバックあり）
      const partCode = String(
        selectedPost.part_code ||
        selectedPost.partCode ||
        selectedPost.original_part_code ||
        ''
      ).trim();
      const partFree = String(
        selectedPost.part_free_text ||
        selectedPost.partFreeText ||
        selectedPost.original_part_free_text ||
        ''
      ).trim();
      applyCommonPartUi(code, partCode, partFree);

      // お客様側：status / visibility / post_type
      const statusRaw = String(selectedPost.status || '').trim();
      const visRaw = String(selectedPost.visibility || selectedPost.original_visibility || '').trim();
      const postTypeRaw = (selectedPost.original_post_type || selectedPost.post_type || selectedPost.postType || '');

      el('origStatusBadgeWrap') && (el('origStatusBadgeWrap').innerHTML = renderCustomerStatusBadge(statusRaw));
      el('origVisibilityBadgeWrap') && (el('origVisibilityBadgeWrap').innerHTML = renderVisibilityBadge(visRaw));
      el('origPostTypeText') && (el('origPostTypeText').textContent = labelPostTypeJa(postTypeRaw) || (postTypeRaw ? String(postTypeRaw) : '-'));

      // お客様入力：部位（表示用）
      const origPartText = el('origPartText');
      const originalPart = selectedPost.original_part_code || selectedPost.original_part_free_text || selectedPost.part_code || selectedPost.part_free_text || '';
      origPartText && (origPartText.textContent = originalPart ? String(originalPart) : '-');

      // 原文
      const origTitle = el('origTitle');
      const origBody = el('origBody');
      origTitle && (origTitle.value = String(selectedPost.original_title || selectedPost.title || ''));
      origBody && (origBody.value = String(selectedPost.original_body || selectedPost.body || ''));

      // public_* の入力欄は、既に値があるならそれ、無いなら原文（フォールバック）を表示
      const publicTitle = el('publicTitle');
      const publicBody = el('publicBody');
      publicTitle && (publicTitle.value = String(selectedPost.effective_public_title || selectedPost.public_title || selectedPost.publicTitle || selectedPost.original_title || selectedPost.title || ''));
      publicBody && (publicBody.value = String(selectedPost.effective_public_body || selectedPost.public_body || selectedPost.publicBody || selectedPost.original_body || selectedPost.body || ''));

      // デベロッパー側：status_dev（バッジ＆セレクト）
      const stSel = el('publishStatus');
      if (stSel) {
        const st = normalizeDevStatus(selectedPost.status_dev || selectedPost.statusDev || '');
        stSel.value = st || 'reviewing';
        el('commonStatusDevBadgeWrap') && (el('commonStatusDevBadgeWrap').innerHTML = renderDevStatusBadge(stSel.value));
      }

      // visibility_dev（今は見た目のみ）
      const visDevSel = el('visibilityDev');
      if (visDevSel) {
        const v = String(selectedPost.visibility_dev || selectedPost.visibilityDev || '').trim().toLowerCase();
        if (v === 'public' || v === 'private') {
          visDevSel.value = v;
        } else {
          visDevSel.value = 'private';
        }
      }

      // public_part_code
      const partWrap = el('publicPartWrap');
      if (partWrap) {
        partWrap.style.display = hasPublicPartCode ? '' : 'none';
      }

      const ptWrap = el('publicPostTypeWrap');
      if (ptWrap) {
        ptWrap.style.display = hasPublicPostType ? '' : 'none';
      }

      // タイプ（公開）
      if (hasPublicPostType) {
        const ptSel = el('publicPostType');
        if (ptSel) {
          const cur = normalizePostType(
            selectedPost.effective_public_post_type ||
            selectedPost.public_post_type ||
            selectedPost.publicPostType ||
            ''
          );
          const fallback = normalizePostType(
            selectedPost.original_post_type ||
            selectedPost.post_type ||
            selectedPost.postType ||
            ''
          );
          ptSel.value = cur || fallback || 'improve';
        }
      }

      bindCharCount();
    };

    // === API 呼び出し ===
    const loadDashboard = async () => {
      // 初期表示
      const acc = el('productAccordion');
      acc && (acc.innerHTML = '<div class="text-center text-secondary py-4">読み込み中...</div>');

      try {
        // JWT が無い場合は common.js の挙動に任せる（あれば）
        try {
          const token = (window.ADDEVA && ADDEVA.LS && ADDEVA.LS.authToken) ? (localStorage.getItem(ADDEVA.LS.authToken) || '') : '';
          if (!token || (typeof ADDEVA.isJwtExpired === 'function' && ADDEVA.isJwtExpired(token))) {
            if (window.ADDEVA && typeof ADDEVA._handleAuthFailure === 'function') {
              ADDEVA._handleAuthFailure('startup: token missing/expired');
              return;
            }
          }
        } catch (_) {}

        const res = await ADDEVA.apiFetch('/api/addeva/dev_approval/dashboard', {
          method: 'POST',
          body: {}
        });

        // capability
        const caps = (res && res.capabilities) ? res.capabilities : {};
        supportsPostDetailById = !!caps.supports_post_detail_by_id;
        supportsPublishById = !!caps.supports_publish_by_id;
        supportsPublicPartCode = !!caps.supports_public_part_code;
        supportsPublicPostType = !!caps.supports_public_post_type;

        // developer
        developerRole = (res && res.role) ? String(res.role) : '';
        isDeveloper = !!(res && (res.is_developer || developerRole));

        // products
        const rawProducts = (res && (res.products || res.developer_products || res.product_list)) ? (res.products || res.developer_products || res.product_list) : [];
        products = (Array.isArray(rawProducts) ? rawProducts : []).map(v => {
          if (typeof v === 'string') {
            return { product_code: v, product_name: '' };
          }
          return {
            product_code: String(v.product_code || v.productCode || ''),
            product_name: String(v.product_name || v.productName || ''),
          };
        }).filter(x => x.product_code);

        // pending
        pendingByProduct = new Map();
        pendingTotal = 0;

        const by = res && (res.pending_by_product_code || res.pendingByProductCode || res.pending_by_product) ? (res.pending_by_product_code || res.pendingByProductCode || res.pending_by_product) : null;
        if (by && typeof by === 'object' && !Array.isArray(by)) {
          Object.keys(by).forEach(code => {
            const arr = Array.isArray(by[code]) ? by[code] : [];
            pendingByProduct.set(String(code), arr);
            pendingTotal += arr.length;
          });
        } else {
          const all = res && (res.pending || res.pending_list || res.pendingList) ? (res.pending || res.pending_list || res.pendingList) : [];
          const arrAll = Array.isArray(all) ? all : [];
          for (const it of arrAll) {
            const code = String(it.product_code || it.productCode || '');
            if (!code) continue;
            if (!pendingByProduct.has(code)) pendingByProduct.set(code, []);
            pendingByProduct.get(code).push(it);
          }
          // total
          pendingByProduct.forEach(v => { pendingTotal += v.length; });
        }

        // products の順序に合わせて、pendingByProduct に無いキーも作っておく
        for (const p of products) {
          const code = String(p.product_code || '');
          if (!pendingByProduct.has(code)) pendingByProduct.set(code, []);
        }

        // 部位管理ボタン：初期表示でも product_code が決まっているなら有効化する
        if (isDeveloper) {
          const defaultPcForParts = (() => {
            if (focusProductCode) return String(focusProductCode).trim();
            if (selectedProductCode) return String(selectedProductCode).trim();
            // 承認待ちがある商品を優先、それ以外は先頭
            for (const pp of products) {
              const c = String(pp.product_code || '').trim();
              if (!c) continue;
              const arr = pendingByProduct.get(c) || [];
              if (arr.length > 0) return c;
            }
            return (products[0] && products[0].product_code) ? String(products[0].product_code).trim() : '';
          })();
          setPartsRegistButton(defaultPcForParts);
        } else {
          setPartsRegistButton('');
        }

        // 表示
        renderHeaderSummary();
        renderProducts();

        // 権限なし
        if (!isDeveloper) {
          showAlert('danger', 'デベロッパー権限がありません。');
          el('btnReload') && (el('btnReload').disabled = true);
          el('btnPublish') && (el('btnPublish').disabled = true);
          return;
        }

      } catch (e) {
        console.error(e);
        isDeveloper = false;
        developerRole = '';
        products = [];
        pendingByProduct = new Map();
        pendingTotal = 0;
        setPartsRegistButton('');
        renderHeaderSummary();
        renderProducts();
        showAlert('danger', e && e.message ? e.message : '承認待ち情報の取得に失敗しました。');
      }
    };

    const loadPartsForProduct = async (productCode) => {
      const pc = String(productCode || '').trim();
      if (!pc) return [];
      if (partsCache.has(pc)) return partsCache.get(pc);

      try {
        const res = await ADDEVA.apiFetch('/api/addeva/feedback/parts/list', {
          method: 'POST',
          body: { productCode: pc, grouped: true }
        });
        const parts = Array.isArray(res) ? res : [];
        partsCache.set(pc, parts);
        return parts;
      } catch (e) {
        console.error(e);
        partsCache.set(pc, []);
        return [];
      }
    };

    const loadPostDetail = async (postId, productCode, opts = {}) => {
      selectedPostId = postId;
      selectedProductCode = String(productCode || '').trim();
      setPartsRegistButton(selectedProductCode || focusProductCode);
      selectedPost = null;
      hasPublicPartCode = false;
      renderDetail();

      try {
        let res = null;

        if (supportsPostDetailById) {
          res = await ADDEVA.apiFetch('/api/addeva/dev_approval/post_detail_by_id', {
            method: 'POST',
            body: { postId: Number(postId) }
          });
        }

        if (!res) {
          // 互換：従来ルート
          const pc = String(selectedProductCode || '').trim();
          if (!pc) {
            showAlert('danger', '内部エラー：product_code が取得できません。');
            return;
          }
          res = await ADDEVA.apiFetch('/api/addeva/dev_approval/post_detail', {
            method: 'POST',
            body: { productCode: pc, postId: Number(postId) }
          });
        }

        selectedPost = res || null;
        // capabilities は API で返る想定。未提供の場合は dashboard の capability をフォールバックする。
        hasPublicPartCode = (selectedPost && selectedPost.capabilities && typeof selectedPost.capabilities.has_public_part_code === 'boolean')
          ? selectedPost.capabilities.has_public_part_code
          : supportsPublicPartCode;
        hasPublicPostType = (selectedPost && selectedPost.capabilities && typeof selectedPost.capabilities.has_public_post_type === 'boolean')
          ? selectedPost.capabilities.has_public_post_type
          : supportsPublicPostType;

        // 共通：部位一覧は常に取得（common パネルの部位Selectに使用）
        {
          const pc = String(selectedPost.product_code || selectedProductCode || '').trim();
          if (pc) await loadPartsForProduct(pc);
        }

        // public_part_code を使うときのみ部位一覧を取得
        if (hasPublicPartCode) {
          const pc = String(selectedPost.product_code || selectedProductCode || '').trim();
          const parts = await loadPartsForProduct(pc);
          const defaultCode = (selectedPost.effective_public_part_code || '').trim();
          renderPartsSelect(parts, defaultCode);
        }

        renderDetail();
        clearAlert();

        // 選択した意見が右側（編集ボード）に表示されたら、先頭へスクロール
        if (!opts || !opts.skipScrollToDetail) {
          const detailTarget = el('detailWrap') || el('detailEmpty');
          if (detailTarget) {
            detailTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }

        // 編集を始めやすいように、公開タイトルへフォーカス（スクロールは抑止）
        if (!opts || !opts.skipFocus) {
          setTimeout(() => {
            try { el('publicTitle')?.focus({ preventScroll: true }); } catch (_) {}
          }, 0);
        }

      } catch (e) {
        console.error(e);
        selectedPost = null;
        hasPublicPartCode = false;
        showAlert('danger', e && e.message ? e.message : '意見詳細の取得に失敗しました。');
        renderDetail();
      }
    };

    const doPublish = async () => {
      if (!selectedPost || !selectedPost.post_id) {
        showAlert('warning', '承認対象の意見を選択してください。');
        return;
      }

      const btn = el('btnPublish');
      btn && (btn.disabled = true);

      try {
        const stSel = el('publishStatus');
        const newStatus = stSel ? String(stSel.value || '').trim() : 'reviewing';

        const publicTitle = el('publicTitle') ? String(el('publicTitle').value || '') : '';
        const publicBody = el('publicBody') ? String(el('publicBody').value || '') : '';

        // 公開タイプ（public_post_type）
        let publicPostType = null;
        if (hasPublicPostType) {
          const ptSel = el('publicPostType');
          const v = normalizePostType(ptSel ? ptSel.value : '');
          publicPostType = v ? v : null;
        }

        // 公開部位（public_part_code）
        let publicPartCode = null;
        if (hasPublicPartCode) {
          const sel = el('publicPartSelect');
          const v = sel ? String(sel.value || '').trim() : '';
          publicPartCode = v ? v : null;

          const originalPartCode = (selectedPost.original_part_code || '').trim();
          const originalFree = (selectedPost.original_part_free_text || '').trim();
          const effective = (selectedPost.effective_public_part_code || '').trim();

          // 原文が「その他（自由入力）」で、公開側の部位が未確定のままは NG
          if (!publicPartCode && !effective && !originalPartCode && originalFree) {
            showAlert('warning', '公開側の部位を選択してください。');
            btn && (btn.disabled = false);
            return;
          }
        }

        // payload を一度作ってから、必要な項目だけ追加（古いAPIで余計な項目を送らないため）
        const payloadBase = {
          publicTitle,
          publicBody,
          publicPartCode,
          newStatus,
        };
        if (publicPostType) payloadBase.publicPostType = publicPostType;

        let res = null;

        if (supportsPublishById) {
          const payload = {
            postId: Number(selectedPost.post_id),
            ...payloadBase,
          };
          res = await ADDEVA.apiFetch('/api/addeva/dev_approval/publish_by_id', {
            method: 'POST',
            body: payload
          });
        }

        if (!res) {
          const pc = String(selectedPost.product_code || selectedProductCode || '').trim();
          if (!pc) {
            showAlert('danger', '内部エラー：product_code が取得できません。');
            return;
          }

          const payload = {
            productCode: pc,
            postId: Number(selectedPost.post_id),
            ...payloadBase,
          };
          res = await ADDEVA.apiFetch('/api/addeva/dev_approval/publish', {
            method: 'POST',
            body: payload
          });
        }

        showAlert('success', `承認して公開しました（ID=${res.post_id}, status=${res.status}）。`);

        // 一覧を更新
        const keepPostId = Number(selectedPost.post_id);
        const keepProductCode = String(selectedPost.product_code || selectedProductCode || '').trim();

        await loadDashboard();

        // 保存後：左の一覧へジャンプ（該当行が消えている場合は product のヘッダーへ）
        scrollToEditedList(keepProductCode, keepPostId);

        // 詳細も再読込（ただし保存後は一覧側を見たいので、右ペインへの自動スクロール/フォーカスは抑止）
        await loadPostDetail(keepPostId, keepProductCode, { skipScrollToDetail: true, skipFocus: true });

      } catch (e) {
        console.error(e);
        showAlert('danger', e && e.message ? e.message : '承認（公開）に失敗しました。');
      } finally {
        btn && (btn.disabled = false);
      }
    };

    // === UI バインド ===
    const bindUI = () => {

      el('btnReload')?.addEventListener('click', async () => {
        clearAlert();
        await loadDashboard();
      });

      el('btnScrollToDetail')?.addEventListener('click', () => {
        el('detailWrap')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });

      el('btnPublish')?.addEventListener('click', doPublish);

      // Ctrl/Cmd+Enter で承認（公開）
      el('publicBody')?.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          doPublish();
        }
      });

      // ログアウト
      const logoutBtn = el('logoutButtonTop');
      if (logoutBtn && logoutBtn.dataset.bound !== '1') {
        logoutBtn.addEventListener('click', () => {
          try {
            if (window.ADDEVA && ADDEVA.LS && ADDEVA.LS.authToken) {
              localStorage.removeItem(ADDEVA.LS.authToken);
            } else {
              localStorage.removeItem('authToken');
            }
          } catch (_) {}
          window.location.href = '/customer.html?mode=login';
        });
        logoutBtn.dataset.bound = '1';
      }

      // 部位管理ボタン（初期状態）
      setPartsRegistButton(selectedProductCode || focusProductCode);

      // 共通：部位（part_code）変更ボタン（ロック解除 → 選び直し）
      const commonPartBtn = el('commonPartEditBtn');
      if (commonPartBtn && commonPartBtn.dataset.bound !== '1') {
        commonPartBtn.addEventListener('click', () => {
          const sel = el('commonPartSelect');
          const btn = el('commonPartEditBtn');
          const hint = el('commonPartHint');
          const freeWrap = el('commonPartFreeWrap');
          const freeInput = el('commonPartFreeText');
          if (!sel || !btn) return;

          const isEditing = (sel.dataset.editing === '1');

          if (!isEditing) {
            // 変更開始（ロック解除）
            sel.disabled = false;
            sel.dataset.editing = '1';
            btn.textContent = '固定';
            btn.dataset.editing = '1';
            if (hint) hint.textContent = '部位を選び直してください（変更後は「固定」でロックできます）。';

            // "その他" の場合は自由入力を見せる（読み取り専用）
            if (String(sel.value || '').trim() === OTHER_PART_VALUE) {
              const free = String(sel.dataset.origFree || '').trim();
              if (freeWrap) freeWrap.style.display = '';
              if (freeInput) freeInput.value = free || '-';
            }

            try { sel.focus({ preventScroll: true }); } catch (_) {}
            return;
          }

          // 固定（ロック）
          sel.disabled = true;
          sel.dataset.editing = '0';
          btn.textContent = '変更';
          btn.dataset.editing = '0';
          if (hint) hint.textContent = '';
        });
        commonPartBtn.dataset.bound = '1';
      }

      // 変更中に「その他」を選んだ場合は自由入力を表示（読み取り専用）
      const commonPartSel = el('commonPartSelect');
      if (commonPartSel && commonPartSel.dataset.bound !== '1') {
        commonPartSel.addEventListener('change', () => {
          const sel = el('commonPartSelect');
          const freeWrap = el('commonPartFreeWrap');
          const freeInput = el('commonPartFreeText');
          if (!sel) return;

          const val = String(sel.value || '').trim();
          const free = String(sel.dataset.origFree || '').trim();
          const origCode = String(sel.dataset.origCode || '').trim();

          if (val === OTHER_PART_VALUE) {
            if (freeWrap) freeWrap.style.display = '';
            if (freeInput) freeInput.value = free || '-';
            return;
          }

          // 元々 "その他" 投稿（origCode 空）なら、再分類後も自由入力は参考として残す
          if (!origCode && free) {
            if (freeWrap) freeWrap.style.display = '';
            if (freeInput) freeInput.value = free || '-';
            return;
          }

          if (freeWrap) freeWrap.style.display = 'none';
          if (freeInput) freeInput.value = '';
        });
        commonPartSel.dataset.bound = '1';
      }
    };

    // === スクロール制御（PC） ===
    // 目的：右（編集ボード）上でホイール/トラックパッド操作したときに、左の一覧ではなく右ペインが優先的にスクロールされるようにする。
    const initWheelRouting = () => {
      const leftBox = el('leftPanelScroll');
      const rightBox = el('rightPanelScroll');
      if (!leftBox || !rightBox) return;

      const isDesktop = () => {
        try { return window.matchMedia('(min-width: 992px)').matches; } catch (_) { return window.innerWidth >= 992; }
      };

      const canScroll = (box, deltaY) => {
        if (!box) return false;
        if (box.scrollHeight <= box.clientHeight + 1) return false;
        const atTop = box.scrollTop <= 0;
        const atBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 1;
        if (deltaY < 0) return !atTop;
        if (deltaY > 0) return !atBottom;
        return false;
      };

      document.addEventListener('wheel', (e) => {
        if (!isDesktop()) return;
        if (e.defaultPrevented) return;
        if (e.ctrlKey) return; // pinch-zoom 等

        const target = e.target;
        if (!(target instanceof Element)) return;

        // 入力要素はネイティブ動作を優先（テキストエリア内部スクロール等）
        if (target.closest('textarea, select, input, [contenteditable="true"]')) return;

        const deltaY = Number(e.deltaY || 0);
        if (!deltaY) return;

        let box = null;
        if (target.closest('.col-lg-7')) box = rightBox;
        else if (target.closest('.col-lg-5')) box = leftBox;
        else return;

        if (canScroll(box, deltaY)) {
          box.scrollTop += deltaY;
          e.preventDefault();
        }
      }, { passive: false, capture: true });
    };

    // === 初期化 ===
    (async () => {
      bindUI();
      initWheelRouting();
      await loadDashboard();
      renderDetail();
    })();
  </script>
</body>
</html>
