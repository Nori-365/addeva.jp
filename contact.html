<!doctype html>
<html lang="ja">
<head>
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>お問い合わせ | ADDEVA® 公式</title>
  <meta name="description" content="ADDEVAへのお問い合わせフォーム。ご質問・ご相談を受け付けています。">
  <link rel="icon" href="favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/main.css?v=3.5">
  <meta property="og:type" content="website">
  <meta property="og:title" content="お問い合わせ | ADDEVA">
  <meta property="og:description" content="ADDEVAへのお問い合わせフォーム。返信まで最大3日いただく場合があります。">
  <meta property="og:url" content="/contact.html">
  <style>
    .page-hero{padding:64px 0 24px;}
    .form-note{font-size:.95rem;}
  </style>
</head>
<body>
  <!-- 共通ヘッダー（include は維持） -->
  <div data-include="/includes/header.html" aria-busy="true"></div>

  <main>
    <section class="page-hero">
      <div class="container container-narrow">
        <div class="kicker">Contact</div>
        <h1 class="h2 mb-0">お問い合わせ</h1>
      </div>
    </section>

    <section class="section">
      <div class="container container-narrow">
        <p class="text-muted form-note">
          お返事には、<strong>3日</strong> かかる場合もございます。あらかじめご了承ください。<br>
          お問い合わせ前に、<a href="faq.html">よくあるご質問（FAQ）</a>もご覧ください。
        </p>

        <div class="alert alert-success d-none" id="successBox" role="alert" aria-live="polite"></div>
        <div class="alert alert-danger d-none" id="errorBox" role="alert" aria-live="assertive"></div>

        <!-- 送信結果（成功時はフォームを隠して、この結果カードを表示） -->
        <div class="card shadow-sm d-none" id="resultCard" aria-live="polite">
          <div class="card-body p-4">
            <h2 class="h5 mb-3">送信が完了しました</h2>
            <div class="mb-2">受付番号：<strong id="resultTicket">-</strong></div>
            <div class="text-muted small mb-3">※送信控え（自動返信メール）が届いているか必ずご確認ください（迷惑メールフォルダもご確認ください）。</div>
            <div class="border rounded p-3 bg-light" id="resultSummary"></div>
            <div class="mt-3 d-flex flex-column flex-sm-row gap-2">
              <a class="btn btn-outline-dark" href="faq.html">FAQを見る</a>
              <button class="btn btn-dark" type="button" id="resultNewBtn">別の問い合わせを送る</button>
            </div>
          </div>
        </div>

        <div class="card shadow-sm" id="formCard">
          <div class="card-body p-4">
            <form id="contactForm" class="needs-validation" novalidate>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="name" class="form-label">お名前 <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="name" name="name" maxlength="120" autocomplete="name" required>
                  <div class="invalid-feedback">お名前をご入力ください。</div>
                </div>

                <div class="col-md-6">
                  <label for="email" class="form-label">メールアドレス <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" id="email" name="email" maxlength="200" autocomplete="email" inputmode="email" required>
                  <div class="invalid-feedback">正しいメールアドレスをご入力ください。</div>
                </div>

                <div class="col-md-6">
                  <label for="phone" class="form-label">電話番号（任意）</label>
                  <input type="tel" class="form-control" id="phone" name="phone" maxlength="30" autocomplete="tel" inputmode="tel" placeholder="例：09012345678">
                  <div class="form-text">※内容により、お電話したほうが早いと判断した場合は、お電話させていただくことがあります。</div>
                </div>

                <div class="col-md-6">
                  <label for="callTime" class="form-label">ご連絡可能な時間帯（任意）</label>
                  <input type="text" class="form-control" id="callTime" name="callTime" maxlength="120" autocomplete="off" placeholder="例：平日10:00-12:00 / 14:00-18:00">
                </div>

                <div class="col-md-6">
                  <label for="subject" class="form-label">件名 <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="subject" name="subject" maxlength="200" required>
                  <div class="invalid-feedback">件名をご入力ください。</div>
                </div>

                <div class="col-md-6">
                  <label for="orderId" class="form-label">ご注文番号（任意）</label>
                  <input type="text" class="form-control" id="orderId" name="orderId" maxlength="80" autocomplete="off">
                </div>

                <div class="col-12">
                  <label for="message" class="form-label">お問い合わせ内容 <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="message" name="message" rows="6" maxlength="5000" required></textarea>
                  <div class="invalid-feedback">お問い合わせ内容をご入力ください。</div>
                  <div class="form-text">最大5,000文字</div>
                </div>

                <!-- honeypot（人間は入力しない想定） -->
                <div class="d-none" aria-hidden="true">
                  <label for="website" class="form-label">Website</label>
                  <input type="text" class="form-control" id="website" name="website" tabindex="-1" autocomplete="off">
                </div>

                <div class="col-12 d-flex flex-column flex-sm-row gap-2 align-items-start align-items-sm-center mt-2">
                  <button type="submit" class="btn btn-dark" id="submitBtn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="sendSpinner" aria-hidden="true"></span>
                    送信する
                  </button>
                  <div class="text-muted small">※送信控え（自動返信メール）をお送りします。<br>届いているか必ずご確認ください（迷惑メールフォルダもご確認ください）。</div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="mt-4" id="fallbackMail">
          <p class="mb-2 text-muted small">フォーム送信がうまくいかない場合は、メールでも受け付けています。</p>
          <a class="btn btn-outline-dark"
             href="mailto:contact@addeva.jp?subject=%E3%81%8A%E5%95%8F%E3%81%84%E5%90%88%E3%82%8F%E3%81%9B%EF%BC%88ADDEVA%EF%BC%89">
            メールアプリを開く
          </a>
          <p class="mt-2 mb-0">
            送信先「ADDEVA お問い合わせ窓口」：<a href="mailto:contact@addeva.jp">contact@addeva.jp</a>
            <button id="copyBtn" class="btn btn-sm btn-outline-secondary ms-2" type="button">コピー</button>
            <span id="copied" class="text-success small ms-2" style="display:none;">コピーしました</span>
          </p>
        </div>

      </div>
    </section>
  </main>

  <!-- 共通フッター（include は維持） -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/common.js?v=1.0.0"></script>

  <script>
    (async function () {
      // header/footer 読み込み
      const nodes = document.querySelectorAll('[data-include]');
      await Promise.all([...nodes].map(async el => {
        const f = el.getAttribute('data-include');
        const r = await fetch(f, {cache:'no-cache'});
        el.outerHTML = await r.text();
      }));

      // フッターの年号更新がある場合
      const y = document.getElementById('y');
      if (y) y.textContent = new Date().getFullYear();

      // メールコピー
      const btn = document.getElementById('copyBtn');
      const ok = document.getElementById('copied');
      btn?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText('contact@addeva.jp');
          ok.style.display = 'inline';
          setTimeout(()=> ok.style.display='none', 1800);
        } catch(e) {}
      });

      // お問い合わせフォーム送信
      const API_ENDPOINT = '/api/addeva/contact';

      const form = document.getElementById('contactForm');
      const submitBtn = document.getElementById('submitBtn');
      const spinner = document.getElementById('sendSpinner');
      const successBox = document.getElementById('successBox');
      const errorBox = document.getElementById('errorBox');

      // 表示切替（送信結果/フォーム）
      const formCard = document.getElementById('formCard');
      const resultCard = document.getElementById('resultCard');
      const fallbackMail = document.getElementById('fallbackMail');
      const resultTicket = document.getElementById('resultTicket');
      const resultSummary = document.getElementById('resultSummary');
      const resultNewBtn = document.getElementById('resultNewBtn');

      const LS_LAST = 'addeva_contact_last';

      function setView(mode) {
        if (mode === 'result') {
          formCard?.classList.add('d-none');
          resultCard?.classList.remove('d-none');
          // 送信完了画面では「メールでも受付」ブロックは不要
          fallbackMail?.classList.add('d-none');
        } else {
          resultCard?.classList.add('d-none');
          formCard?.classList.remove('d-none');
          // 初期画面/エラー時は表示する
          fallbackMail?.classList.remove('d-none');
        }
      }

      function setUrlStatus(status, ticket) {
        try {
          const u = new URL(location.href);
          if (status) u.searchParams.set('status', status);
          else u.searchParams.delete('status');
          if (ticket) u.searchParams.set('ticket', ticket);
          else u.searchParams.delete('ticket');
          history.replaceState({}, '', u.toString());
        } catch (_e) { /* no-op */ }
      }

      function clearUrlStatus() {
        try {
          const u = new URL(location.href);
          u.searchParams.delete('status');
          u.searchParams.delete('ticket');
          history.replaceState({}, '', u.pathname);
        } catch (_e) { /* no-op */ }
      }

      function saveLast(ticket, payload) {
        try {
          sessionStorage.setItem(LS_LAST, JSON.stringify({ ticket, payload, at: Date.now() }));
        } catch (_e) { /* no-op */ }
      }

      function loadLast(ticket) {
        try {
          const raw = sessionStorage.getItem(LS_LAST);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj || obj.ticket !== ticket) return null;
          return obj;
        } catch (_e) {
          return null;
        }
      }

      function escHtml(s) {
        return String(s || '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      }

      function renderResult(ticket, payload) {
        if (resultTicket) resultTicket.textContent = ticket || '-';

        const p = payload || {};
        const lines = [];

        if (p.name || p.email || p.subject || p.message) {
          lines.push(`<div class="small text-muted mb-2">送信内容</div>`);
          if (p.name)   lines.push(`<div class="mb-1"><strong>お名前</strong>：${escHtml(p.name)}</div>`);
          if (p.email)  lines.push(`<div class="mb-1"><strong>メール</strong>：${escHtml(p.email)}</div>`);
          if (p.phone)  lines.push(`<div class="mb-1"><strong>電話番号</strong>：${escHtml(p.phone)}</div>`);
          if (p.call_time) lines.push(`<div class="mb-1"><strong>ご連絡可能な時間帯</strong>：${escHtml(p.call_time)}</div>`);
          if (p.order_id)  lines.push(`<div class="mb-1"><strong>ご注文番号</strong>：${escHtml(p.order_id)}</div>`);
          if (p.subject)   lines.push(`<div class="mb-2"><strong>件名</strong>：${escHtml(p.subject)}</div>`);
          if (p.message)   lines.push(`<div class="mt-2"><strong>お問い合わせ内容</strong><div class="mt-1" style="white-space:pre-wrap;">${escHtml(p.message)}</div></div>`);
        } else {
          lines.push('<div class="text-muted small">送信内容は、自動返信メール（送信控え）でご確認ください。</div>');
        }

        if (resultSummary) resultSummary.innerHTML = lines.join('');
      }

      // 初期表示: status=success の場合は結果表示へ
      (function initViewByQuery() {
        try {
          const q = new URLSearchParams(location.search);
          const status = (q.get('status') || '').toLowerCase();
          const ticket = (q.get('ticket') || '').trim();
          if (status === 'success' && ticket) {
            const last = loadLast(ticket);
            renderResult(ticket, last ? last.payload : null);
            setView('result');
          } else {
            setView('form');
          }
        } catch (_e) {
          setView('form');
        }
      })();

      // 「別の問い合わせ」を押したらフォームへ戻す
      resultNewBtn?.addEventListener('click', () => {
        hideBox(successBox);
        hideBox(errorBox);
        clearUrlStatus();
        setView('form');
        try {
          form?.reset();
          form?.classList.remove('was-validated');
          document.getElementById('name')?.focus();
        } catch (_e) { /* no-op */ }
      });

      function showBox(el, html) {
        if (!el) return;
        el.innerHTML = html;
        el.classList.remove('d-none');
      }
      function hideBox(el) {
        if (!el) return;
        el.classList.add('d-none');
        el.innerHTML = '';
      }

      form?.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        hideBox(successBox);
        hideBox(errorBox);

        // Bootstrap validation
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        const name = document.getElementById('name')?.value?.trim() || '';
        const email = document.getElementById('email')?.value?.trim() || '';
        const phone = document.getElementById('phone')?.value?.trim() || '';
        const callTime = document.getElementById('callTime')?.value?.trim() || '';
        const subject = document.getElementById('subject')?.value?.trim() || '';
        const orderId = document.getElementById('orderId')?.value?.trim() || '';
        const message = document.getElementById('message')?.value?.trim() || '';
        const website = document.getElementById('website')?.value?.trim() || '';

        // honeypot: 値が入っていたら成功した体で終了（ボット対策）
        if (website) {
          // bot 対策: 表示上は成功に見せる（DB/APIにも送らない）
          renderResult('-', null);
          setUrlStatus('success', '-');
          setView('result');
          try { form.reset(); form.classList.remove('was-validated'); } catch (_e) {}
          return;
        }

        const payload = {
          name,
          email,
          phone,
          call_time: callTime,
          subject,
          order_id: orderId,
          message,
          page_url: location.href
        };

        // UI: sending
        submitBtn?.setAttribute('disabled', 'disabled');
        spinner?.classList.remove('d-none');

        try {
          let data = null;

          // common.js が読み込まれていれば、APIキー付与などを共通処理に任せる
          if (window.ADDEVA && typeof window.ADDEVA.apiFetch === 'function') {
            data = await window.ADDEVA.apiFetch(API_ENDPOINT, { method: 'POST', body: payload });
          } else {
            // フォールバック（x-api-key が必須な構成の場合は common.js を必ず読み込んでください）
            const res = await fetch(API_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            try { data = await res.json(); } catch (_) { data = null; }

            if (!res.ok) {
              const msg = (data && (data.detail || data.message)) ? (data.detail || data.message) : '送信に失敗しました。時間をおいて再度お試しください。';
              throw new Error(msg);
            }
          }

          const ticket = data && (data.ticket_id || data.id || data.reference);
          if (ticket) {
            // 送信内容を「結果画面」に表示（フォームは非表示）
            saveLast(String(ticket), payload);
            renderResult(String(ticket), payload);
            setUrlStatus('success', String(ticket));
            setView('result');
          } else {
            // チケットが返らない場合も結果表示へ
            saveLast('', payload);
            renderResult('-', payload);
            setUrlStatus('success', '-');
            setView('result');
          }

          // 送信後は結果画面へ遷移するため、ここではフォームを見せない（値は保存済み）
          try { form.reset(); } catch (_e) {}
          form?.classList.remove('was-validated');
        } catch (e) {
          const raw = (e && e.message) ? String(e.message) : '';
          // escHtml は上で定義済み
          const detail = raw ? `<div class="small text-muted mt-2">詳細：${esc(raw)}</div>` : '';
          showBox(errorBox, `送信に失敗しました。${detail}<div class="mt-2">お手数ですが、<a href="mailto:contact@addeva.jp">contact@addeva.jp</a> へメールでご連絡ください。</div>`);
          console.error('contact submit failed:', e);
        } finally {
          spinner?.classList.add('d-none');
          submitBtn?.removeAttribute('disabled');
        }
      });
    })();
  </script>
</body>
</html>
