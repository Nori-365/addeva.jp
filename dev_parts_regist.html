<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,nofollow">

  <title>部位コード管理（Developer）｜ADDEVA サポート</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    #messageArea { overflow-anchor: none; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .row-clickable { cursor: pointer; }
    .row-clickable:hover { background: rgba(13,110,253,.04); }

    /* 一覧の表示密度を上げる */
    .table-sm td, .table-sm th { padding-top: .35rem; padding-bottom: .35rem; }

    .row-new td { font-weight: 600; }

    .sticky-pane {
      position: sticky;
      top: 86px; /* fixed header を想定 */
    }

    @media (max-width: 991.98px) {
      .sticky-pane { position: static; top: auto; }
    }

    @media (min-width: 992px) {
      .panel-scroll {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        overscroll-behavior: contain;
      }
    }

    @media (max-width: 767.98px) {
      .col-hide-sm { display: none !important; }
    }

    .badge-inactive {
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(220,53,69,.06);
      color: #dc3545;
    }

    .badge-active {
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(25,135,84,.06);
      color: #198754;
    }

    .compact-label { font-size: .85rem; color: #6c757d; }
  </style>
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header fixed-top" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container">

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item"><a href="/customer.html">ユーザーサポート</a></li>
            <li class="breadcrumb-item"><a id="breadcrumbBoard" href="#">フィードバックボード</a></li>
            <li class="breadcrumb-item"><a id="breadcrumbDevApproval" href="#">デベロッパー承認</a></li>
            <li class="breadcrumb-item active" aria-current="page">部位コード管理</li>
          </ol>
        </nav>

        <!-- 右上アクション（デベロッパー管理＋自分の意見管理＋ログアウト） -->
        <div id="feedbackTopBar" class="d-flex justify-content-end align-items-center gap-2 mb-2">
          <a id="developerButtonTop" class="btn btn-outline-primary btn-sm" href="#" role="button">
            <i class="bi bi-gear me-1"></i>デベロッパー管理
          </a>
          <a id="opinionManageButtonTop" class="btn btn-outline-primary btn-sm" href="/user_opinion_manage.html" role="button">
            <i class="bi bi-card-checklist me-1"></i>自分の意見管理
          </a>
          <button id="logoutButtonTop" class="btn btn-outline-secondary btn-sm" type="button">
            <i class="bi bi-box-arrow-right me-1"></i>ログアウト
          </button>
        </div>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert" aria-live="polite" aria-atomic="true">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div id="messageText" class="flex-grow-1"></div>
            <button type="button" class="btn-close" aria-label="閉じる" id="messageCloseBtn"></button>
          </div>
        </div>

        <!-- ページヘッダー -->
        <div class="mb-4">
          <div class="mb-3 p-3 bg-light border rounded border-start border-3 border-primary">
            <div class="fw-bold" style="font-size: 1.35rem; line-height: 1.35;">部位コード（part_code）を登録・修正できます（Developer）。</div>
            <div class="mt-1 text-secondary">
              ここで登録した部位は、意見入力・投票・承認画面の部位選択に使用されます。
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <h1 class="mb-1">部位コード管理</h1>
              <div class="text-secondary">
                対象商品：<span id="productName" class="fw-semibold">-</span>
                <span class="badge bg-secondary fw-normal ms-2" id="productCodeChip">-</span>
                <span class="ms-2 small" id="developerBadgeWrap" style="display:none;">
                  <span class="badge bg-success-subtle text-success border border-success-subtle">Developer: <span id="developerRole">-</span></span>
                </span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <button id="btnReload" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> 更新
              </button>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <!-- 左：一覧（できるだけ多く表示） -->
          <div class="col-12 col-lg-7">
            <div class="card shadow-sm">
              <div class="card-body p-3 p-md-4 panel-scroll" id="leftPanelScroll">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                  <div>
                    <div class="h5 m-0">部位一覧</div>
                    <div class="text-secondary small">左の一覧をクリックすると右側で編集できます。</div>
                  </div>
                  <div class="text-secondary small">件数：<span id="partsCount">-</span></div>
                </div>

                <div class="input-group input-group-sm mb-2">
                  <span class="input-group-text">検索</span>
                  <input id="searchInput" class="form-control" type="text" placeholder="部位名 / part_code / カテゴリ">
                  <span class="input-group-text">表示</span>
                  <select id="filterActive" class="form-select" style="max-width: 10rem;">
                    <option value="all" selected>すべて</option>
                    <option value="active">有効のみ</option>
                    <option value="inactive">無効のみ</option>
                  </select>
                </div>

                <div class="table-responsive">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead>
                      <tr>
                        <th style="width: 13rem;">カテゴリ</th>
                        <th style="width: 10rem;">part_code</th>
                        <th>部位名</th>
                        <th class="col-hide-sm text-end" style="width: 5rem;">順</th>
                        <th class="text-end" style="width: 5.5rem;">状態</th>
                      </tr>
                    </thead>
                    <tbody id="partsRows">
                      <tr>
                        <td colspan="5" class="text-center text-secondary py-4">読み込み中...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="mt-2 text-secondary small">
                  ※ 一覧の一番下の「新しい部位を登録する」をクリックすると、右側が新規登録モードになります。
                </div>
              </div>
            </div>
          </div>

          <!-- 右：編集（新規／更新） -->
          <div class="col-12 col-lg-5">
            <div class="sticky-pane">
              <div class="card shadow-sm">
                <div class="card-body p-3 p-md-4 panel-scroll" id="rightPanelScroll">
                  <div id="editPanelTop"></div>
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                    <div>
                      <div class="h5 m-0">登録・修正</div>
                      <div class="text-secondary small">part_code は英小文字/数字/_ のみ（3〜32文字）。</div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <div class="text-secondary small" id="editMode">新規登録</div>
                      <button id="btnToNewMode" class="btn btn-outline-secondary btn-sm" type="button" disabled>新規登録へ</button>
                    </div>
                  </div>

                  <form id="partForm" novalidate>
                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label" for="fCategoryName">カテゴリ名</label>
                        <input id="fCategoryName" class="form-control" type="text" maxlength="64" required>
                      </div>

                      <div class="col-12">
                        <label class="form-label" for="fPartCode">part_code</label>
                        <input id="fPartCode" class="form-control mono" type="text" maxlength="32" required placeholder="example_part">
                        <div class="compact-label mt-1">変更すると新規レコードになる場合があります。</div>
                      </div>

                      <div class="col-12">
                        <label class="form-label" for="fPartNameJa">部位名（日本語）</label>
                        <input id="fPartNameJa" class="form-control" type="text" maxlength="64" required>
                      </div>

                      <div class="col-6">
                        <label class="form-label" for="fCategorySort">カテゴリ順</label>
                        <input id="fCategorySort" class="form-control" type="number" min="0" max="1000000" placeholder="1000">
                      </div>

                      <div class="col-6">
                        <label class="form-label" for="fSort">部位順</label>
                        <input id="fSort" class="form-control" type="number" min="0" max="1000000" placeholder="1000">
                      </div>

                      <div class="col-12">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="fIsActive" checked>
                          <label class="form-check-label" for="fIsActive">有効</label>
                        </div>
                      </div>

                      <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <button id="btnReset" class="btn btn-outline-secondary" type="button">フォームをクリア</button>
                        <button id="btnSave" class="btn btn-primary" type="submit">
                          <i class="bi bi-check2-circle"></i> 保存
                        </button>
                      </div>
                    </div>
                  </form>

                  <hr class="my-3">

                  <div class="text-secondary small">
                    ・左の一覧をクリックすると修正モードになります。<br>
                    ・無効化（is_active=false）した部位は、入力UIで非表示にする運用が可能です。
                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/common.js"></script>

  <script>
    // === ユーティリティ ===
    const qs = (name) => new URL(window.location.href).searchParams.get(name) || '';
    const el = (id) => document.getElementById(id);

    const productCode = (qs('product_code') || '').trim();

    const clearAlert = () => {
      const box = el('messageArea');
      const text = el('messageText');
      if (!box || !text) return;
      box.className = 'alert d-none';
      text.textContent = '';
    };

    const showAlert = (type, msg) => {
      const box = el('messageArea');
      const text = el('messageText');
      if (!box || !text) return;

      const klass = (type === 'success') ? 'alert-success'
                  : (type === 'warning') ? 'alert-warning'
                  : (type === 'info') ? 'alert-info'
                  : 'alert-danger';

      box.className = 'alert ' + klass;
      text.textContent = msg || '';
      el('messageCloseBtn')?.addEventListener('click', clearAlert, { once: true });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const escapeHtml = (s) => {
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    };

    const buildBoardUrl = (pc) => `/feedback_board.html?product_code=${encodeURIComponent(pc || '')}`;
    const buildDevApprovalUrl = (pc) => `/dev_approval.html?product_code=${encodeURIComponent(pc || '')}`;

    const isValidPartCode = (s) => /^[a-z0-9_]{3,32}$/.test(String(s || '').trim());

    // モバイル時：編集パネルへジャンプ（固定ヘッダー分のオフセット込み）
    const jumpToEditor = () => {
      try {
        const isMobile = window.matchMedia('(max-width: 991.98px)').matches;
        if (!isMobile) return;

        const target = el('editPanelTop') || el('rightPanelScroll') || el('partForm');
        if (!target) return;

        const y = target.getBoundingClientRect().top + window.pageYOffset - 96;
        window.scrollTo({ top: Math.max(0, y), behavior: 'smooth' });
      } catch (_) {}
    };

    // === 状態 ===
    let isDeveloper = false;
    let developerRole = '';

    // flat list: {category_name, category_sort_order, part_code, part_name_ja, sort_order, is_active}
    let parts = [];

    // 選択中（編集モード）のキー
    let selectedKey = null; // `${category_name}::${part_code}`
    let selectedBefore = { categoryName: '', partCode: '' }; // 変更前キー

    // === API ===
    // 画面に必要な情報をまとめて返す（商品情報＋権限＋部位一覧）
    const loadDashboard = async () => {
      // 初期リンク
      el('productCodeChip') && (el('productCodeChip').textContent = productCode || '-');
      el('breadcrumbBoard') && (el('breadcrumbBoard').href = buildBoardUrl(productCode));
      el('breadcrumbDevApproval') && (el('breadcrumbDevApproval').href = buildDevApprovalUrl(productCode));
      el('developerButtonTop') && (el('developerButtonTop').href = '/dev_approval.html');

      if (!productCode) {
        showAlert('danger', 'product_code が指定されていません。URLに ?product_code=... を付けて開いてください。');
        el('productName') && (el('productName').textContent = '-');
        parts = [];
        renderParts();
        return;
      }

      // 一覧をローディング表示
      const tbody = el('partsRows');
      tbody && (tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary py-4">読み込み中...</td></tr>');

      try {
        const res = await ADDEVA.apiFetch('/api/addeva/dev_parts_regist/dashboard', {
          method: 'POST',
          body: { productCode }
        });

        // 商品
        const prod = (res && res.product) ? res.product : {};
        el('productName') && (el('productName').textContent = String(prod.product_name || prod.productName || '-'));

        // 権限
        isDeveloper = !!(res && (res.is_developer || res.isDeveloper));
        developerRole = String((res && (res.role || res.developer_role || res.developerRole)) || '');

        if (isDeveloper) {
          el('developerRole') && (el('developerRole').textContent = developerRole || '-');
          el('developerBadgeWrap') && (el('developerBadgeWrap').style.display = '');
        } else {
          el('developerBadgeWrap') && (el('developerBadgeWrap').style.display = 'none');
        }

        // 一覧
        const raw = (res && (res.parts || res.part_list || res.partList)) ? (res.parts || res.part_list || res.partList) : [];
        const flat = Array.isArray(raw) ? raw : [];

        parts = flat.map(x => ({
          category_name: String(x.category_name || x.categoryName || ''),
          category_sort_order: (x.category_sort_order ?? x.categorySortOrder ?? 0),
          part_code: String(x.part_code || x.partCode || ''),
          part_name_ja: String(x.part_name_ja || x.partNameJa || ''),
          sort_order: (x.sort_order ?? x.sortOrder ?? 0),
          is_active: (typeof x.is_active === 'boolean') ? x.is_active
                    : (typeof x.isActive === 'boolean') ? x.isActive
                    : true,
        })).filter(x => x.part_code);

        // 表示順：カテゴリ順 → 部位順 → code
        parts.sort((a,b) => {
          const ca = Number(a.category_sort_order || 0), cb = Number(b.category_sort_order || 0);
          if (ca !== cb) return ca - cb;
          const sa = Number(a.sort_order || 0), sb = Number(b.sort_order || 0);
          if (sa !== sb) return sa - sb;
          return String(a.part_code || '').localeCompare(String(b.part_code || ''));
        });

        renderParts();
        clearAlert();

        if (!isDeveloper) {
          showAlert('danger', 'デベロッパー権限がありません。');
          el('btnReload') && (el('btnReload').disabled = true);
          el('btnSave') && (el('btnSave').disabled = true);
          el('btnReset') && (el('btnReset').disabled = true);
          el('btnNewPart') && (el('btnNewPart').disabled = true);
          el('btnToNewMode') && (el('btnToNewMode').disabled = true);
          el('searchInput') && (el('searchInput').disabled = true);
          el('filterActive') && (el('filterActive').disabled = true);
          return;
        }

      } catch (e) {
        console.error(e);
        isDeveloper = false;
        developerRole = '';
        parts = [];
        renderParts();
        showAlert('danger', e && e.message ? e.message : '部位一覧の取得に失敗しました。');
      }
    };

    const upsertPart = async (payload) => {
      return await ADDEVA.apiFetch('/api/addeva/dev_parts_regist/upsert', {
        method: 'POST',
        body: payload,
      });
    };

    // === 描画 ===
    const renderParts = () => {
      const tbody = el('partsRows');
      const countEl = el('partsCount');
      if (!tbody) return;

      const q = String(el('searchInput')?.value || '').trim().toLowerCase();
      const f = String(el('filterActive')?.value || 'all');

      let view = parts;

      if (q) {
        view = view.filter(x => {
          const s = `${x.category_name} ${x.part_code} ${x.part_name_ja}`.toLowerCase();
          return s.includes(q);
        });
      }

      if (f === 'active') view = view.filter(x => !!x.is_active);
      if (f === 'inactive') view = view.filter(x => !x.is_active);

      countEl && (countEl.textContent = String(view.length));

      // 一覧の一番下に「新しい部位を登録する」を出す
      const newRowHtml = isDeveloper
        ? `
          <tr class="row-clickable row-new" id="rowNewPart">
            <td colspan="5">
              <i class="bi bi-plus-circle me-1"></i>新しい部位を登録する
            </td>
          </tr>
        `
        : '';

      let html = '';

      if (!view.length) {
        html += '<tr><td colspan="5" class="text-center text-secondary py-4">該当する部位がありません。</td></tr>';
        html += newRowHtml;
        tbody.innerHTML = html;
      } else {
        for (const x of view) {
          const key = `${x.category_name}::${x.part_code}`;
          const isSel = (selectedKey && selectedKey === key);

          const badge = x.is_active
            ? `<span class="badge badge-active">有効</span>`
            : `<span class="badge badge-inactive">無効</span>`;

          html += `
            <tr class="row-clickable ${isSel ? 'table-primary' : ''}" data-key="${escapeHtml(key)}">
              <td class="text-truncate" style="max-width: 16rem;" title="${escapeHtml(x.category_name)}">
                ${escapeHtml(x.category_name || '-')}
                <div class="text-secondary small">順: ${escapeHtml(x.category_sort_order)}</div>
              </td>
              <td class="mono">${escapeHtml(x.part_code || '')}</td>
              <td class="text-truncate" style="max-width: 24rem;" title="${escapeHtml(x.part_name_ja)}">${escapeHtml(x.part_name_ja || '')}</td>
              <td class="col-hide-sm text-end">${escapeHtml(x.sort_order)}</td>
              <td class="text-end">${badge}</td>
            </tr>
          `;
        }

        html += newRowHtml;
        tbody.innerHTML = html;
      }

      // クリック：編集（部位を選択 → 編集パネルへジャンプ）
      tbody.querySelectorAll('tr.row-clickable[data-key]').forEach(tr => {
        tr.addEventListener('click', () => {
          const key = tr.getAttribute('data-key');
          if (!key) return;
          const [category_name, part_code] = key.split('::');
          const hit = parts.find(p => p.category_name === category_name && p.part_code === part_code);
          if (!hit) return;

          selectedKey = key;
          selectedBefore = { categoryName: String(hit.category_name || ''), partCode: String(hit.part_code || '') };
          fillForm(hit);
          renderParts();
          jumpToEditor();
        });
      });

      // クリック：新規登録（一覧の一番下）
      tbody.querySelector('#rowNewPart')?.addEventListener('click', () => {
        resetForm({ focus: true, scroll: true, jump: true });
      });
    };

    const fillForm = (p) => {
      el('editMode') && (el('editMode').textContent = '修正モード');
      el('btnToNewMode') && (el('btnToNewMode').disabled = false);

      el('fCategoryName') && (el('fCategoryName').value = String(p.category_name || ''));
      el('fPartCode') && (el('fPartCode').value = String(p.part_code || ''));
      el('fPartNameJa') && (el('fPartNameJa').value = String(p.part_name_ja || ''));

      el('fCategorySort') && (el('fCategorySort').value = (p.category_sort_order ?? '') !== null ? String(p.category_sort_order ?? '') : '');
      el('fSort') && (el('fSort').value = (p.sort_order ?? '') !== null ? String(p.sort_order ?? '') : '');
      el('fIsActive') && (el('fIsActive').checked = !!p.is_active);
    };

    const resetForm = (opts = {}) => {
      selectedKey = null;
      selectedBefore = { categoryName: '', partCode: '' };

      el('editMode') && (el('editMode').textContent = '新規登録');
      el('btnToNewMode') && (el('btnToNewMode').disabled = true);

      el('fCategoryName') && (el('fCategoryName').value = '');
      el('fPartCode') && (el('fPartCode').value = '');
      el('fPartNameJa') && (el('fPartNameJa').value = '');
      el('fCategorySort') && (el('fCategorySort').value = '');
      el('fSort') && (el('fSort').value = '');
      el('fIsActive') && (el('fIsActive').checked = true);

      renderParts();

      if (opts && (opts.jump || opts.focus || opts.scroll)) {
        try {
          if (opts.jump) {
            jumpToEditor();
          }
          if (opts.scroll) {
            const rp = el('rightPanelScroll');
            if (rp) rp.scrollTop = 0;
          }
          if (opts.focus) {
            el('fCategoryName')?.focus();
          }
        } catch (_) {}
      }
    };

    // === 操作 ===
    const saveOne = async (ev) => {
      ev && ev.preventDefault && ev.preventDefault();

      if (!productCode) return;
      if (!isDeveloper) {
        showAlert('danger', 'デベロッパー権限がありません。');
        return;
      }

      const btn = el('btnSave');
      btn && (btn.disabled = true);

      try {
        const categoryName = String(el('fCategoryName')?.value || '').trim();
        const partCode = String(el('fPartCode')?.value || '').trim();
        const partNameJa = String(el('fPartNameJa')?.value || '').trim();

        if (!categoryName || !partCode || !partNameJa) {
          showAlert('warning', 'カテゴリ名 / part_code / 部位名（日本語）は必須です。');
          return;
        }

        if (!isValidPartCode(partCode)) {
          showAlert('warning', 'part_code の形式が不正です（英小文字/数字/_ のみ、3〜32文字）。');
          return;
        }

        const payload = {
          productCode,
          categoryName,
          partCode,
          partNameJa,
          isActive: !!el('fIsActive')?.checked,
        };

        const cs = String(el('fCategorySort')?.value || '').trim();
        const so = String(el('fSort')?.value || '').trim();
        if (cs !== '') payload.categorySortOrder = Number(cs);
        if (so !== '') payload.sortOrder = Number(so);

        // 修正モード：キー変更を許容するため、変更前キーを送る（変更がなければ送らない）
        if (selectedBefore.categoryName && selectedBefore.partCode) {
          if (selectedBefore.categoryName !== categoryName || selectedBefore.partCode !== partCode) {
            payload.beforeCategoryName = selectedBefore.categoryName;
            payload.beforePartCode = selectedBefore.partCode;
          }
        }

        await upsertPart(payload);

        showAlert('success', `保存しました（${partCode}）。`);
        await loadDashboard();

        // 保存後：可能なら選択を維持
        const newKey = `${categoryName}::${partCode}`;
        selectedKey = newKey;
        selectedBefore = { categoryName, partCode };
        renderParts();

      } catch (e) {
        console.error(e);
        showAlert('danger', e && e.message ? e.message : '保存に失敗しました。');
      } finally {
        btn && (btn.disabled = false);
      }
    };

    // === UI bind ===
    const bindUI = () => {
      el('btnReload')?.addEventListener('click', async () => {
        clearAlert();
        await loadDashboard();
      });

      el('partForm')?.addEventListener('submit', saveOne);
      el('btnReset')?.addEventListener('click', () => resetForm({ focus: true, scroll: true }));

      // 新規登録
      el('btnNewPart')?.addEventListener('click', () => resetForm({ focus: true, scroll: true }));
      el('btnToNewMode')?.addEventListener('click', () => resetForm({ focus: true, scroll: true, jump: true }));

      el('searchInput')?.addEventListener('input', renderParts);
      el('filterActive')?.addEventListener('change', renderParts);

      // ログアウト
      const logoutBtn = el('logoutButtonTop');
      if (logoutBtn && logoutBtn.dataset.bound !== '1') {
        logoutBtn.addEventListener('click', () => {
          try {
            if (window.ADDEVA && ADDEVA.LS && ADDEVA.LS.authToken) {
              localStorage.removeItem(ADDEVA.LS.authToken);
            } else {
              localStorage.removeItem('authToken');
            }
          } catch (_) {}
          window.location.href = '/customer.html?mode=login';
        });
        logoutBtn.dataset.bound = '1';
      }
    };

    // === 初期化 ===
    (async () => {
      bindUI();
      await loadDashboard();
      resetForm();
    })();
  </script>
</body>
</html>
