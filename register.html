<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary SEO -->
  <title>製品保証登録・アフターサービス｜ADDEVA（アデバ）公式</title>
  <meta name="description" content="ADDEVA製品の保証を有効化するためのご登録ページです。Amazon購入情報をご入力ください。">

  <!-- Canonical -->
  <link rel="canonical" href="https://addeva.jp/register.html">

  <!-- Icons -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Robots -->
  <meta name="robots" content="noindex,nofollow">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.7">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- APIキーをcommon.jsが読み取るためのメタタグ -->
  <!-- .envで設定したAPIキーをここに埋め込んでください -->
  <meta name="x-api-key" content="ADDEVA_API_KEY_c3rITY1LbafHBYaO62tJ4h4nzqQKsEMvXQ7aFRz3Uqk">
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item active" aria-current="page">製品保証登録</li>
          </ol>
        </nav>

        <h1 class="mb-4">製品保証登録・アフターサービス</h1>
        <p class="lead mb-5">ADDEVA UrbanFlex製品をご購入いただきありがとうございます。保証を有効化し、より充実したアフターサービスをご利用いただくため、下記フォームより購入情報をご登録ください。</p>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert"></div>

        <div class="card shadow-sm p-4 mb-5">
          <form id="registrationForm" method="POST" action=""> <!-- actionはJSで制御 -->
            <!-- メールアドレス -->
            <div class="mb-3">
              <label for="email" class="form-label">メールアドレス <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="email" name="email" required placeholder="メールアドレスをご入力ください">
              <div class="form-text">ご登録いただいたメールアドレスは、保証に関するご連絡にのみ利用いたします。</div>
            </div>

            <!-- 商品選択 -->
            <div class="mb-3">
              <label for="productCode" class="form-label">ご購入商品 <span class="text-danger">*</span></label>
              <select class="form-select" id="productCode" name="productCode" required>
                <option value="">商品を選択してください</option>
                <!-- 商品リストはJavaScriptで動的に読み込まれます -->
              </select>
              <div class="form-text">ご購入されたADDEVA製品を選択してください。</div>
            </div>

            <!-- 購入日 -->
            <div class="mb-3">
              <label for="purchaseDate" class="form-label">購入日 <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="purchaseDate" name="purchaseDate" required>
              <div class="form-text">Amazonでのご注文日をご入力ください。</div>
            </div>

            <!-- 購入サイト (Amazon固定) -->
            <div class="mb-3">
              <label for="purchaseSite" class="form-label">購入サイト</label>
              <input type="text" class="form-control" id="purchaseSite" name="purchaseSite" value="Amazon" readonly>
              <div class="form-text">現在、Amazonでのご購入が保証登録の対象となります。</div>
            </div>

            <!-- 注文番号 -->
            <div class="mb-4">
              <label for="orderNumber" class="form-label">Amazon注文番号 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="orderNumber" name="orderNumber" required placeholder="例: 123-1234567-1234567">
              <div id="orderNumberFeedback" class="invalid-feedback">
                Amazonの注文番号形式が正しくありません。（例: 123-1234567-1234567）
              </div>
              <div class="form-text">半角数字とハイフンで構成されるAmazonの注文番号をご入力ください。</div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg w-100">保証を登録する</button>
          </form>
        </div>

        <p class="text-muted small text-center">ご登録いただいた個人情報は、当社の<a href="/privacy-policy/" target="_blank">プライバシーポリシー</a>に基づき厳重に管理いたします。</p>

      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- addeva.jp 専用 common.js を読み込み -->
  <script defer src="/common.js"></script>
  
  <script>
    // ADDEVAオブジェクトがロードされた後に実行されるように待機
    function waitForADDEVA(callback) {
      if (typeof ADDEVA !== 'undefined' && typeof ADDEVA.apiFetch === 'function') {
        callback();
      } else {
        setTimeout(() => waitForADDEVA(callback), 50); // 50msごとにチェック
      }
    }

    waitForADDEVA(async () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('purchaseDate').setAttribute('max', today);

      const orderNumberInput = document.getElementById('orderNumber');
      const amazonOrderPattern = /^\d{3}-\d{7}-\d{7}$/;

      orderNumberInput.addEventListener('input', function() {
        if (amazonOrderPattern.test(this.value)) {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        } else {
          this.classList.add('is-invalid');
          this.classList.remove('is-valid');
        }
      });

      const registrationForm = document.getElementById('registrationForm');
      const messageArea = document.getElementById('messageArea');
      const productCodeSelect = document.getElementById('productCode');

      // ==== 商品リストをAPIから動的に取得する処理 ====
      async function fetchProducts() {
          try {
              // ADDEVA.apiFetch を使用。パスはNginxでFastAPIにプロキシされるもの。
              const products = await ADDEVA.apiFetch('/api/addeva/products', { method: 'POST', body: {} }); // POSTメソッドと空のボディ
              
              products.forEach(product => {
                  const option = document.createElement('option');
                  option.value = product.product_code;
                  option.textContent = product.product_name;
                  productCodeSelect.appendChild(option);
              });
          } catch (error) {
              console.error('商品リストの取得に失敗しました:', error);
              // ADDEVA.apiFetch はエラー時に Error オブジェクトを投げる
              let errorMessage = error.message || '商品リストの読み込みに失敗しました。';
              messageArea.textContent = errorMessage;
              messageArea.classList.remove('d-none', 'alert-success');
              messageArea.classList.add('alert-danger');
          }
      }
      fetchProducts(); // ページ読み込み時に商品リストをフェッチ

      // ==== フォーム送信処理 ====
      registrationForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        // クライアント側での最終バリデーション
        if (!amazonOrderPattern.test(orderNumberInput.value)) {
            messageArea.textContent = 'Amazon注文番号の形式をご確認ください。';
            messageArea.classList.remove('d-none', 'alert-success');
            messageArea.classList.add('alert-danger');
            orderNumberInput.focus();
            return;
        }
        if (productCodeSelect.value === "") {
            messageArea.textContent = 'ご購入商品を選択してください。';
            messageArea.classList.remove('d-none', 'alert-success');
            messageArea.classList.add('alert-danger');
            productCodeSelect.focus();
            return;
        }

        const formData = new FormData(registrationForm);
        const data = Object.fromEntries(formData.entries()); // JSONに変換

        messageArea.classList.add('d-none'); // メッセージを一旦非表示に

        try {
          // ADDEVA.apiFetch を使用。ボディは自動でJSON化される。
          const result = await ADDEVA.apiFetch('/api/addeva/register', {
            method: 'POST',
            body: data,
          });

          // 成功レスポンスの処理 (FastAPIはJSONで "message" を返す想定)
          messageArea.textContent = result.message || '保証登録が完了しました。ありがとうございます！';
          messageArea.classList.remove('alert-danger');
          messageArea.classList.add('alert-success');
          registrationForm.reset(); // フォームをクリア
          orderNumberInput.classList.remove('is-valid'); // バリデーション状態をリセット
          productCodeSelect.value = ""; // 商品選択もリセット
          
        } catch (error) {
          console.error('API Error:', error);
          // ADDEVA.apiFetch が投げたエラーオブジェクトからメッセージを取得
          messageArea.textContent = error.message; // common.jsでdetailを抽出済み
          messageArea.classList.remove('alert-success');
          messageArea.classList.add('alert-danger');
        } finally {
          messageArea.classList.remove('d-none');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    });
  </script>
</body>
</html>
