<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary SEO -->
  <title>製品保証登録・アフターサービス｜ADDEVA（アデバ）公式</title>
  <meta name="description" content="ADDEVA製品の保証を有効化するためのご登録ページです。Amazon購入情報をご入力ください。">

  <!-- Canonical -->
  <link rel="canonical" href="https://addeva.jp/register.html">

  <!-- Icons -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Robots -->
  <meta name="robots" content="noindex,nofollow">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.7">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Flatpickr の CSS を追加 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <!-- 修正: include-html ではなく data-include に統一 -->
  <div data-include="/includes/header.html" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item active" aria-current="page">製品保証登録</li>
          </ol>
        </nav>

        <h1 class="mb-4">製品保証登録・アフターサービス</h1>
        <p class="lead mb-5">ADDEVA UrbanFlex製品をご購入いただきありがとうございます。保証を有効化し、より充実したアフターサービスをご利用いただくため、下記フォームより購入情報をご登録ください。</p>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert"></div>

        <div class="card shadow-sm p-4 mb-5">
          <form id="registrationForm" method="POST" action="" novalidate>
            <!-- お客様ID (会員番号) -->
            <div class="mb-4">
              <label for="customerId" class="form-label">お客様ID (会員番号)</label>
              <input type="text" class="form-control" id="customerId" name="customerId" readonly>
              <div class="form-text" id="customerIdHelp"></div>
            </div>

            <!-- メールアドレス -->
            <div class="mb-4">
              <label for="email" class="form-label">メールアドレス <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="email" name="email" required placeholder="メールアドレスをご入力ください">
              <div class="form-text">ご登録いただいたメールアドレスは、保証に関するご連絡にのみ利用いたします。</div>
            </div>

            <!-- パスワード入力欄 (新規登録時のみ表示) -->
            <div id="passwordFields" class="mb-4">
              <label for="password" class="form-label">パスワード <span class="text-danger">*</span></label>
              <input type="password" class="form-control mb-2" id="password" name="password" required minlength="8" placeholder="パスワード（8文字以上）">
              <label for="confirmPassword" class="form-label">パスワード確認 <span class="text-danger">*</span></label>
              <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required placeholder="もう一度パスワードを入力してください">
              <div id="passwordMismatchFeedback" class="invalid-feedback" style="display: none;">
                パスワードが一致しません。
              </div>
              <div class="form-text">半角英数字と記号を組み合わせた8文字以上で設定してください。</div>
            </div>

            <hr class="my-4">

            <!-- 注文番号 (トップレベル) -->
            <div class="mb-3">
              <label for="masterOrderNumber" class="form-label">Amazon注文番号 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="masterOrderNumber" name="masterOrderNumber" required placeholder="例: 123-1234567-1234567">
              <div id="masterOrderNumberFeedback" class="invalid-feedback" style="display: none;">
                Amazonの注文番号形式が正しくありません。（例: 123-1234567-1234567）
              </div>
              <div class="form-text text-danger">
                ※ 異なる注文番号の商品は、分けてご登録ください。同一商品を複数ご注文の場合は、複数行でご登録ください。
              </div>
            </div>

            <!-- 購入日 (トップレベル) -->
            <div class="mb-4">
              <label for="masterPurchaseDate" class="form-label">購入日 <span class="text-danger">*</span></label>
              <div class="input-group" id="masterPurchaseDateWrapper">
                <input type="text" class="form-control" id="masterPurchaseDate" name="masterPurchaseDate" required placeholder="YYYY/MM/DD" data-input>
                <button class="btn btn-outline-secondary" type="button" id="masterPurchaseDateCalendarBtn" data-toggle>
                    <i class="bi bi-calendar"></i>
                </button>
              </div>
              <div class="form-text">Amazonでのご注文日を YYYY/MM/DD 形式でご入力ください。</div>
            </div>

            <hr class="my-4">

            <!-- 複数商品入力エリアのコンテナ -->
            <div id="productEntriesContainer" class="mb-4 border p-3 rounded bg-light">
              <h5 class="mb-3">購入商品情報 <span class="small text-muted">(最低1つ入力)</span></h5>
              <!-- ここに動的な商品入力ブロックが追加されます -->
            </div>
            
            <button type="button" id="addProductButton" class="btn btn-outline-secondary btn-sm mb-4">
              <i class="bi bi-plus-circle me-2"></i>別の商品を追加する
            </button>

            <button type="submit" class="btn btn-primary btn-lg w-100">保証を登録する</button>
          </form>
        </div>

        <p class="text-muted small text-center">ご登録いただいた個人情報は、当社の<a href="/privacy-policy.html" target="_blank">プライバシーポリシー</a>に基づき厳重に管理いたします。</p>

      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <!-- 修正: include-html ではなく data-include に統一 -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- addeva.jp 専用 common.js を読み込み -->
  <script defer src="/common.js"></script>
  <!-- Flatpickr の JavaScript を追加 -->
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  
  <script>
    function waitForADDEVA(callback) {
      if (typeof ADDEVA !== 'undefined' && typeof ADDEVA.apiFetch === 'function' && typeof flatpickr !== 'undefined') {
        callback();
      } else {
        setTimeout(() => waitForADDEVA(callback), 50);
      }
    }

    waitForADDEVA(async () => {
      const TODAY_ISO = new Date().toISOString().split('T')[0];
      const TODAY_DATE = new Date(TODAY_ISO);

      const registrationForm = document.getElementById('registrationForm');
      const messageArea = document.getElementById('messageArea');
      const productEntriesContainer = document.getElementById('productEntriesContainer');
      const addProductButton = document.getElementById('addProductButton');

      const customerIdInput = document.getElementById('customerId');
      const customerIdHelp = document.getElementById('customerIdHelp');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const passwordMismatchFeedback = document.getElementById('passwordMismatchFeedback');
      const passwordFields = document.getElementById('passwordFields');

      const masterOrderNumberInput = document.getElementById('masterOrderNumber');
      const masterOrderNumberFeedback = document.getElementById('masterOrderNumberFeedback');
      const masterPurchaseDateInput = document.getElementById('masterPurchaseDate');
      const masterPurchaseDateCalendarBtn = document.getElementById('masterPurchaseDateCalendarBtn');

      const AMAZON_ORDER_PATTERN = /^\d{3}-\d{7}-\d{7}$/;
      const JAPANESE_DATE_PATTERN = /^\d{4}\/\d{2}\/\d{2}$/;
      let availableProducts = [];

      let isUserLoggedIn = false;
      let loggedInCustomerId = null;
      let loggedInEmail = '';

      let fpInstance = null;

      function showError(msg, asHtml=false) {
        if (asHtml) {
          messageArea.innerHTML = msg;
        } else {
          messageArea.textContent = msg;
        }
        messageArea.classList.remove('d-none', 'alert-success');
        messageArea.classList.add('alert-danger');
        window.scrollTo(0, 0);
      }

      function clearMessage() {
        messageArea.classList.add('d-none');
        messageArea.innerHTML = '';
        messageArea.classList.remove('alert-danger', 'alert-success');
      }

      function formatJapaneseDateToISO(japaneseDateString) {
        if (!japaneseDateString || !JAPANESE_DATE_PATTERN.test(japaneseDateString)) return null;
        const [year, month, day] = japaneseDateString.split('/');
        const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        if (isNaN(dateObj.getTime()) || dateObj.getFullYear() != parseInt(year)) return null;
        return `${year}-${String(parseInt(month)).padStart(2, '0')}-${String(parseInt(day)).padStart(2, '0')}`;
      }

      function ensureFlatpickr() {
        if (fpInstance) return;
        fpInstance = flatpickr("#masterPurchaseDateWrapper", {
          wrap: true,
          locale: "ja",
          dateFormat: "Y/m/d",
          maxDate: TODAY_ISO,
          disableMobile: true,
          onClose: function() {
            validatePurchaseDate();
          }
        });
      }

      async function checkLoginStatusAndSetupUI() {
        const authToken = localStorage.getItem(ADDEVA.LS.authToken);

        if (authToken) {
          try {
            const userInfo = await ADDEVA.apiFetch('/api/addeva/customer/me', {
              method: 'GET'
            });

            isUserLoggedIn = true;
            loggedInCustomerId = userInfo.customer_id;
            loggedInEmail = userInfo.email;

            document.querySelector('h1').textContent = '商品情報追加・登録';
            document.querySelector('p.lead').textContent = 'ログイン済みのお客様として、追加の商品情報をご登録ください。';

            customerIdInput.value = loggedInCustomerId;
            customerIdHelp.textContent = 'お客様IDは変更できません。';

            emailInput.value = loggedInEmail;
            emailInput.readOnly = true;
            emailInput.classList.add('form-control-plaintext');

            passwordFields.style.display = 'none';

            ensureFlatpickr();
            return;
          } catch (error) {
            console.warn("ログイン状態の取得失敗:", error);
            localStorage.removeItem(ADDEVA.LS.authToken);
          }
        }

        setupNewRegistrationUI();
      }

      function setupNewRegistrationUI() {
        isUserLoggedIn = false;
        loggedInCustomerId = null;
        loggedInEmail = '';

        customerIdInput.value = '＜新規＞';
        customerIdHelp.textContent = 'お客様IDは登録後に自動発行されます。';

        emailInput.readOnly = false;
        emailInput.classList.remove('form-control-plaintext');

        passwordFields.style.display = 'block';

        ensureFlatpickr();
      }

      async function fetchProducts() {
        try {
          const products = await ADDEVA.apiFetch('/api/addeva/products', { method: 'POST', body: {} });
          availableProducts = products;
        } catch (error) {
          console.error("商品リスト取得失敗:", error);
          throw error;
        }
      }

      function createProductEntry(index, initialData = {}) {
        const entryDiv = document.createElement('div');
        entryDiv.className = `product-entry mb-3 p-3 border rounded ${index > 0 ? 'mt-2 bg-white' : 'bg-white'}`;
        entryDiv.setAttribute('data-index', index);

        entryDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 text-secondary small">商品 ${index + 1}</h6>
            ${index > 0 ? `<button type="button" class="btn btn-outline-danger btn-sm remove-product-btn" style="padding: 0.1rem 0.4rem; font-size: 0.75rem;">削除</button>` : ''}
          </div>
          <div class="mb-0">
            <label for="productCode_${index}" class="form-label small mb-1">ご購入商品 <span class="text-danger">*</span></label>
            <select class="form-select form-select-sm product-code-select" id="productCode_${index}" name="products[${index}][productCode]" required>
              <option value="">商品を選択してください</option>
              ${availableProducts.map(p => `<option value="${p.product_code}">${p.product_name}</option>`).join('')}
            </select>
          </div>
        `;

        if (initialData.productCode) {
          entryDiv.querySelector('.product-code-select').value = initialData.productCode;
        }

        if (index > 0) {
          entryDiv.querySelector('.remove-product-btn').addEventListener('click', () => {
            entryDiv.remove();
          });
        }
        productEntriesContainer.appendChild(entryDiv);
      }

      function validatePasswords() {
        passwordInput.classList.remove('is-invalid');
        confirmPasswordInput.classList.remove('is-invalid');
        passwordMismatchFeedback.style.display = 'none';

        if (passwordInput.value.length < 8) {
          passwordInput.classList.add('is-invalid');
          passwordMismatchFeedback.textContent = 'パスワードは8文字以上で入力してください。';
          passwordMismatchFeedback.style.display = 'block';
          return false;
        }

        if (passwordInput.value === confirmPasswordInput.value) {
          return true;
        }

        confirmPasswordInput.classList.add('is-invalid');
        passwordMismatchFeedback.textContent = 'パスワードが一致しません。';
        passwordMismatchFeedback.style.display = 'block';
        return false;
      }

      function validateOrderNumber() {
        const v = masterOrderNumberInput.value.trim();
        masterOrderNumberInput.classList.remove('is-invalid', 'is-valid');

        if (!v) return false;

        if (AMAZON_ORDER_PATTERN.test(v)) {
          masterOrderNumberInput.classList.add('is-valid');
          masterOrderNumberFeedback.style.display = 'none';
          return true;
        }

        masterOrderNumberInput.classList.add('is-invalid');
        masterOrderNumberFeedback.style.display = 'block';
        return false;
      }

      function validatePurchaseDate() {
        const dateString = masterPurchaseDateInput.value.trim();
        masterPurchaseDateInput.classList.remove('is-invalid', 'is-valid');

        if (!dateString) return false;

        if (!JAPANESE_DATE_PATTERN.test(dateString)) {
          masterPurchaseDateInput.classList.add('is-invalid');
          return false;
        }

        const isoDateString = formatJapaneseDateToISO(dateString);
        if (!isoDateString) {
          masterPurchaseDateInput.classList.add('is-invalid');
          return false;
        }

        const inputDate = new Date(isoDateString);
        if (inputDate > TODAY_DATE) {
          masterPurchaseDateInput.classList.add('is-invalid');
          return false;
        }

        masterPurchaseDateInput.classList.add('is-valid');
        return true;
      }

      function collectProductsData() {
        const productEntries = productEntriesContainer.querySelectorAll('.product-entry');
        const productsData = [];
        productEntries.forEach((entry) => {
          const code = entry.querySelector('.product-code-select').value;
          if (code) {
            productsData.push({
              productCode: code,
              purchaseDate: formatJapaneseDateToISO(masterPurchaseDateInput.value),
              orderNumber: masterOrderNumberInput.value.trim(),
              purchaseSite: "Amazon"
            });
          }
        });
        return productsData;
      }

      function storeAuthTokenFromResult(result) {
        if (!result) return false;

        const token = result.access_token || result.token || result.jwt || '';
        if (!token || typeof token !== 'string') return false;

        try {
          localStorage.setItem(ADDEVA.LS.authToken, token);
          return true;
        } catch (e) {
          console.error("Failed to store auth token:", e);
          return false;
        }
      }

      async function tryAutoLogin(email, password) {
        if (!email || !password) return false;
        const loginRes = await ADDEVA.apiFetch('/api/addeva/login', {
          method: 'POST',
          body: { email, password }
        });
        return storeAuthTokenFromResult(loginRes);
      }

      async function init() {
        await fetchProducts();
        await checkLoginStatusAndSetupUI();

        for (let i = 0; i < 5; i++) {
          createProductEntry(i);
        }

        masterOrderNumberInput.addEventListener('input', validateOrderNumber);
        masterPurchaseDateInput.addEventListener('change', validatePurchaseDate);

        addProductButton.addEventListener('click', () => {
          const nextIndex = productEntriesContainer.querySelectorAll('.product-entry').length;
          createProductEntry(nextIndex);
        });

        registrationForm.addEventListener('submit', onSubmit);
      }

      async function onSubmit(event) {
        event.preventDefault();
        clearMessage();

        let ok = true;

        if (!emailInput.value.trim()) ok = false;
        if (!validateOrderNumber()) ok = false;
        if (!validatePurchaseDate()) ok = false;

        if (!isUserLoggedIn) {
          if (!validatePasswords()) ok = false;
        }

        const productsData = collectProductsData();
        if (productsData.length === 0) {
          alert("商品を1つ以上選択してください。");
          return;
        }

        if (!ok) {
          showError('入力内容に不備があります。赤枠の部分を確認してください。');
          return;
        }

        const submissionData = {
          email: emailInput.value.trim(),
          ...(isUserLoggedIn ? { customerId: loggedInCustomerId } : { password: passwordInput.value }),
          masterOrderNumber: masterOrderNumberInput.value.trim(),
          masterPurchaseDate: formatJapaneseDateToISO(masterPurchaseDateInput.value.trim()),
          products: productsData
        };

        try {
          const result = await ADDEVA.apiFetch('/api/addeva/register', {
            method: 'POST',
            body: submissionData
          });

          const stored = storeAuthTokenFromResult(result);

          if (!stored && !isUserLoggedIn) {
            const loggedIn = await tryAutoLogin(emailInput.value.trim(), passwordInput.value);
            if (!loggedIn) {
              window.location.href = `/customer.html?mode=login&registered=true`;
              return;
            }
          }

          window.location.href = `/customer.html?mode=support&registered=true`;
        } catch (error) {
          const msg = (error && error.message) ? error.message : '登録処理でエラーが発生しました。';

          if (msg.includes('既に登録されています')) {
            showError('このメールアドレスは既に登録されています。<a href="/customer.html?mode=login" class="alert-link">こちらからログイン</a>して商品を追加してください。', true);
            return;
          }

          showError(msg);
        }
      }

      try {
        await init();
      } catch (error) {
        showError(`初期化エラー: ${error.message}`);
      }
    });
  </script>

  <!-- ▼ includeエンジン（将来の不具合予防：data-include と include-html 両対応） -->
  <script>
    (async () => {
      try {
        const targets = document.querySelectorAll('[data-include],[include-html]');
        for (const el of targets) {
          const url = el.getAttribute('data-include') || el.getAttribute('include-html');
          if (!url) continue;

          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`include failed: ${url} (${res.status})`);

          const buf = await res.arrayBuffer();
          const html = new TextDecoder('utf-8').decode(buf);
          el.outerHTML = html;
        }
      } catch (e) {
        console.error('include loader error:', e);
      }
    })();
  </script>
</body>
</html>
