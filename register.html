<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary SEO -->
  <title>製品保証登録・アフターサービス｜ADDEVA（アデバ）公式</title>
  <meta name="description" content="ADDEVA製品の保証を有効化するためのご登録ページです。Amazon購入情報をご入力ください。">

  <!-- Canonical -->
  <link rel="canonical" href="https://addeva.jp/register.html">

  <!-- Icons -->
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Robots -->
  <meta name="robots" content="noindex,nofollow">

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.7">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- APIキーをcommon.jsが読み取るためのメタタグ -->
  <meta name="x-api-key" content="ADDEVA_API_KEY_c3rITY1LbafHBYaO62tJ4h4nzqQKsEMvXQ7aFRz3Uqk">
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item active" aria-current="page">製品保証登録</li>
          </ol>
        </nav>

        <h1 class="mb-4">製品保証登録・アフターサービス</h1>
        <p class="lead mb-5">ADDEVA UrbanFlex製品をご購入いただきありがとうございます。保証を有効化し、より充実したアフターサービスをご利用いただくため、下記フォームより購入情報をご登録ください。</p>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert"></div>

        <div class="card shadow-sm p-4 mb-5">
          <form id="registrationForm" method="POST" action="">
            <!-- メールアドレス -->
            <div class="mb-4">
              <label for="email" class="form-label">メールアドレス <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="email" name="email" required placeholder="メールアドレスをご入力ください">
              <div class="form-text">ご登録いただいたメールアドレスは、保証に関するご連絡にのみ利用いたします。</div>
            </div>

            <!-- パスワード入力欄 (新規登録時のみ表示) -->
            <div id="passwordFields" class="mb-4">
              <label for="password" class="form-label">パスワード <span class="text-danger">*</span></label>
              <input type="password" class="form-control mb-2" id="password" name="password" required minlength="8" placeholder="パスワード（8文字以上）">
              <label for="confirmPassword" class="form-label">パスワード確認 <span class="text-danger">*</span></label>
              <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required placeholder="もう一度パスワードを入力してください">
              <div id="passwordMismatchFeedback" class="invalid-feedback" style="display: none;">
                パスワードが一致しません。
              </div>
              <div class="form-text">半角英数字と記号を組み合わせた8文字以上で設定してください。</div>
            </div>

            <hr class="my-4">

            <!-- 注文番号 (トップレベル) -->
            <div class="mb-3">
              <label for="masterOrderNumber" class="form-label">Amazon注文番号 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="masterOrderNumber" name="masterOrderNumber" required placeholder="例: 123-1234567-1234567">
              <div id="masterOrderNumberFeedback" class="invalid-feedback" style="display: none;">
                Amazonの注文番号形式が正しくありません。（例: 123-1234567-1234567）
              </div>
              <div class="form-text text-danger">
                ※ 異なる注文番号の商品は、分けてご登録ください。同一商品を複数ご注文の場合は、複数行でご登録ください。
              </div>
            </div>

            <!-- 購入日 (トップレベル) -->
            <div class="mb-4">
              <label for="masterPurchaseDate" class="form-label">購入日 <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="masterPurchaseDate" name="masterPurchaseDate" required>
              <div class="form-text">Amazonでのご注文日をご入力ください。</div>
            </div>

            <hr class="my-4">

            <!-- 複数商品入力エリアのコンテナ -->
            <div id="productEntriesContainer" class="mb-4 border p-3 rounded bg-light">
              <h5 class="mb-3">購入商品情報 <span class="small text-muted">(最低1つ入力)</span></h5>
              <!-- ここに動的な商品入力ブロックが追加されます -->
            </div>
            
            <button type="button" id="addProductButton" class="btn btn-outline-secondary btn-sm mb-4">
              <i class="bi bi-plus-circle me-2"></i>別の商品を追加する
            </button>

            <button type="submit" class="btn btn-primary btn-lg w-100">保証を登録する</button>
          </form>
        </div>

        <p class="text-muted small text-center">ご登録いただいた個人情報は、当社の<a href="/privacy-policy/" target="_blank">プライバシーポリシー</a>に基づき厳重に管理いたします。</p>

      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- addeva.jp 専用 common.js を読み込み -->
  <script defer src="/common.js"></script>
  
  <script>
    // ADDEVAオブジェクトがロードされた後に実行されるように待機
    function waitForADDEVA(callback) {
      if (typeof ADDEVA !== 'undefined' && typeof ADDEVA.apiFetch === 'function') {
        callback();
      } else {
        setTimeout(() => waitForADDEVA(callback), 50); // 50msごとにチェック
      }
    }

    waitForADDEVA(async () => {
      const TODAY_ISO = new Date().toISOString().split('T')[0]; // 購入日の最大値

      const registrationForm = document.getElementById('registrationForm');
      const messageArea = document.getElementById('messageArea');
      const productEntriesContainer = document.getElementById('productEntriesContainer');
      const addProductButton = document.getElementById('addProductButton');

      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const passwordMismatchFeedback = document.getElementById('passwordMismatchFeedback');
      const passwordFields = document.getElementById('passwordFields'); // パスワード入力欄全体

      const masterOrderNumberInput = document.getElementById('masterOrderNumber');
      const masterOrderNumberFeedback = document.getElementById('masterOrderNumberFeedback');
      const masterPurchaseDateInput = document.getElementById('masterPurchaseDate');

      const AMAZON_ORDER_PATTERN = /^\d{3}-\d{7}-\d{7}$/; // Amazon注文番号の正規表現
      let availableProducts = []; // APIから取得した商品リストを保持

      // ==== ページモードの判別とUI調整 ====
      const urlParams = new URLSearchParams(window.location.search);
      const isEditMode = urlParams.get('mode') === 'edit';
      const defaultEmail = urlParams.get('email') || '';
      const defaultOrderNumber = urlParams.get('orderNumber') || '';
      const defaultPurchaseDate = urlParams.get('purchaseDate') || '';
      // 将来的にユーザーIDもデフォルト表示する場合
      // const defaultCustomerId = urlParams.get('customerId') || ''; 

      if (isEditMode) {
          // ログイン済み（サポートページから遷移）の場合
          document.querySelector('h1').textContent = '商品情報追加・登録';
          document.querySelector('p.lead').textContent = 'ログイン済みのお客様として、追加の商品情報をご登録ください。';

          // メールアドレスをデフォルト表示し、編集不可
          emailInput.value = defaultEmail;
          emailInput.readOnly = true;
          emailInput.classList.add('form-control-plaintext'); // Bootstrapのスタイル

          // パスワード入力欄は非表示
          passwordFields.style.display = 'none';

          // Amazon注文番号をデフォルト表示し、編集不可
          masterOrderNumberInput.value = defaultOrderNumber;
          masterOrderNumberInput.readOnly = true;
          masterOrderNumberInput.classList.add('form-control-plaintext');
          masterOrderNumberInput.classList.add('is-valid'); // 有効な状態として表示
          masterOrderNumberFeedback.style.display = 'none'; // フィードバックも非表示
          
          // 購入日をデフォルト表示し、編集不可
          masterPurchaseDateInput.value = defaultPurchaseDate;
          masterPurchaseDateInput.readOnly = true;
          masterPurchaseDateInput.classList.add('form-control-plaintext');
          masterPurchaseDateInput.type = 'text'; // date入力のUIを無効化
          
          // トップレベルの必須アスタリスクを削除 (見た目上)
          document.querySelector('label[for="email"] span').style.display = 'none';
          document.querySelector('label[for="masterOrderNumber"] span').style.display = 'none';
          document.querySelector('label[for="masterPurchaseDate"] span').style.display = 'none';

      } else {
          // 新規登録の場合（パスワード入力欄を表示し、メールアドレスと注文番号は入力可）
          // 特に何もしない（デフォルトで表示されているため）
          masterPurchaseDateInput.setAttribute('max', TODAY_ISO); // 新規登録時にのみ最大日を設定
      }


      // ==== 商品リストをAPIから動的に取得する処理 ====
      async function fetchProducts() {
          try {
              const products = await ADDEVA.apiFetch('/api/addeva/products', { method: 'POST', body: {} });
              availableProducts = products; // 取得した商品をグローバル変数に保存
          } catch (error) {
              console.error('商品リストの取得に失敗しました:', error);
              let errorMessage = error.message || '商品リストの読み込みに失敗しました。';
              messageArea.textContent = errorMessage;
              messageArea.classList.remove('d-none', 'alert-success');
              messageArea.classList.add('alert-danger');
              throw error; // エラーを再スローしてフォーム表示を中止
          }
      }

      // ==== 動的な商品入力ブロックを生成する関数 ====
      function createProductEntry(index, initialData = {}) {
        const entryDiv = document.createElement('div');
        entryDiv.className = `product-entry mb-4 p-3 border rounded ${index > 0 ? 'mt-3 bg-white' : ''}`;
        entryDiv.setAttribute('data-index', index);

        entryDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 text-secondary">商品 ${index + 1}</h6>
            ${index > 0 ? `<button type="button" class="btn btn-outline-danger btn-sm remove-product-btn">削除</button>` : ''}
          </div>
          <div class="mb-3">
            <label for="productCode_${index}" class="form-label">ご購入商品 <span class="text-danger">*</span></label>
            <select class="form-select product-code-select" id="productCode_${index}" name="products[${index}][productCode]">
              <option value="">商品を選択してください</option>
              ${availableProducts.map(p => `<option value="${p.product_code}">${p.product_name}</option>`).join('')}
            </select>
          </div>
          <!-- 購入日と注文番号はトップレベルから引き継ぐため、個別の入力欄は削除 -->
        `;

        // 初期値のセット (もしあれば)
        if (initialData.productCode) {
            entryDiv.querySelector('.product-code-select').value = initialData.productCode;
        }
        
        // 削除ボタンのイベントリスナー
        if (index > 0) {
          entryDiv.querySelector('.remove-product-btn').addEventListener('click', () => {
            entryDiv.remove();
            // 削除後、残った商品のインデックスを整理
            productEntriesContainer.querySelectorAll('.product-entry').forEach((el, newIdx) => {
              el.setAttribute('data-index', newIdx);
              el.querySelector('h6').textContent = `商品 ${newIdx + 1}`;
              el.querySelector('.product-code-select').name = `products[${newIdx}][productCode]`;
              el.querySelector('.product-code-select').id = `productCode_${newIdx}`;
              el.querySelector('label[for^="productCode_"]').setAttribute('for', `productCode_${newIdx}`);
            });
          });
        }
        // 個別の注文番号バリデーションは不要になったため削除

        productEntriesContainer.appendChild(entryDiv);
      }

      // ==== 初期化処理 ====
      try {
        await fetchProducts(); // まず商品リストを取得
        // 初期表示で5つの入力ブロックを生成
        for (let i = 0; i < 5; i++) {
          createProductEntry(i);
        }
        // masterPurchaseDateInput.setAttribute('max', TODAY_ISO); // mode=editでなければ上記で設定済み

      } catch (error) {
        // 商品リスト取得でエラーがあれば、フォームは表示しないか、エラーメッセージを強調
        console.error("Initialization failed:", error);
        messageArea.textContent = `初期化に失敗しました。FastAPIとの接続を確認してください: ${error.message}`;
        messageArea.classList.remove('d-none', 'alert-success');
        messageArea.classList.add('alert-danger');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return; // エラーがあればフォーム送信もブロック
      }

      // トップレベル注文番号のリアルタイムバリデーション (新規登録時のみ有効)
      if (!isEditMode) {
        masterOrderNumberInput.addEventListener('input', function() {
          if (AMAZON_ORDER_PATTERN.test(this.value)) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            masterOrderNumberFeedback.style.display = 'none';
          } else {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
            masterOrderNumberFeedback.style.display = 'block';
          }
        });
      }


      // パスワード一致チェック
      if (!isEditMode) {
        passwordInput.addEventListener('input', validatePasswords);
        confirmPasswordInput.addEventListener('input', validatePasswords);
      }
      function validatePasswords() {
        if (passwordInput.value === confirmPasswordInput.value) {
          passwordInput.classList.remove('is-invalid');
          confirmPasswordInput.classList.remove('is-invalid');
          passwordMismatchFeedback.style.display = 'none';
        } else {
          passwordInput.classList.add('is-invalid');
          confirmPasswordInput.classList.add('is-invalid');
          passwordMismatchFeedback.style.display = 'block';
        }
      }


      addProductButton.addEventListener('click', () => {
        const newIndex = productEntriesContainer.querySelectorAll('.product-entry').length;
        createProductEntry(newIndex);
      });

      // ==== フォーム送信処理 ====
      registrationForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        messageArea.classList.add('d-none'); // メッセージを一旦非表示に

        // トップレベルの必須項目チェック (モードによって一部スキップ)
        if (!emailInput.value) {
            messageArea.textContent = 'メールアドレスを入力してください。';
            messageArea.classList.remove('d-none', 'alert-success');
            messageArea.classList.add('alert-danger');
            emailInput.focus();
            messageArea.classList.remove('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }
        
        // 新規登録モードの場合のみパスワードチェック
        if (!isEditMode) {
            if (!passwordInput.value || !confirmPasswordInput.value) {
                messageArea.textContent = 'パスワードを入力してください。';
                messageArea.classList.remove('d-none', 'alert-success');
                messageArea.classList.add('alert-danger');
                passwordInput.focus();
                messageArea.classList.remove('d-none');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            if (passwordInput.value !== confirmPasswordInput.value) {
                messageArea.textContent = 'パスワードが一致しません。';
                messageArea.classList.remove('d-none', 'alert-success');
                messageArea.classList.add('alert-danger');
                passwordInput.focus();
                passwordInput.classList.add('is-invalid');
                confirmPasswordInput.classList.add('is-invalid');
                passwordMismatchFeedback.style.display = 'block';
                messageArea.classList.remove('d-none');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            if (!masterOrderNumberInput.value || !AMAZON_ORDER_PATTERN.test(masterOrderNumberInput.value)) {
                messageArea.textContent = 'Amazon注文番号の形式が正しくありません。';
                messageArea.classList.remove('d-none', 'alert-success');
                messageArea.classList.add('alert-danger');
                masterOrderNumberInput.focus();
                masterOrderNumberInput.classList.add('is-invalid');
                masterOrderNumberFeedback.style.display = 'block';
                messageArea.classList.remove('d-none');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            } else {
                masterOrderNumberInput.classList.remove('is-invalid');
                masterOrderNumberInput.classList.add('is-valid');
                masterOrderNumberFeedback.style.display = 'none';
            }
            if (!masterPurchaseDateInput.value) {
                messageArea.textContent = '購入日を入力してください。';
                messageArea.classList.remove('d-none', 'alert-success');
                messageArea.classList.add('alert-danger');
                masterPurchaseDateInput.focus();
                messageArea.classList.remove('d-none');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
        }


        const productEntries = productEntriesContainer.querySelectorAll('.product-entry');
        const productsData = [];
        let hasAtLeastOneProductSelected = false; // 少なくとも1つの商品が選択されたかを示すフラグ

        productEntries.forEach((entry) => {
            const productCodeSelect = entry.querySelector('.product-code-select');
            
            // 商品コードが選択されている行のみを処理対象とする
            if (productCodeSelect.value) { 
                hasAtLeastOneProductSelected = true;
                productsData.push({
                    productCode: productCodeSelect.value,
                    // 購入日と注文番号はトップレベルから引き継ぐ
                    purchaseDate: masterPurchaseDateInput.value,
                    orderNumber: masterOrderNumberInput.value,
                    purchaseSite: "Amazon" // 固定値
                });
            }
            // 商品コードが選択されていない行は完全にスキップし、エラーとはしない
        });
        
        // 最終チェック: 少なくとも1つの商品が選択されたか
        if (!hasAtLeastOneProductSelected) {
            messageArea.textContent = '少なくとも1つの商品情報を入力してください。';
            messageArea.classList.remove('d-none', 'alert-success');
            messageArea.classList.add('alert-danger');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }

        const submissionData = {
            email: emailInput.value,
            // 新規登録モードの場合のみパスワードを含める
            ...(isEditMode ? {} : { password: passwordInput.value }),
            masterOrderNumber: masterOrderNumberInput.value,    // トップレベルの注文番号
            masterPurchaseDate: masterPurchaseDateInput.value,  // トップレベルの購入日
            products: productsData // 複数の商品情報（注文番号と購入日はセット済み）をリストとして送信
        };

        try {
          const result = await ADDEVA.apiFetch('/api/addeva/register', {
            method: 'POST',
            body: submissionData, // 複数商品を含むデータを送信
          });

          // 登録成功時のリダイレクト処理
          if (result && result.message) {
            const params = new URLSearchParams();
            params.append('customerId', result.customerId); // FastAPIから返す顧客ID
            params.append('email', submissionData.email);
            // registeredProductsをFastAPIからJSON文字列として受け取り、URLエンコードして渡す
            params.append('products', encodeURIComponent(JSON.stringify(result.registeredProducts))); 

            window.location.href = `/confirmation.html?${params.toString()}`;
          } else {
             messageArea.textContent = result.detail || result.error || '保証登録に失敗しました。';
             messageArea.classList.remove('alert-success');
             messageArea.classList.add('alert-danger');
             messageArea.classList.remove('d-none');
             window.scrollTo({ top: 0, behavior: 'smooth' });
          }
          
        } catch (error) {
          console.error('API Error:', error);
          let errorMessage = error.message || 'サーバーとの通信に失敗しました。しばらくしてから再度お試しください。';
          messageArea.textContent = errorMessage;
          messageArea.classList.remove('alert-success');
          messageArea.classList.add('alert-danger');
          messageArea.classList.remove('d-none');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } finally {
          messageArea.classList.remove('d-none');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    });
  </script>
</body>
</html>
