<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>製品保証登録・アフターサービス｜ADDEVA（アデバ）公式</title>
  <meta name="description" content="ADDEVA製品の保証を有効化するためのご登録ページです。Amazon購入情報をご入力ください。">
  <link rel="canonical" href="https://addeva.jp/register.html">

  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <meta name="robots" content="noindex,nofollow">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.7">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
  <div data-include="/includes/header.html" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item active" aria-current="page">製品保証登録</li>
          </ol>
        </nav>

        <h1 class="mb-4">
          <span id="pageTitleText">製品保証登録・アフターサービス</span>
        </h1>
        <p class="lead mb-5" id="pageLead">
          ADDEVA UrbanFlex製品をご購入いただきありがとうございます。保証を有効化し、より充実したアフターサービスをご利用いただくため、下記フォームより購入情報をご登録ください。
        </p>

        <div id="messageArea" class="alert d-none" role="alert"></div>

        <div class="card shadow-sm p-4 mb-5">
          <form id="registrationForm" method="POST" action="" novalidate>

            <!-- =========================================================
                 Step 1: Email OTP（未ログイン時のみ使用）
                 ========================================================= -->
            <div class="mb-4" id="otpSection">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h2 class="h5 mb-0" id="otpTitle">メールアドレス確認</h2>
                <span class="badge text-bg-secondary d-none" id="otpStageBadge">STEP 1</span>
              </div>

              <div class="mt-3" id="emailBlock">
                <label for="email" class="form-label" id="emailLabel">メールアドレス <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="email" name="email" required placeholder="メールアドレスをご入力ください">
                <div class="form-text" id="emailHelpText">ご登録いただいたメールアドレスは、安全上重要なお知らせ（リコール、重大な不具合、保証に関わる連絡等）の送付に利用いたします。</div>
              </div>

              <div class="mt-3 d-flex flex-wrap gap-2 align-items-center" id="sendOtpRow">
                <button type="button" class="btn btn-outline-primary" id="sendOtpButton">
                  <i class="bi bi-envelope me-1"></i>確認コードを送信
                </button>
                <div class="small text-muted" id="sendOtpHint">メールに6桁の確認コードを送ります。</div>
              </div>

              <div class="mt-3 d-none" id="otpInputBlock">
                <label for="otpCode" class="form-label">確認コード（6桁）</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="otpCode"
                    inputmode="numeric"
                    autocomplete="one-time-code"
                    placeholder="例: 123456"
                    maxlength="6"
                  >
                  <button type="button" class="btn btn-primary" id="confirmOtpButton">
                    <i class="bi bi-check2-circle me-1"></i>認証する
                  </button>
                </div>
                <div class="form-text">メールに届いた6桁のコードを入力してください。</div>
              </div>

              <div class="mt-3 d-none" id="otpVerifiedBlock">
                <span class="badge text-bg-success">
                  <i class="bi bi-check-circle me-1"></i>メール確認済み
                </span>
                <div class="small text-muted mt-2">このまま登録情報の入力へ進んでください。</div>
              </div>
            </div>

            <hr class="my-4" id="afterOtpHr">

            <!-- =========================================================
                 Step 2+: 認証後（またはログイン済み）
                 ========================================================= -->
            <div id="afterOtpFields" class="d-none">

              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3" id="afterOtpTopTitleRow">
                <h2 class="h5 mb-0" id="afterOtpTopTitle">パスワード登録</h2>
              </div>

              <!-- お客様ID -->
              <div class="mb-4">
                <label for="customerId" class="form-label">お客様ID (会員番号)</label>
                <input type="text" class="form-control" id="customerId" name="customerId" readonly>
                <div class="form-text" id="customerIdHelp"></div>
              </div>

              <!-- パスワード（新規登録時のみ表示） -->
              <div id="passwordFields" class="mb-4">
                <label for="password" class="form-label">パスワード <span class="text-danger">*</span></label>
                <input type="password" class="form-control mb-2" id="password" name="password" minlength="8" placeholder="パスワード（8文字以上）">
                <label for="confirmPassword" class="form-label">パスワード確認 <span class="text-danger">*</span></label>
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="もう一度パスワードを入力してください">
                <div id="passwordMismatchFeedback" class="invalid-feedback" style="display:none;">パスワードが一致しません。</div>
                <div class="form-text">半角英数字と記号を組み合わせた8文字以上で設定してください。</div>
              </div>

              <hr class="my-4">

              <!-- 購入商品情報（注文番号・購入日・購入商品） -->
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3" id="purchaseInfoTitleRow">
                <h2 class="h5 mb-0">購入商品情報</h2>
              </div>

              <!-- 注文番号 -->
              <div class="mb-3">
                <label for="masterOrderNumber" class="form-label">Amazon注文番号 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="masterOrderNumber" name="masterOrderNumber" placeholder="例: 123-1234567-1234567">
                <div id="masterOrderNumberFeedback" class="invalid-feedback" style="display:none;">
                  Amazonの注文番号形式が正しくありません。（例: 123-1234567-1234567）
                </div>
                <div class="form-text text-danger">
                  ※ 異なる注文番号の商品は、分けてご登録ください。同一商品を複数ご注文の場合は、複数行でご登録ください。
                </div>
              </div>

              <!-- 購入日 -->
              <div class="mb-4">
                <label for="masterPurchaseDate" class="form-label">購入日 <span class="text-danger">*</span></label>
                <div class="input-group" id="masterPurchaseDateWrapper">
                  <input type="text" class="form-control" id="masterPurchaseDate" name="masterPurchaseDate" placeholder="YYYY/MM/DD" data-input>
                  <button class="btn btn-outline-secondary" type="button" id="masterPurchaseDateCalendarBtn" data-toggle>
                    <i class="bi bi-calendar"></i>
                  </button>
                </div>
                <div class="form-text">Amazonでのご注文日を YYYY/MM/DD 形式でご入力ください。</div>
              </div>

              <hr class="my-4">

              <!-- 複数商品 -->
              <div id="productEntriesContainer" class="mb-4 border p-3 rounded bg-light">
                <div class="mb-2">
                  <span class="form-label mb-0 d-block">ご購入商品（複数可）</span>
                </div>
              </div>

              <button type="button" id="addProductButton" class="btn btn-outline-secondary btn-sm mb-4"><i class="bi bi-plus-circle me-1"></i>別の商品を追加する</button>

              <!-- 同意（新規登録時のみ有効） -->
              <div class="mb-4" id="optinFields">
                <div class="form-text mb-3">
                  安全上重要なお知らせ（リコール、重大な不具合、保証に関わる連絡等）は、配信設定にかかわらず登録メール宛に送付されます。
                </div>

                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                  <h2 class="h6 mb-0">メール配信</h2>
                  <span class="small text-muted">（任意）</span>
                </div>
                <div class="form-text mb-2">メール配信の同意をお願いいたします。</div>
                <div class="form-text mb-2">
                  弊社のメール配信は、お客さまがご使用されている製品に関連するお知らせのみを選んで配信しています。（現在の配信は年に数回程度）。
                </div>

                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="optinSales">
                  <label class="form-check-label" for="optinSales">
                    使用中製品の互換オプションや交換部品の新発売、セール情報を受け取る。
                  </label>
                </div>
              </div>

              <button type="submit" class="btn btn-primary btn-lg w-100" id="submitButton">保証を登録する</button>
            </div>

          </form>
        </div>

        <p class="text-muted small text-center">
          ご登録いただいた個人情報は、当社の<a href="/privacy-policy.html" target="_blank">プライバシーポリシー</a>に基づき厳重に管理いたします。
        </p>
      </div>
    </section>
  </main>

  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="/common.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

  <script>
    function waitForADDEVA(callback) {
      if (typeof ADDEVA !== 'undefined' && typeof ADDEVA.apiFetch === 'function' && typeof flatpickr !== 'undefined') {
        callback();
      } else {
        setTimeout(() => waitForADDEVA(callback), 50);
      }
    }

    waitForADDEVA(async () => {
      const TODAY_ISO = new Date().toISOString().split('T')[0];
      const TODAY_DATE = new Date(TODAY_ISO);

      const AMAZON_ORDER_PATTERN = /^\d{3}-\d{7}-\d{7}$/;
      const JAPANESE_DATE_PATTERN = /^\d{4}\/\d{2}\/\d{2}$/;

      const SS_SIGNUP_EMAIL = "addeva.signup.email";
      const SS_SIGNUP_TOKEN = "addeva.signup.token";

      const registrationForm = document.getElementById('registrationForm');
      const messageArea = document.getElementById('messageArea');

      const pageTitleText = document.getElementById('pageTitleText');
      const pageLead = document.getElementById('pageLead');

      const otpSection = document.getElementById('otpSection');
      const otpStageBadge = document.getElementById('otpStageBadge');
      const otpTitle = document.getElementById('otpTitle');

      const emailInput = document.getElementById('email');
      const emailBlock = document.getElementById('emailBlock');
      const emailLabel = document.getElementById('emailLabel');
      const emailHelpText = document.getElementById('emailHelpText');
      const sendOtpButton = document.getElementById('sendOtpButton');
      const sendOtpHint = document.getElementById('sendOtpHint');
      const sendOtpRow = document.getElementById('sendOtpRow');

      const otpInputBlock = document.getElementById('otpInputBlock');
      const otpCodeInput = document.getElementById('otpCode');
      const confirmOtpButton = document.getElementById('confirmOtpButton');
      const otpVerifiedBlock = document.getElementById('otpVerifiedBlock');

      const afterOtpHr = document.getElementById('afterOtpHr');
      const afterOtpFields = document.getElementById('afterOtpFields');

      const afterOtpTopTitleRow = document.getElementById('afterOtpTopTitleRow');
      const afterOtpTopTitle = document.getElementById('afterOtpTopTitle');

      const customerIdInput = document.getElementById('customerId');
      const customerIdHelp = document.getElementById('customerIdHelp');

      const passwordFields = document.getElementById('passwordFields');
      const passwordInput = document.getElementById('password');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const passwordMismatchFeedback = document.getElementById('passwordMismatchFeedback');

      const optinFields = document.getElementById('optinFields');

      const optinSales = document.getElementById('optinSales');

      const masterOrderNumberInput = document.getElementById('masterOrderNumber');
      const masterOrderNumberFeedback = document.getElementById('masterOrderNumberFeedback');
      const masterPurchaseDateInput = document.getElementById('masterPurchaseDate');
      const productEntriesContainer = document.getElementById('productEntriesContainer');
      const addProductButton = document.getElementById('addProductButton');

      let fpInstance = null;
      let availableProducts = [];
      let productsLoaded = false;

      let isUserLoggedIn = false;
      let loggedInCustomerId = null;
      let loggedInEmail = '';

      let otpState = "init";  // init | sent | verified | loggedin
      let signupToken = "";

      function showError(msg, asHtml=false) {
        if (asHtml) messageArea.innerHTML = msg;
        else messageArea.textContent = msg;

        messageArea.classList.remove('d-none', 'alert-success');
        messageArea.classList.add('alert-danger');
        window.scrollTo(0, 0);
      }

      function showSuccess(msg, asHtml=false) {
        if (asHtml) messageArea.innerHTML = msg;
        else messageArea.textContent = msg;

        messageArea.classList.remove('d-none', 'alert-danger');
        messageArea.classList.add('alert-success');
        window.scrollTo(0, 0);
      }

      function clearMessage() {
        messageArea.classList.add('d-none');
        messageArea.innerHTML = '';
        messageArea.classList.remove('alert-danger', 'alert-success');
      }

      function normalizeEmail(v) {
        return (v || "").trim();
      }

      function formatJapaneseDateToISO(japaneseDateString) {
        if (!japaneseDateString || !JAPANESE_DATE_PATTERN.test(japaneseDateString)) return null;
        const [year, month, day] = japaneseDateString.split('/');
        const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        if (isNaN(dateObj.getTime()) || dateObj.getFullYear() != parseInt(year)) return null;
        return `${year}-${String(parseInt(month)).padStart(2, '0')}-${String(parseInt(day)).padStart(2, '0')}`;
      }

      function ensureFlatpickr() {
        if (fpInstance) return;
        fpInstance = flatpickr("#masterPurchaseDateWrapper", {
          wrap: true,
          locale: "ja",
          dateFormat: "Y/m/d",
          maxDate: TODAY_ISO,
          disableMobile: true
        });
      }

      function setEmailReadonly(readonly) {
        emailInput.readOnly = !!readonly;
        if (readonly) {
          emailInput.classList.add('form-control-plaintext');
        } else {
          emailInput.classList.remove('form-control-plaintext');
        }
      }

      function setOtpUiState(state) {
        otpState = state;

        if (state === "loggedin") {
          otpSection.classList.add("d-none");
          afterOtpHr.classList.add("d-none");
          afterOtpFields.classList.remove("d-none");

          if (afterOtpTopTitleRow) afterOtpTopTitleRow.classList.add('d-none');

          otpInputBlock.classList.add("d-none");
          otpVerifiedBlock.classList.add("d-none");

          setEmailReadonly(true);

          passwordFields.style.display = "none";
          optinFields.style.display = "none";

          otpStageBadge.textContent = "LOGGED IN";
          return;
        }

        otpSection.classList.remove("d-none");
        afterOtpHr.classList.remove("d-none");

        if (state === "init") {
          if (otpTitle) otpTitle.textContent = "メールアドレス確認";
          otpStageBadge.textContent = "STEP 1";
          otpStageBadge.classList.add('d-none');

          // STEP1: ページ見出し
          pageTitleText.innerHTML = '新規登録（メール確認）<span style="font-size:0.82em;">（ステップ１）</span>';
          pageLead.textContent = 'はじめにメールアドレスを確認します。確認が完了すると、登録情報と購入情報の入力に進めます。';
          pageLead.classList.remove('d-none');
          otpVerifiedBlock.classList.add("d-none");
          otpInputBlock.classList.add("d-none");
          sendOtpButton.classList.remove("d-none");
          sendOtpButton.disabled = false;
          sendOtpButton.innerHTML = '<i class="bi bi-envelope me-1"></i>確認コードを送信';
          sendOtpHint.textContent = "メールに6桁の確認コードを送ります。";

          if (emailHelpText) emailHelpText.classList.remove('d-none');
          if (sendOtpRow) sendOtpRow.classList.remove('d-none');
          if (emailLabel) emailLabel.classList.remove('d-none');
          if (emailBlock) { emailBlock.classList.add('mt-3'); emailBlock.classList.remove('mt-0'); }

          afterOtpFields.classList.add("d-none");
          setEmailReadonly(false);

          passwordFields.style.display = "block";
          optinFields.style.display = "block";
          return;
        }

        if (state === "sent") {
          if (otpTitle) otpTitle.textContent = "メールアドレス確認";
          otpStageBadge.textContent = "STEP 1";
          otpStageBadge.classList.add('d-none');

          // STEP1: ページ見出し
          pageTitleText.innerHTML = '新規登録（メール確認）<span style="font-size:0.82em;">（ステップ１）</span>';
          pageLead.textContent = 'はじめにメールアドレスを確認します。確認が完了すると、登録情報と購入情報の入力に進めます。';
          pageLead.classList.remove('d-none');
          otpVerifiedBlock.classList.add("d-none");
          otpInputBlock.classList.remove("d-none");
          afterOtpFields.classList.add("d-none");
          setEmailReadonly(false);

          if (emailHelpText) emailHelpText.classList.remove('d-none');
          if (sendOtpRow) sendOtpRow.classList.remove('d-none');
          if (emailLabel) emailLabel.classList.remove('d-none');
          if (emailBlock) { emailBlock.classList.add('mt-3'); emailBlock.classList.remove('mt-0'); }

          passwordFields.style.display = "block";
          optinFields.style.display = "block";
          return;
        }

        if (state === "verified") {
          if (otpTitle) otpTitle.textContent = "ご登録メールアドレス";
          otpStageBadge.textContent = "STEP 2";
          // STEP2では重複表示を避けるため、バッジは隠す
          otpStageBadge.classList.add('d-none');

          // STEP2: ページ見出し（スマホで下のフォームを見せるため、リード文は隠す）
          pageTitleText.innerHTML = '製品登録<span style="font-size:0.82em;">（ステップ２）</span>';
          pageLead.textContent = '';
          pageLead.classList.add('d-none');
          otpVerifiedBlock.classList.remove("d-none");
          otpInputBlock.classList.add("d-none");
          sendOtpButton.classList.add("d-none");

          // STEP 2では縦を詰める（スマホで下のフォームを見せる）
          if (emailHelpText) emailHelpText.classList.add('d-none');
          if (sendOtpRow) sendOtpRow.classList.add('d-none');
          if (emailLabel) emailLabel.classList.add('d-none');
          if (emailBlock) { emailBlock.classList.remove('mt-3'); emailBlock.classList.add('mt-0'); }

          afterOtpFields.classList.remove("d-none");

          if (afterOtpTopTitleRow) afterOtpTopTitleRow.classList.remove('d-none');
          if (afterOtpTopTitle) afterOtpTopTitle.textContent = 'パスワード登録';

          setEmailReadonly(true);

          passwordFields.style.display = "block";
          optinFields.style.display = "block";
          return;
        }
      }

      function startSendCooldown(seconds) {
        const base = seconds;
        let remain = base;

        sendOtpButton.disabled = true;
        const timer = setInterval(() => {
          remain -= 1;
          if (remain <= 0) {
            clearInterval(timer);
            sendOtpButton.disabled = false;
            sendOtpButton.innerHTML = '<i class="bi bi-envelope me-1"></i>確認コードを送信';
            sendOtpHint.textContent = "確認コードの再送信が可能です。";
            return;
          }
          sendOtpButton.innerHTML = `再送信まで ${remain}s`;
          sendOtpHint.textContent = "連続送信を防ぐため、少し時間をおいてください。";
        }, 1000);
      }

      async function fetchProductsOnce() {
        if (productsLoaded) return;
        const products = await ADDEVA.apiFetch('/api/addeva/products', { method: 'POST', body: {} });
        availableProducts = Array.isArray(products) ? products : [];
        productsLoaded = true;
      }

      function createProductEntry(index) {
        const entryDiv = document.createElement('div');
        entryDiv.className = `product-entry mb-3 p-3 border rounded bg-white`;
        entryDiv.setAttribute('data-index', index);

        entryDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 text-secondary small">${index === 0 ? '商品 1 <span class="text-danger">*</span>' : `商品 ${index + 1}`}</h6>
            ${index > 0 ? `<button type="button" class="btn btn-outline-danger btn-sm remove-product-btn" style="padding: 0.1rem 0.4rem; font-size: 0.75rem;">削除</button>` : ''}
          </div>
          <div class="mb-0">
            <select class="form-select form-select-sm product-code-select" id="productCode_${index}" required aria-label="ご購入商品">
              <option value="">商品を選択してください</option>
              ${availableProducts.map(p => `<option value="${p.product_code}">${p.product_name}</option>`).join('')}
            </select>
          </div>
        `;

        const sel = entryDiv.querySelector('.product-code-select');
        if (sel) {
          sel.addEventListener('change', () => {
            sel.classList.remove('is-invalid');
            // 1つでも選択されていれば、全セレクトの赤枠を解除
            if (hasAtLeastOneProductSelected()) {
              productEntriesContainer.querySelectorAll('.product-code-select').forEach(s => s.classList.remove('is-invalid'));
            }
          });
        }

        if (index > 0) {
          const btn = entryDiv.querySelector('.remove-product-btn');
          if (btn) {
            btn.addEventListener('click', () => {
              entryDiv.remove();
              updateProductEntryDisplayNumbers();
              ensureAtLeastOneProductEntry();
            });
          }
        }

        productEntriesContainer.appendChild(entryDiv);
        updateProductEntryDisplayNumbers();
      }

      function updateProductEntryDisplayNumbers() {
        const entries = productEntriesContainer.querySelectorAll('.product-entry');
        entries.forEach((entry, pos) => {
          const h = entry.querySelector('h6');
          if (!h) return;

          if (pos === 0) {
            h.innerHTML = `商品 ${pos + 1} <span class="text-danger">*</span>`;
          } else {
            h.textContent = `商品 ${pos + 1}`;
          }
        });
      }

      function getNextProductIndex() {
        let max = -1;
        productEntriesContainer.querySelectorAll('.product-entry').forEach((entry) => {
          const v = parseInt(entry.getAttribute('data-index'), 10);
          if (!isNaN(v) && v > max) max = v;
        });
        return max + 1;
      }

      function hasAtLeastOneProductSelected() {
        const selects = productEntriesContainer.querySelectorAll('.product-code-select');
        for (const s of selects) {
          if (s && s.value) return true;
        }
        return false;
      }

      function ensureAtLeastOneProductEntry() {
        const count = productEntriesContainer.querySelectorAll('.product-entry').length;
        if (count === 0) createProductEntry(0);
      }

      function ensureInitialProductEntries() {
        const count = productEntriesContainer.querySelectorAll('.product-entry').length;
        if (count === 0) {
          for (let i = 0; i < 5; i++) {
            createProductEntry(i);
          }
        }
        updateProductEntryDisplayNumbers();
      }

      function validatePasswords() {
        passwordInput.classList.remove('is-invalid');
        confirmPasswordInput.classList.remove('is-invalid');
        passwordMismatchFeedback.style.display = 'none';

        const pw = (passwordInput.value || "");
        const cpw = (confirmPasswordInput.value || "");

        if (pw.length < 8) {
          passwordInput.classList.add('is-invalid');
          passwordMismatchFeedback.textContent = 'パスワードは8文字以上で入力してください。';
          passwordMismatchFeedback.style.display = 'block';
          return false;
        }

        if (pw !== cpw) {
          confirmPasswordInput.classList.add('is-invalid');
          passwordMismatchFeedback.textContent = 'パスワードが一致しません。';
          passwordMismatchFeedback.style.display = 'block';
          return false;
        }

        return true;
      }

      function validateOrderNumber() {
        const v = (masterOrderNumberInput.value || "").trim();
        masterOrderNumberInput.classList.remove('is-invalid', 'is-valid');

        if (!v) return false;

        if (AMAZON_ORDER_PATTERN.test(v)) {
          masterOrderNumberInput.classList.add('is-valid');
          masterOrderNumberFeedback.style.display = 'none';
          return true;
        }

        masterOrderNumberInput.classList.add('is-invalid');
        masterOrderNumberFeedback.style.display = 'block';
        return false;
      }

      function validatePurchaseDate() {
        const dateString = (masterPurchaseDateInput.value || "").trim();
        masterPurchaseDateInput.classList.remove('is-invalid', 'is-valid');

        if (!dateString) return false;

        if (!JAPANESE_DATE_PATTERN.test(dateString)) {
          masterPurchaseDateInput.classList.add('is-invalid');
          return false;
        }

        const isoDateString = formatJapaneseDateToISO(dateString);
        if (!isoDateString) {
          masterPurchaseDateInput.classList.add('is-invalid');
          return false;
        }

        const inputDate = new Date(isoDateString);
        if (inputDate > TODAY_DATE) {
          masterPurchaseDateInput.classList.add('is-invalid');
          return false;
        }

        masterPurchaseDateInput.classList.add('is-valid');
        return true;
      }

      function collectProductsData() {
        const productEntries = productEntriesContainer.querySelectorAll('.product-entry');
        const productsData = [];

        productEntries.forEach((entry) => {
          const sel = entry.querySelector('.product-code-select');
          const code = sel ? sel.value : "";
          if (code) {
            productsData.push({
              productCode: code,
              purchaseDate: formatJapaneseDateToISO(masterPurchaseDateInput.value),
              orderNumber: (masterOrderNumberInput.value || "").trim(),
              purchaseSite: "Amazon"
            });
          }
        });
        return productsData;
      }

      function storeAuthTokenFromResult(result) {
        if (!result) return false;
        const token = result.access_token || result.token || result.jwt || '';
        if (!token || typeof token !== 'string') return false;

        try {
          localStorage.setItem(ADDEVA.LS.authToken, token);
          return true;
        } catch (e) {
          console.error("Failed to store auth token:", e);
          return false;
        }
      }

      function clearSignupSessionStorage() {
        try {
          sessionStorage.removeItem(SS_SIGNUP_EMAIL);
          sessionStorage.removeItem(SS_SIGNUP_TOKEN);
        } catch(e) {}
        signupToken = "";
      }

      function loadSignupSessionStorageIfAny() {
        try {
          const e = sessionStorage.getItem(SS_SIGNUP_EMAIL) || "";
          const t = sessionStorage.getItem(SS_SIGNUP_TOKEN) || "";
          if (e && t && normalizeEmail(e).toLowerCase() === normalizeEmail(emailInput.value).toLowerCase()) {
            signupToken = t;
            return true;
          }
        } catch(e) {}
        return false;
      }

      async function enterAfterOtpStageIfNeeded() {
        await fetchProductsOnce();
        ensureFlatpickr();
        ensureInitialProductEntries();
      }

      async function checkLoginStatus() {
        const authToken = localStorage.getItem(ADDEVA.LS.authToken);

        if (!authToken) return false;

        try {
          const userInfo = await ADDEVA.apiFetch('/api/addeva/customer/me', { method: 'GET' });
          isUserLoggedIn = true;
          loggedInCustomerId = userInfo.customer_id;
          loggedInEmail = userInfo.email;

          pageTitleText.textContent = '商品情報追加・登録';
          pageLead.textContent = 'ログイン済みのお客様として、追加の商品情報をご登録ください。';

          emailInput.value = loggedInEmail;
          setEmailReadonly(true);

          customerIdInput.value = loggedInCustomerId;
          customerIdHelp.textContent = 'お客様IDは変更できません。';

          setOtpUiState("loggedin");
          await enterAfterOtpStageIfNeeded();
          return true;

        } catch (e) {
          console.warn("ログイン状態の取得失敗:", e);
          localStorage.removeItem(ADDEVA.LS.authToken);
          return false;
        }
      }

      async function onSendOtp() {
        clearMessage();

        const email = normalizeEmail(emailInput.value);
        if (!email) {
          showError("メールアドレスを入力してください。");
          return;
        }

        clearSignupSessionStorage();
        setOtpUiState("init");

        try {
          const res = await ADDEVA.apiFetch('/api/addeva/signup/email-otp/start', {
            method: 'POST',
            body: { email }
          });

          showSuccess("確認コードを送信しました。メールをご確認ください。");
          setOtpUiState("sent");
          otpCodeInput.value = "";
          otpCodeInput.focus();

          startSendCooldown(60);

        } catch (e) {
          const msg = (e && e.message) ? e.message : "確認コードの送信に失敗しました。";

          if (msg.includes("404")) {
            showError("APIが見つかりません（404）。サーバー側で /api/addeva/signup/email-otp/start が有効か、/api/openapi.json で email-otp を検索して確認してください。");
            return;
          }

          if (msg.includes("既に登録済み")) {
            showError('このメールアドレスは既に登録済みです。<a href="/customer.html?mode=login" class="alert-link">こちらからログイン</a>してください。', true);
            return;
          }

          showError(msg);
        }
      }

      async function onConfirmOtp() {
        clearMessage();

        const email = normalizeEmail(emailInput.value);
        const code = (otpCodeInput.value || "").trim();

        if (!email) {
          showError("メールアドレスを入力してください。");
          return;
        }
        if (!/^\d{6}$/.test(code)) {
          showError("確認コード（6桁）を入力してください。");
          return;
        }

        try {
          const res = await ADDEVA.apiFetch('/api/addeva/signup/email-otp/confirm', {
            method: 'POST',
            body: { email, code }
          });

          signupToken = res.signup_token || "";
          if (!signupToken) {
            showError("認証は完了しましたが、登録トークンの取得に失敗しました。最初からやり直してください。");
            setOtpUiState("init");
            return;
          }

          try {
            sessionStorage.setItem(SS_SIGNUP_EMAIL, email);
            sessionStorage.setItem(SS_SIGNUP_TOKEN, signupToken);
          } catch(e) {}

          showSuccess("メール確認が完了しました。続けて登録情報を入力してください。");
          setOtpUiState("verified");
          await enterAfterOtpStageIfNeeded();

          customerIdInput.value = '＜新規＞';
          customerIdHelp.textContent = 'お客様IDは登録後に自動発行されます。';

          passwordInput.focus();

        } catch (e) {
          const msg = (e && e.message) ? e.message : "確認処理に失敗しました。";
          showError(msg);
        }
      }

      async function completeSignupIfNeeded() {
        if (isUserLoggedIn) return { customer_id: loggedInCustomerId, email: loggedInEmail };

        const email = normalizeEmail(emailInput.value);
        if (!email) throw new Error("メールアドレスを入力してください。");

        if (otpState !== "verified") {
          throw new Error("メール確認が完了していません。確認コードの送信と入力を行ってください。");
        }

        if (!signupToken) {
          loadSignupSessionStorageIfAny();
        }
        if (!signupToken) {
          throw new Error("登録セッションが見つかりません。最初からやり直してください。");
        }

        if (!validatePasswords()) {
          throw new Error("パスワードを確認してください。");
        }

        const res = await ADDEVA.apiFetch('/api/addeva/signup/email-otp/complete', {
          method: 'POST',
          body: {
            email,
            signup_token: signupToken,
            password: passwordInput.value,
            marketing_updates_optin: true,
            marketing_sales_optin: !!optinSales.checked,
            milestone_notify_optin: false
          }
        });

        const stored = storeAuthTokenFromResult(res);
        if (!stored) {
          throw new Error("認証トークンの保存に失敗しました。ブラウザ設定をご確認ください。");
        }

        isUserLoggedIn = true;
        loggedInCustomerId = res.customer_id;
        loggedInEmail = res.email;

        clearSignupSessionStorage();

        setOtpUiState("loggedin");
        await enterAfterOtpStageIfNeeded();

        return { customer_id: loggedInCustomerId, email: loggedInEmail };
      }

      async function submitPurchaseRegistration(customerId) {
        const ok1 = validateOrderNumber();
        const ok2 = validatePurchaseDate();
        if (!ok1 || !ok2) {
          throw new Error("入力内容に不備があります。赤枠の部分を確認してください。");
        }

        const productsData = collectProductsData();
        if (productsData.length === 0) {
          // 1つも選択されていない場合のみエラー（空欄行があるのはOK）
          productEntriesContainer.querySelectorAll('.product-code-select').forEach(s => s.classList.add('is-invalid'));
          throw new Error("商品を1つ以上選択してください。");
        }

        const submissionData = {
          email: normalizeEmail(emailInput.value),
          customerId: customerId,
          masterOrderNumber: (masterOrderNumberInput.value || "").trim(),
          masterPurchaseDate: formatJapaneseDateToISO((masterPurchaseDateInput.value || "").trim()),
          products: productsData
        };

        await ADDEVA.apiFetch('/api/addeva/register', {
          method: 'POST',
          body: submissionData
        });
      }

      async function onSubmit(event) {
        event.preventDefault();
        clearMessage();

        try {
          const signup = await completeSignupIfNeeded();
          await submitPurchaseRegistration(signup.customer_id);

          window.location.href = `/customer.html?mode=support&registered=true`;

        } catch (e) {
          const msg = (e && e.message) ? e.message : "登録処理でエラーが発生しました。";
          showError(msg);
        }
      }

      async function init() {
        registrationForm.addEventListener('submit', onSubmit);
        sendOtpButton.addEventListener('click', onSendOtp);
        confirmOtpButton.addEventListener('click', onConfirmOtp);

        otpCodeInput.addEventListener('keydown', (ev) => {
          if (ev.key === "Enter") {
            ev.preventDefault();
            onConfirmOtp();
          }
        });

        addProductButton.addEventListener('click', () => {
          const nextIndex = getNextProductIndex();
          createProductEntry(nextIndex);
        });

        masterOrderNumberInput.addEventListener('input', validateOrderNumber);
        masterPurchaseDateInput.addEventListener('change', validatePurchaseDate);

        const loggedIn = await checkLoginStatus();
        if (loggedIn) return;

        pageTitleText.innerHTML = '新規登録（メール確認）<span style="font-size:0.82em;">（ステップ１）</span>';
        pageLead.textContent = 'はじめにメールアドレスを確認します。確認が完了すると、登録情報と購入情報の入力に進めます。';

        customerIdInput.value = '＜新規＞';
        customerIdHelp.textContent = 'お客様IDは登録後に自動発行されます。';

        setOtpUiState("init");

        // もしリロード等でトークンが残っていたら、メール一致時のみ復元
        const ssEmail = (sessionStorage.getItem(SS_SIGNUP_EMAIL) || "");
        const ssToken = (sessionStorage.getItem(SS_SIGNUP_TOKEN) || "");
        if (ssEmail && ssToken) {
          emailInput.value = ssEmail;
          signupToken = ssToken;
          setOtpUiState("verified");
          await enterAfterOtpStageIfNeeded();
        }
      }

      try {
        await init();
      } catch (e) {
        showError(`初期化エラー: ${(e && e.message) ? e.message : e}`);
      }
    });
  </script>

  <!-- ▼ includeエンジン（data-include と include-html 両対応） -->
  <script>
    (async () => {
      try {
        const targets = document.querySelectorAll('[data-include],[include-html]');
        for (const el of targets) {
          const url = el.getAttribute('data-include') || el.getAttribute('include-html');
          if (!url) continue;

          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`include failed: ${url} (${res.status})`);

          const buf = await res.arrayBuffer();
          const html = new TextDecoder('utf-8').decode(buf);
          el.outerHTML = html;
        }
      } catch (e) {
        console.error('include loader error:', e);
      }
    })();
  </script>
</body>
</html>
