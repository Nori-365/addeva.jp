<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,nofollow">

  <title>ユーザー意見管理｜ADDEVA サポート</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    /* dev_approval.html に合わせつつ、ユーザー用に最小限の差分 */
    #messageArea { overflow-anchor: none; }

    .row-clickable { cursor: pointer; }
    .row-clickable:hover { background: rgba(13,110,253,.04); }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .sticky-pane {
      position: sticky;
      top: 86px; /* fixed header を想定 */
    }

    .textarea-readonly { background: #f8f9fa; }

    .char-hint { font-size: .85rem; color: #6c757d; }

    @media (max-width: 991.98px) {
      .sticky-pane { position: static; top: auto; }
    }

    @media (max-width: 767.98px) {
      .col-hide-sm { display: none !important; }
    }

    @media (min-width: 992px) {
      .panel-scroll {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        overscroll-behavior: contain;
      }
    }
  </style>
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header fixed-top" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container">

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item"><a href="/customer.html">ユーザーサポート</a></li>
            <li class="breadcrumb-item d-none" id="breadcrumbBoardItem"><a id="breadcrumbBoard" href="#">フィードバックボード</a></li>
            <li class="breadcrumb-item active" aria-current="page">ユーザー意見管理</li>
          </ol>
        </nav>

        <!-- 右上アクション（デベロッパー管理＋自分の意見管理＋ログアウト） -->
        <div id="feedbackTopBar" class="d-flex justify-content-end align-items-center gap-2 mb-2">
          <a id="developerButtonTop" class="btn btn-outline-primary btn-sm d-none" href="#" role="button">
            <i class="bi bi-gear me-1"></i>デベロッパー管理
          </a>
          <span id="opinionManageButtonTop" class="btn btn-outline-secondary btn-sm disabled" role="button" aria-disabled="true" aria-current="page" tabindex="-1">
            <i class="bi bi-card-checklist me-1"></i>自分の意見管理
          </span>
          <button id="logoutButtonTop" class="btn btn-outline-secondary btn-sm" type="button">
            <i class="bi bi-box-arrow-right me-1"></i>ログアウト
          </button>
        </div>

        <!-- メッセージ表示エリア（汎用 alert） -->
        <div id="messageArea" class="alert d-none" role="alert" aria-live="polite" aria-atomic="true">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div id="messageText" class="flex-grow-1"></div>
            <button type="button" class="btn-close" aria-label="閉じる" id="messageCloseBtn"></button>
          </div>
        </div>

        <!-- ▼ 未読のデベロッパー返信（ページ上部のまとめ通知：常時表示枠） -->
        <div id="devReplyGlobalNotice" class="d-none mb-3 p-3 bg-light border rounded border-start border-3 border-primary" aria-live="polite" aria-atomic="true">
          <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
            <div class="flex-grow-1">
              <div class="fw-bold" style="font-size: 1.25rem; line-height: 1.35;">
                開発者から返信があります
                <span id="devReplyGlobalCountBadge" class="badge bg-danger ms-2">0</span>
              </div>
              <div class="text-secondary small mt-1">未読の返信（最新3件）</div>
              <div id="devReplyGlobalList" class="mt-2"></div>
            </div>
          </div>
        </div>

        <!-- ページヘッダー -->
        <div class="mb-4">
          <div id="introMessage" class="mb-3 p-3 bg-light border rounded border-start border-3 border-primary">
            <div class="fw-bold" style="font-size: 1.4rem; line-height: 1.35;">あなたが投稿した意見を一覧で確認し、原文（title/body/part 等）を修正できます。</div>
            <div class="mt-1 text-secondary">
              公開表示は public_* を参照します。公開されるのは「あなたの visibility=public」かつ「デベロッパー側 visibility_dev=public」の投稿のみです。開発者がまだ審査・公開していない間は、あなたが原文を修正しても status は new のままです。開発者の審査・公開後に原文を修正した場合は status が updated になり、再承認が必要です。
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <h1 class="mb-1">ユーザー意見管理</h1>
              <div class="text-secondary">
                投稿数：<span id="postTotal" class="fw-semibold">-</span> 件 ／ 対象商品：<span id="productCount" class="fw-semibold">-</span> 件
                <span class="ms-2 small" id="loginBadgeWrap" style="display:none;">
                  <span class="badge bg-success-subtle text-success border border-success-subtle">Login: <span id="loginEmail">-</span></span>
                </span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <button id="btnReload" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> 更新
              </button>
              <button id="btnScrollToDetail" class="btn btn-outline-secondary" disabled>
                <i class="bi bi-box-arrow-in-down"></i> 詳細へ
              </button>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <!-- 左：投稿一覧 -->
          <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
              <div class="card-body p-4 panel-scroll" id="leftPanelScroll">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                  <div>
                    <div class="h5 m-0">あなたの投稿一覧（商品別）</div>
                    <div class="text-secondary small">行をクリックすると右側に詳細（編集フォーム）を表示します。</div>
                  </div>
                  <div class="text-secondary small" id="leftHint"></div>
                </div>

                <div id="productAccordion" class="accordion">
                  <div class="text-center text-secondary py-4">読み込み中...</div>
                </div>

              </div>
            </div>
          </div>

          <!-- 右：詳細／原文編集 -->
          <div class="col-12 col-lg-6">
            <div class="sticky-pane">
              <div class="card shadow-sm">
                <div class="card-body p-4 panel-scroll" id="rightPanelScroll">


                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3" id="detailHeader">
                    <div>
                      <div class="h5 m-0">意見詳細</div>
                    </div>
                    <div class="text-secondary small">
                      <span id="detailMeta">未選択</span>
                    </div>
                  </div>

                  <!-- ▼ デベロッパー返信（未読時：この位置に常時表示／既読にするまで消えない） -->
                  <div id="devReplyTopNotice" class="d-none mb-3 p-3 bg-light border rounded border-start border-3 border-primary">
                    <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
                      <div class="flex-grow-1">
                        <div class="fw-bold" style="font-size: 1.25rem; line-height: 1.35;">
                          開発者から返信があります
                          <span id="devReplyTopUnreadBadge" class="badge bg-danger ms-2">未読</span>
                        </div>
                        <div id="devReplyTopMeta" class="mt-1 text-secondary small"></div>
                        <div id="devReplyTopBody" class="mt-2" style="white-space: pre-wrap;"></div>
                      </div>

                      <div class="d-flex align-items-center gap-2">
                        <button id="btnDevReplyGoDetail" class="btn btn-outline-primary btn-sm" type="button">
                          <i class="bi bi-chat-dots me-1"></i>返信を見る
                        </button>
                        <button id="btnDevReplyMarkRead" class="btn btn-primary btn-sm" type="button">
                          <i class="bi bi-check2-circle me-1"></i>既読にする
                        </button>
                      </div>
                    </div>
                  </div>

                  <div id="detailEmpty" class="text-secondary">
                    左の一覧から意見を選択してください。
                  </div>

                  <div id="detailWrap" class="d-none">

                    <!-- 原文（編集可） -->
                    <div class="border rounded p-3 mb-3">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">あなたの原文（編集可）</div>
                        <div class="text-secondary small d-flex align-items-center justify-content-end flex-wrap gap-2">
                          <label class="me-1" for="visibility"><span class="d-none d-sm-inline">公開設定</span></label>
                          <select id="visibility" class="form-select form-select-sm d-inline-block" style="width:auto;">
                            <option value="public">public（公開）</option>
                            <option value="private">private（非公開）</option>
                          </select>

                          <label class="me-1 ms-2" for="postType">タイプ</label>
                          <select id="postType" class="form-select form-select-sm d-inline-block" style="width:auto;">
                            <option value="improve">改善</option>
                            <option value="praise">良かった点</option>
                            <option value="guide">ガイド要望</option>
                          </select>
                        </div>
                      </div>

                      <div class="text-secondary small mt-1">private の投稿は他ユーザーには表示されません（投票対象にもなりません）。</div>

                      <hr class="my-3">

                      <div class="mb-3">
                        <div class="small text-secondary">部位（固定）</div>
                        <div class="mono" id="originalPartText">-</div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label" for="title">タイトル</label>
                        <input id="title" class="form-control" type="text" maxlength="200">
                        <div class="d-flex justify-content-end">
                          <div class="char-hint"><span id="titleCount">0</span>/200</div>
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label" for="body">本文</label>
                        <textarea id="body" class="form-control" rows="14"></textarea>
                      </div>

                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <button id="btnCancel" class="btn btn-danger" type="button">
                          <i class="bi bi-x-octagon"></i> 意見を取消
                        </button>

                        <button id="btnSave" class="btn btn-primary" type="button">
                          <i class="bi bi-save"></i> 更新する
                        </button>
                      </div>

                      <div class="text-secondary small mt-2">
                        <div>※部位の変更はできません。部位を変更する場合は「意見を取消」後に、正しい部位で投稿してください。</div>
                        <div>※公開されたご意見の場合、修正しても審査が完了するまでは反映されません。</div>
                      </div>
                    </div>

                    <!-- ▼ デベロッパー返信（返信が無い場合は非表示） -->
                    <div class="border rounded p-3 mb-3" id="devReplyPanel" style="display:none;">
                      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="fw-semibold">デベロッパー返信</div>
                        <div class="d-flex align-items-center gap-2">
                          <span id="devReplyUnreadBadge" class="badge bg-danger d-none">未読</span>
                          <button id="btnDevReplyMarkReadInPanel" class="btn btn-outline-primary btn-sm" type="button" disabled>
                            <i class="bi bi-check2-circle me-1"></i>既読にする
                          </button>
                        </div>
                      </div>
                      <div id="devReplyMeta" class="text-secondary small mt-1"></div>
                      <textarea id="devCommentText" class="form-control textarea-readonly mt-2" rows="7" readonly></textarea>
                    </div>

                    <!-- 公開情報 -->
                    <div class="border rounded p-3 mb-3 bg-light" id="publicInfoPanel" style="display:none;">
                      <div class="fw-semibold mb-2">公開情報</div>

                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <div class="small text-secondary">status（審査状態）</div>
                          <div class="mono" id="statusText">-</div>
                        </div>
                        <div class="col-12 col-md-6">
                          <div class="small text-secondary">公開可否</div>
                          <div class="mono" id="publicAllowedText">-</div>
                        </div>
                      </div>
                    </div>

                    <!-- 内容（公開） -->
                    <div class="border rounded p-3" id="publicContentPanel" style="display:none;">
                      <div class="fw-semibold">内容</div>

                      <div class="mt-3">
                        <div class="small text-secondary">部位（公開）</div>
                        <div class="mono" id="publicPartText">-</div>
                      </div>

                      <div class="mt-2">
                        <div class="small text-secondary">タイトル（公開）</div>
                        <input id="publicTitle" class="form-control textarea-readonly" type="text" readonly>
                      </div>

                      <div class="mt-2">
                        <div class="small text-secondary">本文（公開）</div>
                        <textarea id="publicBody" class="form-control textarea-readonly" rows="10" readonly></textarea>
                      </div>
                    </div>

                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/common.js"></script>

  <script>
    // === ユーティリティ ===
    const qs = name => new URL(window.location.href).searchParams.get(name) || '';
    const el = (id) => document.getElementById(id);

    const escapeHtml = (s) => {
      return String(s ?? '').replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[c]));
    };

    const fmtDateTime = (iso) => {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return String(iso);
        return d.toLocaleString();
      } catch {
        return String(iso);
      }
    };

    const parseDate = (iso) => {
      if (!iso) return null;
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return null;
        return d;
      } catch {
        return null;
      }
    };

    // 初期表示の説明（青枠）は、初回だけ表示（以降は非表示にする）
    const hideIntroMessage = () => {
      const intro = el('introMessage');
      if (intro) intro.classList.add('d-none');
    };

    // alert（メッセージ）は「自動で消さない」方針
    // ・成功/失敗/警告いずれも、ユーザーが × を押すか、次のメッセージで上書きされるまで表示する
    const clearAlert = (_force = false) => {
      const box = el('messageArea');
      const text = el('messageText');
      if (!box || !text) return;
      box.className = 'alert d-none';
      text.textContent = '';
    };

    const showAlert = (type, msg) => {
      const box = el('messageArea');
      const text = el('messageText');
      if (!box || !text) return;

      const klass = (type === 'success') ? 'alert-success'
                  : (type === 'warning') ? 'alert-warning'
                  : (type === 'info') ? 'alert-info'
                  : 'alert-danger';

      box.className = 'alert ' + klass;
      text.textContent = msg || '';

      // クリックで閉じる
      el('messageCloseBtn')?.addEventListener('click', () => clearAlert(true), { once: true });

      hideIntroMessage();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const buildBoardUrl = (productCode) => {
      const p = encodeURIComponent(productCode || '');
      return `/feedback_board.html?product_code=${p}`;
    };

    // 右上「デベロッパー管理」表示判定（customer.html と同じ考え方：対象product_codeを順に試す）
    async function findDeveloperProductCode(productCodes) {
      try {
        const uniq = Array.from(new Set((productCodes || []).map(v => String(v || '').trim()).filter(Boolean)));
        for (const code of uniq) {
          try {
            const res = await ADDEVA.apiFetch('/api/addeva/feedback_board/developer_status', {
              method: 'POST',
              body: { productCode: code }
            });
            if (res && res.is_developer) {
              return String(code);
            }
          } catch (_) {
            // 権限なし/未ログイン/通信失敗は静かに無視
          }
        }
      } catch (_) {}
      return '';
    }

    async function loadDeveloperTopButton(productCodes) {
      const devBtn = document.getElementById('developerButtonTop');
      if (devBtn) {
        devBtn.classList.add('d-none');
        devBtn.setAttribute('href', '#');
      }

      const devProductCode = await findDeveloperProductCode(productCodes);
      if (devProductCode && devBtn) {
        // パンくずには出さない（右上ボタンのみ）
        devBtn.href = '/dev_approval.html';
        devBtn.classList.remove('d-none');
      }
    }

    // === 状態 ===
    const focusProductCode = (qs('product_code') || '').trim();

    let me = null; // { customer_id, email, nickname }

    // dashboard から
    let products = []; // [{product_code, product_name}]
    let postsByProduct = new Map(); // product_code => posts[]
    let postTotal = 0;

    // 詳細
    let selectedPostId = null;
    let selectedProductCode = '';
    let selectedPost = null;

    // === dev_comment（デベロッパー返信） ===
    const hasDevComment = (post) => {
      const t = String(post?.dev_comment ?? post?.devComment ?? '').trim();
      return Boolean(t);
    };

    const isDevCommentUnread = (post) => {
      if (!hasDevComment(post)) return false;
      const readAt = post?.dev_comment_read_at ?? post?.devCommentReadAt ?? null;
      const updAt = post?.dev_comment_updated_at ?? post?.devCommentUpdatedAt ?? null;

      // 1) read_at が NULL なら未読
      if (!readAt) return true;

      // 2) updated_at が read_at より新しければ未読
      const dRead = parseDate(readAt);
      const dUpd = parseDate(updAt);
      if (!dRead) return true;           // read_at が壊れているなら安全側（未読）
      if (!dUpd) return false;           // updated_at が無いなら「既読済み」を優先
      return dUpd.getTime() > dRead.getTime();
    };

    // API が is_dev_comment_unread を返す場合は、それを最優先（dashboardの一覧では dev_comment 本文が無い場合がある）
    const getIsDevCommentUnread = (post) => {
      if (!post) return false;
      if (typeof post.is_dev_comment_unread === 'boolean') return post.is_dev_comment_unread;
      if (typeof post.isDevCommentUnread === 'boolean') return post.isDevCommentUnread;
      return isDevCommentUnread(post);
    };

    const hideDevReplyTopNotice = () => {
      const box = el('devReplyTopNotice');
      if (box) box.classList.add('d-none');
      el('devReplyTopMeta') && (el('devReplyTopMeta').textContent = '');
      el('devReplyTopBody') && (el('devReplyTopBody').textContent = '');
    };

    const patchPostEverywhere = (postId, patch) => {
      const pid = Number(postId || 0);
      if (!pid) return;

      if (selectedPost && Number(selectedPost.post_id || 0) === pid) {
        try { Object.assign(selectedPost, patch || {}); } catch (_) {}
      }

      try {
        for (const [code, arr] of postsByProduct.entries()) {
          if (!Array.isArray(arr)) continue;
          for (const it of arr) {
            const itId = Number(it?.post_id ?? it?.postId ?? 0);
            if (itId === pid) {
              try { Object.assign(it, patch || {}); } catch (_) {}
            }
          }
        }
      } catch (_) {}
    };

    const computeUnreadPosts = () => {
      const list = [];
      try {
        for (const [pCode, arr] of postsByProduct.entries()) {
          const items = Array.isArray(arr) ? arr : [];
          for (const it of items) {
            if (!it) continue;
            const pid = Number(it.post_id ?? it.postId ?? 0);
            if (!pid) continue;
            if (!getIsDevCommentUnread(it)) continue;

            const productCode = String(it.product_code || it.productCode || pCode || '');
            const title = String(it.title || it.original_title || it.public_title || '');
            const updAt = it.dev_comment_updated_at ?? it.devCommentUpdatedAt ?? it.updated_at ?? it.updatedAt ?? it.created_at ?? it.createdAt ?? null;
            const ms = parseDate(updAt)?.getTime() || 0;

            list.push({
              postId: pid,
              productCode,
              title,
              ms,
            });
          }
        }
      } catch (_) {}

      list.sort((a, b) => {
        const d = (Number(b.ms || 0) - Number(a.ms || 0));
        if (d !== 0) return d;
        return Number(b.postId || 0) - Number(a.postId || 0);
      });

      return list;
    };

    const renderGlobalDevReplyNotice = () => {
      const box = el('devReplyGlobalNotice');
      const badge = el('devReplyGlobalCountBadge');
      const listEl = el('devReplyGlobalList');
      if (!box || !badge || !listEl) return;

      const unread = computeUnreadPosts();
      const count = unread.length;

      if (!count) {
        box.classList.add('d-none');
        badge.textContent = '0';
        listEl.innerHTML = '';
        return;
      }

      box.classList.remove('d-none');
      badge.textContent = String(count);

      const top3 = unread.slice(0, 3);
      let html = '';
      for (const u of top3) {
        const title = (String(u.title || '').trim()) ? String(u.title || '').trim() : '（タイトルなし）';
        html += `
          <div class="mb-1">
            <span class="text-truncate d-inline-block align-middle" style="max-width: 36rem; vertical-align: middle;">ID ${escapeHtml(u.postId)}：${escapeHtml(title)}</span>
            <button type="button" class="btn btn-outline-primary btn-sm py-0 px-2 ms-2 align-baseline" data-action="open-unread-post" data-post-id="${escapeHtml(u.postId)}" data-product-code="${escapeHtml(u.productCode)}">詳しく見る</button>
          </div>
        `;
      }

      if (count > 3) {
        html += `<div class="text-secondary small mt-1">ほか ${escapeHtml(count - 3)} 件（左の一覧に「未読」バッジで表示）</div>`;
      }

      listEl.innerHTML = html;
    };

    const renderDevReplyPanels = () => {
      // 詳細未選択時は非表示
      if (!selectedPost) {
        hideDevReplyTopNotice();
        const p = el('devReplyPanel');
        if (p) p.style.display = 'none';
        return;
      }

      const devText = String(selectedPost.dev_comment ?? selectedPost.devComment ?? '').trim();
      const hasText = Boolean(devText);

      // 返信ブロック（右ペイン指定位置）
      const panel = el('devReplyPanel');
      if (panel) {
        if (!hasText) {
          panel.style.display = 'none';
          const btnPanel = el('btnDevReplyMarkReadInPanel');
          if (btnPanel) btnPanel.disabled = true;
        } else {
          panel.style.display = '';
          el('devCommentText') && (el('devCommentText').value = devText);

          const updAt = selectedPost.dev_comment_updated_at ?? selectedPost.devCommentUpdatedAt ?? null;
          const readAt = selectedPost.dev_comment_read_at ?? selectedPost.devCommentReadAt ?? null;

          const metaParts = [];
          if (updAt) metaParts.push('返信日時: ' + fmtDateTime(updAt));
          if (readAt) metaParts.push('既読日時: ' + fmtDateTime(readAt));
          el('devReplyMeta') && (el('devReplyMeta').textContent = metaParts.join(' / '));

          const unread = getIsDevCommentUnread(selectedPost);
          const badge = el('devReplyUnreadBadge');
          if (badge) badge.classList.toggle('d-none', !unread);

          const btnPanel = el('btnDevReplyMarkReadInPanel');
          if (btnPanel) btnPanel.disabled = !unread;
        }
      }

      // Top 通知（未読時のみ）
      if (hasText && getIsDevCommentUnread(selectedPost)) {
        const top = el('devReplyTopNotice');
        top && top.classList.remove('d-none');

        const updAt = selectedPost.dev_comment_updated_at ?? selectedPost.devCommentUpdatedAt ?? null;
        el('devReplyTopMeta') && (el('devReplyTopMeta').textContent = updAt ? ('返信日時: ' + fmtDateTime(updAt)) : '');

        // 長文でも読めるように、Top は本文をそのまま表示（改行保持）
        el('devReplyTopBody') && (el('devReplyTopBody').textContent = devText);
      } else {
        hideDevReplyTopNotice();
      }
    };

    const markDevCommentRead = async () => {
      if (!selectedPost || !selectedPost.post_id) return;
      if (!hasDevComment(selectedPost)) return;

      const postId = Number(selectedPost.post_id);
      const topBtn = el('btnDevReplyMarkRead');
      const panelBtn = el('btnDevReplyMarkReadInPanel');
      if (topBtn) topBtn.disabled = true;
      if (panelBtn) panelBtn.disabled = true;

      try {
        const res = await ADDEVA.apiFetch('/api/addeva/user_opinion/mark_dev_comment_read', {
          method: 'POST',
          body: { postId }
        });

        // 期待：res.dev_comment_read_at または res.devCommentReadAt
        const readAt = (res && (res.dev_comment_read_at ?? res.devCommentReadAt)) ? (res.dev_comment_read_at ?? res.devCommentReadAt) : null;
        const readIso = readAt || new Date().toISOString();

        patchPostEverywhere(postId, {
          dev_comment_read_at: readIso,
          devCommentReadAt: readIso,
          is_dev_comment_unread: false,
          isDevCommentUnread: false,
        });

        renderDevReplyPanels();
        renderProducts();
        renderGlobalDevReplyNotice();
        showAlert('success', '既読にしました。');

      } catch (e) {
        console.error(e);
        showAlert('danger', e && e.message ? e.message : '既読更新に失敗しました。');
      } finally {
        const unread = selectedPost ? getIsDevCommentUnread(selectedPost) : false;
        if (topBtn) topBtn.disabled = !unread;
        if (panelBtn) panelBtn.disabled = !unread;
      }
    };

    // === UI：文字数カウント ===
    const bindCharCount = () => {
      const title = el('title');
      const titleCount = el('titleCount');

      const update = () => {
        if (title && titleCount) titleCount.textContent = String((title.value || '').length);
      };

      title?.addEventListener('input', update);
      update();
    };

    const renderHeaderSummary = () => {
      el('postTotal') && (el('postTotal').textContent = String(postTotal));
      el('productCount') && (el('productCount').textContent = String(products.length));

      const hint = el('leftHint');
      if (hint) {
        hint.textContent = products.length ? ('商品数：' + String(products.length)) : '';
      }

      const wrap = el('loginBadgeWrap');
      if (wrap) {
        if (me && me.email) {
          wrap.style.display = '';
          el('loginEmail') && (el('loginEmail').textContent = String(me.email));
        } else {
          wrap.style.display = 'none';
        }
      }

      const bcItem = el('breadcrumbBoardItem');
      const bcLink = el('breadcrumbBoard');
      if (bcItem && bcLink) {
        if (focusProductCode) {
          bcLink.href = buildBoardUrl(focusProductCode);
          bcItem.classList.remove('d-none');
        } else {
          bcItem.classList.add('d-none');
        }
      }
    };

    const renderProducts = () => {
      const acc = el('productAccordion');
      if (!acc) return;

      if (!products.length) {
        acc.innerHTML = '<div class="text-center text-secondary py-4">投稿がありません。</div>';
        return;
      }

      let html = '';

      for (let i = 0; i < products.length; i++) {
        const p = products[i];
        const code = String(p.product_code || '');
        const name = String(p.product_name || '');
        const items = postsByProduct.get(code) || [];

        const headingId = 'heading_' + i;
        const collapseId = 'collapse_' + i;

        const count = items.length;
        const badge = count
          ? `<span class="badge bg-primary-subtle text-primary border border-primary-subtle ms-2">${count}</span>`
          : `<span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle ms-2">0</span>`;

        // 表示：対象がある商品は展開。focusProductCode があればその商品も展開。
        const isShow = (count > 0) || (focusProductCode && focusProductCode === code);
        const expanded = isShow ? 'true' : 'false';
        const showClass = isShow ? 'show' : '';
        const collapsedClass = isShow ? '' : 'collapsed';

        let bodyHtml = '';
        if (!count) {
          bodyHtml = '<div class="text-secondary">この商品の投稿はありません。</div>';
        } else {
          let rows = '';
          for (const it of items) {
            const postId = it.post_id;
            const stRaw = String(it.status || '-');
            const stLc = stRaw.toLowerCase();

            // デベロッパー側（参考）：status_dev / visibility_dev（返ってくる場合のみ表示）
            const stDevRaw = String(it.status_dev || it.statusDev || '');
            const visDevRaw = String(it.visibility_dev || it.visibilityDev || '');

            const approvedAtRaw = String(it.approved_at || it.approvedAt || '');
            const hasPublic = Boolean(it.public_title || it.publicTitle || it.public_body || it.publicBody || it.public_part_code || it.publicPartCode);
            const hasDevTouched = Boolean(approvedAtRaw) || Boolean(stDevRaw) || Boolean(visDevRaw) || hasPublic;

            let stDisp = stRaw;
            if (stLc === 'updated' && !hasDevTouched) stDisp = 'new';
            const stDispLc = String(stDisp || '').toLowerCase();

            let stBadgeClass = 'bg-secondary-subtle text-secondary border border-secondary-subtle';
            if (stDispLc === 'new') stBadgeClass = 'bg-warning text-dark';
            else if (stDispLc === 'updated') stBadgeClass = 'bg-warning text-dark';
            else if (stDispLc === 'done') stBadgeClass = 'bg-info-subtle text-info border border-info-subtle';

            const stBadge = `<span class="badge ${stBadgeClass} ms-2 align-middle">${escapeHtml(stDisp)}</span>`;

            let devBadges = '';
            const stDevLc = stDevRaw.toLowerCase();
            let stDevLabel = stDevRaw;
            if (stDevLc === 'reviewing') stDevLabel = '確認中';
            else if (stDevLc === 'planned') stDevLabel = '対応予定';
            else if (stDevLc === 'shipped') stDevLabel = '対応済み';
            else if (stDevLc === 'rejected') stDevLabel = '不採用';

            const visDevLc = String(visDevRaw || '').toLowerCase();
            const devVisLabel = (visDevLc === 'public') ? '公開'
                              : (visDevLc === 'private') ? '非公開'
                              : '';

            if (stDevRaw && stDevLc === 'reviewing') {
              devBadges += `<span class="badge bg-light text-dark border ms-2 align-middle">${escapeHtml(stDevLabel)}</span>`;
            } else if (devVisLabel) {
              devBadges += `<span class="badge bg-light text-dark border ms-2 align-middle">${escapeHtml(devVisLabel)}</span>`;
            } else if (stDevRaw) {
              devBadges += `<span class="badge bg-light text-dark border ms-2 align-middle">${escapeHtml(stDevLabel)}</span>`;
            }

            const vis = String(it.visibility || 'public');
            const visBadge = vis === 'private'
              ? '<span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle ms-2 align-middle">private</span>'
              : '<span class="badge bg-primary-subtle text-primary border border-primary-subtle ms-2 align-middle">public</span>';

            let pt = String(it.post_type || it.postType || '').toLowerCase();
            if (pt === 'good') pt = 'praise';

            let typeLabel = '';
            let typeBadgeClass = 'bg-secondary-subtle text-secondary border border-secondary-subtle';
            if (pt === 'improve') { typeLabel = '改善'; typeBadgeClass = 'bg-danger-subtle text-danger border border-danger-subtle'; }
            else if (pt === 'praise') { typeLabel = 'Good'; typeBadgeClass = 'bg-success-subtle text-success border border-success-subtle'; }
            else if (pt === 'guide') { typeLabel = 'ガイド'; typeBadgeClass = 'bg-info-subtle text-info border border-info-subtle'; }

            const typeBadge = typeLabel
              ? `<span class="badge ${typeBadgeClass} ms-2 align-middle">${escapeHtml(typeLabel)}</span>`
              : '';

            const title = it.title || '';

            const partCode = String(it.part_code || it.partCode || '');
            const partNameJa = String(it.part_name_ja || it.partNameJa || '');
            const partFree = String(it.part_free_text || it.partFreeText || '');

            let partLabel = '';
            if (partCode) {
              partLabel = partNameJa ? partNameJa : partCode;
            } else {
              partLabel = partFree || '';
            }

            const updatedAt = fmtDateTime(it.updated_at || it.created_at || '');
            const isActive = (selectedPostId && Number(selectedPostId) === Number(postId));

            const unreadBadge = getIsDevCommentUnread(it)
              ? '<span class="badge bg-danger ms-2 align-middle">未読</span>'
              : '';

            rows += `
              <tr class="row-clickable ${isActive ? 'table-primary' : ''}" data-post-id="${escapeHtml(postId)}" data-product-code="${escapeHtml(code)}">
                <td class="mono text-nowrap">${escapeHtml(postId)}</td>
                <td>
                  <div class="small text-secondary text-truncate" style="max-width: 26rem;">
                    <span>${escapeHtml(partLabel)}</span>${stBadge}${visBadge}
                  </div>
                  <div class="fw-semibold text-truncate" style="max-width: 26rem;">
                    ${escapeHtml(title)}${typeBadge}${devBadges}${unreadBadge}
                  </div>
                </td>
                <td class="col-hide-sm"><span class="text-secondary small">${escapeHtml(updatedAt)}</span></td>
              </tr>
            `;
          }

          bodyHtml = `
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <div>
                <span class="fw-semibold">${escapeHtml(name || code || '-')}</span>
                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle fw-normal ms-2">${escapeHtml(code)}</span>
              </div>
              <div>
                <a class="btn btn-sm btn-outline-secondary" href="${escapeHtml(buildBoardUrl(code))}">フィードバックボード</a>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th class="text-nowrap" style="width:4.4rem;">ID</th>
                    <th class="text-center">意見</th>
                    <th class="col-hide-sm text-nowrap" style="width:11.5rem;">更新日時</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          `;
        }

        const safeName = name ? escapeHtml(name) : '<span class="text-secondary small ms-2">（商品名未設定）</span>';

        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="${escapeHtml(headingId)}">
              <button class="accordion-button ${collapsedClass}" type="button" data-product-code="${escapeHtml(code)}" data-bs-toggle="collapse" data-bs-target="#${escapeHtml(collapseId)}" aria-expanded="${expanded}" aria-controls="${escapeHtml(collapseId)}">
                <span class="mono me-2">${escapeHtml(code)}</span>
                <span class="me-2">${safeName}</span>
                ${badge}
              </button>
            </h2>
            <div id="${escapeHtml(collapseId)}" class="accordion-collapse collapse ${showClass}" aria-labelledby="${escapeHtml(headingId)}">
              <div class="accordion-body">
                ${bodyHtml}
              </div>
            </div>
          </div>
        `;
      }

      acc.innerHTML = html;

      acc.querySelectorAll('tr.row-clickable').forEach(tr => {
        tr.addEventListener('click', async () => {
          const postId = tr.getAttribute('data-post-id');
          const pc = tr.getAttribute('data-product-code') || '';
          if (!postId) return;
          await loadPostDetail(Number(postId), String(pc));
          renderProducts();
          renderGlobalDevReplyNotice();
        });
      });
    };

    const renderDetail = () => {
      const empty = el('detailEmpty');
      const wrap = el('detailWrap');
      const meta = el('detailMeta');
      const btnScroll = el('btnScrollToDetail');

      if (!selectedPost) {
        empty && empty.classList.remove('d-none');
        wrap && wrap.classList.add('d-none');
        meta && (meta.textContent = '未選択');
        btnScroll && (btnScroll.disabled = true);
        hideDevReplyTopNotice();
        const p = el('devReplyPanel');
        if (p) p.style.display = 'none';
        return;
      }

      empty && empty.classList.add('d-none');
      wrap && wrap.classList.remove('d-none');
      btnScroll && (btnScroll.disabled = false);

      {
        const codeForMeta = String(selectedPost.product_code || selectedProductCode || '');
        const pForMeta = products.find(x => String(x.product_code || '') === codeForMeta);
        const nameForMeta = pForMeta ? String(pForMeta.product_name || '') : '';
        const updatedForMeta = fmtDateTime(selectedPost.updated_at || '');
        const parts = [`ID: ${selectedPost.post_id}`];
        if (nameForMeta) parts.push(nameForMeta);
        if (codeForMeta) parts.push(codeForMeta);
        if (updatedForMeta) parts.push(`更新: ${updatedForMeta}`);
        meta && (meta.textContent = parts.join(' / '));
      }

      // status 表示（開発者がまだ審査・公開していない間は new のまま）
      const statusRaw = String(selectedPost.status || '-');
      const statusLc = statusRaw.toLowerCase();
      const stDevForStatus = String(selectedPost.status_dev || selectedPost.statusDev || '').toLowerCase();
      const visDevForStatus = String(selectedPost.visibility_dev || selectedPost.visibilityDev || '').toLowerCase();
      const approvedAtForStatus = String(selectedPost.approved_at || selectedPost.approvedAt || '');
      const hasPublicForStatus = Boolean(selectedPost.public_title || selectedPost.publicTitle || selectedPost.public_body || selectedPost.publicBody || selectedPost.public_part_code || selectedPost.publicPartCode);
      const hasDevTouchedForStatus = Boolean(approvedAtForStatus) || Boolean(stDevForStatus) || Boolean(visDevForStatus) || hasPublicForStatus;

      let statusDisp = statusRaw;
      if (statusLc === 'updated' && !hasDevTouchedForStatus) statusDisp = 'new';

      const statusDispLc = String(statusDisp || '').toLowerCase();
      const statusDispJa =
        (statusDispLc === 'new') ? '審査中' :
        (statusDispLc === 'updated') ? '再審査中' :
        (statusDispLc === 'done') ? '審査完了' :
        (statusDispLc === 'cancel') ? '取消' :
        (statusDispLc === 'delete') ? '取消' :
        statusDisp;

      el('statusText') && (el('statusText').textContent = statusDispJa);

      // 公開可否（NULL は未設定として扱う）
      const userVisLc = String(selectedPost.visibility || 'public').toLowerCase();
      const devVisLc = visDevForStatus;
      let allowed = '非公開';
      if (!devVisLc) {
        allowed = '未設定';
      } else {
        allowed = (userVisLc === 'public' && devVisLc === 'public') ? '公開' : '非公開';
      }
      el('publicAllowedText') && (el('publicAllowedText').textContent = allowed);

      // 「ユーザーが非公開 かつ デベロッパーも非公開」のときのみ、公開情報は非表示
      const publicInfoPanel = el('publicInfoPanel');
      if (publicInfoPanel) {
        const hidePanel = (userVisLc === 'private' && devVisLc === 'private');
        publicInfoPanel.style.display = hidePanel ? 'none' : '';
      }

      const vis = String(selectedPost.visibility || 'public');
      el('visibility') && (el('visibility').value = vis);

      let pt = String(selectedPost.post_type || 'improve');
      if (pt === 'good') pt = 'praise';
      el('postType') && (el('postType').value = pt);

      // 原文
      el('title') && (el('title').value = String(selectedPost.title || ''));
      el('body') && (el('body').value = String(selectedPost.body || ''));

      const partCode = String(selectedPost.part_code || '');
      const partNameJa = String(selectedPost.part_name_ja || selectedPost.partNameJa || '');
      const partFree = String(selectedPost.part_free_text || selectedPost.partFreeText || '');

      let partDisp = '-';
      if (partCode) {
        partDisp = partNameJa ? partNameJa : partCode;
      } else if (partFree) {
        partDisp = partFree;
      }
      el('originalPartText') && (el('originalPartText').textContent = String(partDisp));

      // 公開内容（参照）
      el('publicTitle') && (el('publicTitle').value = String(selectedPost.public_title || ''));
      el('publicBody') && (el('publicBody').value = String(selectedPost.public_body || ''));

      const pubPartCode = String(selectedPost.public_part_code || selectedPost.publicPartCode || '');
      const pubPartNameJa = String(selectedPost.public_part_name_ja || selectedPost.publicPartNameJa || '');

      let pubPartDisp = '-';
      if (pubPartCode) {
        pubPartDisp = pubPartNameJa ? pubPartNameJa : pubPartCode;
      }
      el('publicPartText') && (el('publicPartText').textContent = String(pubPartDisp || '-'));

      // 「内容（公開）」は public_* が存在するときだけ表示
      const publicContentPanel = el('publicContentPanel');
      if (publicContentPanel) {
        const hasPublic = Boolean(pubPartCode)
          || Boolean(String(selectedPost.public_title || '').trim())
          || Boolean(String(selectedPost.public_body || '').trim());
        publicContentPanel.style.display = hasPublic ? '' : 'none';
      }

      // デベロッパー返信
      renderDevReplyPanels();

      bindCharCount();
    };

    // === API ===
    const loadMe = async () => {
      try {
        const res = await ADDEVA.apiFetch('/api/addeva/customer/me', { method: 'GET' });
        me = res || null;
      } catch (e) {
        me = null;
      }
    };

    const loadDashboard = async (opts = {}) => {
      const acc = el('productAccordion');
      acc && (acc.innerHTML = '<div class="text-center text-secondary py-4">読み込み中...</div>');

      try {
        // JWT が無い場合は common.js の挙動に任せる
        try {
          const token = (window.ADDEVA && ADDEVA.LS && ADDEVA.LS.authToken) ? (localStorage.getItem(ADDEVA.LS.authToken) || '') : '';
          if (!token || (typeof ADDEVA.isJwtExpired === 'function' && ADDEVA.isJwtExpired(token))) {
            if (window.ADDEVA && typeof ADDEVA._handleAuthFailure === 'function') {
              ADDEVA._handleAuthFailure('startup: token missing/expired');
              return;
            }
          }
        } catch (_) {}

        await loadMe();

        const res = await ADDEVA.apiFetch('/api/addeva/user_opinion/dashboard', {
          method: 'POST',
          body: {
            focusProductCode: focusProductCode || null
          }
        });

        const rawProducts = (res && res.products) ? res.products : [];
        products = (Array.isArray(rawProducts) ? rawProducts : []).map(v => ({
          product_code: String(v.product_code || v.productCode || ''),
          product_name: String(v.product_name || v.productName || ''),
        })).filter(x => x.product_code);

        postTotal = Number(res && (res.post_total ?? res.postTotal) ? (res.post_total ?? res.postTotal) : 0) || 0;

        postsByProduct = new Map();
        const by = res && (res.posts_by_product_code || res.postsByProductCode) ? (res.posts_by_product_code || res.postsByProductCode) : null;

        if (by && typeof by === 'object' && !Array.isArray(by)) {
          Object.keys(by).forEach(code => {
            const arr = Array.isArray(by[code]) ? by[code] : [];
            postsByProduct.set(String(code), arr);
          });
        } else {
          const all = res && (res.posts || res.post_list) ? (res.posts || res.post_list) : [];
          const arrAll = Array.isArray(all) ? all : [];
          for (const it of arrAll) {
            const code = String(it.product_code || it.productCode || '');
            if (!code) continue;
            if (!postsByProduct.has(code)) postsByProduct.set(code, []);
            postsByProduct.get(code).push(it);
          }
        }

        for (const p of products) {
          const code = String(p.product_code || '');
          if (!postsByProduct.has(code)) postsByProduct.set(code, []);
        }

        renderHeaderSummary();
        renderProducts();
        renderGlobalDevReplyNotice();

        // デベロッパー権限がある場合のみ「デベロッパー管理」ボタンを表示
        await loadDeveloperTopButton(products.map(p => p.product_code));

        if (!opts || !opts.preserveAlert) clearAlert();

      } catch (e) {
        console.error(e);
        products = [];
        postsByProduct = new Map();
        postTotal = 0;
        renderHeaderSummary();
        renderProducts();
        renderGlobalDevReplyNotice();
        showAlert('danger', e && e.message ? e.message : '投稿一覧の取得に失敗しました。');
      }
    };

    const loadPostDetail = async (postId, productCode, opts = {}) => {
      selectedPostId = postId;
      selectedProductCode = String(productCode || '').trim();
      selectedPost = null;
      renderDetail();

      try {
        const res = await ADDEVA.apiFetch('/api/addeva/user_opinion/post_detail', {
          method: 'POST',
          body: { postId: Number(postId) }
        });

        selectedPost = res || null;
        hideIntroMessage();

        renderDetail();
        if (!opts || !opts.preserveAlert) clearAlert();

        if (!opts || !opts.skipScrollToDetail) {
          (el('detailHeader') || el('detailWrap') || el('detailEmpty'))?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        if (!opts || !opts.skipFocus) {
          setTimeout(() => {
            try { el('title')?.focus({ preventScroll: true }); } catch (_) {}
          }, 0);
        }

      } catch (e) {
        console.error(e);
        selectedPost = null;
        showAlert('danger', e && e.message ? e.message : '意見詳細の取得に失敗しました。');
        renderDetail();
      }
    };

    const doCancel = async () => {
      if (!selectedPost || !selectedPost.post_id) {
        showAlert('warning', '取消対象の意見を選択してください。');
        return;
      }

      const ok = window.confirm('この意見を取消します。元に戻せません。よろしいですか？');
      if (!ok) return;

      const btnCancel = el('btnCancel');
      const btnSave = el('btnSave');
      btnCancel && (btnCancel.disabled = true);
      btnSave && (btnSave.disabled = true);

      try {
        // まずは status=cancel の保存を試す（API未対応なら fallback で非公開化）
        await ADDEVA.apiFetch('/api/addeva/user_opinion/update', {
          method: 'POST',
          body: {
            postId: Number(selectedPost.post_id),
            status: 'cancel',
            visibility: 'private'
          }
        });

        showAlert('success', `取消しました（ID=${selectedPost.post_id}）。`);

      } catch (e) {
        console.error(e);
        try {
          await ADDEVA.apiFetch('/api/addeva/user_opinion/update', {
            method: 'POST',
            body: {
              postId: Number(selectedPost.post_id),
              visibility: 'private'
            }
          });
          showAlert('warning', '取消ステータスの保存が未対応のため、非公開（private）にしました。');
        } catch (e2) {
          console.error(e2);
          showAlert('danger', (e2 && e2.message) ? e2.message : '取消に失敗しました。');
          return;
        }
      } finally {
        btnCancel && (btnCancel.disabled = false);
        btnSave && (btnSave.disabled = false);
      }

      const keepPostId = Number(selectedPost.post_id);
      const keepProductCode = String(selectedPost.product_code || selectedProductCode || '').trim();

      await loadDashboard({ preserveAlert: true });
      await loadPostDetail(keepPostId, keepProductCode, { skipScrollToDetail: true, skipFocus: true, preserveAlert: true });
    };

    const doSave = async () => {
      if (!selectedPost || !selectedPost.post_id) {
        showAlert('warning', '更新対象の意見を選択してください。');
        return;
      }

      const btn = el('btnSave');
      btn && (btn.disabled = true);

      try {
        const title = el('title') ? String(el('title').value || '').trim() : '';
        const body = el('body') ? String(el('body').value || '').trim() : '';
        let postType = el('postType') ? String(el('postType').value || '').trim() : 'improve';
        if (postType === 'good') postType = 'praise';
        const visibility = el('visibility') ? String(el('visibility').value || '').trim() : 'public';

        if (!title) {
          showAlert('warning', 'タイトルを入力してください。');
          return;
        }
        if (!body) {
          showAlert('warning', '本文を入力してください。');
          return;
        }

        const res = await ADDEVA.apiFetch('/api/addeva/user_opinion/update', {
          method: 'POST',
          body: {
            postId: Number(selectedPost.post_id),
            title,
            body,
            postType,
            visibility,
          }
        });

        showAlert('success', `更新しました（ID=${res.post_id}, status=${res.status}）。`);

        const keepPostId = Number(selectedPost.post_id);
        const keepProductCode = String(selectedPost.product_code || selectedProductCode || '').trim();

        await loadDashboard({ preserveAlert: true });
        await loadPostDetail(keepPostId, keepProductCode, { skipScrollToDetail: true, skipFocus: true, preserveAlert: true });

      } catch (e) {
        console.error(e);
        showAlert('danger', e && e.message ? e.message : '更新に失敗しました。');
      } finally {
        btn && (btn.disabled = false);
      }
    };

    // === UI バインド ===
    const scrollToDevReplyDetail = () => {
      // 右ペインの返信ブロックへ（「返信を見る」と同じ）
      const p = el('devReplyPanel');
      if (p && p.style.display !== 'none') {
        p.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        (el('detailWrap') || el('detailHeader'))?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    const bindUI = () => {
      el('btnReload')?.addEventListener('click', async () => {
        clearAlert(true);
        await loadDashboard();
      });

      el('btnScrollToDetail')?.addEventListener('click', () => {
        (el('detailHeader') || el('detailWrap'))?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });

      el('btnCancel')?.addEventListener('click', doCancel);
      el('btnSave')?.addEventListener('click', doSave);

      // Ctrl/Cmd+Enter で更新
      el('body')?.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          doSave();
        }
      });

      // ページ上部まとめ通知：詳しく見る（選択→「返信を見る」と同じ場所へ）
      const globalNotice = el('devReplyGlobalNotice');
      if (globalNotice && globalNotice.dataset.bound !== '1') {
        globalNotice.addEventListener('click', async (ev) => {
          const btn = (ev.target && ev.target.closest) ? ev.target.closest('[data-action="open-unread-post"]') : null;
          if (!btn) return;
          ev.preventDefault();

          const pid = Number(btn.getAttribute('data-post-id') || 0);
          const pc = String(btn.getAttribute('data-product-code') || '');
          if (!pid) return;

          await loadPostDetail(pid, pc, { preserveAlert: true, skipScrollToDetail: true, skipFocus: true });

          // 詳しく見るは「返信を見る」と同じ場所へ
          setTimeout(() => scrollToDevReplyDetail(), 0);

          renderProducts();
          renderGlobalDevReplyNotice();
        });
        globalNotice.dataset.bound = '1';
      }

      // Top 通知：返信を見る
      const goBtn = el('btnDevReplyGoDetail');
      if (goBtn && goBtn.dataset.bound !== '1') {
        goBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          scrollToDevReplyDetail();
        });
        goBtn.dataset.bound = '1';
      }

      // Top 通知：既読にする
      const readBtn = el('btnDevReplyMarkRead');
      if (readBtn && readBtn.dataset.bound !== '1') {
        readBtn.addEventListener('click', markDevCommentRead);
        readBtn.dataset.bound = '1';
      }

      // 右ペイン：既読にする（未読のときだけ押せる）
      const readBtnPanel = el('btnDevReplyMarkReadInPanel');
      if (readBtnPanel && readBtnPanel.dataset.bound !== '1') {
        readBtnPanel.addEventListener('click', markDevCommentRead);
        readBtnPanel.dataset.bound = '1';
      }

      // ログアウト
      const logoutBtn = el('logoutButtonTop');
      if (logoutBtn && logoutBtn.dataset.bound !== '1') {
        logoutBtn.addEventListener('click', () => {
          try {
            if (window.ADDEVA && ADDEVA.LS && ADDEVA.LS.authToken) {
              localStorage.removeItem(ADDEVA.LS.authToken);
            } else {
              localStorage.removeItem('authToken');
            }
          } catch (_) {}
          window.location.href = '/customer.html?mode=login';
        });
        logoutBtn.dataset.bound = '1';
      }
    };

    // === 初期化 ===
    (async () => {
      bindUI();
      await loadDashboard();
      renderDetail();
      bindCharCount();
    })();
  </script>
</body>
</html>
