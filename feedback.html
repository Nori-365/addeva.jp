<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,follow">

  <title>フィードバック（投票とご意見の追加）｜ADDEVA サポート</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- APIキーをcommon.jsが読み取るためのメタタグ -->
  <meta name="x-api-key" content="ADDEVA_API_KEY_c3rITY1LbafHBYaO62tJ4h4nzqQKsEMvXQ7aFRz3Uqk">

  <style>
    /* main.css 側に寄せつつ、カードUIの最低限だけ補強 */
    .post-card h3 { line-height: 1.35; }
    .vote-btn.active { box-shadow: inset 0 0 0 2px rgba(13,110,253,.35); }

    /* カード：上段(左/右) + 下段(本文)の2段構成（Grid） */
    .post-card-top{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: .5rem 1rem;
      align-items: start;
    }
    .post-card-top-left{ min-width: 0; }
    .post-card-top-right{ justify-self: end; }

    /* Chromeのスクロールアンカーで「追加後に勝手に移動」するのを防ぐ */
    #messageArea, #partPostsWrap { overflow-anchor: none; }

    /* 重要注意（ダークレッド） */
    .text-darkred { color: #8B0000 !important; }

    /* 公開設定：どちらを選んでも「青」で強調（main.css等の上書き対策） */
    .visibility-group .btn-check:checked + .btn{
      background-color: var(--bs-primary) !important;
      border-color: var(--bs-primary) !important;
      color: #fff !important;
    }

    /* スマホ微調整 */
    @media (max-width: 575.98px) {
      .post-card-top { gap: .5rem !important; }
      .post-card-top-right .form-text { font-size: .75rem; }
    }
  </style>
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header fixed-top" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item"><a href="/customer.html">ユーザーサポート</a></li>
            <li class="breadcrumb-item"><a id="breadcrumbBoardLink" href="/feedback_board.html">フィードバックボード</a></li>
            <li class="breadcrumb-item active" aria-current="page">フィードバック（投票とご意見の追加）</li>
          </ol>
        </nav>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert" aria-live="polite" aria-atomic="true">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div id="messageText" class="flex-grow-1"></div>
            <button type="button" class="btn-close" aria-label="閉じる" id="messageCloseBtn"></button>
          </div>
        </div>

        <!-- Debug: Alert trace (inspectable) -->
        <pre id="debugAlertTrace" class="d-none small text-secondary mt-2"
             style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></pre>

        <!-- ページヘッダー情報 -->
        <div class="mb-4">
          <div class="mb-3 p-3 bg-light border rounded border-start border-3 border-primary">
            <div class="fw-bold" style="font-size: 1.35rem; line-height: 1.35;">開発責任者に直接届くフィードバックです。</div>
            <div class="mt-1">
              <!--
                不具合対策：
                ここは span + br の書き間違いがあると「タグ文字が表示される」「以降の行が崩れる」事故が起きやすいので、
                行ごとに div で分離して堅牢化しています。
              -->
              <div class="fw-semibold">賛成の多い「改善点」は、優先的に製品への反映を検討いたします。</div>
              <div class="fw-semibold">賛成の多い「良かった点」は、次モデルに継承されます。</div>
              <div>公開したご意見は、審査後に他のユーザーにも表示され、投票の対象になります。非公開は開発責任者のみが確認します。</div>
              <div>製品ガイドに掲載してほしい情報（使い方、FAQ、注意点など）も、ご意見として追加できます。</div>
            </div>
          </div>

          <h1 class="mb-2">フィードバック（投票とご意見の追加）</h1>
          <p class="lead mb-1">
            <span class="d-none d-sm-inline">対象商品：</span><span class="d-inline d-sm-none">対象：</span> <span id="productName" class="fw-bold text-primary">-</span>
            <span class="badge bg-secondary fw-normal ms-2" id="productCodeChip">-</span>
          </p>
          <p class="text-secondary">
            製品改善のため、皆様のご意見をお聞かせください。<br>
            手順：部位を選ぶ → その部位のご意見を先に読む → 必要なら投票・ご意見を追加
          </p>
        </div>

        <!-- コンテンツコンテナ -->
        <div id="feedbackContent" class="card shadow-sm p-4">

          <!-- 1. 部位を選ぶ -->
          <h2 class="h5 mb-3 border-bottom pb-2">1. 部位を選ぶ</h2>
          <div class="row g-3 align-items-end">
            <div class="col-12">
              <label for="partSelect" class="form-label">部位</label>
              <select id="partSelect" class="form-select">
                <option value="">読み込み中...</option>
              </select>
              <div class="form-text">まずは部位を選び、その部位のご意見を先に確認してください。製品ガイド要望は「全体性能 / その他」から追加するのがおすすめです。</div>
            </div>
          </div>

          <div id="newPartWrap" class="mt-4 d-none">
            <div class="p-3 bg-light border rounded">
              <p class="fw-bold mb-2">新しい部位を登録（その他）</p>
              <div class="row g-3">
                <div class="col-12 col-md-5">
                  <label for="newPartCode" class="form-label">部位コード（英語）</label>
                  <input type="text" id="newPartCode" class="form-control" maxlength="32" placeholder="例: main_zipper">
                  <div class="form-text">半角英小文字・数字・アンダースコアのみ（3〜32文字）。</div>
                </div>
                <div class="col-12 col-md-7">
                  <label for="newPartNameJa" class="form-label">部位名（日本語）</label>
                  <input type="text" id="newPartNameJa" class="form-control" maxlength="64" placeholder="例: メインファスナー">
                </div>
                <div class="col-12">
                  <button id="btnCreatePart" class="btn btn-primary">この部位を追加して選択する</button>
                </div>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <!-- 2. この部位のご意見を読む -->
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <h2 class="h5 m-0">2. ご意見に投票する</h2>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <select id="filterType" class="form-select form-select-sm" style="width:auto;">
                <option value="">すべて表示</option>
                <option value="improve">改善してほしい点</option>
                <option value="praise">良かった点</option>
                <option value="guide">製品ガイド要望</option>
              </select>
              <button id="btnReload" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-clockwise"></i> 更新</button>
            </div>
          </div>
          <p class="text-secondary small">審査中のご意見は、ご本人のみ表示されます。わからないご意見には、無投票でお願いします。</p>

          <div class="vstack gap-3" id="partPostsWrap">
            <div class="text-center p-4 bg-light rounded">
              <p class="text-secondary mb-0">上に表示されたメニューから部位を選択してください。</p>
            </div>
          </div>

          <hr class="my-4">

          <!-- 3. この部位の新しいご意見を追加する -->
          <h2 class="h5 mb-3">3. この部位の新しいご意見を追加</h2>

          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">ご意見タイプ <span class="text-danger">*</span></label>
              <div class="btn-group w-100" role="group" aria-label="ご意見タイプ">
                <input type="radio" class="btn-check" name="postType" id="ptImprove" autocomplete="off" value="improve">
                <label class="btn btn-outline-primary" for="ptImprove"><i class="bi bi-lightbulb me-1"></i>改善してほしい点</label>

                <input type="radio" class="btn-check" name="postType" id="ptPraise" autocomplete="off" value="praise">
                <label class="btn btn-outline-primary" for="ptPraise"><i class="bi bi-hand-thumbs-up me-1"></i>良かった点</label>

                <input type="radio" class="btn-check" name="postType" id="ptGuide" autocomplete="off" value="guide">
                <label class="btn btn-outline-primary" for="ptGuide"><i class="bi bi-journal-text me-1"></i>製品ガイド要望</label>
              </div>
              <div class="form-text mt-2">製品ガイドへの追記・修正のご要望は、「製品ガイド要望」をご選択ください。</div>
              <div class="form-text text-darkred fw-semibold">上記のいずれかを必ず選択してください。</div>
            </div>

            <div class="col-12">
              <label class="form-label">公開設定 <span class="text-danger">*</span></label>
              <div class="btn-group w-100 visibility-group" role="group" aria-label="公開設定">
                <input type="radio" class="btn-check" name="visibility" id="visPublic" autocomplete="off" value="public">
                <label class="btn btn-outline-primary" for="visPublic"><i class="bi bi-globe2 me-1"></i>公開（投票の対象）</label>

                <input type="radio" class="btn-check" name="visibility" id="visPrivate" autocomplete="off" value="private">
                <label class="btn btn-outline-primary" for="visPrivate"><i class="bi bi-lock me-1"></i>非公開（開発責任者のみ）</label>
              </div>
              <div class="form-text mt-2">公開したご意見は、審査後に同じ製品のユーザーへ表示され、投票の対象になります。非公開は開発責任者のみが確認します。</div>
            </div>

            <div class="col-12 col-md-5">
              <label for="nickname" class="form-label">ニックネーム <span class="text-danger">*</span></label>
              <input type="text" id="nickname" class="form-control" maxlength="32" placeholder="例：Taro" required>
              <div class="form-text">ニックネームを変更すると、過去のご意見も変わります。</div>
            </div>

            <div class="col-12 col-md-7">
              <label for="title" class="form-label">タイトル</label>
              <input type="text" id="title" class="form-control" maxlength="120" placeholder="例：〇〇の改善 / 〇〇が便利 / 製品ガイド要望：〇〇">
            </div>

            <div class="col-12">
              <label for="body" class="form-label">内容</label>
              <textarea id="body" class="form-control" rows="6" maxlength="4000" placeholder="詳細をご入力ください。"></textarea>
              <div class="form-text mt-2 text-secondary">※用語の統一・商標保護のため、ご意見は公開前の審査で表現を一部調整する場合があります（内容の趣旨は変えません）。あらかじめご了承ください。</div>
            </div>

            <div class="col-12">
              <button id="btnSubmit" class="btn btn-primary btn-lg w-100">ご意見を追加する</button>
              <div id="submitHint" class="form-text mt-2 text-center">部位を選ぶとご意見を追加できます。</div>
            </div>
          </div>

        </div> <!-- /#feedbackContent -->
      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="/common.js"></script>

  <script>
    // === ユーティリティ ===
    const qs = name => new URL(window.location.href).searchParams.get(name) || '';

    // ニックネーム（フロント側の控え。APIで取得できない場合のフォールバック用途）
    const NICK_CACHE_KEY = 'addeva_nickname_cache';

    const bindMessageClose = () => {
      const btn = document.getElementById('messageCloseBtn');
      if (!btn) return;
      if (btn.dataset.bound === '1') return;
      btn.addEventListener('click', clearAlert);
      btn.dataset.bound = '1';
    };

    const getVisibilityValue = () => {
      const el = document.querySelector('input[name="visibility"]:checked');
      const v = String(el?.value || '').trim();
      if (!v) return '';
      return (v === 'private') ? 'private' : 'public';
    };

    // === Debug trace (alert) ===
    // ・URLに ?debug=1 を付けると画面上にも表示します（付けなくてもDOM上には残ります）
    const dbg = (() => {
      const enabled = (qs('debug') === '1');
      const el = () => document.getElementById('debugAlertTrace');
      const write = (line) => {
        const d = el();
        if (!d) return;
        if (enabled) d.classList.remove('d-none');
        d.textContent += (line + "\n");
      };
      const snapshot = (tag, extra = {}) => {
        const box = document.getElementById('messageArea');
        const text = document.getElementById('messageText');
        const payload = {
          tag,
          time: new Date().toISOString(),
          boxClass: box ? String(box.className || '') : null,
          hidden: box ? !!box.classList.contains('d-none') : null,
          messageText: text ? String(text.textContent || '') : null,
          ...extra,
        };
        write('DEBUG: ' + JSON.stringify(payload));
      };
      return { enabled, write, snapshot };
    })();

    const showAlert = (kind, msg) => {
      const box = document.getElementById('messageArea');
      if (!box) return;

      box.className = `alert alert-${kind} shadow-sm`;
      box.classList.remove('d-none');

      const text = document.getElementById('messageText');
      if (text) text.textContent = msg;

      // Debug: showAlertが実行された時点でのメッセージ内容を強制的に記録
      try { dbg.snapshot('showAlert', { kind: String(kind), msgParam: String(msg ?? '') }); } catch (_) {}

      bindMessageClose();

      // メッセージは確実に上部で見せる
      if (kind === 'danger' || kind === 'warning' || kind === 'success') {
        try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch (_) {}
      }
    };

    const clearAlert = () => {
      const box = document.getElementById('messageArea');
      if (!box) return;

      // Debug: clearAlertが走ったかどうかを記録（before/after）
      try { dbg.snapshot('clearAlert.before'); } catch (_) {}

      box.classList.add('d-none');
      const text = document.getElementById('messageText');
      if (text) text.textContent = '';
      bindMessageClose();

      try { dbg.snapshot('clearAlert.after'); } catch (_) {}
    };

    const escapeHtml = v => String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);

    const api = (path, opts) => ADDEVA.apiFetch(path, opts);

    // === 表示ラベル ===
    const statusMap = { new: '審査中', reviewing: '検討中', planned: '対応予定', shipped: '対応済み', rejected: '否認' };
    const statusLabel = s => statusMap[s] || s || '';
    const isApprovedStatus = s => ['reviewing', 'planned', 'shipped'].includes(s);

    const postTypeLabel = (t) => {
      const v = String(t || '').trim();
      if (v === 'improve') return '改善してほしい点';
      if (v === 'guide') return '製品ガイド要望';
      return '良かった点';
    };

    // === 表示順固定（ロード/更新時に確定）===
    // ・初回表示/「更新」/フィルタ変更/部位変更のタイミングで、賛成(up)が多い順に並べ替え
    // ・投票時は並び順を変えず、該当カードのDOMだけを更新
    let _ctxKey = '';
    let _renderOrder = [];          // post_id の配列
    let _postMap = new Map();       // post_id -> post object

    const _makeCtxKey = () => {
      const productCode = qs('product_code');
      const partCode = document.getElementById('partSelect')?.value || '';
      const filterType = document.getElementById('filterType')?.value || '';
      return [productCode, partCode, filterType].join('|');
    };

    const _sortForInitialOrder = (posts) => {
      // 賛成(up)が多い順（同数なら投稿IDの小さい順で安定化）
      return [...posts].sort((a, b) => {
        const au = Number(a.up_count || 0);
        const bu = Number(b.up_count || 0);
        if (bu !== au) return bu - au;
        const ai = Number(a.post_id || 0);
        const bi = Number(b.post_id || 0);
        return ai - bi;
      });
    };

    const _ensureOrder = (posts, forceReorder = false) => {
      const key = _makeCtxKey();
      const need = forceReorder || key !== _ctxKey || _renderOrder.length === 0;
      _ctxKey = key;

      _postMap = new Map();
      for (const p of posts) _postMap.set(Number(p.post_id), p);

      if (need) {
        const sorted = _sortForInitialOrder(posts);
        _renderOrder = sorted.map(p => Number(p.post_id));
        return;
      }

      // 既存orderに無いものが増えた場合は末尾へ（追加直後など）
      for (const p of posts) {
        const id = Number(p.post_id);
        if (!_renderOrder.includes(id)) _renderOrder.push(id);
      }
      // 消えたものを除去
      _renderOrder = _renderOrder.filter(id => _postMap.has(id));
    };

    const _updatePostDom = (postId) => {
      const p = _postMap.get(Number(postId));
      if (!p) return;

      const card = document.querySelector(`.post-card[data-post-card="${Number(postId)}"]`);
      if (!card) return;

      const btnUp = card.querySelector(`.vote-btn[data-v="up"]`);
      const btnDown = card.querySelector(`.vote-btn[data-v="down"]`);

      if (btnUp) {
        const b = btnUp.querySelector('span.badge');
        if (b) b.textContent = String(p.up_count ?? 0);
        btnUp.classList.toggle('active', p.my_vote === 'up');
      }
      if (btnDown) {
        const b = btnDown.querySelector('span.badge');
        if (b) b.textContent = String(p.down_count ?? 0);
        btnDown.classList.toggle('active', p.my_vote === 'down');
      }
    };

    const _setVotingDisabled = (postId, disabled) => {
      const card = document.querySelector(`.post-card[data-post-card="${Number(postId)}"]`);
      if (!card) return;
      card.querySelectorAll('.vote-btn').forEach(b => { b.disabled = !!disabled; });
    };

    function renderPostCard(p) {
      const approved = isApprovedStatus(p.status);

      // visibility: APIが visibility 文字列 / is_public を返すどちらの形でも判定できるようにする
      const vis = String((p && (p.visibility ?? '')) ?? '').trim().toLowerCase();
      const isPrivate = (vis === 'private') || (p?.is_public === false) || (p?.is_public === 0);
      const canVote = approved && !isPrivate;

      const statusClass = approved ? 'text-bg-success' : 'text-bg-secondary';
      const statusChip = `<span class="badge ${statusClass} fw-normal">${escapeHtml(statusLabel(p.status))}</span>`;
      const typeChip = `<span class="badge text-bg-info fw-normal">${escapeHtml(postTypeLabel(p.post_type))}</span>`;
      const privateChip = isPrivate ? `<span class="badge text-bg-dark fw-normal"><i class="bi bi-lock-fill me-1"></i>非公開</span>` : '';

      const voteButton = (voteType, label, count) => `
        <button class="btn btn-sm btn-outline-secondary vote-btn ${p.my_vote === voteType ? 'active' : ''}"
                data-act="vote" data-post="${p.post_id}" data-v="${voteType}" ${canVote ? '' : 'disabled'}>
          ${label} <span class="badge text-bg-light">${count}</span>
        </button>`;

      const devCommentBlock = (p.dev_comment || '').trim() ? `
        <div class="mt-3 pt-3 border-top">
          <p class="fw-bold mb-1"><i class="bi bi-chat-right-text me-2"></i>開発者コメント</p>
          <p class="small text-secondary mb-0" style="white-space:pre-wrap;">${escapeHtml(p.dev_comment)}</p>
        </div>` : '';

      const title = String(p.title || '').trim() || '(無題)';
      const nickLine = (p.nickname || '').trim()
        ? `<p class="small text-secondary mb-2">ニックネーム: ${escapeHtml(p.nickname)}</p>`
        : '';

      const voteHint = canVote ? 'クリックで投票/取消' : (isPrivate ? '非公開のため投票不可' : '審査中は投票不可');

      return `
        <div class="post-card border rounded p-3" data-post-card="${p.post_id}">
          <div class="post-card-top">
            <div class="post-card-top-left">
              <div class="d-flex gap-2 align-items-center flex-wrap">
                ${statusChip}
                ${typeChip}
                ${privateChip}
              </div>
            </div>

            <div class="post-card-top-right text-end">
              <div class="btn-group btn-group-sm" role="group" aria-label="投票">
                ${voteButton('up', '賛成', p.up_count)}
                ${voteButton('down', '反対', p.down_count)}
              </div>
              <div class="form-text mt-1">${voteHint}</div>
            </div>
          </div>

          <div class="post-card-bottom mt-2">
            ${nickLine}
            <h3 class="h6 mb-2">${escapeHtml(title)}</h3>
            <p class="mb-0" style="white-space:pre-wrap;">${escapeHtml(p.body)}</p>
            ${devCommentBlock}
          </div>
        </div>`;
    }

    // === ニックネーム（初期表示） ===
    function getNicknameEl() {
      return document.getElementById('nickname');
    }

    function getNicknameValue() {
      const el = getNicknameEl();
      return el ? String(el.value || '').trim() : '';
    }

    function setNicknameValue(v) {
      const el = getNicknameEl();
      if (!el) return;
      el.value = String(v || '').trim();
    }

    function cacheNickname(v) {
      try {
        const val = String(v || '').trim();
        if (!val) {
          localStorage.removeItem(NICK_CACHE_KEY);
        } else {
          localStorage.setItem(NICK_CACHE_KEY, val);
        }
      } catch (_) {}
    }

    function loadNicknameFromCacheIfEmpty() {
      try {
        const el = getNicknameEl();
        if (!el) return;
        const cur = String(el.value || '').trim();
        if (cur) return;
        const cached = String(localStorage.getItem(NICK_CACHE_KEY) || '').trim();
        if (cached) el.value = cached;
      } catch (_) {}
    }

    async function tryLoadNicknameFromApi() {
      // 方針：POST優先。ただしサーバ側がPOSTを許可していない場合(405)はGETにフォールバック。
      // 重要：ここだけは common.js(ADDEVA.apiFetch) を使わず fetch 直叩きにして、
      // 405時に console.error を大量発生させないようにします。

      const parseNick = (res) => {
        const nick = (res && (res.nickname ?? (res.customer && res.customer.nickname) ?? (res.data && res.data.nickname))) || '';
        return String(nick || '').trim();
      };

      const headers = { 'Content-Type': 'application/json' };
      try {
        const apiKey = localStorage.getItem(ADDEVA.LS.apiKey) || '';
        const authToken = localStorage.getItem(ADDEVA.LS.authToken) || '';
        if (apiKey) headers['x-api-key'] = apiKey;
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
      } catch (_) {}

      const url = '/api/addeva/customer/me';

      try {
        // 1) POST優先
        let r = await fetch(url, { method: 'POST', headers, body: '{}' });

        // 2) POSTが許可されていなければGETへ
        if (r && r.status === 405) {
          r = await fetch(url, { method: 'GET', headers });
        }

        if (!r || !r.ok) return;

        const j = await r.json().catch(() => null);
        const v = parseNick(j);
        if (v) {
          setNicknameValue(v);
          cacheNickname(v);
        }
      } catch (_) {
        // ignore
      }
    }

    // === API連携 ===
    async function loadProductInfo(productCode) {
      const res = await api('/api/addeva/feedback/product_info', { method: 'POST', body: { productCode } });
      document.getElementById('productName').textContent = res.product_name || '-';
      document.getElementById('productCodeChip').textContent = res.product_code || productCode || '-';
    }

    async function loadParts(productCode) {
      const res = await api('/api/addeva/feedback/parts/list', { method: 'POST', body: { productCode } });
      const sel = document.getElementById('partSelect');
      if (!Array.isArray(res)) {
        sel.innerHTML = '<option value="">部位の取得に失敗</option>';
        return;
      }

      // category_name でグルーピング（未指定は「その他」扱い）
      const groups = new Map();
      for (const p of res) {
        const cat = String(p.category_name || '').trim() || 'その他';
        if (!groups.has(cat)) groups.set(cat, []);
        groups.get(cat).push(p);
      }

      let html = '<option value="">部位を選択してください</option>';
      for (const [cat, items] of groups.entries()) {
        html += `<optgroup label="${escapeHtml(cat)}">`;
        html += items.map(p => `<option value="${escapeHtml(p.part_code)}">${escapeHtml(p.part_name_ja)}（${escapeHtml(p.part_code)}）</option>`).join('');
        html += `</optgroup>`;
      }

      // 追加（ユーザー定義部位）
      html += '<option value="__new__">その他（新しい部位を登録）</option>';
      sel.innerHTML = html;
    }

    function setUIState(partCode) {
      const isNew = partCode === '__new__';
      const hasSelection = !!partCode && !isNew;
      const nickOk = !!getNicknameValue();
      const typeOk = !!document.querySelector('input[name="postType"]:checked');
      const visOk = !!document.querySelector('input[name="visibility"]:checked');
      const titleOk = !!String(document.getElementById('title')?.value || '').trim();
      const bodyOk  = !!String(document.getElementById('body')?.value  || '').trim();

      document.getElementById('newPartWrap').classList.toggle('d-none', !isNew);

      const btnSubmit = document.getElementById('btnSubmit');
      if (btnSubmit) btnSubmit.disabled = !(hasSelection && nickOk && typeOk && visOk && titleOk && bodyOk);

      const hint = document.getElementById('submitHint');
      if (hint) {
        if (isNew) {
          hint.textContent = '新しい部位を登録してからご意見を追加できます。';
          hint.className = 'form-text mt-2 text-center';
        } else if (!hasSelection) {
          hint.textContent = '部位を選ぶとご意見を追加できます。';
          hint.className = 'form-text mt-2 text-center';
        } else {
          const missing = [];
          if (!typeOk) missing.push('ご意見タイプ');
          if (!visOk) missing.push('公開設定');
          if (!nickOk) missing.push('ニックネーム');
          if (!titleOk) missing.push('タイトル');
          if (!bodyOk) missing.push('内容');

          if (missing.length > 0) {
            hint.textContent = '未入力項目：' + missing.join('、');
            hint.className = 'form-text mt-2 text-center fw-semibold text-darkred';
          } else {
            hint.textContent = '送信できます。';
            hint.className = 'form-text mt-2 text-center';
          }
        }
      }
    }

    async function loadPartPosts(opts = {}) {
      const keepAlert = !!opts.keepAlert;
      if (!keepAlert) clearAlert();

      try { dbg.snapshot('loadPartPosts.begin', { keepAlert }); } catch (_) {}

      const wrap = document.getElementById('partPostsWrap');
      const productCode = qs('product_code');
      const partCode = document.getElementById('partSelect')?.value || '';
      const filterType = document.getElementById('filterType')?.value || '';

      if (!wrap) return;

      if (!productCode) {
        wrap.innerHTML = '<div class="alert alert-danger mb-0">商品コードが指定されていません。ユーザーサポートから再度お試しください。</div>';
        return;
      }

      if (!partCode) {
        wrap.innerHTML = '<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">部位を選択してください。</p></div>';
        return;
      }

      if (partCode === '__new__') {
        wrap.innerHTML = '<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">新しい部位を登録してください。</p></div>';
        return;
      }

      wrap.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>';

      try {
        const posts = await api('/api/addeva/feedback/part_posts', {
          method: 'POST',
          body: { productCode, partCode, postType: filterType || null }
        });

        if (!Array.isArray(posts) || posts.length === 0) {
          wrap.innerHTML = '<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">この部位のご意見はまだありません。</p></div>';
          return;
        }

        _ensureOrder(posts, !!opts.forceReorder);

        wrap.innerHTML = _renderOrder.map(id => renderPostCard(_postMap.get(id))).join('');
        try { dbg.snapshot('loadPartPosts.rendered', { keepAlert, renderedCount: Array.isArray(posts) ? posts.length : null }); } catch (_) {}

        wrap.querySelectorAll('.vote-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const postId = Number(btn.dataset.post);
            const voteType = String(btn.dataset.v || '').trim();

            try {
              _setVotingDisabled(postId, true);

              const res = await api('/api/addeva/feedback/vote', {
                method: 'POST',
                body: { postId, voteType }
              });

              const p = _postMap.get(Number(postId));
              if (p && res) {
                p.my_vote = (res.myVote ?? null);
                p.up_count = Number(res.upCount ?? p.up_count ?? 0);
                p.down_count = Number(res.downCount ?? p.down_count ?? 0);
              }
              _updatePostDom(postId);

            } catch (e) {
              showAlert('danger', e.message || '投票に失敗しました。');
            } finally {
              _setVotingDisabled(postId, false);
            }
          });
        });

      } catch (e) {
        wrap.innerHTML = `<div class="alert alert-danger mb-0">${escapeHtml(e.message) || 'ご意見の読み込みに失敗しました。'}</div>`;
      }
    }

    async function createPart() {
      clearAlert();
      const productCode = qs('product_code');
      const partCode = document.getElementById('newPartCode').value.trim();
      const partNameJa = document.getElementById('newPartNameJa').value.trim();

      if (!partCode || !partNameJa) {
        showAlert('warning', '部位コードと部位名を入力してください。');
        return;
      }

      try {
        await api('/api/addeva/feedback/parts/create', { method: 'POST', body: { productCode, partCode, partNameJa } });
        showAlert('success', '部位を追加しました。');

        await loadParts(productCode);

        const sel = document.getElementById('partSelect');
        if (sel) sel.value = partCode;
        setUIState(partCode);

        await loadPartPosts({ keepAlert: true, forceReorder: true });
      } catch (e) {
        showAlert('danger', e.message || '部位の追加に失敗しました。');
      }
    }

    async function submitPost() {
      clearAlert();
      const productCode = qs('product_code');
      const partCode = document.getElementById('partSelect').value;
      const title = document.getElementById('title').value.trim();
      const body = document.getElementById('body').value.trim();
      const nickname = getNicknameValue();
      const ptEl = document.querySelector('input[name="postType"]:checked');
      const visEl = document.querySelector('input[name="visibility"]:checked');
      const visibility = String(visEl?.value || '').trim();

      if (!partCode || partCode === '__new__') { showAlert('warning', '部位を選択してください。'); return; }
      if (!visEl) { showAlert('warning', '公開設定を選択してください。'); return; }
      if (!ptEl) { showAlert('warning', 'ご意見タイプを選択してください。'); return; }
      if (!nickname) { showAlert('warning', 'ニックネームを入力してください。'); return; }
      if (!title || !body) { showAlert('warning', 'タイトルと内容を入力してください。'); return; }

      const postData = {
        productCode,
        partCode,
        title,
        body,
        postType: String(ptEl.value || '').trim(),
        nickname,
        visibility,
        is_public: (visibility !== 'private'),
      };

      cacheNickname(nickname);

      try {
        await api('/api/addeva/feedback/create', { method: 'POST', body: postData });

        if (visibility === 'private') {
          showAlert('success', 'ご意見を追加しました。ありがとうございます。開発責任者に直接届きます（非公開）。');
        } else {
          showAlert('success', 'ご意見を追加しました。ありがとうございます。審査後に公開され、投票の対象になります。');
        }

        try { dbg.snapshot('submitPost.afterShowAlert'); } catch (_) {}

        document.getElementById('title').value = '';
        document.getElementById('body').value = '';

        document.getElementById('partSelect').value = partCode;
        setUIState(partCode);

        const filterEl = document.getElementById('filterType');
        if (filterEl) filterEl.value = '';

        await loadPartPosts({ keepAlert: true });

      } catch (e) {
        showAlert('danger', e.message || 'ご意見の追加に失敗しました。');
      }
    }

    function setBreadcrumbBoardLink(productCode) {
      const a = document.getElementById('breadcrumbBoardLink');
      if (!a) return;
      const base = '/feedback_board.html';
      const pc = String(productCode || '').trim();
      a.href = pc ? (base + '?product_code=' + encodeURIComponent(pc)) : base;
    }

    async function init() {
      const productCode = qs('product_code');

      setBreadcrumbBoardLink(productCode);

      if (!productCode) {
        showAlert('danger', '商品コードが指定されていません。ユーザーサポートから再度お試しください。');
        return;
      }

      document.getElementById('productCodeChip').textContent = productCode;

      document.getElementById('partSelect').addEventListener('change', async e => {
        setUIState(e.target.value);
        await loadPartPosts({ forceReorder: true });
      });

      document.getElementById('filterType').addEventListener('change', () => loadPartPosts({ forceReorder: true }));
      document.getElementById('btnReload').addEventListener('click', () => loadPartPosts({ forceReorder: true }));
      document.getElementById('btnCreatePart').addEventListener('click', createPart);
      document.getElementById('btnSubmit').addEventListener('click', submitPost);

      // 公開設定はデフォルト未選択（ユーザーに選択してもらう）
      document.querySelectorAll('input[name="visibility"]').forEach(el => { el.checked = false; });

      ['title', 'body'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', () => {
          const pc = document.getElementById('partSelect') ? document.getElementById('partSelect').value : '';
          setUIState(pc);
        });
      });

      document.querySelectorAll('input[name="postType"]').forEach(el => {
        el.addEventListener('change', () => {
          const pc = document.getElementById('partSelect') ? document.getElementById('partSelect').value : '';
          setUIState(pc);
        });
      });

      document.querySelectorAll('input[name="visibility"]').forEach(el => {
        el.addEventListener('change', () => {
          const pc = document.getElementById('partSelect') ? document.getElementById('partSelect').value : '';
          setUIState(pc);
        });
      });

      const nickEl = document.getElementById('nickname');
      if (nickEl) {
        nickEl.addEventListener('input', () => {
          cacheNickname(getNicknameValue());
          const pc = document.getElementById('partSelect') ? document.getElementById('partSelect').value : '';
          setUIState(pc);
        });
      }

      try {
        loadNicknameFromCacheIfEmpty();
        await tryLoadNicknameFromApi();

        await loadProductInfo(productCode);
        await loadParts(productCode);

        const urlPartCode = String(qs('part_code') || '').trim();
        if (urlPartCode) {
          const sel = document.getElementById('partSelect');
          if (sel) {
            sel.value = urlPartCode;

            if (sel.value !== urlPartCode) {
              sel.value = '';
              setUIState('');
              showAlert('warning', '指定された部位が見つかりませんでした。部位を選択してください。');
            } else {
              setUIState(urlPartCode);
              await loadPartPosts({ keepAlert: true });
            }
          } else {
            setUIState('');
          }
        } else {
          setUIState('');
        }

      } catch (e) {
        showAlert('danger', e.message || '初期化に失敗しました。');
      }
    }

    (function waitForADDEVA() {
      const START = Date.now();
      const TIMEOUT_MS = 7000;

      function tick() {
        if (typeof ADDEVA !== 'undefined' && ADDEVA && typeof ADDEVA.apiFetch === 'function') {
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
          } else {
            init();
          }
          return;
        }

        if (Date.now() - START > TIMEOUT_MS) {
          showAlert('danger', 'common.js の読み込みが完了していないため、API通信を開始できません。/common.js が 404 になっていないか、キャッシュを消して再読み込みしてください。');
          return;
        }

        setTimeout(tick, 50);
      }

      tick();
    })();
  </script>

  <!-- ▼ includeエンジン -->
  <script>
    (async()=>{try{const t=document.querySelectorAll('[data-include]');for(const e of t){const l=e.getAttribute('data-include');if(!l)continue;const o=await fetch(l,{cache:'no-cache'});if(!o.ok)throw new Error(`include failed: ${l} (${o.status})`);e.outerHTML=await o.text()}}catch(e){console.error('include loader error:',e)}})();
  </script>
</body>
</html>
