<!doctype html>
<html lang="ja">
<head>
  <!-- ▼ 共通ヘッダーのhead-common.htmlを読み込み -->
  <script>(async(d,u)=>{try{const r=await fetch(u,{cache:'no-cache'}),h=await r.text(),tpl=d.createElement('template');tpl.innerHTML=h;[...tpl.content.childNodes].forEach(n=>{if(n.tagName==='SCRIPT'){const s=d.createElement('script');[...n.attributes].forEach(a=>s.setAttribute(a.name,a.value));s.textContent=n.textContent;d.head.appendChild(s);}else{d.head.appendChild(n);}});}catch(e){console.error('head include failed:',u,e);}})(document,'/includes/head-common.html');</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary SEO -->
  <title>フィードバックボード｜ADDEVA サポート</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- APIキーをcommon.jsが読み取るためのメタタグ -->
  <meta name="x-api-key" content="ADDEVA_API_KEY_c3rITY1LbafHBYaO62tJ4h4nzqQKsEMvXQ7aFRz3Uqk">
</head>

<body>
  <!-- ▼ 共通ヘッダーを読み込み -->
  <div data-include="/includes/header.html" class="site-header fixed-top" aria-busy="true"></div>

  <main>
    <section class="section py-5">
      <div class="container container-narrow">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item"><a href="/customer.html">顧客ポータル</a></li>
            <li class="breadcrumb-item active" aria-current="page">フィードバックボード</li>
          </ol>
        </nav>

        <!-- メッセージ表示エリア -->
        <div id="messageArea" class="alert d-none" role="alert"></div>

        <!-- ページヘッダー情報 -->
        <div class="mb-4">
          <h1 class="mb-2">フィードバックボード</h1>
          <p class="lead mb-1">
            対象商品：<span id="productName" class="fw-bold text-primary">-</span>
            <span class="badge bg-secondary fw-normal ms-2" id="productCodeChip">-</span>
          </p>
          <p class="text-secondary">
            製品改善のため、皆様のご意見をお聞かせください。<br>
            手順：部位を選ぶ → その部位の意見を先に読む → 必要なら投票・投稿
          </p>
        </div>

        <!-- コンテンツコンテナ -->
        <div id="feedbackContent" class="card shadow-sm p-4">

          <!-- 1. 部位を選ぶ -->
          <h2 class="h5 mb-3 border-bottom pb-2">1. 部位を選ぶ</h2>
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-8">
              <label for="partSelect" class="form-label">部位</label>
              <select id="partSelect" class="form-select">
                <option value="">読み込み中...</option>
              </select>
              <div class="form-text">まずは部位を選び、その部位の意見を先に確認してください。</div>
            </div>
            <div class="col-12 col-md-4">
              <button id="btnReloadPartPosts" class="btn btn-outline-secondary w-100"><i class="bi bi-arrow-clockwise"></i> この部位の意見を更新</button>
            </div>
          </div>
          <div id="newPartWrap" class="mt-4 d-none">
            <div class="p-3 bg-light border rounded">
              <p class="fw-bold mb-2">新しい部位を登録（その他）</p>
              <div class="row g-3">
                <div class="col-12 col-md-5">
                  <label for="newPartCode" class="form-label">部位コード（英語）</label>
                  <input type="text" id="newPartCode" class="form-control" maxlength="32" placeholder="例: main_zipper">
                  <div class="form-text">半角英小文字・数字・アンダースコアのみ。</div>
                </div>
                <div class="col-12 col-md-7">
                  <label for="newPartNameJa" class="form-label">部位名（日本語）</label>
                  <input type="text" id="newPartNameJa" class="form-control" maxlength="64" placeholder="例: メインファスナー">
                </div>
                <div class="col-12">
                  <button id="btnCreatePart" class="btn btn-primary">この部位を追加して選択する</button>
                </div>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <!-- 2. この部位の意見を読む -->
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <h2 class="h5 m-0">2. この部位の意見を読む</h2>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <select id="filterType" class="form-select form-select-sm" style="width:auto;">
                <option value="">すべて表示</option>
                <option value="improve">改善案</option>
                <option value="praise">良い点</option>
              </select>
            </div>
          </div>
          <p class="text-secondary small">審査中の投稿も含めて表示します。投票できるのは承認済みの投稿のみです。</p>
          <div class="vstack gap-3" id="partPostsWrap">
            <div class="text-center p-4 bg-light rounded">
              <p class="text-secondary mb-0">上に表示されたメニューから部位を選択してください。</p>
            </div>
          </div>

          <hr class="my-4">

          <!-- 3. この部位に意見を投稿する -->
          <h2 class="h5 mb-3">3. この部位に意見を投稿する</h2>
          <div class="row g-3">
            <div class="col-12 col-md-7">
              <label class="form-label d-block mb-2">投稿タイプ</label>
              <div class="btn-group w-100" role="group" aria-label="投稿タイプ選択">
                <input type="radio" class="btn-check" name="postType" id="ptImprove" value="improve" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="ptImprove"><i class="bi bi-lightbulb me-2"></i>改善してほしいところ</label>

                <input type="radio" class="btn-check" name="postType" id="ptPraise" value="praise" autocomplete="off">
                <label class="btn btn-outline-primary" for="ptPraise"><i class="bi bi-hand-thumbs-up me-2"></i>良いと思ったところ</label>
              </div>
            </div>
            <div class="col-12 col-md-5">
              <label for="nickname" class="form-label">ニックネーム<span class="text-secondary small">（任意）</span></label>
              <input type="text" id="nickname" class="form-control" maxlength="32" placeholder="初回投稿時のみ登録されます">
            </div>
            <div class="col-12">
              <label for="title" class="form-label">タイトル</label>
              <input type="text" id="title" class="form-control" maxlength="120" placeholder="例：肩ひもの緩み止めが欲しい">
            </div>
            <div class="col-12">
              <label for="body" class="form-label">内容</label>
              <textarea id="body" class="form-control" rows="5" placeholder="どういう状況で困ったか、期待する改善案などをご記入ください。"></textarea>
            </div>
            <div class="col-12">
              <button id="btnSubmit" class="btn btn-primary btn-lg w-100">投稿する</button>
              <div id="submitHint" class="form-text mt-2 text-center">部位を選ぶと投稿できます。</div>
            </div>
          </div>

        </div> <!-- /#feedbackContent -->
      </div>
    </section>
  </main>

  <!-- ▼ 共通フッターを読み込み -->
  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script defer src="/common.js"></script>

  <script>
    // === ユーティリティ関数 ===
    const qs = name => new URL(window.location.href).searchParams.get(name) || '';
    const showAlert = (kind, msg) => {
      const box = document.getElementById('messageArea');
      box.className = `alert alert-${kind}`;
      box.textContent = msg;
      box.classList.remove('d-none');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    const clearAlert = () => document.getElementById('messageArea').classList.add('d-none');
    const escapeHtml = v => String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
    const api = (path, opts) => ADDEVA.apiFetch(path, opts);

    // === UIレンダリング関数 ===
    const statusMap = { new: '審査中', reviewing: '検討中', planned: '対応予定', shipped: '対応済み', rejected: '否認' };
    const statusLabel = s => statusMap[s] || s || '';
    const isApprovedStatus = s => ['reviewing', 'planned', 'shipped'].includes(s);

    function renderPostCard(p) {
      const approved = isApprovedStatus(p.status);
      const statusClass = approved ? 'text-bg-success' : 'text-bg-secondary';
      const statusChip = `<span class="badge ${statusClass} fw-normal">${escapeHtml(statusLabel(p.status))}</span>`;
      const typeChip = `<span class="badge text-bg-info fw-normal">${p.post_type === 'improve' ? '改善案' : '良い点'}</span>`;

      const voteButton = (voteType, label, count) => `
        <button class="btn btn-sm btn-outline-secondary vote-btn ${p.my_vote === voteType ? 'active' : ''}"
                data-act="vote" data-post="${p.post_id}" data-v="${voteType}" ${approved ? '' : 'disabled'}>
          ${label} <span class="badge text-bg-light">${count}</span>
        </button>`;

      const devCommentBlock = p.dev_comment ? `
        <div class="mt-3 pt-3 border-top">
          <p class="fw-bold mb-1"><i class="bi bi-chat-right-text me-2"></i>開発者コメント</p>
          <p class="small text-secondary mb-0" style="white-space:pre-wrap;">${escapeHtml(p.dev_comment)}</p>
        </div>` : '';

      return `
        <div class="border rounded p-3">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div class="flex-grow-1">
              <div class="d-flex gap-2 align-items-center flex-wrap mb-1">
                ${statusChip}
                ${typeChip}
                <h3 class="h6 mb-0">${escapeHtml(p.title)}</h3>
              </div>
              <p class="small text-secondary mb-2">
                投稿ID: ${p.post_id} / ${p.nickname ? `ニックネーム: ${escapeHtml(p.nickname)}` : ''}
              </p>
              <p class="mb-0" style="white-space:pre-wrap;">${escapeHtml(p.body)}</p>
            </div>
            <div class="text-end" style="min-width:150px;">
              <div class="btn-group btn-group-sm" role="group">
                ${voteButton('up', '賛成', p.up_count)}
                ${voteButton('down', '反対', p.down_count)}
              </div>
              <div class="form-text mt-1">
                ${approved ? 'クリックで投票/取消' : '審査中は投票不可'}
              </div>
            </div>
          </div>
          ${devCommentBlock}
        </div>`;
    }

    // === API連携 & イベントハンドラ ===
    async function loadProductInfo(productCode) {
      const res = await api('/api/addeva/feedback/product_info', { method: 'POST', body: { productCode } });
      document.getElementById('productName').textContent = res.product_name || '-';
      document.getElementById('productCodeChip').textContent = res.product_code || productCode || '-';
    }

    async function loadParts(productCode) {
      const res = await api('/api/addeva/feedback/parts/list', { method: 'POST', body: { productCode } });
      const sel = document.getElementById('partSelect');
      if (!Array.isArray(res)) {
        sel.innerHTML = '<option value="">部位の取得に失敗</option>';
        return;
      }
      sel.innerHTML = [
        '<option value="">部位を選択してください</option>',
        ...res.map(p => `<option value="${escapeHtml(p.part_code)}">${escapeHtml(p.part_name_ja)}</option>`),
        '<option value="__new__">その他（新しい部位を登録）</option>'
      ].join('');
    }

    async function loadPartPosts() {
      clearAlert();
      const wrap = document.getElementById('partPostsWrap');
      const productCode = qs('product_code');
      const partCode = document.getElementById('partSelect').value;
      const filterType = document.getElementById('filterType').value;

      if (!partCode || partCode === '__new__') {
        wrap.innerHTML = `<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">${partCode === '__new__' ? '新しい部位を登録してください。' : '部位を選択してください。'}</p></div>`;
        return;
      }
      wrap.innerHTML = `<div class="text-center p-4"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>`;

      try {
        const posts = await api('/api/addeva/feedback/part_posts', {
          method: 'POST',
          body: { productCode, partCode, postType: filterType || null }
        });

        if (!posts || posts.length === 0) {
          wrap.innerHTML = '<div class="text-center p-4 bg-light rounded"><p class="text-secondary mb-0">この部位の投稿はまだありません。</p></div>';
        } else {
          wrap.innerHTML = posts.map(renderPostCard).join('');
          wrap.querySelectorAll('.vote-btn').forEach(btn => {
            btn.addEventListener('click', async () => handleVote(btn));
          });
        }
      } catch (e) {
        wrap.innerHTML = `<div class="alert alert-danger mb-0">${escapeHtml(e.message) || '投稿の読み込みに失敗しました。'}</div>`;
      }
    }

    async function handleVote(btn) {
      const postId = btn.dataset.post;
      const voteType = btn.dataset.v;
      try {
        // キャンセルは「同じボタンをもう一度押す」で実現（サーバ側でDELETEする仕様）
        await api('/api/addeva/feedback/vote', {
          method: 'POST',
          body: { postId: Number(postId), voteType }
        });
        await loadPartPosts();
      } catch (e) {
        showAlert('danger', e.message || '投票に失敗しました。');
      }
    }

    function setUIState(partCode) {
      const isNew = partCode === '__new__';
      const hasSelection = !!partCode && !isNew;
      document.getElementById('newPartWrap').classList.toggle('d-none', !isNew);
      document.getElementById('btnSubmit').disabled = !hasSelection;
      document.getElementById('submitHint').textContent = hasSelection ? '内容を入力して投稿してください。' : '部位を選ぶと投稿できます。';
    }

    async function createPart() {
      clearAlert();
      const productCode = qs('product_code');
      const partCode = document.getElementById('newPartCode').value.trim();
      const partNameJa = document.getElementById('newPartNameJa').value.trim();
      if (!partCode || !partNameJa) {
        showAlert('warning', '部位コードと部位名を入力してください。');
        return;
      }
      try {
        await api('/api/addeva/feedback/parts/create', { method: 'POST', body: { productCode, partCode, partNameJa } });
        showAlert('success', '部位を追加しました。');
        await loadParts(productCode);
        document.getElementById('partSelect').value = partCode;
        setUIState(partCode);
        await loadPartPosts();
      } catch (e) {
        showAlert('danger', e.message || '部位の追加に失敗しました。');
      }
    }

    async function submitPost() {
      clearAlert();
      const productCode = qs('product_code');
      const partCode = document.getElementById('partSelect').value;
      const title = document.getElementById('title').value.trim();
      const body = document.getElementById('body').value.trim();
      if (!partCode || partCode === '__new__') { showAlert('warning', '部位を選択してください。'); return; }
      if (!title || !body) { showAlert('warning', 'タイトルと内容を入力してください。'); return; }

      const postData = {
        productCode, partCode, title, body,
        postType: document.querySelector('input[name="postType"]:checked').value,
        nickname: document.getElementById('nickname').value.trim() || null,
      };

      try {
        await api('/api/addeva/feedback/create', { method: 'POST', body: postData });
        showAlert('success', '投稿しました。ありがとうございます。審査後に公開されます。');
        document.getElementById('title').value = '';
        document.getElementById('body').value = '';
        await loadPartPosts();
      } catch (e) {
        showAlert('danger', e.message || '投稿に失敗しました。');
      }
    }

    // === 初期化処理 ===
    async function init() {
      const productCode = qs('product_code');
      if (!productCode) {
        showAlert('danger', '商品コードが指定されていません。顧客ポータルから再度お試しください。');
        return;
      }
      document.getElementById('productCodeChip').textContent = productCode;

      document.getElementById('partSelect').addEventListener('change', e => {
        setUIState(e.target.value);
        loadPartPosts();
      });
      document.getElementById('filterType').addEventListener('change', loadPartPosts);
      document.getElementById('btnReloadPartPosts').addEventListener('click', loadPartPosts);
      document.getElementById('btnCreatePart').addEventListener('click', createPart);
      document.getElementById('btnSubmit').addEventListener('click', submitPost);

      try {
        await loadProductInfo(productCode);
        await loadParts(productCode);
        setUIState('');
      } catch(e) {
        showAlert('danger', e.message || '初期化に失敗しました。');
      }
    }

    // ADDEVAオブジェクトの準備ができてから初期化を実行
    (function waitForADDEVA() {
      if (typeof ADDEVA !== 'undefined' && ADDEVA.apiFetch) {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        setTimeout(waitForADDEVA, 50);
      }
    })();
  </script>

  <!-- ▼ includeエンジン -->
  <script>
    (async()=>{try{const t=document.querySelectorAll('[data-include]');for(const e of t){const l=e.getAttribute('data-include');if(!l)continue;const o=await fetch(l,{cache:'no-cache'});if(!o.ok)throw new Error(`include failed: ${l} (${o.status})`);e.outerHTML=await o.text()}}catch(e){console.error('include loader error:',e)}})();
  </script>
</body>
</html>
