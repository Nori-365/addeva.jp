<!doctype html>
<html lang="ja">
<head>
  <script>
    (async (d, u) => {
      try {
        const r = await fetch(u, { cache: 'no-cache' });
        const h = await r.text();
        const tpl = d.createElement('template');
        tpl.innerHTML = h;
        [...tpl.content.childNodes].forEach(n => {
          if (n.tagName === 'SCRIPT') {
            const s = d.createElement('script');
            [...n.attributes].forEach(a => s.setAttribute(a.name, a.value));
            s.textContent = n.textContent;
            d.head.appendChild(s);
          } else {
            d.head.appendChild(n);
          }
        });
      } catch (e) {
        console.error('head include failed:', u, e);
      }
    })(document, '/includes/head-common.html');
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>フィードバックボード｜ADDEVA サポート</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css?v=3.8">

  <script defer src="/common.js"></script>

  <style>
    .chip { display:inline-block; padding:2px 8px; border:1px solid rgba(255,255,255,.25); border-radius:999px; font-size:.85rem; }
    .post-card { border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px; }
    .vote-btn.active { outline:2px solid rgba(255,255,255,.45); }
    .muted { opacity:.75; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .status-chip { border-color: rgba(255,255,255,.25); }
    .status-new { opacity:.75; }
    .status-approved { opacity:1; }
    .divider-soft { border-top: 1px solid rgba(255,255,255,.10); }
  </style>
</head>

<body>
  <div data-include="/includes/header.html" aria-busy="true"></div>

  <main class="py-4">
    <div class="container container-narrow">
      <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
        <div>
          <div class="kicker">Support / Feedback</div>
          <h1 class="h3 mb-1">フィードバックボード</h1>
          <div class="muted">
            対象商品：<span id="productName" class="fw-semibold">-</span>
            <span class="chip ms-2 mono" id="productCodeChip">-</span>
          </div>
          <div class="muted mt-2" style="font-size:.95rem;">
            手順：部位を選ぶ → その部位の意見を先に読む → 必要なら投稿
          </div>
        </div>
        <div class="text-end">
          <a href="/support/customer.html" class="btn btn-outline-light btn-sm">サポートページへ戻る</a>
        </div>
      </div>

      <hr class="my-4 divider-soft">

      <div id="alertBox" class="alert d-none" role="alert"></div>

      <div class="card border-0 shadow-sm" style="border-radius:16px;">
        <div class="card-body">
          <h2 class="h5 mb-3">1. 部位を選ぶ</h2>

          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-8">
              <label for="partSelect" class="form-label fw-semibold mb-1">部位</label>
              <select id="partSelect" class="form-select">
                <option value="">読み込み中...</option>
              </select>
              <div class="form-text">まずは部位を選び、その部位の意見を先に確認してください。</div>
            </div>

            <div class="col-12 col-md-4">
              <button id="btnReloadPartPosts" class="btn btn-outline-light w-100">この部位の意見を更新</button>
            </div>
          </div>

          <div id="newPartWrap" class="mt-4 d-none">
            <div class="p-3" style="border:1px solid rgba(255,255,255,.12); border-radius:14px;">
              <div class="fw-semibold mb-2">新しい部位を登録（その他）</div>
              <div class="row g-3">
                <div class="col-12 col-md-5">
                  <label for="newPartCode" class="form-label fw-semibold mb-1">部位コード（英語）</label>
                  <input type="text" id="newPartCode" class="form-control mono" maxlength="32" placeholder="例: main_zipper / shoulder_strap">
                  <div class="form-text">半角英小文字・数字・アンダースコアのみ（3〜32文字）。</div>
                </div>
                <div class="col-12 col-md-7">
                  <label for="newPartNameJa" class="form-label fw-semibold mb-1">部位名（日本語）</label>
                  <input type="text" id="newPartNameJa" class="form-control" maxlength="64" placeholder="例: メインファスナー / ショルダーベルト">
                </div>
                <div class="col-12">
                  <button id="btnCreatePart" class="btn btn-dark">この部位を追加して選択する</button>
                  <div class="form-text mt-2">追加後、この部位の意見一覧が表示され、投稿できるようになります。</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <hr class="my-4 divider-soft">

      <div class="card border-0 shadow-sm" style="border-radius:16px;">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <h2 class="h5 m-0">2. この部位の意見を先に読む</h2>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <select id="filterType" class="form-select form-select-sm" style="width:auto;">
                <option value="">すべて</option>
                <option value="improve">改善してほしいところ</option>
                <option value="praise">良いと思ったところ</option>
              </select>
              <button id="btnReload" class="btn btn-outline-light btn-sm">更新</button>
            </div>
          </div>

          <div class="muted mt-2" style="font-size:.95rem;">
            審査中の投稿も含めて同部位の意見を表示します。投票できるのは承認済み（検討中/対応予定/対応済み）の投稿のみです。
          </div>

          <div class="mt-3 vstack gap-3" id="partPostsWrap"></div>
        </div>
      </div>

      <hr class="my-4 divider-soft">

      <div class="card border-0 shadow-sm" style="border-radius:16px;">
        <div class="card-body">
          <h2 class="h5 mb-3">3. この部位に意見を投稿する</h2>

          <div class="row g-3">
            <div class="col-12 col-md-7">
              <div class="mb-2 fw-semibold">投稿タイプ</div>
              <div class="d-flex flex-wrap gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="postType" id="ptImprove" value="improve" checked>
                  <label class="form-check-label" for="ptImprove">改善してほしいところ</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="postType" id="ptPraise" value="praise">
                  <label class="form-check-label" for="ptPraise">良いと思ったところ</label>
                </div>
              </div>
              <div class="muted mt-2" style="font-size:.95rem;">
                使っていない/分からない場合は、投票は「無投票」のままが正解です（無理に反対を入れないでください）。
              </div>
            </div>

            <div class="col-12 col-md-5">
              <label for="nickname" class="form-label fw-semibold mb-1">ニックネーム（任意）</label>
              <input type="text" id="nickname" class="form-control" maxlength="32" placeholder="初回投稿時のみ登録できます（例：Ueda）">
              <div class="form-text">未登録の場合のみ保存されます。すでに登録済みの場合は無視されます。</div>
            </div>

            <div class="col-12">
              <label for="title" class="form-label fw-semibold mb-1">タイトル</label>
              <input type="text" id="title" class="form-control" maxlength="120" placeholder="例：肩ひもの緩み止めが欲しい / ここが最高に便利だった">
            </div>

            <div class="col-12">
              <label for="body" class="form-label fw-semibold mb-1">内容</label>
              <textarea id="body" class="form-control" rows="6" placeholder="例：どういう状況で困ったか、どの動作で起きるか、期待する改善案など。"></textarea>
            </div>

            <div class="col-12">
              <button id="btnSubmit" class="btn btn-dark">投稿する</button>
              <div id="submitHint" class="form-text mt-2">部位を選ぶと投稿できます。</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <div data-include="/includes/footer.html" aria-busy="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function qs(name) {
      const url = new URL(window.location.href);
      return (url.searchParams.get(name) || '').trim();
    }

    function showAlert(kind, msg) {
      const box = document.getElementById('alertBox');
      box.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info');
      box.classList.add('alert-' + kind);
      box.textContent = msg;
    }

    function clearAlert() {
      const box = document.getElementById('alertBox');
      box.classList.add('d-none');
      box.textContent = '';
    }

    function escapeHtml(v) {
      const s = (v === null || v === undefined) ? '' : String(v);
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function api(path, opts) {
      return await ADDEVA.apiFetch(path, opts);
    }

    async function loadProductInfo(productCode) {
      // product_name は URL からは受け取らず、DB から取得する
      const res = await api('/api/addeva/feedback/product_info', {
        method: 'POST',
        body: { productCode }
      });

      if (!res || typeof res !== 'object') {
        throw new Error('商品情報の取得に失敗しました。');
      }

      document.getElementById('productName').textContent = res.product_name || '-';
      document.getElementById('productCodeChip').textContent = res.product_code || productCode || '-';
    }

    function voteLabel(v) {
      if (v === 'up') return '賛成';
      if (v === 'down') return '反対';
      if (v === 'neutral') return 'どちらでもない';
      return '無投票';
    }

    function voteBtnClass(active) {
      return 'btn btn-outline-light btn-sm vote-btn' + (active ? ' active' : '');
    }

    function statusLabel(s) {
      if (s === 'new') return '審査中';
      if (s === 'reviewing') return '検討中';
      if (s === 'planned') return '対応予定';
      if (s === 'shipped') return '対応済み';
      if (s === 'rejected') return '否認';
      return s || '';
    }

    function isApprovedStatus(s) {
      return s === 'reviewing' || s === 'planned' || s === 'shipped';
    }

    function renderPostCard(p) {
      const devComment = (p.dev_comment || '').trim();
      const devImgs = Array.isArray(p.dev_image_urls) ? p.dev_image_urls : [];

      const approved = isApprovedStatus(p.status);
      const statusChip = `<span class="chip status-chip ${approved ? 'status-approved' : 'status-new'}">${escapeHtml(statusLabel(p.status))}</span>`;

      const devBlock = `
        <div class="mt-3">
          <div class="fw-semibold">開発者コメント</div>
          <div class="muted" style="white-space:pre-wrap;">${escapeHtml(devComment)}</div>
          ${devImgs.length ? `
            <div class="d-flex flex-wrap gap-2 mt-2">
              ${devImgs.map(u => `<a href="${escapeHtml(u)}" target="_blank" rel="noopener"><img src="${escapeHtml(u)}" alt="dev" style="height:80px;border-radius:10px;border:1px solid rgba(255,255,255,.12);"></a>`).join('')}
            </div>
          ` : ''}
        </div>
      `;

      return `
        <div class="post-card">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div>
              <div class="d-flex gap-2 align-items-center flex-wrap">
                <div class="fw-semibold">${escapeHtml(p.title)}</div>
                <span class="chip">${p.post_type === 'improve' ? '改善' : '良かった'}</span>
                ${statusChip}
                <span class="chip muted">投稿ID ${p.post_id}</span>
              </div>
              <div class="muted mt-1" style="white-space:pre-wrap;">${escapeHtml(p.body)}</div>
              <div class="muted mt-2" style="font-size:.95rem;">
                作成：${escapeHtml(p.created_at || '')}
                ${p.nickname ? ` / ニックネーム：${escapeHtml(p.nickname)}` : ''}
              </div>
            </div>

            <div class="text-end" style="min-width:260px;">
              <div class="fw-semibold mb-2">投票</div>
              <div class="d-flex justify-content-end gap-2 flex-wrap">
                <button class="${voteBtnClass(p.my_vote === 'up')}" data-act="vote" data-post="${p.post_id}" data-v="up" ${approved ? '' : 'disabled'}>賛成 ${p.up_count}</button>
                <button class="${voteBtnClass(p.my_vote === 'down')}" data-act="vote" data-post="${p.post_id}" data-v="down" ${approved ? '' : 'disabled'}>反対 ${p.down_count}</button>
                <button class="${voteBtnClass(p.my_vote === 'neutral')}" data-act="vote" data-post="${p.post_id}" data-v="neutral" ${approved ? '' : 'disabled'}>どちらでもない ${p.neutral_count}</button>
              </div>
              <div class="muted mt-2" style="font-size:.92rem;">あなたの状態：${escapeHtml(voteLabel(p.my_vote))}</div>
              ${approved ? `<div class="muted" style="font-size:.92rem;">同じボタンをもう一度押すと無投票に戻せます</div>` : `<div class="muted" style="font-size:.92rem;">審査中は投票できません</div>`}
            </div>
          </div>
          ${devBlock}
        </div>
      `;
    }

    async function loadParts(productCode) {
      const res = await api('/api/addeva/feedback/parts/list', {
        method: 'POST',
        body: { productCode }
      });

      const sel = document.getElementById('partSelect');
      if (!Array.isArray(res)) {
        sel.innerHTML = '<option value="">部位の取得に失敗しました</option>';
        return;
      }

      const opts = [];
      opts.push('<option value="">部位を選択してください</option>');
      res.forEach(p => {
        opts.push(`<option value="${escapeHtml(p.part_code)}">${escapeHtml(p.part_name_ja)}（${escapeHtml(p.part_code)}）</option>`);
      });
      opts.push('<option value="__new__">その他（新しい部位を登録）</option>');

      sel.innerHTML = opts.join('');
    }

    function setNewPartMode(on) {
      const wrap = document.getElementById('newPartWrap');
      if (on) wrap.classList.remove('d-none');
      else wrap.classList.add('d-none');

      const btnSubmit = document.getElementById('btnSubmit');
      const hint = document.getElementById('submitHint');
      if (on) {
        btnSubmit.disabled = true;
        hint.textContent = '新しい部位を登録してから投稿できます。';
      }
    }

    function setSubmitEnabled(enabled) {
      const btnSubmit = document.getElementById('btnSubmit');
      const hint = document.getElementById('submitHint');
      btnSubmit.disabled = !enabled;
      hint.textContent = enabled ? 'この部位について投稿できます。' : '部位を選ぶと投稿できます。';
    }

    function currentPartCode() {
      const v = (document.getElementById('partSelect').value || '').trim();
      if (!v || v === '__new__') return '';
      return v;
    }

    async function loadPartPosts() {
      clearAlert();

      const productCode = qs('product_code');
      const partCode = currentPartCode();
      const filterType = (document.getElementById('filterType').value || '').trim();

      const wrap = document.getElementById('partPostsWrap');
      if (!productCode) {
        wrap.innerHTML = '<div class="muted">product_code が指定されていません。</div>';
        return;
      }
      if (!partCode) {
        wrap.innerHTML = '<div class="muted">部位を選択してください。</div>';
        return;
      }

      const res = await api('/api/addeva/feedback/part_posts', {
        method: 'POST',
        body: { productCode, partCode, postType: filterType || null }
      });

      if (!Array.isArray(res) || res.length === 0) {
        wrap.innerHTML = '<div class="muted">この部位の投稿はまだありません。</div>';
        return;
      }

      wrap.innerHTML = res.map(renderPostCard).join('');

      wrap.querySelectorAll('button[data-act="vote"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const postId = Number(btn.getAttribute('data-post'));
          const voteType = btn.getAttribute('data-v');
          try {
            await api('/api/addeva/feedback/vote', {
              method: 'POST',
              body: { postId, voteType }
            });
            await loadPartPosts();
          } catch (e) {
            showAlert('danger', e.message || '投票に失敗しました。');
          }
        });
      });
    }

    async function createPart() {
      clearAlert();

      const productCode = qs('product_code');
      const partCode = (document.getElementById('newPartCode').value || '').trim();
      const partNameJa = (document.getElementById('newPartNameJa').value || '').trim();

      if (!productCode) {
        showAlert('danger', 'product_code が指定されていません。');
        return;
      }
      if (!partCode) {
        showAlert('warning', '部位コード（英語）を入力してください。');
        return;
      }
      if (!partNameJa) {
        showAlert('warning', '部位名（日本語）を入力してください。');
        return;
      }

      try {
        await api('/api/addeva/feedback/parts/create', {
          method: 'POST',
          body: { productCode, partCode, partNameJa }
        });

        showAlert('success', '部位を追加しました。');

        await loadParts(productCode);
        document.getElementById('partSelect').value = partCode;
        setNewPartMode(false);
        setSubmitEnabled(true);

        await loadPartPosts();

      } catch (e) {
        showAlert('danger', e.message || '部位の追加に失敗しました。');
      }
    }

    async function submitPost() {
      clearAlert();

      const productCode = qs('product_code');
      const partCode = currentPartCode();
      const postType = (document.querySelector('input[name="postType"]:checked') || {}).value || 'improve';
      const nickname = (document.getElementById('nickname').value || '').trim();
      const title = (document.getElementById('title').value || '').trim();
      const body = (document.getElementById('body').value || '').trim();

      if (!productCode) {
        showAlert('danger', 'product_code が指定されていません。');
        return;
      }
      if (!partCode) {
        showAlert('warning', '部位を選択してください。');
        return;
      }
      if (!title) {
        showAlert('warning', 'タイトルを入力してください。');
        return;
      }
      if (!body) {
        showAlert('warning', '内容を入力してください。');
        return;
      }

      try {
        await api('/api/addeva/feedback/create', {
          method: 'POST',
          body: {
            productCode,
            partCode,
            postType,
            title,
            body,
            nickname: nickname || null
          }
        });

        showAlert('success', '投稿しました。ありがとうございます。審査後に公開されます。');

        document.getElementById('title').value = '';
        document.getElementById('body').value = '';

        await loadPartPosts();

      } catch (e) {
        showAlert('danger', e.message || '投稿に失敗しました。');
      }
    }

    async function init() {
      const productCode = qs('product_code');

      document.getElementById('productName').textContent = '読み込み中...';
      document.getElementById('productCodeChip').textContent = productCode ? productCode : '-';

      if (!productCode) {
        showAlert('danger', 'product_code が指定されていません。サポートページ（customer.html）から遷移してください。');
        return;
      }

      try {
        await loadProductInfo(productCode);
      } catch (e) {
        showAlert('danger', e.message || '商品情報の取得に失敗しました。');
        return;
      }

      document.getElementById('btnReload').addEventListener('click', loadPartPosts);
      document.getElementById('btnReloadPartPosts').addEventListener('click', loadPartPosts);
      document.getElementById('filterType').addEventListener('change', loadPartPosts);
      document.getElementById('btnCreatePart').addEventListener('click', createPart);
      document.getElementById('btnSubmit').addEventListener('click', submitPost);

      document.getElementById('partSelect').addEventListener('change', async () => {
        clearAlert();
        const v = (document.getElementById('partSelect').value || '').trim();
        if (!v) {
          setNewPartMode(false);
          setSubmitEnabled(false);
          document.getElementById('partPostsWrap').innerHTML = '<div class="muted">部位を選択してください。</div>';
          return;
        }
        if (v === '__new__') {
          setNewPartMode(true);
          document.getElementById('partPostsWrap').innerHTML = '<div class="muted">新しい部位を登録してください。</div>';
          return;
        }
        setNewPartMode(false);
        setSubmitEnabled(true);
        await loadPartPosts();
      });

      await loadParts(productCode);
      setSubmitEnabled(false);
      document.getElementById('partPostsWrap').innerHTML = '<div class="muted">部位を選択してください。</div>';
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
